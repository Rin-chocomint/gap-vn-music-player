<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title> Gap vn & music Player | v0.0.0.8 Alpha </title>

    <style>
        /* ================================ GLOBAL STYLES ================================ */

        /* =========== Global Reset & Font ============= */
        /*------------------- reset box model -------------------------*/
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /*------------------- end reset box model -------------------------*/

        /*------------------- fade animations -------------------------*/
        body.fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        body.fade-in {
            opacity: 1;
            transition: opacity 0.5s ease-in;
        }

        /*------------------- end fade animations -------------------------*/

        /*------------------- user select -------------------------*/
        * {
            -webkit-user-select: none;
            user-select: none;
        }

        input,
        textarea {
            -webkit-user-select: auto;
            user-select: auto;
        }

        /*------------------- end user select -------------------------*/
        /* ===================== End Global Reset & Font ====================== */

        /* =============================== Window Debug ============================ */
        /*------------------- log window container -------------------------*/
        #log-window-container {
            position: fixed;
            top: 50px;
            left: 50px;
            width: 700px;
            height: 400px;
            min-width: 300px;
            min-height: 150px;
            background-color: rgba(15, 18, 25, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 9999999;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        #log-window-container.hidden {
            display: none !important;
        }

        /*------------------- end log window container -------------------------*/

        /*------------------- log title bar -------------------------*/
        .log-title-bar {
            width: 100%;
            padding: 8px 12px;
            background-color: rgba(0, 255, 255, 0.1);
            color: cyan;
            font-family: monospace;
            font-weight: bold;
            cursor: move;
            user-select: none;
        }

        /*------------------- end log title bar -------------------------*/

        /*------------------- log content -------------------------*/
        #log-content {
            flex-grow: 1;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            color: #aaffaa;
            padding: 5px;
        }

        #log-content .log-line {
            margin: 0;
            padding: 3px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /*------------------- end log content -------------------------*/

        /*------------------- resize handle -------------------------*/
        .resizer {
            position: absolute;
            width: 10px;
            height: 10px;
        }

        .resizer-se {
            bottom: 0;
            right: 0;
            cursor: nwse-resize;
        }

        /*------------------- end resize handle -------------------------*/
        /* =============================== End Window Debug ============================ */

        /* ============================= Body ================================= */
        /*------------------- html & body base -------------------------*/
        html,
        body {
            width: 100%;
            height: 100%;
            font-family: 'Lexend', sans-serif;
            background-color: black;
            color: white;
        }

        body {
            overflow: hidden;
            text-align: center;
            transition: opacity 4.3s ease-in-out;
        }

        body.fade-out {
            opacity: 0;
        }

        /*------------------- end html & body base -------------------------*/

        /*------------------- fonts - lexend -------------------------*/
        /* lexend-300 - latin */
        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 300;
            src: url('./aset/fonts/lexend-v26-latin-300.woff2') format('woff2');
        }

        /* lexend-regular - latin */
        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 400;
            src: url('./aset/fonts/lexend-v26-latin-regular.woff2') format('woff2');
        }

        /* lexend-700 - latin */
        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 700;
            src: url('./aset/fonts/lexend-v26-latin-700.woff2') format('woff2');
        }

        /*------------------- end fonts - lexend -------------------------*/
        /* ============================ End Body ============================= */


        /* ============================== Screen ================================= */
        /*------------------- screen base -------------------------*/
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background-color: black;
            transition: opacity 1s ease-in-out;
        }

        /*------------------- end screen base -------------------------*/

        /*------------------- screen animations -------------------------*/
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /*------------------- end screen animations -------------------------*/
        /* =============================== End Screen ============================= */

        /* ============================ WARNING SCREEN ============================ */
        /*------------------- warning screen -------------------------*/
        #warning-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            animation: fadeIn 1s forwards;
            background-color: black;
            padding: 20px;
            cursor: pointer;
        }

        .warning-icon-svg {
            width: 80px;
            height: 80px;
            fill: #FFD700;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));
        }

        .warning-main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #eeeeee;
            letter-spacing: 1px;
            text-align: center;
            font-family: 'Lexend', sans-serif;
            margin: 0;
        }

        .warning-sub-text {
            font-size: 1.1rem;
            color: #aaaaaa;
            text-align: center;
            line-height: 1.6;
            max-width: 800px;
            font-weight: 300;
            font-family: 'Lexend', sans-serif;
        }

        .warning-sub-text p {
            margin: 5px 0;
        }

        .click-to-continue {
            margin-top: 30px;
            font-size: 1rem;
            color: #888;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }

        .click-to-continue.visible {
            opacity: 1;
        }

        /*------------------- end warning screen -------------------------*/
        /* ========================== End WARNING SCREEN ========================== */

        /* ============================ Dev Screen ================================= */
        /*------------------- developer screen -------------------------*/
        #developer-screen h2 {
            font-size: 4rem;
            font-weight: bold;
            animation: fadeIn 2s ease forwards;
        }

        #developer-screen h4 {
            font-size: 1.5rem;
            margin-top: 10px;
            animation: fadeIn 2s ease forwards;
        }

        /*------------------- end developer screen -------------------------*/
        /* ============================ End Dev Screen ================================= */


        /* ============================ Title Screen ================================= */
        /*------------------- title animations -------------------------*/
        @keyframes fadeInLetter {
            from {
                opacity: 0;
                filter: blur(10px);
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                filter: blur(0);
                transform: translateY(0);
            }
        }

        @keyframes fadeInBlur {
            from {
                opacity: 0;
                filter: blur(10px);
            }

            to {
                opacity: 1;
                filter: blur(0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            80% {
                opacity: 0.7;
            }
        }

        @keyframes glowPulse {
            from {
                text-shadow:
                    0 0 5px #8ec9ff,
                    0 0 10px #8ec9ff,
                    0 0 20px #8ec9ff,
                    0 0 30px rgba(142, 201, 255, 0.8),
                    0 0 40px rgba(142, 201, 255, 0.6);
            }

            to {
                text-shadow:
                    0 0 10px #8ec9ff,
                    0 0 20px #8ec9ff,
                    0 0 30px rgba(142, 201, 255, 0.9),
                    0 0 40px rgba(142, 201, 255, 0.7),
                    0 0 50px rgba(142, 201, 255, 0.5);
            }
        }

        @keyframes revealAndHide {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            10% {
                opacity: 1;
                transform: translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        @keyframes fall {
            0% {
                transform: translateX(var(--start-x)) translateY(var(--start-y)) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateX(var(--end-x)) translateY(var(--end-y)) scale(0.7);
                opacity: 0;
            }
        }

        /*------------------- end title animations -------------------------*/

        /*------------------- title heading -------------------------*/
        #title-screen h1 {
            font-size: 3rem;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            text-shadow:
                0 0 5px #8ec9ff,
                0 0 10px #8ec9ff,
                0 0 20px #8ec9ff,
                0 0 30px rgba(142, 201, 255, 0.8),
                0 0 40px rgba(142, 201, 255, 0.6);
            animation: glowPulse 2s infinite alternate;
        }

        #title-screen h1 span {
            display: inline-block;
            opacity: 0;
            animation: fadeInLetter 0.5s ease forwards;
        }

        #title-screen h3 {
            font-size: 2rem;
            opacity: 0;
            animation: fadeInBlur 1s ease-out forwards;
            animation-delay: 2s;
        }

        #title-screen p {
            font-size: 1.5rem;
            opacity: 0;
            animation: fadeIn 1s ease-out forwards, blink 0.5s infinite;
            animation-delay: 0s;
            position: relative;
            top: 230px;
        }

        /*------------------- end title heading -------------------------*/

        /*------------------- rotating text -------------------------*/
        #rotating-text {
            font-size: 1.5rem;
            opacity: 0;
            margin: 60px;
            animation: fadeIn 2s ease-out forwards;
            animation-delay: 6s;
            position: relative;
        }

        #rotating-text.cycling {
            animation: revealAndHide 4.8s linear infinite;
        }

        /*------------------- end rotating text -------------------------*/

        /*------------------- background video -------------------------*/
        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            opacity: 0;
            z-index: -1;
            transition: opacity 2s ease-in-out;
            filter: brightness(70%);
        }

        /*------------------- end background video -------------------------*/

        /*------------------- falling stars -------------------------*/
        .star {
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .star-container {
            position: absolute;
            animation: fall linear infinite;
        }

        .star-container::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 2px;
            filter: blur(4px);
            top: 50%;
            left: -200px;
            transform: translateY(-50%) rotate(0deg);
            opacity: 0.8;
        }

        /*------------------- end falling stars -------------------------*/
        /* ============================ End Title Screen ================================= */


        /* ============================ Main Menu ================================= */

        /*------------------- profile section -------------------------*/
        #profile-section {
            display: flex;
            align-items: center;
            gap: 20px;
            position: absolute;
            top: 20px;
            left: 20px;
            transform: scale(0.8);
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 204, 255, 0.2), rgba(0, 102, 204, 0.3));
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.3);
            transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        #profile-section:hover {
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
        }

        #profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid cyan;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        }

        #profile-info {
            color: white;
            text-align: left;
            font-family: 'Lexend', sans-serif;
        }

        #profile-info h2 {
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 0 0 5px cyan, 0 0 10px rgba(0, 255, 255, 0.6);
            transition: color 0.3s ease-in-out;
        }

        #profile-info h2:hover {
            color: #00e5ff;
        }

        #profile-info p {
            margin: 4px 0;
            font-size: 1rem;
            color: #bbb;
            text-shadow: 0 0 3px rgba(0, 255, 255, 0.3);
        }

        #profile-level {
            font-size: 1.05rem !important;
            color: #ffd700 !important;
            margin-bottom: 4px !important;
        }

        #profile-description {
            font-size: 0.95rem !important;
            color: #ccc !important;
            line-height: 1.4 !important;
        }

        #level-bar {
            position: relative;
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid cyan;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        #level-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #0a99b3, #e81183, #ee5d9e, #0181ce, #f38112, #00a2b9, #da1784, #e88409, #0085cd, #0899ac, #0a99b3, #e81183, #ee5d9e);
            background-size: 600% 100%;
            animation: gradient-shift-rtl 2s linear infinite;
            border-radius: 8px;
        }

        @keyframes gradient-shift-rtl {
            0% {
                background-position: 100% 0%;
            }

            100% {
                background-position: 0% 0%;
            }
        }

        #level-max-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 0 0 5px cyan;
            pointer-events: none;
        }

        /*------------------- end profile section -------------------------*/

        /*------------------- connection status -------------------------*/
        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
        }

        #connect-button {
            font-family: 'Lexend', sans-serif;
            background: #2c2c2c;
            border: 2px solid #444;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        #connect-button:hover {
            border-color: #666;
            background: #363636;
        }

        #connect-button.connecting {
            border-color: #2196F3;
            background: #2196F310;
        }

        #connect-button.connected {
            border-color: #4CAF50;
            background: #4CAF5010;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }

        .loading-spinner .spin-path {
            transform-origin: center;
            animation: spin-pure 1s linear infinite;
        }

        @keyframes spin-pure {
            100% {
                transform: rotate(360deg);
            }
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: none;
            display: none;
        }

        .loading-spinner.visible {
            display: inline-block;
        }

        #ping-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .ping-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #777;
        }

        .ping-dot.good {
            background: #4CAF50;
        }

        .ping-dot.moderate {
            background: #FFC107;
        }

        .ping-dot.poor {
            background: #F44336;
        }

        /*------------------- end connection status -------------------------*/

        /*------------------- notification system -------------------------*/
        #notification-container {
            position: fixed;
            top: 30px;
            /* Moved to top right */
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 350px;
            z-index: 9999;
            pointer-events: none;
        }

        .notification {
            background: rgba(20, 20, 25, 0.95);
            /* Darker, more opaque */
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 4px;
            /* Sharper corners */
            border-left: 4px solid #2196F3;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            backdrop-filter: blur(10px);
            font-family: 'Lexend', sans-serif;
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }

        /* Shine effect */
        .notification::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.05) 40%, transparent 100%);
            pointer-events: none;
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(120%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.fade-out {
            animation: fadeOutRight 0.5s forwards;
        }

        @keyframes fadeOutRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        .notification-icon {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 5px currentColor);
            /* Glow for icon */
        }

        .notification-success {
            border-left-color: #00ff88;
        }

        .notification-success .notification-icon {
            color: #00ff88;
        }

        .notification-error {
            border-left-color: #ff4d4d;
        }

        .notification-error .notification-icon {
            color: #ff4d4d;
        }

        .notification-warning {
            border-left-color: #ffcc00;
        }

        .notification-warning .notification-icon {
            color: #ffcc00;
        }

        .notification-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .notification-message {
            line-height: 1.25;
            word-break: break-word;
        }

        .notification-details {
            margin: 0;
            padding-left: 18px;
            font-size: 0.82rem;
            color: rgba(224, 224, 224, 0.85);
            line-height: 1.25;
        }

        .notification-details li {
            margin: 2px 0;
        }

        /*------------------- end notification system -------------------------*/

        /*------------------- menu options -------------------------*/
        #menu-options {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        #menu-options h1 {
            font-size: 3rem;
            color: #FF4C4C;
            margin-bottom: 20px;
        }

        #menu-options ul {
            list-style: none;
            font-size: 2rem;
            padding: 0;
        }

        #menu-options li {
            margin: 10px;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
        }

        #menu-options li:hover {
            transform: scale(1.1);
            color: #FF4C4C;
        }

        /*------------------- end menu options -------------------------*/

        /*------------------- quit confirmation popup -------------------------*/
        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
            pointer-events: none;
        }

        .custom-popup-overlay.hidden {
            display: none !important;
        }

        .custom-popup-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .custom-popup-content {
            background-color: #2a2e37;
            padding: 25px 35px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: #e8eaed;
            width: auto;
            min-width: 300px;
            max-width: 420px;
            transform: scale(0.9);
            transition: transform 0.25s ease-in-out;
        }

        .custom-popup-overlay.visible .custom-popup-content {
            transform: scale(1);
        }

        .custom-popup-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #ff6b6b;
        }

        .custom-popup-content p {
            margin-bottom: 25px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .custom-popup-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .popup-btn {
            padding: 10px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-family: 'Lexend', sans-serif;
        }

        .popup-btn:active {
            transform: scale(0.96);
        }

        .popup-btn-danger {
            background-color: #ff6b6b;
            color: white;
        }

        .popup-btn-danger:hover {
            background-color: #e74c3c;
        }

        .popup-btn-secondary {
            background-color: #4a4e57;
            color: #e8eaed;
        }

        .popup-btn-secondary:hover {
            background-color: #5c6068;
        }

        /* ---- Animasi lucu saat quitting ---- */
        /* Kaomoji emoji styling */
        .quit-kaomoji {
            font-size: 2rem;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Elemen yang akan menghilang saat quitting */
        .quit-hideable {
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }

        /* State saat quitting - elemen lain hilang */
        .custom-popup-overlay.quitting .quit-hideable {
            opacity: 0;
            transform: translateY(-15px);
            pointer-events: none;
        }

        /* State saat quitting - kaomoji beranimasi miring ke kiri */
        .custom-popup-overlay.quitting .quit-kaomoji {
            animation: kaomojiQuitting 2.4s ease-out forwards, kaomojiPulse 0.25s ease-in-out infinite;
            font-size: 3rem;
        }

        /* Animasi utama kaomoji - miring, fade, shrink, dan geser ke kiri */
        @keyframes kaomojiQuitting {
            0% {
                transform: rotate(0deg) scale(1.2) translateX(0);
                opacity: 1;
            }

            30% {
                transform: rotate(-8deg) scale(1.1) translateX(-20px);
                opacity: 0.85;
            }

            60% {
                transform: rotate(-12deg) scale(0.95) translateX(-40px);
                opacity: 0.65;
            }

            100% {
                transform: rotate(-15deg) scale(0.85) translateX(-60px);
                opacity: 0.45;
            }
        }

        /* Animasi denyut sederhana - hanya scale naik turun di tempat */
        @keyframes kaomojiPulse {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.12);
            }
        }

        /* Popup content saat quitting - shrink ke arah kaomoji */
        .custom-popup-overlay.quitting .custom-popup-content {
            background-color: transparent;
            box-shadow: none;
        }

        /*------------------- end quit confirmation popup -------------------------*/

        /*------------------- options modal -------------------------*/
        #options-modal .option-row-checkbox {
            display: flex;
            margin-bottom: 22px;
            gap: 15px;
        }

        #options-modal .option-row-checkbox .label-text-wrapper {
            min-width: 300px;
            margin-right: auto;
            color: #c8d0d8;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.4;
        }

        #options-modal .option-row-checkbox input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            background-color: #22252c;
            border: 1px solid #333842;
            border-radius: 4px;
            width: 12px;
            height: 12px;
            cursor: pointer;
            position: relative;
            outline: none;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            flex-shrink: 0;
            margin-left: 0;
        }

        #options-modal .option-row-checkbox input[type="checkbox"]:checked {
            background-color: cyan;
            border-color: cyan;
        }

        #options-modal .option-row-checkbox input[type="checkbox"]:checked::after {
            font-size: 15px;
            color: #1c1e24;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
        }

        #options-modal .option-row-checkbox input[type="checkbox"]:hover {
            border-color: rgba(0, 200, 200, 0.6);
        }

        /* Remember Settings & Clear Buttons Styling */
        .remember-setting-btn,
        .clear-remember-setting-btn {
            font-family: 'Lexend', sans-serif;
            padding: 10px 20px;
            border-radius: 6px;
            border: 2px solid;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .remember-setting-btn::before,
        .clear-remember-setting-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .remember-setting-btn:hover::before,
        .clear-remember-setting-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .remember-setting-btn {
            background: linear-gradient(135deg, #2a2e37 0%, #1a1e27 100%);
            border-color: #555;
            color: #ccc;
        }

        .remember-setting-btn.is-enabled {
            color: white;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
        }

        .remember-setting-btn:hover {
            box-shadow: 0 5px 15px rgba(0, 191, 174, 0.3);
        }

        .remember-setting-btn.is-enabled:hover {
            box-shadow: 0 5px 20px rgba(0, 255, 204, 0.5);
        }

        .clear-remember-setting-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            border-color: #ff4444;
            color: white;
        }

        .clear-remember-setting-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
            box-shadow: 0 5px 20px rgba(255, 68, 68, 0.5);
        }

        .clear-remember-setting-btn:active,
        .remember-setting-btn:active {
            transform: translateY(0);
        }

        #option-description-box {
            margin-top: auto;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 15px;
            background-color: rgba(10, 20, 30, 0.4);
            border-top: 1px solid rgba(224, 72, 230, 0.606);
            padding: 15px;
            box-shadow: inset 0 1px 10px rgba(0, 0, 0, 0.2);
            height: 90px;
            overflow-y: auto;
            display: flex;
            transition: background-color 0.3s ease;
        }

        #option-description-text {
            font-size: 0.9rem;
            line-height: 1.5;
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }

        .options-main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /*------------------- end options modal -------------------------*/

        /* ============================ End Main Menu ================================= */

        /*------------------- game mode modal -------------------------*/
        .game-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .game-mode-overlay:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }

        .game-mode-content {
            background: #1e1e24;
            border-radius: 12px;
            width: 90%;
            max-width: 680px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .game-mode-overlay:not(.hidden) .game-mode-content {
            transform: scale(1);
        }

        .game-mode-header {
            padding: 18px 25px;
            border-bottom: 1px solid #333640;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-mode-header h2 {
            margin: 0;
            font-size: 1.4rem;
            color: #e0e2e8;
        }

        .game-mode-header .close-button {
            background: none;
            border: none;
            color: #8a8d98;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .game-mode-header .close-button:hover {
            color: #fff;
            transform: scale(1.1);
        }

        .game-mode-options {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .game-mode-card {
            background: #2a2c34;
            border: 1px solid #3a3c44;
            border-radius: 8px;
            padding: 40px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .game-mode-card:hover {
            transform: translateY(-5px);
            border-color: #00bfff;
            box-shadow: 0 5px 20px rgba(0, 191, 255, 0.15);
        }

        .game-mode-card.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .game-mode-card.disabled:hover {
            transform: none;
            border-color: #3a3c44;
            box-shadow: none;
        }

        .game-mode-card .card-content h3 {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
            color: #ffffff;
        }

        .game-mode-card .card-content p {
            margin: 0;
            font-size: 0.9rem;
            color: #a0a4b0;
            line-height: 1.5;
        }

        .experimental-tag {
            position: absolute;
            top: 10px;
            right: 180px;
            border-radius: 4px;
            background-color: #ffc107;
            color: #111;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 5px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /*------------------- end game mode modal -------------------------*/

        /*------------------- background video -------------------------*/
        #background-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #character-background {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(70%);
        }

        #character-background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(70%);
        }

        /*------------------- end background video -------------------------*/

        /*------------------- wallpaper control -------------------------*/
        #wallpaper-control {
            position: absolute;
            transition: bottom 0.3s ease;
            bottom: 120px;
            left: 20px;
            width: 350px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 7px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            margin-bottom: 20px;
        }

        #wallpaper-control button {
            background: none;
            border: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
            font-family: 'Lexend', sans-serif;
        }

        #wallpaper-control button:hover {
            color: cyan;
        }

        #wallpaper-name {
            font-size: 0.9rem;
            color: cyan;
            text-align: center;
            flex: 1;
        }

        .fade-out {
            animation: fadeOut 0.5s forwards;
            opacity: 0;
            display: flex !important;
        }

        .fade-in {
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        #pause-wallpaper {
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #wallpaper-settings {
            position: absolute;
            right: -260px;
            top: 0;
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #wallpaper-control .trigger-zone {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 30px;
        }

        .trigger-zone:hover~#wallpaper-settings,
        #wallpaper-settings.show {
            right: 0;
            transform: translateX(320px);
            opacity: 1;
        }

        #wallpaper-settings label {
            font-size: 13px;
            color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        #wallpaper-darkness {
            width: 150px;
            margin-left: 10px;
        }

        #wallpaper-settings.disabled {
            display: none !important;
        }

        /*------------------- end wallpaper control -------------------------*/


        /* ================================ Musik Player =============================== */
        #music-control {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 370px;
            height: 110px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            color: white;
            font-family: 'Lexend', sans-serif;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 30;
        }

        #music-control.expanded {
            width: 920px;
            height: 525px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        #music-expanded-content {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;

            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;

            margin: 10px;
            height: 100%;
            display: flex;
            flex-direction: row;
            gap: 5px;
        }

        #music-control.expanded #music-expanded-content {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* =============== Musik Player Expanded Content ============ */

        /* ---------- online music ---------*/
        #online-music-sidebar {
            position: absolute;
            top: 61%;
            left: 0;
            transform: translateY(-50%);
            width: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 900;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            cursor: pointer;
            padding: 5px 0;
        }

        #online-music-sidebar:hover {
            width: 150px;
        }

        /* Style header teks "Online Music" */
        #online-music-header {
            font-size: 14px;
            padding: 5px;
            text-align: center;
            opacity: 0;
            /* akan muncul hanya saat expand */
            transition: opacity 0.3s ease;
        }

        /* ============================ Music Player ================================= */

        /*------------------- music control base -------------------------*/
        #music-control {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 370px;
            height: 110px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            color: white;
            font-family: 'Lexend', sans-serif;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 30;
        }

        #music-control.expanded {
            width: 920px;
            height: 525px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        /*------------------- end music control base -------------------------*/

        /*------------------- online music -------------------------*/
        #online-music-sidebar {
            position: absolute;
            top: 61%;
            left: 0;
            transform: translateY(-50%);
            width: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 900;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            cursor: pointer;
            padding: 5px 0;
        }

        #online-music-sidebar:hover {
            width: 150px;
        }

        #online-music-header {
            font-size: 14px;
            padding: 5px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #online-music-sidebar:hover #online-music-header {
            opacity: 1;
        }

        .online-icon {
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
        }

        #online-music-sidebar:hover .online-icon {
            opacity: 1;
        }

        .online-icon img {
            width: 32px;
            height: 32px;
            transition: transform 0.2s;
        }

        .online-icon:hover img {
            transform: scale(1.1);
        }

        #external-browser-container {
            opacity: 1;
            pointer-events: auto;
            background: transparent;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        #webview-window {
            pointer-events: auto;
            position: absolute;
            top: 10px;
            right: 10px;
            left: auto;
            width: 1250px;
            height: 73%;
            background: #121212;
            border: 2px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            z-index: 10000;
        }

        #external-browser-container.hidden {
            display: none !important;
        }

        #external-browser-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
        }

        .title-bar {
            height: 30px;
            background: #333;
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            user-select: none;
            cursor: move;
            z-index: 10001;
        }

        .close-btn {
            margin-left: auto;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #f44336;
        }

        .webview-preset-controls {
            margin-left: 20px;
            display: flex;
            gap: 5px;
        }

        .webview-preset-controls button {
            background: #555;
            border: 1px solid #777;
            color: #fff;
            padding: 2px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .webview-preset-controls button:hover {
            background: #666;
        }

        .webview-preset-controls button.active {
            background: #2196F3;
            border-color: #55aaff;
        }

        webview#external-webview.vertical-mode::-webkit-scrollbar {
            display: none;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10002;
        }

        .loader.hidden {
            display: none !important;
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /*------------------- end online music -------------------------*/

        /*------------------- playlist toggle -------------------------*/
        #playlist-toggle-btn {
            position: absolute;
            top: 5px;
            left: 0px;
            z-index: 10;
            background: none;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Lexend', sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
            color: #00e5ff;
            text-shadow:
                0 0 5px rgba(0, 229, 255, 0.8),
                0 0 10px rgba(0, 229, 255, 0.6),
                0 0 15px rgba(0, 229, 255, 0.4),
                0 0 20px rgba(7, 133, 150, 0.5);
            transition: all 0.3s ease;
        }

        #playlist-toggle-btn:hover {
            color: #ffffff;
            text-shadow:
                0 0 8px rgba(255, 255, 255, 0.9),
                0 0 15px rgba(0, 229, 255, 0.8);
        }

        #playlist-toggle-btn.online-mode {
            color: #f3557a;
            text-shadow:
                0 0 5px rgba(243, 85, 122, 0.9),
                0 0 10px rgba(243, 85, 122, 0.7),
                0 0 15px rgba(243, 85, 122, 0.5);
        }

        #playlist-toggle-btn.online-mode:hover {
            color: #ffffff;
            text-shadow:
                0 0 8px rgba(255, 255, 255, 0.9),
                0 0 15px rgba(243, 85, 122, 0.8);
        }

        /*------------------- end playlist toggle -------------------------*/

        /*------------------- music expanded content -------------------------*/
        #music-expanded-content {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            margin: 10px;
            height: 100%;
            display: flex;
            flex-direction: row;
            gap: 5px;
        }

        #music-control.expanded #music-expanded-content {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /*------------------- end music expanded content -------------------------*/

        /*------------------- disk container -------------------------*/
        #disk-container {
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            padding: 25px;
        }

        #music-disk {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            animation: rotateDisk 13s linear infinite;
            margin-bottom: 10px;
            animation-play-state: running;
            object-fit: cover;
        }

        @keyframes rotateDisk {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #now-playing-text {
            font-size: 0.9rem;
            margin-bottom: 10px;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /*------------------- end disk container -------------------------*/

        /*------------------- volume and buttons -------------------------*/
        #volume-and-buttons {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 7px;
            margin-bottom: 15px;
        }

        #volume-wrapper {
            display: flex;
            align-items: center;
            margin-right: 3px;
            gap: 5px;
        }

        #volume-slider {
            width: 0;
            opacity: 0;
            padding: 5px;
            transition: width 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
        }

        #volume-wrapper:hover #volume-slider {
            width: 65px;
            opacity: 1;
        }

        #music-buttons-expanded button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 5px;
            transition: transform 0.2s, color 0.2s;
        }

        #music-buttons-expanded button:hover {
            color: cyan;
            transform: scale(1.1);
        }

        #music-buttons-expanded .shuffle-text {
            font-size: 1.2rem;
            font-family: 'Lexend', sans-serif;
            display: inline;
            opacity: 0;
        }

        /*------------------- end volume and buttons -------------------------*/

        /*------------------- progress bar expanded -------------------------*/
        #progress-expanded {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 220px;
        }

        #progress-container-expanded {
            position: relative;
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        #progress-bar-expanded {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FF4C4C, #ff7b7b);
            transition: width 0.1s linear;
        }

        #time-expanded {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /*------------------- end progress bar expanded -------------------------*/

        /*------------------- playlist container -------------------------*/
        #playlist-container {
            width: 60%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            text-align: left;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        }

        #playlist-container h3 {
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            color: cyan;
        }

        #playlist {
            margin: 0;
            padding: 10px;
            list-style: none;
            max-height: 430px;
            overflow-y: auto;
            font-size: 1rem;
            color: white;
        }

        #playlist::-webkit-scrollbar {
            width: 8px;
        }

        #playlist::-webkit-scrollbar-track {
            background: black;
            border-radius: 5px;
        }

        #playlist::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #FF4C4C, #B33030);
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(255, 76, 76, 0.7);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        #playlist::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 76, 76, 0.7);
            box-shadow: 0 0 10px rgba(255, 76, 76, 0.9);
        }

        #playlist li {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        #playlist li.active {
            background: linear-gradient(to right, #00bfff, #1e90ff);
            font-weight: bold;
            color: white;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }

        #playlist li:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
        }

        .playlist-divider {
            width: 90%;
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            margin: 5px auto;
        }

        #expand-collapse {
            position: absolute;
            bottom: 5px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 99;
        }

        #expand-collapse:hover {
            transform: scale(1.2);
        }

        /*------------------- end playlist container -------------------------*/

        /*------------------- music info collapsed -------------------------*/
        #music-info {
            margin-bottom: 10px;
            padding-top: 7px;
        }

        #music-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #progress-container {
            position: relative;
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FF4C4C, #ff7b7b);
            transition: width 0.1s linear;
        }

        #music-buttons button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 5px;
            transition: transform 0.2s;
        }

        #music-buttons button:hover {
            transform: scale(1.1);
        }

        .shuffle-text {
            font-size: 1.2rem;
            font-family: 'Lexend', sans-serif;
            display: inline;
            opacity: 0;
        }

        #music-time {
            margin-top: 4px;
        }

        /*------------------- end music info collapsed -------------------------*/

        /*------------------- music visualizer -------------------------*/
        #music-visualizer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 50px;
            margin-top: 10px;
            width: 100%;
            /* Ensure it takes full width of parent */
        }

        .bar {
            width: 2px;
            height: 1px;
            background-color: #dadada;
            transform-origin: center;
            transition: transform 0.02s linear;
        }

        /*------------------- end music visualizer -------------------------*/

        /*------------------- expanded state visibility -------------------------*/
        #music-control.expanded #disk-container {
            position: relative;
        }

        #music-control.expanded #music-info,
        #music-control.expanded #music-buttons,
        #music-control.expanded #music-time,
        #music-control.expanded #progress-container {
            display: none !important;
        }

        /*------------------- end expanded state visibility -------------------------*/

        /* ============================ End Music Player ================================= */

        /* ============================ Game Editor Screen ================================= */

        /*------------------- screen base -------------------------*/
        #game-editor-screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background-color: #000000;
            color: white;
            padding: 10px;
            overflow-y: auto;
            position: relative;
        }

        #back-to-main-menu-editor {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: rgba(30, 30, 30, 0.8);
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
            z-index: 100;
            font-family: 'Lexend', sans-serif;
        }

        #back-to-main-menu-editor:hover {
            background-color: #555;
            color: white;
        }

        .editor-main-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 20px;
            width: 100%;
        }

        /*------------------- end screen base -------------------------*/

        /*------------------- layout container -------------------------*/
        .editor-layout-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 70px);
            gap: 20px;
        }

        .editor-preview-column,
        .editor-input-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .editor-preview-column {
            flex-basis: 45%;
            overflow-y: auto;
            padding-right: 10px;
        }

        .editor-input-column {
            flex-basis: 55%;
            overflow-y: auto;
            padding-right: 10px;
        }

        .preview-item-container,
        .input-section-container {
            background-color: transparent;
            padding: 0;
            border-radius: 8px;
        }

        .preview-label {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 8px;
            margin-left: 4px;
            display: flex;
            justify-content: left;
            text-transform: capitalize;
        }

        .preview-box {
            width: 100%;
            height: 240px;
            margin: 5px;
            background-color: #0A0A0A;
            border: 2px solid #444;
            border-radius: 6px;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            transform: scale(0.9);
            padding: 0;
        }

        .live-preview-content .screen {
            display: flex !important;
            width: 100%;
            height: 100%;
        }

        .live-preview-content h1,
        .live-preview-content h2,
        .live-preview-content h3,
        .live-preview-content h4 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .live-preview-content p {
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .live-preview-content h1 span {
            font-size: 1.5rem;
        }

        /*------------------- end layout container -------------------------*/

        /*------------------- input section -------------------------*/
        .input-section-container {
            background-color: #101010;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }

        .input-section-container h4 {
            color: #FFB86C;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .input-section-container h5 {
            color: #bbb;
            font-size: 0.9rem;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .input-section-container label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #f0f0f0;
        }

        .input-section-container input[type="text"],
        .input-section-container textarea {
            width: 100%;
            padding: 10px;
            background-color: #1E1E1E;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            font-family: 'Lexend', sans-serif;
            font-size: 1rem;
            margin-bottom: 10px;
            box-sizing: border-box;
            resize: vertical;
        }

        .input-section-container textarea {
            min-height: 80px;
        }

        #edit-profile-section-inputs {
            text-align: left;
        }

        #edit-profile-section-inputs label[for="edit-profile-description"] {
            text-align: center;
        }

        .editor-buttons {
            padding-top: 20px;
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        #save-editor-changes {
            padding: 12px 25px;
            background-color: #50fa7b;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            font-family: 'Lexend', sans-serif;
        }

        #save-editor-changes:hover {
            background-color: #42e068;
        }

        /*------------------- end input section -------------------------*/

        /*------------------- scrollbars -------------------------*/
        .editor-preview-column::-webkit-scrollbar,
        .editor-input-column::-webkit-scrollbar,
        #game-editor-screen::-webkit-scrollbar {
            width: 8px;
        }

        .editor-preview-column::-webkit-scrollbar-track,
        .editor-input-column::-webkit-scrollbar-track,
        #game-editor-screen::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .editor-preview-column::-webkit-scrollbar-thumb,
        .editor-input-column::-webkit-scrollbar-thumb,
        #game-editor-screen::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }

        .editor-preview-column::-webkit-scrollbar-thumb:hover,
        .editor-input-column::-webkit-scrollbar-thumb:hover,
        #game-editor-screen::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /*------------------- end scrollbars -------------------------*/

        /*------------------- responsive layout -------------------------*/
        @media (max-width: 900px) {
            .editor-layout-container {
                flex-direction: column;
                height: auto;
            }

            .editor-preview-column,
            .editor-input-column {
                flex-basis: 100%;
                max-height: 50vh;
                overflow-y: auto;
            }
        }

        /*------------------- end responsive layout -------------------------*/

        /*------------------- character editor -------------------------*/
        #edit-character-menu-inputs h4 {
            color: #FFB86C;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .character-editor-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
            max-height: 800px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .character-editor-list::-webkit-scrollbar {
            width: 6px;
        }

        .character-editor-list::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 3px;
        }

        .character-editor-list::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .character-editor-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .character-edit-item {
            background-color: #1A1C1E;
            border: 1px solid #303234;
            border-radius: 6px;
            padding: 15px;
            transition: box-shadow 0.2s ease-in-out;
        }

        .character-edit-item:hover {
            box-shadow: 0 0 8px rgba(255, 184, 108, 0.1);
        }

        .character-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2c2e;
        }

        .character-edit-name-display {
            margin: 0;
            color: #e0e0e0;
            font-size: 1rem;
            font-weight: 500;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 10px;
            text-align: center;
        }

        .button-remove-character {
            background-color: #792820;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            line-height: 1;
            transition: background-color 0.2s ease;
        }

        .button-remove-character:hover {
            background-color: #a5382d;
        }

        #buttonAddNewCharacter.editor-button-positive {
            background-color: #2ecc71;
            color: white;
            border: 1px solid #27ae60;
            transition: background-color 0.2s ease;
            font-weight: 500;
            text-transform: none;
        }

        #buttonAddNewCharacter.editor-button-positive:hover {
            background-color: #27ae60;
            box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4);
        }

        .character-edit-body .form-group {
            margin-bottom: 12px;
            text-align: left;
        }

        .character-edit-body .form-group:last-child {
            margin-bottom: 0;
        }

        .character-edit-body .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: #a0a0a0;
            font-weight: 400;
        }

        .character-edit-body .form-group input[type="text"],
        .character-edit-body .form-group textarea {
            width: 100%;
            padding: 9px 12px;
            background-color: #222426;
            color: #e0e0e0;
            border: 1px solid #383a3c;
            border-radius: 4px;
            font-family: 'Lexend', sans-serif;
            font-size: 0.9rem;
            box-sizing: border-box;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .character-edit-body .form-group input[type="text"]:focus,
        .character-edit-body .form-group textarea:focus {
            border-color: #FFB86C;
            background-color: #282a2c;
            outline: none;
        }

        .character-edit-body .form-group textarea {
            resize: vertical;
            min-height: 70px;
            line-height: 1.5;
        }

        .character-edit-body .form-group input[type="file"].char-media-input {
            display: none;
        }

        .character-edit-body .form-group .media-input-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-top: 8px;
        }

        .character-edit-body .form-group .media-input-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
        }

        .character-edit-body .form-group .custom-file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3a3c3e;
            color: #e0e0e0;
            border: 1px solid #505254;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            text-align: center;
            transition: background-color 0.2s ease;
            margin-bottom: 8px;
        }

        .character-edit-body .form-group .custom-file-input-label:hover {
            background-color: #4a4c4e;
        }

        .character-edit-body .form-group .current-media-file-display {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-top: 0;
            font-style: normal;
            word-break: break-all;
            text-align: center;
        }

        .character-edit-body .form-group .media-thumbnail-preview {
            width: 80px;
            height: 160px;
            border-radius: 6px;
            margin-top: 0;
            display: block;
            object-fit: cover;
            border: 1px solid #383a3c;
            background-color: #2a2c2e;
            flex-shrink: 0;
        }

        .character-list-empty-placeholder {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
            border: 1px dashed #444;
            border-radius: 6px;
        }

        /*------------------- end character editor -------------------------*/

        /* ============================ End Game Editor Screen ================================= */

        /* ============================ Character Menu ================================= */

        /*------------------- animations -------------------------*/
        @keyframes swipeUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #character-menu .main-container .image-preview {
            opacity: 0;
            animation: swipeUp 0.5s ease forwards;
        }

        #character-menu .main-container .image-preview:nth-child(1) {
            animation-delay: 0.2s;
        }

        #character-menu .main-container .image-preview:nth-child(2) {
            animation-delay: 0.4s;
        }

        #character-menu .main-container .image-preview:nth-child(3) {
            animation-delay: 0.6s;
        }

        #character-menu .main-container .image-preview:nth-child(4) {
            animation-delay: 0.8s;
        }

        #character-menu .main-container .image-preview:nth-child(5) {
            animation-delay: 1s;
        }

        #character-menu .main-container .image-preview:nth-child(6) {
            animation-delay: 1.2s;
        }

        #character-menu .main-container .image-preview:nth-child(7) {
            animation-delay: 1.4s;
        }

        #character-menu.animating .image-preview {
            pointer-events: none;
        }

        /*------------------- end animations -------------------------*/

        /*------------------- layout & styling -------------------------*/
        /* Di dalam #character-menu-preview-instance */
        #character-menu-preview-instance .image-preview {
            flex: 1;
            /* Agar kartu-kartu berbagi ruang */
            height: 100%;
            /* Mengambil tinggi penuh dari #character-menu-preview-instance */
            position: relative;
            overflow: hidden;
            /* border-right: 1px solid #222; (dari JS atau CSS) */
        }

        #character-menu-preview-instance .image-preview .video,
        #character-menu-preview-instance .image-preview .character-image {
            width: 100%;
            height: 100%;
            /* Pilih salah satu 'object-fit' sesuai kebutuhan: */
            object-fit: cover;
            /* Pilihan saat ini: mengisi dan memotong jika perlu */
            /* object-fit: contain; */
            /* Alternatif: menampilkan seluruh gambar/video, mungkin dengan spasi kosong */
            display: block;
            /* Untuk menghilangkan spasi ekstra di bawah elemen inline seperti img */
        }

        #character-menu {
            opacity: 0;
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
            background-color: black;
        }

        /* Back Main Menu */
        #back-to-main-menu {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            z-index: 99;
            font-family: 'Lexend', sans-serif;
        }

        #back-to-main-menu:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        #character-menu .main-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Tiap Kartu Karakter */
        #character-menu .image-preview {
            flex: 1;
            position: relative;
            overflow: hidden;
            transition: flex 0.4s ease-in-out;
            cursor: pointer;

            /* Garis tipis */
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Hilangkan garis di kartu paling akhir agar tidak dobel */
        #character-menu .image-preview:last-child {
            border-right: none;
        }

        /* hover melebar sedikit */
        #character-menu .image-preview:hover {
            flex: 1.5;
        }

        #character-menu .image-preview.dim {
            flex: 0.8;
            opacity: 0.5;
        }

        /* Video di dalam kartu */
        #character-menu .video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        #character-menu .image-preview:hover .video {
            transform: scale(1.05);
        }

        /* Role Badges kalau mau */
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            margin: 0 3px;
            font-size: 0.75rem;
            border-radius: 12px;
            text-transform: uppercase;
            color: #fff;
            background-color: #444;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }

        .overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            display: flex;
            flex-direction: column;
            padding: 20px;

            transform: translateY(100%);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        #character-menu .image-preview:hover .overlay {
            transform: translateY(0);
            opacity: 1;
        }

        .overlay .desc {
            margin-top: auto;
            color: white;
        }

        .overlay .desc h1 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .overlay .desc p {
            font-size: 0.85rem;
            line-height: 1.4;
            text-align: justify;
            color: #ddd;
        }

        /* ----- Bagian konten tambahan (extended) untuk tombol More ----- */
        .extended-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease, opacity 0.5s ease;
        }

        .extended-content.show {
            max-height: 500px;
            /* Ubah sesuai kebutuhan */
            opacity: 1;
        }

        /* Tombol More / Less */
        .more-button {
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .more-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

        .character-image {
            transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out;
        }

        .image-preview:hover .character-image {
            transform: scale(1.03);
        }

        /*------------------- end layout & styling -------------------------*/

        /* ============================ End Character Menu ================================= */

        /* ============================ Options & Quit ================================= */

        /*------------------- modal base -------------------------*/
        .modal {
            position: fixed;
            top: 0;
            left: -700px;
            width: 700px;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            z-index: 999999;
            transition: left 0.2s ease-in-out;
            box-shadow: 5px 0 20px rgba(0, 255, 255, 0.3);
            border-right: 2px solid cyan;
        }

        .modal.open {
            left: 0;
        }

        .hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            /* Transisi agar lebih halus */
        }

        /*------------------- end modal base -------------------------*/

        /*------------------- navbar styling -------------------------*/
        .modal-content {
            background-color: transparent;
            padding: 0;
            color: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
        }

        /* Vertikal Navbar di sisi kiri */
        .options-navbar {
            width: 200px;
            padding: 15px 10px;
            border-bottom: none;
            border-right: 1px solid rgba(0, 255, 255, 0.2);
            background-color: rgba(15, 15, 15, 0.6);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .options-navbar-item {
            padding: 12px 15px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 1.1rem;
        }

        .options-navbar-item:last-child {
            border-bottom: none;
        }

        .options-navbar-item:hover,
        .options-navbar-item.active {
            background-color: rgba(0, 255, 255, 0.15);
            color: cyan;
            border-left: 4px solid cyan;
            padding-left: 11px;
        }

        /*------------------- end navbar styling -------------------------*/

        /*------------------- content panes -------------------------*/
        /* Area utama konten (kanan navbar) */
        .options-main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Mengisi tinggi parent (.modal-content) */
        }

        /* Konten untuk tiap pilihan navbar */
        .options-content-pane {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        /* Custom Scrollbar Content Pane */
        .options-content-pane::-webkit-scrollbar {
            width: 8px;
        }

        .options-content-pane::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .options-content-pane::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #FF416C 0%, #FF4B2B 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 65, 108, 0.2);
        }

        .options-content-pane::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ff5e81 0%, #ff6a4d 100%);
            box-shadow: 0 0 8px rgba(255, 65, 108, 0.5);
        }

        .options-content-pane.active {
            display: block;
        }

        /* Styling untuk elemen-elemen di dalam pane (biarkan seperti sebelumnya atau sesuaikan) */
        .option-group-title {
            font-size: 1.4rem;
            color: cyan;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .option-row,
        .buttons-row {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }

        /* Disabled option styling */
        .option-row.disabled-option {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .option-row.disabled-option::after {
            position: absolute;
            right: 10px;
            font-size: 0.8em;
        }

        .option-row.disabled-option select,
        .option-row.disabled-option input {
            cursor: not-allowed;
            background-color: #222 !important;
        }

        .option-row label,
        .option-row-checkbox label {
            flex-basis: 200px;
            text-align: left;
        }

        .option-row-checkbox {
            margin: 15px 0;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            align-items: center;
        }

        .option-row select,
        .option-row input[type="text"],
        .option-row input[type="number"] {
            /* Tambahkan jika ada input number */
            padding: 8px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            flex-grow: 1;
            /* Biar input/select mengisi ruang */
        }

        /* --- CSS Sub-Options Box --- */
        .sub-options-box {
            margin-left: 38px;
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-left: 2px solid cyan;
            border-radius: 0 5px 5px 0;
            display: none;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .sub-options-box.visible {
            display: flex;
        }

        .sub-options-box .option-row-checkbox {
            margin-bottom: 0;
            /* Reset margin di dalam box */
        }

        .sub-options-box label {
            font-size: 0.85rem;
            color: #aaa;
        }

        /* --- GIF Overlay Styling untuk Game Mode --- */
        #game-gif-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .game-gif-input-row {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-gif-settings-btn {
            padding: 6px 8px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-gif-settings-btn:hover {
            background: rgba(0, 255, 255, 0.15);
            border-color: cyan;
            color: cyan;
        }

        .game-gif-settings-btn.has-condition {
            color: #4caf50;
            border-color: #4caf50;
        }

        .game-gif-input-row input[type="text"] {
            flex: 1;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: #eee;
            font-size: 11px;
        }

        .game-gif-browse-btn,
        .game-gif-clear-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #ddd;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-gif-browse-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: cyan;
        }

        .game-gif-clear-btn {
            padding: 6px 8px;
            color: #ff6b6b;
        }

        .game-gif-clear-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }

        /* Settings button */
        .game-gif-settings-btn {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .game-gif-settings-btn:hover {
            background: rgba(156, 136, 255, 0.2);
            border-color: #9c88ff;
        }

        .game-gif-settings-btn.has-condition {
            background: rgba(156, 136, 255, 0.15);
            border-color: rgba(156, 136, 255, 0.4);
            box-shadow: 0 0 8px rgba(156, 136, 255, 0.3);
        }

        .game-gif-settings-btn.has-condition:hover {
            background: rgba(156, 136, 255, 0.25);
            border-color: #9c88ff;
            box-shadow: 0 0 12px rgba(156, 136, 255, 0.5);
        }

        /* Remove button - samakan ukuran dengan settings button */
        .game-gif-remove-btn {
            padding: 6px 10px !important;
            background: transparent;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e74c3c;
            font-size: 13px !important;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-gif-remove-btn:hover {
            background: rgba(231, 76, 60, 0.15);
            border-color: #e74c3c;
        }

        .game-add-gif-btn {
            width: 100%;
            padding: 8px;
            background: rgba(0, 255, 255, 0.1);
            border: 2px dashed rgba(0, 255, 255, 0.3);
            border-radius: 6px;
            color: cyan;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-add-gif-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: cyan;
        }

        .gif-overlay-controls {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* GIF Settings Modal untuk Game Mode */
        #game-gif-settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #game-gif-settings-modal.visible {
            display: flex;
        }

        #game-gif-settings-modal #game-no-music-warning {
            animation: gameFadeIn 0.3s ease;
        }

        @keyframes gameFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .game-gif-settings-box select option:disabled {
            color: #666;
            font-style: italic;
        }

        /* Perbaikan dropdown preset GIF - tingkatkan kontras */
        #game-gif-preset-select {
            background: rgba(15, 20, 30, 0.95) !important;
            color: #fff !important;
        }

        #game-gif-preset-select option {
            background: #1a1f2e;
            color: #ffffff;
            padding: 8px;
        }

        #game-gif-preset-select option:hover,
        #game-gif-preset-select option:checked {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
        }

        .game-gif-settings-box {
            background-color: rgba(20, 22, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            width: 580px;
            max-width: 90%;
            border: 1px solid rgba(243, 85, 122, 0.5);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }

        .game-gif-settings-box h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: #f3557a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .game-gif-settings-box .setting-row {
            margin-bottom: 14px;
        }

        .game-gif-settings-box .setting-row label {
            display: block;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 6px;
        }

        .game-gif-settings-box select,
        .game-gif-settings-box input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 6px;
            color: #eee;
            font-size: 13px;
        }

        .game-gif-settings-box select:focus,
        .game-gif-settings-box input[type="text"]:focus {
            outline: none;
            border-color: cyan;
        }

        .game-gif-settings-box .music-info-box {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            margin-bottom: 14px;
        }

        .game-gif-settings-box .music-info-box .label {
            color: cyan;
            margin-bottom: 6px;
        }

        .game-gif-settings-box .music-info-box .title {
            color: #eee;
            margin-bottom: 2px;
        }

        .game-gif-settings-box .music-info-box .artist {
            color: #aaa;
            font-size: 11px;
        }

        .game-gif-settings-box .no-music-warning {
            background: rgba(255, 200, 100, 0.15);
            border: 1px solid rgba(255, 200, 100, 0.3);
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            color: #ffc864;
            margin-bottom: 14px;
        }

        .game-gif-settings-box .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-gif-settings-box button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-gif-settings-box .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ddd;
        }

        .game-gif-settings-box .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .game-gif-settings-box .btn-save {
            background: linear-gradient(135deg, #f3557a, #ff8fb1);
            color: white;
        }


        .game-gif-settings-box .btn-save:hover {
            opacity: 0.9;
        }

        /* Toggle Switch for Game GIF Settings */
        .game-toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .game-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .game-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 22px;
        }

        .game-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .game-toggle-switch input:checked+.game-slider {
            background-color: #00bcd4;
        }

        .game-toggle-switch input:checked+.game-slider:before {
            transform: translateX(18px);
        }

        /*------------------- end content panes -------------------------*/

        /*------------------- buttons & profile link -------------------------*/
        /* Tombol Apply/Close di bagian bawah */
        .buttons-row {
            /* Menempel di bagian bawah options-main-area */
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: flex-end;
            margin-top: auto;
            /* Ini akan mendorong baris tombol ke bawah */
            flex-shrink: 0;
        }

        .buttons-row button {
            padding: 10px 18px;
            background: #444;
            border: 1px solid #f3557a;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .buttons-row button:hover {
            background-color: #555;
            border-color: #00ffff;
        }

        .buttons-row-left {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: auto;
        }

        .buttons-row-left button {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .remember-setting-btn {
            opacity: 0.75;
        }

        .remember-setting-btn.is-enabled {
            opacity: 1;
        }

        .clear-remember-setting-btn {
            opacity: 0.65;
        }

        .clear-remember-setting-btn:hover {
            opacity: 0.95;
        }

        /* Styling untuk GUI Dropdown (placeholder) */
        .gui-dropdown-placeholder {
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }

        .options-main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .options-content-pane {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
            display: none;
        }

        .options-content-pane.active {
            display: block;
            flex-grow: 1;
        }

        .buttons-row {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: flex-end;
            margin-top: auto;
        }

        /* Styling untuk Link Profil di Navbar Opsi */
        .navbar-profile-link {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid rgba(0, 255, 255, 0.1);
            /* Garis pemisah tipis */
            text-align: center;
        }

        .navbar-profile-link a {
            color: #bbb;
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: color 0.2s ease;
        }

        .navbar-profile-link a:hover {
            color: #fff;
        }

        /*------------------- end buttons & profile link -------------------------*/

        /* ============================ End Options & Quit ================================= */

        /* ===================================== End Main Menu ===================================== */

        /* ================================ Versi Info =============================== */
        #version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            z-index: 1000;
            pointer-events: none;
        }

        /* ================================ End Versi Info =============================== */

        /* ================================ About Panel =============================== */
        #about-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 75%;
            max-width: 90vw;
            max-height: 80vh;
            background: linear-gradient(145deg, rgba(20, 22, 30, 0.98), rgba(10, 12, 18, 0.98));
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 40px rgba(0, 255, 255, 0.1);
            z-index: 10000001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #about-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .about-panel-header {
            padding: 20px 25px;
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .about-panel-header h2 {
            margin: 0;
            color: #fff;
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .about-panel-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .about-panel-close:hover {
            background: rgba(255, 80, 80, 0.6);
            border-color: rgba(255, 80, 80, 0.8);
            transform: rotate(90deg);
        }

        .about-panel-content {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .about-panel-content::-webkit-scrollbar {
            width: 8px;
        }

        .about-panel-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .about-panel-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 4px;
        }

        .about-panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }

        .developers-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .developer-card {
            flex: 1;
            min-width: 280px;
            max-width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px 25px;
            text-align: left;
            transition: all 0.3s ease;
        }

        .developer-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(0, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .developer-card:hover .developer-badge {
            opacity: 1;
            transform: translateX(0);
        }

        .developer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .developer-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #333, #222);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .developer-name {
            color: #fff;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }

        .developer-badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.3px;
            color: #fff;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(25px);
            transition: opacity 0.5s cubic-bezier(0.23, 1, 0.32, 1), transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .developer-badge.lead-core {
            background: rgb(9 132 227 / 60%);
            border: 1px solid rgb(9 132 227 / 80%);
            box-shadow: 0 0 15px rgb(9 132 227 / 30%);
        }

        .developer-badge.project-dev {
            background: rgb(253 121 168 / 60%);
            border: 1px solid rgb(253 121 168 / 80%);
            box-shadow: 0 0 15px rgb(253 121 168 / 30%);
        }

        .developer-description {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            line-height: 1.5;
            min-height: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 12px;
            margin-top: 0;
        }

        .about-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .about-panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .navbar-profile-link-btn {
            color: #bbb;
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s ease;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            font-family: inherit;
        }

        .navbar-profile-link-btn:hover {
            color: #fff;
        }

        .navbar-profile-link-btn:hover {
            opacity: 1;
        }

        /* ================================ End About Panel =============================== */

        /* ================================ Profile CSS Editor =============================== */
        .css-editor-toggle-btn {
            width: 100%;
            padding: 12px 20px;
            background: rgba(30, 35, 45, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.95rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
        }

        .css-editor-toggle-btn:hover {
            background: rgba(40, 45, 60, 0.8);
            border-color: rgba(0, 255, 255, 0.4);
            color: #00ffff;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.15);
        }

        .css-editor-toggle-btn .triangle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.5);
        }

        .css-editor-toggle-btn:hover .triangle-icon {
            color: #00ffff;
        }

        .css-editor-toggle-btn.active .triangle-icon {
            transform: rotate(90deg);
        }

        .css-editor-panel {
            margin-top: 10px;
            padding: 20px;
            background: rgba(15, 18, 25, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .css-code-editor {
            width: 100%;
            padding: 15px;
            background: #0d1117;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e6edf3;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
            margin-top: 8px;
            margin-bottom: 12px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .css-code-editor:focus {
            outline: none;
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.1);
            background: #0f141c;
        }

        .css-code-editor::placeholder {
            color: rgba(255, 255, 255, 0.2);
            font-style: italic;
        }

        /* Common button styles */
        .editor-button-positive,
        .editor-button-negative,
        .editor-button-info {
            padding: 10px 24px;
            border-radius: 6px;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .editor-button-positive:hover {
            background: linear-gradient(135deg, #00d2ff 0%, #00a8e1 100%);
            box-shadow: 0 6px 15px rgba(0, 180, 219, 0.4);
        }

        .editor-button-info {
            background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%);
        }

        .editor-button-info:hover {
            background: linear-gradient(135deg, #9b51e0 0%, #5f15f2 100%);
            box-shadow: 0 6px 15px rgba(142, 45, 226, 0.4);
        }

        #profile-css-editor-panel .editor-button-positive,
        #profile-css-editor-panel .editor-button-info,
        #profile-css-editor-panel .editor-button-negative {
            background: transparent;
            box-shadow: none;
            border-width: 1px;
            border-style: solid;
        }

        #profile-css-editor-panel .editor-button-positive {
            border-color: #00b4db;
            color: #00b4db;
        }

        #profile-css-editor-panel .editor-button-positive:hover {
            border-color: #00d2ff;
            color: #00d2ff;
            background: rgba(0, 180, 219, 0.1);
        }

        #profile-css-editor-panel .editor-button-info {
            border-color: #8E2DE2;
            color: #8E2DE2;
        }

        #profile-css-editor-panel .editor-button-info:hover {
            border-color: #9b51e0;
            color: #9b51e0;
            background: rgba(142, 45, 226, 0.1);
        }

        #profile-css-editor-panel .editor-button-negative {
            border-color: #FF416C;
            color: #FF416C;
        }

        #profile-css-editor-panel .editor-button-negative:hover {
            border-color: #ff5e81;
            color: #ff5e81;
            background: rgba(255, 65, 108, 0.1);
        }

        .editor-button-negative {
            background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
        }

        .editor-button-negative:hover {
            background: linear-gradient(135deg, #ff5e81 0%, #ff6a4d 100%);
            box-shadow: 0 6px 15px rgba(255, 65, 108, 0.4);
        }

        /* ================================ Rotating Texts Editor =============================== */
        .rotating-texts-editor-section {
            margin-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .rotating-texts-editor-section > label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #aaa;
        }

        .rotating-texts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .rotating-texts-list::-webkit-scrollbar {
            width: 6px;
        }

        .rotating-texts-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .rotating-texts-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00b4db 0%, #0083B0 100%);
            border-radius: 3px;
        }

        .rotating-text-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rotating-text-item input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            padding: 8px 10px;
            color: #fff;
            font-size: 0.9rem;
        }

        .rotating-text-item input:focus {
            outline: none;
            border-color: #00b4db;
            box-shadow: 0 0 5px rgba(0, 180, 219, 0.3);
        }

        .rotating-text-item .remove-rotating-text-btn {
            background: transparent;
            border: 1px solid #FF416C;
            color: #FF416C;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .rotating-text-item .remove-rotating-text-btn:hover {
            background: rgba(255, 65, 108, 0.2);
            border-color: #ff5e81;
            color: #ff5e81;
        }

        .rotating-text-item .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 1.1rem;
            user-select: none;
        }

        .rotating-text-item .drag-handle:active {
            cursor: grabbing;
        }
        /* ================================ End Rotating Texts Editor =============================== */

        /* ================================ End Profile CSS Editor =============================== */

        /*------------------- GIF Overlay Settings UI -------------------------*/
        #game-gif-list-container {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            /* Optional: batas visual halus */
            border-radius: 4px;
        }

        /* Custom Scrollbar for GIF list */
        #game-gif-list-container::-webkit-scrollbar {
            width: 8px;
        }

        #game-gif-list-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        #game-gif-list-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #FF416C 0%, #FF4B2B 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 65, 108, 0.2);
        }

        #game-gif-list-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ff5e81 0%, #ff6a4d 100%);
            box-shadow: 0 0 8px rgba(255, 65, 108, 0.5);
        }

        #preview-warning-screen #warning-screen {
            transform: scale(0.65);
            transform-origin: top left;
            width: 153.85%;
            /* 100 / 0.65 */
            height: 153.85%;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <div class="screen" id="warning-screen">
        <svg class="warning-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
        </svg>
        <div class="warning-main-title">Build ini masih Experimental !</div>
        <div class="warning-sub-text">
            <p>Jangan berpikir build saat ini adalah hasil akhir aplikasi, ngga usah ekspektasi semuanya berjalan dengan
                nyaman.</p>
            <p>Kami paham betul apa saja yang masih kurang pada game visual novelnya, sehingga kami perlu untuk terus
                meriset dan meneliti bagaimana arsitektur dan struktur kode program yang terbaik untuk bisa menghasilkan
                program visual novel yang sangat flexible kustomisasinya oleh user tanpa melibatkan koding.</p>
        </div>
        <div class="click-to-continue" id="warning-continue-text">klik untuk lanjutkan</div>
    </div>
    <div class="screen" id="developer-screen">
        <h2>Dev name</h2>
        <h4>sub title</h4>
    </div>
    <div class="screen" id="concept-screen">
        <h2 style="margin-bottom: 20px;">Disclaimer!!</h2>
        <p>Proyek ini dikerjakan secara part time plus kalau lagi mood aja, harap maklumi jika updatenya lama.</p>
    </div>
    <div class="screen" id="title-screen">
        <h1 id="title-screen">
            <span>G</span><span>a</span><span>p</span><span>V</span><span>N</span>
        </h1>
        <h3>Loading...</h3>
        <div id="rotating-text"></div>
        <p>Press Enter</p>
        <video id="background-video" autoplay muted loop preload="none">
        </video>
    </div>
    <div class="screen" id="main-menu">
        <div id="background-section">
            <video id="character-background" autoplay muted loop>
                <source src="./aset/wallpaper" type="video/mp4">
            </video>
            <img id="character-background-image" src="" alt="Wallpaper" style="display: none;">
        </div>

        <div id="profile-section">
            <img src="./aset/ikon.jpg" alt="Profile Picture" id="profile-picture">
            <div id="profile-info">
                <h2 id="profile-name">--</h2>
                <p id="profile-level">Level: --</p>
                <div id="level-bar">
                    <div id="level-fill"></div>
                    <span id="level-max-text">Max</span>
                </div>
                <p id="profile-description">"Description..."</p>
            </div>
        </div>

        <div id="connection-status">
            <div id="ping-indicator" title="Current Latency">
                <div class="ping-dot"></div>
                <span class="ping-value"></span>
            </div>
        </div>

        <div id="menu-options">
            <ul>
                <li id="start-game">Start Game</li>
                <li id="game-editor">Game Editor</li>
                <li id="character-menu-button">Character</li>
                <li id="options">Options</li>
                <li id="quit">Quit</li>
            </ul>
        </div>

        <div id="wallpaper-control">
            <button id="pause-wallpaper"></button>
            <button id="next-wallpaper">Next Wallpaper</button>
            <p id="wallpaper-name">Current: Wallpaper 1</p>
            <div class="trigger-zone"></div>
            <div id="wallpaper-settings">
                <label>
                    Wallpaper Follow Music Title
                    <input type="checkbox" id="follow-music-title">
                </label>
                <label>
                    Darkness (Brightness)
                    <input type="range" id="wallpaper-darkness" min="0" max="100" value="30">
                </label>
                <label>
                    Blur
                    <input type="range" id="wallpaper-blur" min="0" max="20" value="0">
                </label>
                <label>
                    Grayscale
                    <input type="range" id="wallpaper-grayscale" min="0" max="100" value="0">
                </label>
                <label>
                    Zoom
                    <input type="range" id="wallpaper-zoom" min="1" max="2" step="0.1" value="1">
                </label>
                <label>
                    Auto Change (min)
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="auto-change-wallpaper">
                        <input type="number" id="auto-change-interval" min="1" value="5"
                            style="width: 40px; color: black; padding-left: 5px;">
                    </div>
                </label>
                <label>
                    Random Order
                    <input type="checkbox" id="random-wallpaper-order">
                </label>
            </div>
        </div>
        <div id="music-control" class="collapsed">
            <div id="music-info">
                <p id="music-title">Now Playing: None</p>
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>
            </div>

            <div id="music-time">
                <span id="current-time">0:00</span> / <span id="duration">0:00</span>
            </div>

            <div id="music-buttons">
                <button id="prev-music"></button>
                <button id="play-pause"></button>
                <button id="next-music"></button>
                <button id="shuffle-music"></button>
            </div>

            <button id="expand-collapse"></button>

            <div id="music-expanded-content">
                <div id="disk-container">
                    <button id="playlist-toggle-btn">Local Playlist</button>
                    <img id="music-disk" src="./aset/musik.png" alt="Music Disk" />
                    <p id="now-playing-text">Now Playing: <span id="now-playing-song">Judul Musik</span></p>

                    <div id="progress-expanded">
                        <div id="progress-container-expanded">
                            <div id="progress-bar-expanded"></div>
                        </div>
                        <div id="time-expanded">
                            <span id="current-time-expanded">0:00</span> / <span id="duration-expanded">0:00</span>
                        </div>
                    </div>

                    <div id="online-music-sidebar">
                        <div id="online-music-header">Online Music</div>
                        <div class="online-icon" data-url="https://music.youtube.com">
                            <img src="./aset/webview.png" alt="YouTube Music">
                        </div>
                    </div>

                    <div id="volume-and-buttons">
                        <div id="volume-wrapper">
                            <label for="volume-slider">Volume:</label>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5">
                        </div>
                        <div id="music-buttons-expanded">
                            <button id="prev-music-expanded"></button>
                            <button id="play-pause-expanded"></button>
                            <button id="next-music-expanded"></button>
                            <button id="shuffle-music-expanded"></button>
                        </div>
                    </div>
                    <div id="music-visualizer"></div>
                </div>
                <div id="playlist-container">
                    <h3>- Playlist -</h3>
                    <hr class="playlist-divider">
                    <ul id="playlist"></ul>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="game-mode-modal" class="game-mode-overlay hidden">
        <div class="game-mode-content">
            <div class="game-mode-header">
                <h2>Select Game Mode</h2>
                <button id="close-game-mode-modal" class="close-button">&times;</button>
            </div>
            <div class="game-mode-options">
                <div class="game-mode-card" id="start-visual-novel">
                    <div class="card-content">
                        <h3>Visual Novel</h3>
                        <p>Fitur ini masih dalam perancangan, jangan berekspektasi sempurna. Tahap perancangan tidak
                            mengidikasikan kualitas akhir Aplikasi.</p>
                    </div>
                    <span class="experimental-tag">Experimental</span>
                </div>
                <div class="game-mode-card disabled">
                    <div class="card-content">
                        <h3>???</h3>
                        <p>Mungkin mode Novel biasa aja nanti?. Coming soon!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-quit-popup" class="custom-popup-overlay hidden">
        <div class="custom-popup-content">
            <h2 class="quit-hideable">udahan?</h2>
            <p class="quit-hideable">Apakah Kamu yakin mau udahan aja?</p>
            <p id="quit-kaomoji" class="quit-kaomoji">(  )</p>
            <div class="custom-popup-buttons quit-hideable">
                <button id="custom-confirm-quit-btn" class="popup-btn popup-btn-danger">iya udahan</button>
                <button id="custom-cancel-quit-btn" class="popup-btn popup-btn-secondary">nanti aja</button>
            </div>
        </div>
    </div>

    <div class="screen" id="game-editor-screen">
        <button id="back-to-main-menu-editor">Back to Main Menu</button>
        <h2 class="editor-main-title">Game Editor</h2>

        <div class="editor-layout-container">
            <div class="editor-preview-column">
                <div class="preview-item-container" data-element="warning-screen">
                    <label class="preview-label">warning screen :</label>
                    <div class="preview-box" id="preview-warning-screen">
                        <div class="live-preview-content">
                            <div class="screen" id="warning-screen">
                                <svg class="warning-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                                <div class="warning-main-title">Build ini masih Experimental !</div>
                                <div class="warning-sub-text">
                                    <p>Jangan berpikir build saat ini adalah hasil akhir aplikasi, ngga usah ekspektasi
                                        semuanya berjalan dengan nyaman.</p>
                                    <p>Kami paham betul apa saja yang masih kurang pada game visual novelnya, Sehingga
                                        kami perlu untuk terus meriset dan meneliti bagaimana arsitektur dan struktur
                                        kode program yang terbaik untuk bisa menghasilkan program visual novel yang
                                        sangat flexible kustomisasinya oleh user tanpa melibatkan koding.</p>
                                </div>
                                <div class="click-to-continue">klik untuk lanjutkan</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-item-container" data-element="developer-screen">
                    <label class="preview-label">developer-screen :</label>
                    <div class="preview-box" id="preview-developer-screen">
                        <div class="live-preview-content">
                            <div class="screen" id="developer-screen">
                                <h2>Developer ..... </h2>
                                <h4>sub teks</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-item-container" data-element="concept-screen">
                    <label class="preview-label">concept-screen :</label>
                    <div class="preview-box" id="preview-concept-screen">
                        <div class="live-preview-content">
                            <div class="screen" id="concept-screen">
                                <h2 style="margin-bottom: 20px;">Disclaimer!!</h2>
                                <p>Proyek ini dikerjakan secara part time plus kalau lagi mood aja, harap maklumi jika
                                    updatenya lama.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-item-container" data-element="title-screen">
                    <label class="preview-label">title-screen :</label>
                    <div class="preview-box" id="preview-title-screen">
                        <div class="live-preview-content">
                            <div class="screen" id="title-screen">
                                <h1 id="title-screen">
                                    <span>V</span><span>N</span>
                                </h1>
                                <h3>Loading...</h3>
                                <div id="rotating-text"></div>
                                <p>Press Enter</p>
                                <video id="background-video" autoplay muted loop>
                                    <source src="./aset" type="video/mp4">
                                </video>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-item-container" data-element="profile-section">
                    <label class="preview-label">profile-section :</label>
                    <div class="preview-box" id="preview-profile-section">
                        <div id="profile-section">
                            <img src="./aset/ikon.jpg" alt="Profile Picture" id="profile-picture">
                            <div id="profile-info">
                                <h2 id="profile-name">--</h2>
                                <p id="profile-level">Level: --</p>
                                <div id="level-bar">
                                    <div id="level-fill"></div>
                                    <span id="level-max-text">Max</span>
                                </div>
                                <p id="profile-description">"Description..."</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-item-container" data-element="character-menu">
                    <label class="preview-label">character menu :</label>
                    <div class="preview-box" id="preview-character-menu-box">
                        <div class="live-preview-content" id="live-preview-character-menu-content"
                            style="width: 100%; height: 100%; overflow: hidden; position: relative; background-color: #000;">
                        </div>
                    </div>
                </div>

            </div>

            <div class="editor-input-column">
                <div class="input-section-container" id="edit-warning-screen-inputs">
                    <h4>Warning Screen Text</h4>
                    <label for="edit-warning-text-1">Line 1 (e.g., Title):</label>
                    <input type="text" id="edit-warning-text-1" placeholder="Enter first line of warning" />
                    <label for="edit-warning-text-2">Line 2 (e.g., Message):</label>
                    <textarea id="edit-warning-text-2" placeholder="Enter second line of warning"></textarea>
                </div>

                <div class="input-section-container" id="edit-developer-screen-inputs">
                    <h4>Developer Screen Text</h4>
                    <label for="edit-developer-title">Title:</label>
                    <input type="text" id="edit-developer-title" placeholder="Enter developer screen title" />
                    <label for="edit-developer-subtitle">Subtitle:</label>
                    <input type="text" id="edit-developer-subtitle" placeholder="Enter developer screen subtitle" />
                </div>

                <div class="input-section-container" id="edit-concept-screen-inputs">
                    <h4>Concept/Disclaimer Screen Text</h4>
                    <label for="edit-disclaimer-title">Main Title:</label>
                    <input type="text" id="edit-disclaimer-title" placeholder="Enter main title (e.g., Disclaimer!!)" />
                    <label for="edit-disclaimer-text">Disclaimer Text:</label>
                    <textarea id="edit-disclaimer-text" placeholder="Enter disclaimer text"></textarea>
                </div>

                <div class="input-section-container" id="edit-title-screen-inputs">
                    <h4>Title Screen Text</h4>
                    <label for="edit-title-main">Main Title (Kanji):</label>
                    <input type="text" id="edit-title-main" placeholder="Main Title" />
                    <label for="edit-title-subtitle">Subtitle (e.g., Subtitle Text):</label>
                    <input type="text" id="edit-title-subtitle" placeholder="Enter subtitle for title screen" />
                    <label for="edit-title-press-start">"Press Start" Text:</label>
                    <input type="text" id="edit-title-press-start" placeholder="Enter text for 'Press Start' message" />
                    <!-- Rotating Texts Editor -->
                    <div class="rotating-texts-editor-section">
                        <label>Rotating Texts (ditampilkan bergantian di title screen):</label>
                        <div id="rotating-texts-list-container" class="rotating-texts-list">
                            <!-- Rotating text items will be rendered here -->
                        </div>
                        <button type="button" id="add-rotating-text-btn" class="editor-button-positive" style="margin-top: 10px; width: 100%;">
                            + Tambah Rotating Text
                        </button>
                    </div>
                </div>

                <div class="input-section-container" id="edit-profile-section-inputs">
                    <h4>Profile Section Text & Image</h4>

                    <div style="display: flex; align-items: center; margin-bottom: 15px; gap: 15px;">
                        <div id="edit-profile-image-container" style="text-align: center;">
                            <label for="edit-profile-image-input"
                                style="cursor: pointer; display: block; margin-bottom: 5px;">Profile Picture:</label>
                            <img id="edit-profile-image-preview" src="./aset/ikon.jpg" alt="Profile Preview"
                                style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #555; cursor: pointer; object-fit: cover;"
                                title="Klik untuk mengubah gambar profil">
                            <input type="file" id="edit-profile-image-input" accept="image/*" style="display: none;">
                        </div>

                        <div style="flex-grow: 1;">
                            <label for="edit-profile-name">Profile Name:</label>
                            <input type="text" id="edit-profile-name" placeholder="Enter profile name"
                                style="width: 100%;" />
                        </div>
                    </div>
                    <label for="edit-profile-level">Profile Level Text (e.g., Level: 30):</label>
                    <input type="text" id="edit-profile-level" placeholder="Enter text for profile level" />
                    <label for="edit-profile-description">Profile Description:</label>
                    <textarea id="edit-profile-description" placeholder="Enter profile description"></textarea>

                    <!-- CSS Editor Toggle Button -->
                    <button id="toggle-profile-css-editor" class="css-editor-toggle-btn" type="button">
                        <span class="triangle-icon"></span>
                        <span>Edit CSS Code</span>
                    </button>

                    <!-- CSS Editor Panel (Hidden by Default) -->
                    <div id="profile-css-editor-panel" class="css-editor-panel" style="display: none;">
                        <label for="profile-css-code" style="margin-top: 10px; display: block;">Custom CSS for Profile
                            Section:</label>
                        <textarea id="profile-css-code" class="css-code-editor" style="height: 465px;"
                            placeholder="/* Enter your custom CSS for #profile-section here */&#10;/* Example:&#10;#profile-section {&#10;    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);&#10;    border-radius: 15px;&#10;    padding: 20px;&#10;}&#10;*/"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            <button id="apply-profile-css" class="editor-button-positive" type="button">Apply
                                CSS</button>
                            <button id="load-current-css" class="editor-button-info" type="button">Load Current
                                CSS</button>
                            <button id="reset-profile-css" class="editor-button-negative" type="button">Reset to
                                Default</button>
                        </div>
                    </div>
                </div>

                <div class="input-section-container" id="edit-character-menu-inputs">
                    <h4>Character Menu Editor</h4>

                    <div class="character-editor-list" id="characterEditorListContainer">
                        <p class="character-list-empty-placeholder"
                            style="display: none; text-align: center; color: #777; margin: 20px 0;">
                            Belum ada karakter. Klik "Tambah Karakter Baru" untuk memulai.
                        </p>
                    </div>

                    <button id="buttonAddNewCharacter" class="editor-button-positive"
                        style="margin-top: 20px; width: 100%; padding: 12px;">
                        + Tambah Karakter Baru
                    </button>
                </div>

                <div class="editor-buttons">
                    <button id="save-editor-changes">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="character-menu">
        <button id="back-to-main-menu">Back to Main Menu</button>

        <div class="main-container" id="character-main-container">
            <div style="width: 100%; text-align: center; margin-top: 50px; color: #666;">
                Loading Character Data...
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                fetch('./aset/konten/character_data.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("HTTP error " + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.novelTitle) {
                            const titleH1 = document.querySelector('h1#title-screen');
                            if (titleH1 && data.novelTitle.mainKanji) {
                                titleH1.innerHTML = '';
                                const kanjiChars = data.novelTitle.mainKanji.split('');
                                kanjiChars.forEach(char => {
                                    const span = document.createElement('span');
                                    span.textContent = char;
                                    titleH1.appendChild(span);
                                });
                            }
                            const titleH3 = document.querySelector('div#title-screen h3');
                            if (titleH3 && data.novelTitle.main) {
                                titleH3.textContent = data.novelTitle.main;
                            }

                            const previewTitleH1 = document.querySelector('div#preview-title-screen h1');
                            if (previewTitleH1 && data.novelTitle.mainKanji) {
                                previewTitleH1.innerHTML = '';
                                const kanjiChars = data.novelTitle.mainKanji.split('');
                                kanjiChars.forEach(char => {
                                    const span = document.createElement('span');
                                    span.textContent = char;
                                    previewTitleH1.appendChild(span);
                                });
                            }
                            const previewTitleH3 = document.querySelector('div#preview-title-screen h3');
                            if (previewTitleH3 && data.novelTitle.main) {
                                previewTitleH3.textContent = data.novelTitle.main;
                            }
                        }

                        if (data.profile) {
                            const profileName = document.getElementById('profile-name');
                            if (profileName && data.profile.name) {
                                profileName.textContent = data.profile.name;
                            }
                            const profileDesc = document.getElementById('profile-description');
                            if (profileDesc && data.profile.description) {
                                profileDesc.textContent = data.profile.description;
                            }
                            const profileLevel = document.getElementById('profile-level');
                            if (profileLevel && data.profile.level) {
                                profileLevel.textContent = data.profile.level;
                            }
                            const previewProfileName = document.querySelector('#preview-profile-section #profile-name');
                            if (previewProfileName && data.profile.name) {
                                previewProfileName.textContent = data.profile.name;
                            }
                            const previewProfileDesc = document.querySelector('#preview-profile-section #profile-description');
                            if (previewProfileDesc && data.profile.description) {
                                previewProfileDesc.textContent = data.profile.description;
                            }
                            const previewProfileLevel = document.querySelector('#preview-profile-section #profile-level');
                            if (previewProfileLevel && data.profile.level) {
                                previewProfileLevel.textContent = data.profile.level;
                            }
                        }


                        const container = document.getElementById('character-main-container');
                        if (!container) return;

                        container.innerHTML = '';

                        if (data.novelTitle) {
                            const titleDiv = document.createElement('div');
                            titleDiv.style.width = '100%';
                            titleDiv.style.textAlign = 'center';
                            titleDiv.style.position = 'absolute';
                            titleDiv.style.top = '5%';
                            titleDiv.style.left = '0';
                            titleDiv.style.zIndex = '20';
                            titleDiv.style.pointerEvents = 'none';
                            titleDiv.style.color = '#ccc';

                            titleDiv.innerHTML = `
                                <h2 style="font-family: 'Lexend', sans-serif; font-size: 1.2rem; margin: 0; opacity: 0.8;">
                                    ${data.novelTitle.main || ''}
                                </h2>
                                <p style="font-size: 0.8rem; color: #888; font-style: italic;">
                                    ${data.novelTitle.subtitle || ''}
                                </p>
                            `;
                            container.appendChild(titleDiv);
                        }

                        if (data.characters && Array.isArray(data.characters)) {
                            data.characters.forEach(char => {
                                const previewDiv = document.createElement('div');
                                previewDiv.className = 'image-preview';

                                let mediaHtml = '';
                                if (char.type === 'image') {
                                    mediaHtml = `<img class="video character-image" src="${char.source}" alt="${char.alt || ''}">`;
                                } else {
                                    mediaHtml = `<video muted loop preload="none" class="video" src="${char.source}"></video>`;
                                }

                                let descContent = '';
                                if (char.name.includes('Academy') || char.name === '??? Academy') {
                                    descContent += `<div class="name-and-role"><h1>${char.name}</h1></div>`;
                                } else {
                                    descContent += `<div class="name-and-role"><h1>${char.name}</h1></div>`;
                                }

                                if (char.descValues) {
                                    const mainText = char.descValues.description || char.descValues.summary;
                                    if (mainText) {
                                        const pClass = char.descValues.summary ? 'class="summary"' : '';
                                        descContent += `<p ${pClass}>${mainText}</p>`;
                                    }
                                    if (char.descValues.extended) {
                                        descContent += `
                                            <div class="extended-content">
                                                <p>${char.descValues.extended}</p>
                                            </div>
                                            <button class="more-button">More</button>
                                        `;
                                    }
                                }

                                previewDiv.innerHTML = `
                                    ${mediaHtml}
                                    <div class="overlay">
                                        <div class="desc">
                                            ${descContent}
                                        </div>
                                    </div>
                                `;
                                previewDiv.style.opacity = '0';
                                console.log('[CharacterMenu] Created preview for:', char.name, 'with opacity 0');
                                container.appendChild(previewDiv);
                            });
                            attachCharacterMenuListeners();
                        }
                    })
                    .catch(error => {
                        console.error("Failed to load character data:", error);
                    });

                function attachCharacterMenuListeners() {
                    const container = document.getElementById('character-main-container');
                    container.addEventListener('click', (e) => {
                        if (e.target.classList.contains('more-button')) {
                            e.stopPropagation();

                            const extendedContent = e.target.previousElementSibling;
                            if (extendedContent && extendedContent.classList.contains('extended-content')) {
                                extendedContent.classList.toggle('show');
                                e.target.textContent = extendedContent.classList.contains('show') ? 'Less' : 'More';
                            }
                        }
                    });
                    const videos = container.querySelectorAll('video');
                    videos.forEach(video => {
                        video.parentElement.addEventListener('mouseenter', () => video.play());
                        video.parentElement.addEventListener('mouseleave', () => {
                            video.pause();
                            video.currentTime = 0;
                        });
                    });
                }
            });

        </script>
    </div>

    <div id="options-modal" class="modal hidden">
        <div class="modal-content">
            <div class="options-navbar">
                <div class="options-navbar-item active" data-pane="game-options">Game</div>
                <div class="options-navbar-item" data-pane="display-options">Display</div>
                <div class="options-navbar-item" data-pane="wallpaper-options">Wallpaper</div>
                <div class="options-navbar-item" data-pane="music-player-options">Music Player</div>
                <div class="options-navbar-item" data-pane="network-options">Network</div>
                <div class="options-navbar-item" data-pane="debug-options">Debug</div>

                <div class="navbar-profile-link">
                    <button class="navbar-profile-link-btn" id="open-about-panel">
                        <span>about engine</span>
                    </button>
                </div>
            </div>
            <div class="options-main-area">
                <div class="options-content-pane active" id="game-options-pane">
                    <h3 class="option-group-title">Game Settings</h3>
                    <div class="option-row-checkbox"
                        data-description="Jika tidak ada aktivitas selama 20 detik di menu utama, aplikasi akan kembali ke layar judul.">
                        <div class="label-text-wrapper"> Return Title Screen when idle 20 sec</div>
                        <input type="checkbox" id="idle-return-checkbox" />
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Menampilkan efek butiran salju. Tapi ini mungkin dapat menyebabkan video wallpaper jadi throttling/macet-macet di momen-momen tertentu.">
                        <div class="label-text-wrapper"> Enable Snow Effect</div>
                        <input type="checkbox" id="snow-effect-checkbox" />
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Menampilkan atau menyembunyikan status aktivitas game Anda di profil Discord.">
                        <div class="label-text-wrapper"> Enable Discord Rich Presence</div>
                        <input type="checkbox" id="enable-rpc-checkbox" />
                    </div>

                    <!-- GIF Overlay Feature -->
                    <div class="option-group-wrapper">
                        <div class="option-row-checkbox"
                            data-description="Menampilkan gambar GIF yang bisa diposisikan bebas di layar. Cocok untuk menambahkan elemen dekoratif seperti karakter favorit.">
                            <div class="label-text-wrapper"> Free GIF Image Overlay</div>
                            <input type="checkbox" id="enable-gif-overlay-checkbox" />
                        </div>

                        <div id="gif-overlay-sub-options" class="sub-options-box">
                            <!-- Dropdown Preset Profile -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <select id="game-gif-preset-select"
                                    style="flex: 1; padding: 8px 10px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 6px; color: #fff; font-size: 12px; cursor: pointer;">
                                    <option value="">-- Pilih Preset --</option>
                                </select>
                                <button id="game-gif-preset-apply-btn" style="
                                        padding: 7px 14px;
                                        background: linear-gradient(45deg, #f3557a, #f78da3);
                                        border: none;
                                        border-radius: 6px;
                                        color: #ffffff;
                                        font-size: 12px;
                                        cursor: pointer;
                                        font-weight: 400;
                                        box-shadow: 0 2px 6px rgba(243, 85, 122, 0.25);
                                    "> Terapkan
                                </button>
                            </div>

                            <div id="game-gif-list-container">
                                <!-- GIF rows akan ditambahkan secara dinamis -->
                            </div>
                            <button class="game-add-gif-btn" id="game-add-gif-btn" title="Tambah GIF Baru">+ Tambah
                                GIF</button>

                            <div class="gif-overlay-controls">
                                <div class="gif-tips-container"
                                    style="margin-bottom: 8px; padding: 10px; background: rgba(0, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(0, 255, 255, 0.15);">
                                    <span style="font-size: 11px; color: #aaa;"> Tips: Cari GIF tanpa background untuk
                                        hasil terbaik. Gunakan website "GIF Background Remover" untuk menghapus
                                        background.</span>
                                </div>
                                <div class="option-row-checkbox" style="margin-bottom: 0;"
                                    data-description="Mengunci posisi semua GIF dan mengabaikan interaksi mouse.">
                                    <div class="label-text-wrapper" style="font-size: 0.85rem;">Kunci posisi GIF (Larang
                                        interaksi kursor)</div>
                                    <input type="checkbox" id="game-gif-interaction-lock" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="option-row"
                        data-description="Contoh untuk komponen GUI dropdown yang belum diimplementasikan.">
                        <label>GUI Dropdown :</label>
                        <div class="gui-dropdown-placeholder">(GUI Dropdown - Blank)</div>
                    </div>
                    <div class="option-row"
                        style="margin-top: 20px; border-top: 1px solid rgba(0, 255, 255, 0.2); padding-top: 15px;">
                        <button id="clear-remembered-settings" class="clear-remember-setting-btn" type="button">Clear
                            saved settings</button>
                    </div>
                </div>

                <div class="options-content-pane" id="display-options-pane">
                    <h3 class="option-group-title">Display Settings</h3>
                    <div class="option-row"
                        data-description="Mengubah resolusi jendela aplikasi. Tidak akan berpengaruh jika aplikasi dalam mode Full Screen.">
                        <label for="resolution-select">Resolution:</label>
                        <select id="resolution-select">
                            <option value="1280x720">1280 x 720</option>
                            <option value="1600x900" selected>1600 x 900</option>
                            <option value="1920x1080">1920 x 1080</option>
                        </select>
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Membuat aplikasi berjalan dalam mode layar penuh (fullscreen) tanpa bingkai jendela.">
                        <label for="fullscreen-checkbox">Full Screen</label>
                        <input type="checkbox" id="fullscreen-checkbox" />
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Mengaktifkan akselerasi WebGPU untuk efek visual. Memerlukan hardware yang mendukung.">
                        <div class="label-text-wrapper"> WebGPU Acceleration <span
                                style="background-color: #ffc107; color: #000; font-size: 0.7em; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">Eksperimental</span>
                        </div>
                        <input type="checkbox" id="webgpu-acceleration-checkbox" />
                    </div>
                    <div class="option-row disabled-option" id="webgpu-visualizer-style-row"
                        data-description="Memilih gaya visualizer saat akselerasi WebGPU aktif.">
                        <label for="webgpu-visualizer-style">WebGPU Visualizer Style:</label>
                        <select id="webgpu-visualizer-style" disabled>
                            <option value="0">Classic (Canvas-like)</option>
                            <option value="1" selected>Modern (Gradient)</option>
                        </select>
                    </div>
                </div>

                <div class="options-content-pane" id="wallpaper-options-pane">
                    <h3 class="option-group-title">Wallpaper Settings</h3>
                    <div class="option-row-checkbox"
                        data-description="Menampilkan/menyembunyikan panel pengaturan wallpaper cepat di pojok kiri bawah layar utama.">
                        <span class="label-text">Enable Hidden Wallpaper Settings Panel</span>
                        <input type="checkbox" id="enable-hidden-wallpaper-settings" />
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Secara otomatis mengubah wallpaper agar cocok dengan judul musik yang sedang diputar (jika file wallpaper dengan nama yang sama ditemukan).">
                        <span class="label-text">Wallpaper Follow Music Title</span>
                        <input type="checkbox" class="follow-music-title">
                    </div>

                    <div class="option-row-checkbox"
                        data-description="Secara otomatis mengganti wallpaper setiap interval waktu tertentu.">
                        <span class="label-text">Auto Change Wallpaper</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="auto-change-wallpaper">
                            <input type="number" class="auto-change-interval" min="1" value="5"
                                style="width: 60px; padding: 2px; color: black;">
                            <span>min</span>
                        </div>
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Mengacak urutan wallpaper saat pergantian otomatis.">
                        <span class="label-text">Random Wallpaper Order</span>
                        <input type="checkbox" class="random-wallpaper-order">
                    </div>

                    <div class="option-item" id="video-wallpaper-setting">
                        <small style="color: #ff4d4f; display: flex; justify-content: left;">
                            High GPU usage if wallpaper is high resolution video,
                        </small>
                        <small style="color: #ff4d4f; display: flex; justify-content: left;">
                            Tidak disarakan menggunakan video 4K di perangkat low end.
                        </small>
                        <div class="option-row-checkbox"
                            data-description="Jika video wallpaper yang kamu miliki punya resolusi dan bitrate yang tinggi, maka tinggi juga penggunaan gpu nya. Disarankan untuk dinonaktifkan jika berkeperluan effisiensi"
                            style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                            <label for="enable-video-wallpaper">Enable Video Wallpaper</label>
                            <input type="checkbox" id="enable-video-wallpaper" checked />
                        </div>
                    </div>

                    <div class="option-row"
                        data-description="Mengatur tingkat kecerahan (kegelapan) pada video wallpaper di menu utama.">
                        <label>Darkness (Brightness)</label>
                        <input type="range" class="wallpaper-darkness" min="0" max="100" value="30">
                    </div>
                    <div class="option-row" data-description="Mengatur tingkat blur pada wallpaper.">
                        <label>Blur</label>
                        <input type="range" class="wallpaper-blur" min="0" max="20" value="0">
                    </div>
                    <div class="option-row" data-description="Mengatur tingkat grayscale (hitam putih) pada wallpaper.">
                        <label>Grayscale</label>
                        <input type="range" class="wallpaper-grayscale" min="0" max="100" value="0">
                    </div>
                    <div class="option-row" data-description="Mengatur tingkat zoom pada wallpaper.">
                        <label>Zoom</label>
                        <input type="range" class="wallpaper-zoom" min="1" max="2" step="0.1" value="1">
                    </div>
                </div>

                <div class="options-content-pane" id="music-player-options-pane">
                    <h3 class="option-group-title">Music Player Settings</h3>
                    <div class="option-group-wrapper">
                        <div class="option-row-checkbox"
                            data-description="Menampilkan pemutar musik mini yang selalu terlihat di atas aplikasi lain di pojok kanan bawah, ini mungkin bisa juga menyebabkan video wallpaper jadi throttling/macet-macet, tapi hanya saja lebih langka terjadinya.">
                            <div class="label-text-wrapper"> Enable Mini Music Player</div>
                            <input type="checkbox" id="mini-player-effect-checkbox" />
                        </div>

                        <div id="mini-player-sub-options" class="sub-options-box">
                            <div class="option-row-checkbox" style="margin-bottom: 0;"
                                data-description="Mini player akan menghilang sementara saat kursor mendekatinya, agar tidak menghalangi tampilan.">
                                <div class="label-text-wrapper" style="font-size: 0.85rem;">Hide when cursor approaches
                                </div>
                                <input type="checkbox" id="mini-player-hide-on-cursor" />
                            </div>
                        </div>
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Mengaktifkan overlay pemutar musik yang bisa diakses dengan hotkey Alt+S kapan saja. Sejauh ini yang diketahui, belum pernah membuat video wallpaper menjadi throttling/macet-macet.">
                        <div class="label-text-wrapper">Enable In-Game Overlay</div>
                        <input type="checkbox" id="enable-overlay-checkbox" />
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Mengubah tema YouTube Music secara dinamis mengikuti warna album art lagu yang sedang diputar.">
                        <div class="label-text-wrapper">Enable Dynamic ytMusic Styling</div>
                        <input type="checkbox" id="enable-dynamic-theme-checkbox" />
                    </div>
                    <div id="dynamic-theme-sub-options" class="sub-options-box" style="display:none;">
                        <div class="option-row"
                            data-description="Pilih mode Dynamic Theme. Overlay (Seamless) menyatu dengan UI player tanpa hard refresh. Harmony memberikan gradien warna yang lebih seirama dan koheren.">
                            <div class="label-text-wrapper" style="font-size: 0.85rem;">Mode</div>
                            <select id="dynamic-theme-mode-select" style="width: 100%; max-width: 240px;">
                                <option value="default">Default</option>
                                <option value="default-optimized">Default Optimized</option>
                                <option value="seamless">Seamless (Full Transparency)</option>
                                <option value="overlay">Overlay (Seamless)</option>
                                <option value="harmony">Harmony (Cohesive)</option>
                            </select>
                        </div>
                    </div>
                    <div class="option-row-checkbox"
                        data-description="Mengubah tampilan Music Player lokal secara dinamis mengikuti warna dominan dari album art lagu yang sedang diputar.">
                        <div class="label-text-wrapper">Enable Dynamic Music Player Styling</div>
                        <input type="checkbox" id="enable-dynamic-music-player-checkbox" />
                    </div>
                    <div class="option-group-wrapper">
                        <div class="option-row-checkbox"
                            data-description="Mencoba mendeteksi iklan di pemutar musik online dan menampilkan tombol untuk melewatinya (skip).">
                            <div class="label-text-wrapper"> Enable Ad Skipper Helper</div>
                            <input type="checkbox" id="enable-ad-skipper-checkbox" />
                        </div>

                        <div id="ad-skipper-sub-options" class="sub-options-box">

                            <div class="option-row-checkbox"
                                data-description="Secara otomatis mematikan suara (Mute) saat iklan terdeteksi, dan mengembalikan suara saat lagu mulai.">
                                <div class="label-text-wrapper" style="font-size: 0.85rem;">Auto Mute Ads</div>
                                <input type="checkbox" id="auto-mute-ads-checkbox" />
                            </div>

                            <div class="option-row-checkbox"
                                data-description="Secara otomatis mengklik tombol Skip segera setelah tombol tersebut muncul.">
                                <div class="label-text-wrapper" style="font-size: 0.85rem;">Auto Click Skip</div>
                                <input type="checkbox" id="auto-skip-ads-checkbox" />
                            </div>
                        </div>
                    </div>
                </div>


                <div class="options-content-pane" id="network-options-pane">
                    <h3 class="option-group-title">Network Settings</h3>
                    <div class="option-row" style="flex-direction: column; align-items: flex-start;"
                        data-description="Menghubungkan aplikasi ke internet untuk mengakses fitur online.">
                        <button id="connect-button"
                            style="width: 100%; display: flex; align-items: center; justify-content: center; padding: 10px;">
                            <span class="button-text">Connect to Internet</span>
                            <svg class="loading-spinner" style="margin-left: 8px;" width="16" height="16"
                                viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="20" fill="none" stroke="rgba(255,255,255,0.3)"
                                    stroke-width="5"></circle>
                                <circle class="spin-path" cx="25" cy="25" r="20" fill="none" stroke="#ffffff"
                                    stroke-width="5" stroke-dasharray="80 200" stroke-linecap="round"></circle>
                            </svg>
                        </button>
                        <div id="connection-details" class="hidden"
                            style="margin-top: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div id="ping-indicator-options"
                                style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                <div class="ping-dot"></div>
                                <span class="ping-value"></span>
                            </div>
                            <button id="disconnect-button" class="popup-btn popup-btn-secondary"
                                style="font-size: 0.8rem; padding: 5px 10px;">Disconnect</button>
                        </div>
                    </div>
                </div>

                <div class="options-content-pane" id="debug-options-pane">
                    <h3 class="option-group-title">Debug Settings</h3>

                    <div class="option-row"
                        data-description="Membuka konsol developer (DevTools) untuk jendela aplikasi utama. Berguna untuk melihat log dan error dari sisi aplikasi.">
                        <span class="label-text">Buka DevTool</span>
                        <button id="open-main-devtools" class="debug-button">Buka</button>
                    </div>


                    <div class="option-row-checkbox"
                        data-description="Menampilkan/menyembunyikan overlay log real-time di bagian bawah layar. Berguna untuk debug tanpa membuka konsol.">
                        <span class="label-text">Tampilkan Overlay Log</span>
                        <input type="checkbox" id="toggle-log-overlay-checkbox" />
                    </div>
                </div>

                <p>Description :</p>
                <div id="option-description-box">
                    <p id="option-description-text">Pilih opsi setting...</p>
                </div>
                <div class="buttons-row">
                    <div class="buttons-row-left">
                        <button id="remember-settings-toggle" class="remember-setting-btn" type="button"
                            aria-pressed="false">Remember this setting?</button>
                    </div>
                    <button id="apply-options">Apply</button>
                    <button id="close-options">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quit-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Confirm Quit</h2>
            <p>Are you sure you want to quit?</p>
            <div class="buttons-row">
                <button id="confirm-quit">Yes, Quit</button>
                <button id="cancel-quit">No</button>
            </div>
        </div>
    </div>

    <!-- GIF Settings Modal untuk Game Mode -->
    <div id="game-gif-settings-modal">
        <!-- Warning di luar box -->
        <div id="game-no-music-warning" class="no-music-warning"
            style="display: none; margin-bottom: 12px; max-width: 360px; text-align: center;">
             Putar musik terlebih dahulu agar opsi judul/artis bisa digunakan.
        </div>

        <div class="game-gif-settings-box">
            <h3> Pengaturan GIF</h3>

            <div class="setting-row">
                <label for="game-gif-condition-type">GIF ini HANYA akan tampil JIKA?? .... :</label>
                <select id="game-gif-condition-type">
                    <option value="always">Selalu tampilkan dalam kondisi apapun</option>
                    <option value="music-playing">Hanya saat musik diputar</option>
                    <option value="music-paused">Hanya saat musik di-pause</option>
                    <option value="ad-playing">Hanya saat ada iklan</option>
                    <option value="music-title" data-default-text="Saat judul musik mengandung...">Saat judul musik
                        mengandung...</option>
                    <option value="music-artist" data-default-text="Saat artis musik mengandung...">Saat artis musik
                        mengandung...</option>
                </select>
            </div>

            <div class="setting-row">
                <label for="game-gif-opacity">Opacity:</label>
                <input type="range" id="game-gif-opacity" min="0.1" max="1" step="0.1" value="1"
                    style="width: 100%; accent-color: cyan;">
                <div
                    style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 4px;">
                    <span>10%</span>
                    <span id="game-gif-opacity-value">100%</span>
                    <span>100%</span>
                </div>
            </div>

            <div class="setting-row"
                style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px;">
                <div style="flex: 1;">
                    <label for="game-gif-hide-on-cursor"
                        style="font-size: 12px; color: #ccc; cursor: pointer;">Menghilang sementara jika didekati
                        kursor</label>
                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Hanya bekerja jika "Kunci posisi GIF"
                        aktif</div>
                </div>
                <label class="game-toggle-switch" style="margin-left: 10px;">
                    <input type="checkbox" id="game-gif-hide-on-cursor">
                    <span class="game-slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <label for="game-gif-rotation">Rotation:</label>
                <input type="range" id="game-gif-rotation" min="0" max="360" step="15" value="0"
                    style="width: 100%; accent-color: #ff64c8;">
                <div
                    style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 4px;">
                    <span>0</span>
                    <span id="game-gif-rotation-value">0</span>
                    <span>360</span>
                </div>
            </div>

            <div class="setting-row">
                <label for="game-gif-animation-type">Animasi Gerakan:</label>
                <select id="game-gif-animation-type">
                    <option value="none">Tidak Ada</option>
                    <option value="dvd">DVD Bouncing</option>
                    <option value="linear">Linear (Wrap Around)</option>
                    <option value="circular">Melingkar (Orbit)</option>
                    <option value="random">Random Walk</option>
                    <option value="patrol">Patroli (Flip)</option>
                    <option value="patrol-wave">Patroli Bergelombang (Flip)</option>
                    <option value="patrol-vertical">Patroli Vertikal (Flip)</option>
                    <option value="patrol-wave-vertical">Patroli Vertikal Bergelombang (Flip)</option>
                </select>
            </div>

            <div class="setting-row" id="game-gif-animation-speed-container" style="display: none;">
                <label for="game-gif-animation-speed">Kecepatan Animasi:</label>
                <input type="range" id="game-gif-animation-speed" min="1" max="10" step="1" value="2"
                    style="width: 100%; accent-color: cyan;">
                <div
                    style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 4px;">
                    <span>1</span>
                    <span id="game-gif-animation-speed-value">2</span>
                    <span>10</span>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn-cancel" id="game-gif-settings-cancel">Batal</button>
                <button class="btn-save" id="game-gif-settings-save">Simpan</button>
            </div>
        </div>
    </div>

    <div class="about-panel-overlay" id="about-panel-overlay"></div>
    <div id="about-panel">
        <div class="about-panel-header">
            <h2>About Engine</h2>
            <button class="about-panel-close" id="close-about-panel">&times;</button>
        </div>
        <div class="about-panel-content">
            <div class="about-general-description"
                style="text-align: left; margin-bottom: 30px; padding: 0 5px; max-width: 850px;">
                <p style="margin-bottom: 15px; font-size: 0.95rem; line-height: 1.6; color: #e0e0e0;">
                    Gap VN & Music Player is an open-source framework designed to create immersive visual novels
                    integrated with a local music player capability. Built with Electron, it offers a lightweight
                    yet customizable engine for creators.
                </p>
                <div
                    style="height: 1px; background: linear-gradient(to right, rgba(0, 255, 255, 0.2), transparent); margin-top: 25px;">
                </div>
            </div>

            <div class="developers-container">
                <div class="developer-card">
                    <div class="developer-header">
                        <div class="developer-name">Rd chocomint</div>
                        <div class="developer-badge lead-core">Original Creator</div>
                    </div>
                    <div class="developer-description">
                        <p style="margin-bottom: 12px;">
                            Lead Developer and Architect of the Gap VN Engine.
                            Responsible for the core logic and project vision.
                        </p>
                    </div>
                </div>
                <div class="developer-card">
                    <div class="developer-header">
                        <div class="developer-name">Rin chocomint</div>
                        <div class="developer-badge project-dev">Co-Developer & Maintainer</div>
                    </div>
                    <div class="developer-description">
                        <p style="margin-bottom: 12px;">
                            Actively contributed to the source code, and managed the open-source adaptation.
                        </p>
                        <p>
                            Also responsible for system stability, rigorous testing,
                            and ensuring the quality of the release.
                        </p>
                    </div>
                </div>
            </div>

            <div class="about-app-section"
                style="margin-top: 20px; padding: 18px; background: rgba(0,0,0,0.35); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">

                <div class="app-info-header" style="margin-bottom: 16px;">
                    <h3
                        style="margin: 0 0 10px 0; font-size: 1.15rem; color: #00ccff; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.3rem;">Gap VN Engine & Music Player (Open Source)</span>
                    </h3>
                    <div class="app-description-container" style="text-align: left;">
                        <p class="app-description"
                            style="margin: 0 0 12px 0; font-size: 0.9rem; color: #b0b0b0; line-height: 1.6; text-align: left;">
                            This version is the raw open-source engine. It does not contain proprietary story assets or
                            creative content.
                            <br><br>
                            <span style="color: #888; font-size: 0.85rem;">Copyright  2026 Rd Chocomint.</span><br>
                            Developers are free to modify this engine under the terms of the ISC License provided in the
                            repository.
                        </p>
                        <p class="app-description"
                            style="margin: 0 0 12px 0; font-size: 0.9rem; color: #b0b0b0; line-height: 1.6; text-align: left;">
                            For the full version of the game featuring the original story and characters, please visit
                            the Releases tab.
                        </p>
                    </div>
                </div>

                <div class="section-separator"
                    style="display: flex; align-items: center; gap: 12px; margin: 16px 0 12px 0;">
                    <div style="font-size: 0.8rem; color: #888; font-weight: 500; white-space: nowrap;">
                        Engine Integrity Status
                    </div>
                    <div
                        style="flex: 1; height: 1px; background: linear-gradient(to right, rgba(255,255,255,0.2), transparent);">
                    </div>
                </div>

                <div id="version-integrity-content" style="font-size: 0.85rem;">
                    <div style="color: #666; text-align: center; padding: 10px;">Loading info...</div>
                </div>
            </div>

        </div>
    </div>

    <audio id="background-audio" preload="auto"></audio>

    <div id="external-browser-container" class="hidden">
        <div id="webview-window">
            <div class="title-bar">
                <span>YT Music webview</span>

                <div class="webview-preset-controls">
                    <button id="preset-normal" class="active" title="Mode Normal (Default)">Desktop Web</button>
                    <button id="preset-vertical" title="Mode Vertikal (Smartphone)">Smartphone App</button>
                </div>
                <button id="close-webview" class="close-btn"></button>
            </div>

            <div id="webview-loader" class="loader hidden"></div>

            <webview id="external-webview" preload="webview-preload.js" src=""
                style="width:100%; height:calc(100% - 30px); border:none;"></webview>
            <button id="openWebviewDevTools"
                style="position: fixed; top: 10px; right: 10px; z-index: 100000; padding: 5px 10px; background-color: #333; color: white; border: 1px solid #555; border-radius: 5px; cursor: pointer;">
                Webview DevTools
            </button>

            <div class="resizer resizer-se"></div>
        </div>
    </div>
    </div>
    <script src="./aset/js/vibrant.min.js"></script>
    <script src="wgsl/visualizer-webgpu.js"></script>
    <script>
        // ================================ ( Modul & State Global ) ================================ //
        //------------------- ( dependensi electron/node ) -------------------------//
        const { ipcRenderer } = require('electron');
        const path = require('path');
        const fs = require('fs');
        //------------------- ( end dependensi electron/node ) -------------------------//

        //------------------- ( debug awal - biar jelas lagi jalan di mana ) -------------------------//
        console.log('Path HTML saat ini:', window.location.href);
        console.log('Mencoba memuat font dari path relatif ./aset/fonts/lexend/');
        //------------------- ( end debug awal - biar jelas lagi jalan di mana ) -------------------------//

        //------------------- ( state global lintas fitur ) -------------------------//
        let screens = [
            document.getElementById("warning-screen"),
            document.getElementById("developer-screen"),
            document.getElementById("concept-screen"),
            document.getElementById("title-screen"),
            document.getElementById("main-menu"),
        ];

        let songs = [
            { title: "", src: "" }
        ];

        let wallpapers = [
            { name: "", src: "" }
        ];

        let currentGlobalVolume = 0.8;
        //------------------- ( end state global lintas fitur ) -------------------------//
        // ================================ ( End Modul & State Global ) ================================ //


        // ================================ ( Utilitas UI ) ================================ //
        //------------------- ( warm-up UI biar modal nggak "kaget" pas dibuka ) -------------------------//
        function warmUpUI() {
            console.log('[Optimization] Warming up UI elements...');
            const elementsToWarmUp = document.querySelectorAll('.modal, #game-mode-modal, #custom-quit-popup');

            elementsToWarmUp.forEach(element => {
                element.classList.remove('hidden');
                void element.offsetHeight;
                element.classList.add('hidden');
            });
            console.log('[Optimization] UI warm-up complete.');
        }
        //------------------- ( end warm-up UI biar modal nggak "kaget" pas dibuka ) -------------------------//

        //------------------- ( About Panel ) -------------------------//
        function initAboutPanel() {
            console.log('Initializing panel...');

            const openBtn = document.getElementById('open-about-panel');
            const closeBtn = document.getElementById('close-about-panel');
            const panel = document.getElementById('about-panel');
            const overlay = document.getElementById('about-panel-overlay');

            console.log('[About]Elements:', {
                openBtn: !!openBtn,
                closeBtn: !!closeBtn,
                panel: !!panel,
                overlay: !!overlay
            });

            async function openAboutPanel() {
                if (panel && overlay) {
                    panel.classList.add('open');
                    overlay.classList.add('open');

                    // Load version and integrity info
                    await loadVersionAndIntegrityInfo();
                }
            }

            async function loadVersionAndIntegrityInfo() {
                const contentEl = document.getElementById('version-integrity-content');
                if (!contentEl) return;

                try {
                    // ambil versi dan integritas sekaligus
                    const [versions, integrity] = await Promise.all([
                        ipcRenderer.invoke('integrity:get-versions'),
                        ipcRenderer.invoke('integrity:check-core')
                    ]);

                    // tabel versi
                    let versionRows = '';
                    if (versions && versions.app) {
                        versionRows = `
                            <tr><td>Aplikasi</td><td>v${versions.app.version} <span style="color:#00ccff;font-size:0.75rem;">${versions.app.stage}</span></td></tr>
                            <tr><td>VN Player</td><td>v${versions.components?.vnPlayer?.version || 'N/A'}</td></tr>
                            <tr><td>VN Hub</td><td>v${versions.components?.vnHub?.version || 'N/A'}</td></tr>
                            <tr><td>VN Manager</td><td>v${versions.components?.vnManager?.version || 'N/A'}</td></tr>
                            <tr><td>Script Schema</td><td>v${versions.scriptSchema?.version || 'N/A'}</td></tr>
                        `;
                    } else {
                        versionRows = '<tr><td colspan="2" style="color:#ff6b6b;">Gagal memuat</td></tr>';
                    }

                    // Build integrity table rows
                    let integrityRows = '';
                    if (integrity && integrity.checked) {
                        for (const [name, info] of Object.entries(integrity.results)) {
                            let icon, color;
                            switch (info.status) {
                                case 'original': icon = ''; color = '#4ade80'; break;
                                case 'modified': icon = ''; color = '#fbbf24'; break;
                                case 'unverified': icon = ''; color = '#60a5fa'; break;
                                case 'missing': icon = ''; color = '#f87171'; break;
                                default: icon = '?'; color = '#9ca3af';
                            }
                            integrityRows += `<tr><td>${name}</td><td style="color:${color};">${icon} ${info.status}</td></tr>`;
                        }
                    } else {
                        integrityRows = '<tr><td colspan="2" style="color:#888;">Tidak tersedia</td></tr>';
                    }

                    // Render complete layout with inline styles in a scoped way
                    contentEl.innerHTML = `
                        <div style="display:flex;gap:20px;">
                            <div style="flex:1;">
                                <div style="font-size:0.75rem;color:#555;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:6px;">Versi Komponen</div>
                                <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                                    <colgroup><col style="width:auto;"><col style="width:auto;text-align:right;"></colgroup>
                                    <tbody style="color:#ccc;">${versionRows}</tbody>
                                </table>
                            </div>
                            <div style="width:1px;background:rgba(255,255,255,0.1);"></div>
                            <div style="flex:1;">
                                <div style="font-size:0.75rem;color:#555;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:6px;">Status Integritas</div>
                                <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                                    <colgroup><col style="width:auto;"><col style="width:auto;text-align:right;"></colgroup>
                                    <tbody style="color:#ccc;">${integrityRows}</tbody>
                                </table>
                            </div>
                        </div>
                        <style>
                            #version-integrity-content table td { padding:3px 0; }
                            #version-integrity-content table td:first-child { color:#888; }
                            #version-integrity-content table td:last-child { text-align:right; color:#ddd; }
                        </style>
                    `;

                } catch (err) {
                    contentEl.innerHTML = '<div style="color:#ff6b6b;text-align:center;">Error memuat informasi</div>';
                }
            }

            function closeAboutPanel() {
                if (panel && overlay) {
                    panel.classList.remove('open');
                    overlay.classList.remove('open');
                }
            }

            if (openBtn) {
                openBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openAboutPanel();
                });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', closeAboutPanel);
            }

            //"tampilkan lebih banyak"
            const moreBtn = document.getElementById('about-more-btn');
            const moreContainer = document.getElementById('about-more-container');

            if (moreBtn && moreContainer) {
                moreBtn.addEventListener('click', () => {
                    const isHidden = moreContainer.style.display === 'none';
                    if (isHidden) {
                        moreContainer.style.display = 'block';
                        moreBtn.textContent = 'tampilkan lebih sedikit';
                    } else {
                        moreContainer.style.display = 'none';
                        moreBtn.textContent = 'tampilkan lebih banyak';
                    }
                });
            }

            if (overlay) {
                overlay.addEventListener('click', closeAboutPanel);
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && panel && panel.classList.contains('open')) {
                    closeAboutPanel();
                }
            });
        }
        // langsung panggil 
        initAboutPanel();
        //------------------- ( end About Panel ) -------------------------//

        //------------------- ( Dynamic Music Player Styling ) -------------------------//
        let dynamicMusicPlayerEnabled = false;
        let lastMusicDiskSrc = '';

        function applyDynamicMusicPlayerStyling() {
            if (!dynamicMusicPlayerEnabled) return;

            const musicDisk = document.getElementById('music-disk');
            const musicControl = document.getElementById('music-control');

            if (!musicDisk || !musicControl) return;

            // Perbarui hanya jika sumber gambar berubah
            if (musicDisk.src === lastMusicDiskSrc) return;
            lastMusicDiskSrc = musicDisk.src;

            console.log('[Dynamic Music Player] Extracting colors using Vibrant.js from:', musicDisk.src);

            // Pastikan library Vibrant sudah tersedia
            if (typeof Vibrant === 'undefined') {
                console.error('[Dynamic Music Player] Vibrant.js not loaded!');
                return;
            }

            // Pakai Vibrant.js biar ekstraksi warnanya lebih mantap dan profesional
            Vibrant.from(musicDisk.src)
                .getPalette()
                .then(palette => {
                    console.log('[Dynamic Music Player] Palette extracted:', palette);

                    // Ambil warna terbaik dari palet yang dihasilkan
                    const vibrant = palette.Vibrant;
                    const darkVibrant = palette.DarkVibrant;
                    const muted = palette.Muted;
                    const darkMuted = palette.DarkMuted;
                    const lightVibrant = palette.LightVibrant;

                    // Tentukan warna utama dan warna pendamping
                    let primaryColor = vibrant || lightVibrant || muted;
                    let secondaryColor = darkVibrant || darkMuted || muted;

                    if (!primaryColor && !secondaryColor) {
                        console.warn('[Dynamic Music Player] No colors extracted, using defaults');
                        musicControl.style.background = 'linear-gradient(135deg, rgba(60, 60, 80, 0.7) 0%, rgba(20, 20, 30, 0.95) 100%)';
                        return;
                    }

                    // Ambil nilai RGB dari sampel warna
                    const primary = primaryColor ? primaryColor.getRgb() : [100, 100, 120];
                    const secondary = secondaryColor ? secondaryColor.getRgb() : primary;
                    const dark = darkMuted ? darkMuted.getRgb() : [20, 20, 30];

                    // Racik gradient-nya pake warna dari Vibrant biar cakep
                    const gradient = `linear-gradient(145deg, 
                        rgba(${Math.round(primary[0])}, ${Math.round(primary[1])}, ${Math.round(primary[2])}, 0.65) 0%, 
                        rgba(${Math.round(secondary[0])}, ${Math.round(secondary[1])}, ${Math.round(secondary[2])}, 0.45) 40%,
                        rgba(${Math.round(dark[0])}, ${Math.round(dark[1])}, ${Math.round(dark[2])}, 0.95) 100%)`;


                    musicControl.style.background = gradient;

                    // Kasih efek glow tipis berdasarkan warna vibran
                    if (vibrant) {
                        const vRgb = vibrant.getRgb();
                        musicControl.style.boxShadow = `0 0 25px rgba(${Math.round(vRgb[0])}, ${Math.round(vRgb[1])}, ${Math.round(vRgb[2])}, 0.25)`;
                    }

                    console.log('[Dynamic Music Player] Applied Vibrant.js gradient');
                })
                .catch(err => {
                    console.warn('[Dynamic Music Player] Vibrant.js extraction failed:', err);
                    musicControl.style.background = 'linear-gradient(135deg, rgba(60, 60, 80, 0.7) 0%, rgba(20, 20, 30, 0.95) 100%)';
                });
        }

        function resetMusicPlayerStyling() {
            const musicControl = document.getElementById('music-control');
            if (musicControl) {
                musicControl.style.background = '';
                musicControl.style.boxShadow = '';
                lastMusicDiskSrc = '';
            }
        }

        // Inisialisasi pendengar perubahan pada checkbox
        function initDynamicMusicPlayerStyling() {
            const checkbox = document.getElementById('enable-dynamic-music-player-checkbox');
            if (!checkbox) {
                console.warn('[Dynamic Music Player] Checkbox not found');
                return;
            }

            checkbox.addEventListener('change', (e) => {
                dynamicMusicPlayerEnabled = e.target.checked;
                console.log('[Dynamic Music Player] Enabled:', dynamicMusicPlayerEnabled);

                if (dynamicMusicPlayerEnabled) {
                    applyDynamicMusicPlayerStyling();
                } else {
                    resetMusicPlayerStyling();
                }
            });

            // Pantau perubahan sumber gambar pada music-disk pakai MutationObserver biar gak lolos
            const musicDisk = document.getElementById('music-disk');
            if (musicDisk) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                            if (dynamicMusicPlayerEnabled) {
                                // delay kecil buat mastiin gambar udah di load
                                setTimeout(applyDynamicMusicPlayerStyling, 100);
                            }
                        }
                    });
                });

                observer.observe(musicDisk, { attributes: true });
                console.log('[Dynamic Music Player] Observer attached to music-disk');
            }

            // juga untuk memastikan gambar sudah di load
            if (musicDisk) {
                musicDisk.addEventListener('load', () => {
                    if (dynamicMusicPlayerEnabled) {
                        applyDynamicMusicPlayerStyling();
                    }
                });
            }

            console.log('[Dynamic Music Player] Initialized with Vibrant.js');
        }

        // Panggil fungsi inisialisasi
        initDynamicMusicPlayerStyling();
        //------------------- ( end Dynamic Music Player Styling ) -------------------------//

        //------------------- ( notifikasi global ) -------------------------//
        function showNotification(message, type = 'notification-success') {
            let resolvedMessage = message;
            let resolvedType = type;
            let resolvedDetails;

            if (resolvedMessage && typeof resolvedMessage === 'object' && !Array.isArray(resolvedMessage)) {
                resolvedType = resolvedMessage.type || resolvedType;
                resolvedDetails = resolvedMessage.details;
                resolvedMessage = resolvedMessage.message ?? '';
            } else {
                resolvedDetails = arguments.length >= 3 ? arguments[2] : undefined;
            }

            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                document.body.appendChild(container);
            }

            const iconText = (resolvedType || '').includes('notification-error')
                ? ''
                : (resolvedType || '').includes('notification-warning')
                    ? ''
                    : '';

            const notification = document.createElement('div');
            notification.className = `notification ${resolvedType || 'notification-success'}`;

            const iconEl = document.createElement('span');
            iconEl.className = 'notification-icon';
            iconEl.textContent = iconText;

            const contentEl = document.createElement('div');
            contentEl.className = 'notification-content';

            const messageEl = document.createElement('div');
            messageEl.className = 'notification-message';
            messageEl.textContent = String(resolvedMessage ?? '');
            contentEl.appendChild(messageEl);

            if (Array.isArray(resolvedDetails) && resolvedDetails.length > 0) {
                const detailsEl = document.createElement('ul');
                detailsEl.className = 'notification-details';
                resolvedDetails
                    .filter((v) => v !== null && v !== undefined && String(v).trim().length > 0)
                    .forEach((detail) => {
                        const li = document.createElement('li');
                        li.textContent = String(detail);
                        detailsEl.appendChild(li);
                    });
                if (detailsEl.childNodes.length > 0) contentEl.appendChild(detailsEl);
            }

            notification.appendChild(iconEl);
            notification.appendChild(contentEl);
            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 5500);
        }

        function buildSettingsSummaryLines(partial) {
            if (!partial || typeof partial !== 'object') return [];

            const lines = [];
            const pushBool = (label, value) => {
                if (value === undefined) return;
                lines.push(`${label}: ${value ? 'ON' : 'OFF'}`);
            };

            if (Number.isFinite(partial.windowWidth) && Number.isFinite(partial.windowHeight)) {
                lines.push(`Resolution: ${partial.windowWidth}x${partial.windowHeight}`);
            }

            pushBool('Fullscreen', partial.isFullscreen);
            pushBool('Idle Return', partial.idleReturn);
            pushBool('Snow Effect', partial.snowFeatureEnabled);
            pushBool('WebGPU Acceleration', partial.webgpuEnabled);
            if (partial.webgpuVisualizerStyle !== undefined && partial.webgpuVisualizerStyle !== null && String(partial.webgpuVisualizerStyle).trim() !== '') {
                lines.push(`WebGPU Visualizer Style: ${partial.webgpuVisualizerStyle}`);
            }
            pushBool('Mini Player', partial.miniPlayerFeatureEnabled);
            pushBool('Discord RPC', partial.rpcEnabled);
            pushBool('Log Overlay', partial.showLogOverlay);

            if (partial.darkness !== undefined && partial.darkness !== null && String(partial.darkness).trim() !== '') {
                lines.push(`Wallpaper Darkness: ${partial.darkness}%`);
            }
            pushBool('Follow Music Title', partial.followMusic);
            pushBool('Hidden Wallpaper Settings', partial.enableHiddenWallpaperSettings);

            pushBool('Ad Skipper', partial.adSkipperEnabled);
            pushBool('Auto Mute Ads', partial.autoMuteAds);
            pushBool('Auto Skip Ads', partial.autoSkipAds);
            pushBool('Dynamic Music Player Styling', partial.dynamicMusicPlayerStylingEnabled);

            return lines;
        }

        function buildSettingsDiffLines(before, after) {
            if (!after || typeof after !== 'object') return [];

            const toFiniteNumber = (v) => {
                const n = Number(v);
                return Number.isFinite(n) ? n : undefined;
            };

            const normalizeBool = (v) => {
                if (v === true || v === false) return v;
                if (v === 'true') return true;
                if (v === 'false') return false;
                return undefined;
            };

            const isDifferent = (a, b) => {
                // jika kita tidak memiliki baseline, mari kita lihat apakah baseline itu ada atau tidak.
                if (a === undefined) return b !== undefined;
                return a !== b;
            };

            const beforeObj = (before && typeof before === 'object') ? before : {};
            const afterObj = after;
            const lines = [];

            const beforeW = toFiniteNumber(beforeObj.windowWidth);
            const beforeH = toFiniteNumber(beforeObj.windowHeight);
            const afterW = toFiniteNumber(afterObj.windowWidth);
            const afterH = toFiniteNumber(afterObj.windowHeight);

            if (afterW !== undefined && afterH !== undefined) {
                const beforeRes = (beforeW !== undefined && beforeH !== undefined) ? `${beforeW}x${beforeH}` : undefined;
                const afterRes = `${afterW}x${afterH}`;
                if (isDifferent(beforeRes, afterRes)) lines.push(`Resolution: ${afterRes}`);
            }

            const diffBool = (key, label) => {
                const b = normalizeBool(beforeObj[key]);
                const a = normalizeBool(afterObj[key]);
                if (a === undefined) return;
                if (isDifferent(b, a)) lines.push(`${label}: ${a ? 'ON' : 'OFF'}`);
            };

            const diffText = (key, label) => {
                const b = (beforeObj[key] === undefined || beforeObj[key] === null) ? undefined : String(beforeObj[key]);
                const a = (afterObj[key] === undefined || afterObj[key] === null) ? undefined : String(afterObj[key]);
                if (a === undefined || a.trim() === '') return;
                if (isDifferent(b, a)) lines.push(`${label}: ${a}`);
            };

            const diffPercent = (key, label) => {
                const b = toFiniteNumber(beforeObj[key]);
                const a = toFiniteNumber(afterObj[key]);
                if (a === undefined) return;
                if (isDifferent(b, a)) lines.push(`${label}: ${a}%`);
            };

            diffBool('isFullscreen', 'Fullscreen');
            diffBool('idleReturn', 'Idle Return');
            diffBool('snowFeatureEnabled', 'Snow Effect');
            diffBool('webgpuEnabled', 'WebGPU Acceleration');
            diffText('webgpuVisualizerStyle', 'WebGPU Visualizer Style');
            diffBool('miniPlayerFeatureEnabled', 'Mini Player');
            diffBool('rpcEnabled', 'Discord RPC');
            diffBool('showLogOverlay', 'Log Overlay');

            diffPercent('darkness', 'Wallpaper Darkness');
            diffBool('followMusic', 'Follow Music Title');
            diffBool('enableHiddenWallpaperSettings', 'Hidden Wallpaper Settings');

            diffBool('adSkipperEnabled', 'Ad Skipper');
            diffBool('autoMuteAds', 'Auto Mute Ads');
            diffBool('autoSkipAds', 'Auto Skip Ads');
            diffBool('dynamicMusicPlayerStylingEnabled', 'Dynamic Music Player Styling');

            diffBool('enableVideoWallpaper', 'Video Wallpaper');
            diffBool('enableGifOverlay', 'Free GIF Overlay');
            diffBool('gameGifInteractionLock', 'GIF Interaction Lock');

            diffBool('miniPlayerHideOnCursor', 'Mini Player Hide on Cursor');
            diffBool('overlayEnabled', 'In-Game Overlay');
            diffBool('dynamicThemeEnabled', 'Dynamic ytMusic Styling');
            diffText('dynamicThemeMode', 'Dynamic Theme Mode');

            return lines;
        }
        //------------------- ( end notifikasi global ) -------------------------//
        // ================================ ( End Utilitas UI ) ================================ //


        // ================================ ( Pengaturan User ) ================================ //
        //------------------- ( inisialisasi & load saat DOM ready ) -------------------------//
        document.addEventListener("DOMContentLoaded", () => {
            const volumeSlider = document.getElementById("volume-slider");
            const wallpaperSelect = document.getElementById("wallpaper-name");

            // Get elements from the hidden wallpaper settings panel
            const followMusicCheckboxHidden = document.getElementById("follow-music-title");
            const darknessSliderHidden = document.getElementById("wallpaper-darkness");
            const blurSliderHidden = document.getElementById("wallpaper-blur");
            const grayscaleSliderHidden = document.getElementById("wallpaper-grayscale");
            const zoomSliderHidden = document.getElementById("wallpaper-zoom");
            const autoChangeCheckboxHidden = document.getElementById("auto-change-wallpaper");
            const autoChangeIntervalInputHidden = document.getElementById("auto-change-interval");
            const randomOrderCheckboxHidden = document.getElementById("random-wallpaper-order");
            const wallpaperSettingsPanel = document.getElementById('wallpaper-settings');

            // Get elements from the options modal wallpaper pane
            const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
            const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
            const optionsPaneBlurSlider = document.querySelector('#wallpaper-options-pane .wallpaper-blur');
            const optionsPaneGrayscaleSlider = document.querySelector('#wallpaper-options-pane .wallpaper-grayscale');
            const optionsPaneZoomSlider = document.querySelector('#wallpaper-options-pane .wallpaper-zoom');
            const optionsPaneAutoChangeCheckbox = document.querySelector('#wallpaper-options-pane .auto-change-wallpaper');
            const optionsPaneAutoChangeIntervalInput = document.querySelector('#wallpaper-options-pane .auto-change-interval');
            const optionsPaneRandomOrderCheckbox = document.querySelector('#wallpaper-options-pane .random-wallpaper-order');
            const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings');

            const snowEffectCheckbox = document.getElementById('snow-effect-checkbox');
            const miniPlayerEffectCheckbox = document.getElementById('mini-player-effect-checkbox');

            const adSkipperMainCheckbox = document.getElementById('enable-ad-skipper-checkbox');
            const adSkipperSubBox = document.getElementById('ad-skipper-sub-options');
            const autoMuteCheckbox = document.getElementById('auto-mute-ads-checkbox');
            const autoSkipCheckbox = document.getElementById('auto-skip-ads-checkbox');

            // GIF Overlay elements
            const enableGifOverlayCheckbox = document.getElementById('enable-gif-overlay-checkbox');
            const gifOverlaySubOptions = document.getElementById('gif-overlay-sub-options');
            const addGameGifBtn = document.getElementById('game-add-gif-btn');
            const gameGifListContainer = document.getElementById('game-gif-list-container');
            const gameGifInteractionLock = document.getElementById('game-gif-interaction-lock');
            const gameGifSettingsModal = document.getElementById('game-gif-settings-modal');

            // Preset GIF elements untuk Game Mode
            const gameGifPresetSelect = document.getElementById('game-gif-preset-select');
            const gameGifPresetApplyBtn = document.getElementById('game-gif-preset-apply-btn');
            let gamePresetsList = []; // Daftar preset untuk game mode

            // State untuk GIF Overlay di Game mode
            let gameGifSettingsMap = new Map(); // Map<overlayId, {condition, value, opacity, rotation, hideOnCursor}>
            let gameCurrentMusicInfo = { title: '', artist: '', isPlaying: false };
            let gameGifUIRestored = false;

            // Ambil pengaturan yang tersimpan jika ada
            if (sessionStorage.getItem("savedVolume")) {
                volumeSlider.value = sessionStorage.getItem("savedVolume");
                document.getElementById("background-audio").volume = parseFloat(sessionStorage.getItem("savedVolume"));
            }

            if (sessionStorage.getItem("savedWallpaper")) {
                wallpaperSelect.textContent = `Current: ${sessionStorage.getItem("savedWallpaper")}`;
            }

            function applyWallpaperStyles() {
                const darkness = sessionStorage.getItem("savedDarkness") || 30;
                const blur = sessionStorage.getItem("savedBlur") || 0;
                const grayscale = sessionStorage.getItem("savedGrayscale") || 0;
                const zoom = sessionStorage.getItem("savedZoom") || 1;

                const filterValue = `brightness(${100 - darkness}%) blur(${blur}px) grayscale(${grayscale}%)`;
                const transformValue = `scale(${zoom})`;

                const wallpaperVideo = document.getElementById("character-background");
                const wallpaperImage = document.getElementById("character-background-image");

                if (wallpaperVideo) {
                    wallpaperVideo.style.filter = filterValue;
                    wallpaperVideo.style.transform = transformValue;
                }
                if (wallpaperImage) {
                    wallpaperImage.style.filter = filterValue;
                    wallpaperImage.style.transform = transformValue;
                }
            }

            if (sessionStorage.getItem("savedDarkness")) {
                const savedDarknessValue = sessionStorage.getItem("savedDarkness");
                if (darknessSliderHidden) darknessSliderHidden.value = savedDarknessValue;
                if (optionsPaneDarknessSlider) optionsPaneDarknessSlider.value = savedDarknessValue;
            }
            if (sessionStorage.getItem("savedBlur")) {
                const savedBlurValue = sessionStorage.getItem("savedBlur");
                if (blurSliderHidden) blurSliderHidden.value = savedBlurValue;
                if (optionsPaneBlurSlider) optionsPaneBlurSlider.value = savedBlurValue;
            }
            if (sessionStorage.getItem("savedGrayscale")) {
                const savedGrayscaleValue = sessionStorage.getItem("savedGrayscale");
                if (grayscaleSliderHidden) grayscaleSliderHidden.value = savedGrayscaleValue;
                if (optionsPaneGrayscaleSlider) optionsPaneGrayscaleSlider.value = savedGrayscaleValue;
            }
            if (sessionStorage.getItem("savedZoom")) {
                const savedZoomValue = sessionStorage.getItem("savedZoom");
                if (zoomSliderHidden) zoomSliderHidden.value = savedZoomValue;
                if (optionsPaneZoomSlider) optionsPaneZoomSlider.value = savedZoomValue;
            }

            if (sessionStorage.getItem("savedAutoChangeWallpaper") === "true") {
                if (autoChangeCheckboxHidden) autoChangeCheckboxHidden.checked = true;
                if (optionsPaneAutoChangeCheckbox) optionsPaneAutoChangeCheckbox.checked = true;
                startAutoChangeWallpaper();
            }
            if (sessionStorage.getItem("savedAutoChangeInterval")) {
                const savedInterval = sessionStorage.getItem("savedAutoChangeInterval");
                if (autoChangeIntervalInputHidden) autoChangeIntervalInputHidden.value = savedInterval;
                if (optionsPaneAutoChangeIntervalInput) optionsPaneAutoChangeIntervalInput.value = savedInterval;
            }
            if (sessionStorage.getItem("savedRandomWallpaperOrder") === "true") {
                if (randomOrderCheckboxHidden) randomOrderCheckboxHidden.checked = true;
                if (optionsPaneRandomOrderCheckbox) optionsPaneRandomOrderCheckbox.checked = true;
            }

            applyWallpaperStyles();

            if (sessionStorage.getItem("savedFollowMusic") === "true") {
                if (followMusicCheckboxHidden) followMusicCheckboxHidden.checked = true;
                if (optionsPaneFollowMusicCheckbox) optionsPaneFollowMusicCheckbox.checked = true;
            }

            // Memuat dan menerapkan status dari checkbox baru
            const savedEnableHiddenSettings = sessionStorage.getItem("savedEnableHiddenSettings");
            if (savedEnableHiddenSettings !== null) { // Cek dulu apakah ada di sessionStorage
                const isEnabled = savedEnableHiddenSettings === "true";
                if (enableHiddenSettingsCheckbox) enableHiddenSettingsCheckbox.checked = isEnabled;
                // Terapkan pengaturannya segera
                if (wallpaperSettingsPanel) {
                    if (isEnabled) {
                        wallpaperSettingsPanel.classList.remove('disabled');
                    } else {
                        wallpaperSettingsPanel.classList.add('disabled');
                    }
                }
            } else {
                // Kalau gak ada di sessionStorage, bikin default-nya mati dan simpan
                if (enableHiddenSettingsCheckbox) enableHiddenSettingsCheckbox.checked = false;
                sessionStorage.setItem("savedEnableHiddenSettings", false);
                if (wallpaperSettingsPanel) wallpaperSettingsPanel.classList.add('disabled');
            }

            // Memuat dan menerapkan pengaturan efek salju
            const savedSnowEffect = sessionStorage.getItem('savedSnowEffect');
            if (savedSnowEffect !== null) {
                const isSnowEnabled = savedSnowEffect === 'true';
                if (snowEffectCheckbox) snowEffectCheckbox.checked = isSnowEnabled;
                ipcRenderer.send('set-snow-feature-enabled', isSnowEnabled);
                if (isSnowEnabled) {
                    ipcRenderer.send('show-snow-effect');
                } else {
                    ipcRenderer.send('hide-snow-effect');
                }
            } else {
                // Bikin default-nya mati kalau gak ada di sessionStorage, terus simpan
                if (snowEffectCheckbox) snowEffectCheckbox.checked = false;
                sessionStorage.setItem('savedSnowEffect', false);
                ipcRenderer.send('set-snow-feature-enabled', false);
                ipcRenderer.send('hide-snow-effect');
            }

            if (adSkipperMainCheckbox) {
                adSkipperMainCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;

                    // Toggle tampilan sub-opsi
                    if (isEnabled) {
                        adSkipperSubBox.classList.add('visible');
                    } else {
                        adSkipperSubBox.classList.remove('visible');
                    }

                    // Simpan setting utama
                    sessionStorage.setItem('savedAdSkipper', isEnabled);
                    // Kita akan kirim ke main process nanti saat tombol Apply ditekan, 
                    // atau bisa juga realtime seperti kode sebelumnya.
                });
            }

            function updateAdSkipperRealtime() {
                // Ambil status terbaru dari semua checkbox terkait
                const isSkipperEnabled = document.getElementById('enable-ad-skipper-checkbox').checked;
                const isMuteEnabled = autoMuteCheckbox.checked;
                const isSkipEnabled = autoSkipCheckbox.checked;

                // Kirim ke Main Process Untuk disimpan ke userSettings
                ipcRenderer.send('save-settings', {
                    adSkipperEnabled: isSkipperEnabled,
                    autoMuteAds: isMuteEnabled,
                    autoSkipAds: isSkipEnabled
                });

                // Kirim LANGSUNG ke Webview (Agar efeknya instan tanpa reload)
                const webview = document.getElementById('external-webview');
                if (webview && webview.getWebContentsId()) {
                    console.log('[Settings] Mengirim update AdSkipper Realtime ke Webview...');
                    webview.send('setting-update', {
                        adSkipperEnabled: isSkipperEnabled,
                        autoMuteAds: isMuteEnabled,
                        autoSkipAds: isSkipEnabled
                    });
                }
            }

            // Pasang Listener 'change' agar fungsi di atas jalan setiap kali diklik
            if (autoMuteCheckbox) {
                autoMuteCheckbox.addEventListener('change', updateAdSkipperRealtime);
            }

            if (autoSkipCheckbox) {
                autoSkipCheckbox.addEventListener('change', updateAdSkipperRealtime);
            }

            // yang ini buat return title screen idle
            document.getElementById('idle-return-checkbox').addEventListener('change', (e) => {
                sessionStorage.setItem('savedIdleReturn', e.target.checked);
                ipcRenderer.send('save-settings', { idleReturn: e.target.checked });

                if (e.target.checked) {
                    resetIdleTimer();
                } else {
                    clearTimeout(idleTimer);
                }
            });

            if (volumeSlider) {
                volumeSlider.addEventListener("input", (e) => {
                    const newVolume = parseFloat(e.target.value);
                    // Kirim nilai baru ke main process, jangan langsung terapkan di sini
                    ipcRenderer.send('set-global-volume', newVolume);
                });
            }

            // --- untuk menerapkan volume global ---
            function applyGlobalVolume(volume) {
                // Terapkan ke semua elemen audio di halaman ini
                document.querySelectorAll('audio').forEach(audioEl => {
                    audioEl.volume = volume;
                });

                // Terapkan ke semua elemen video di halaman ini
                document.querySelectorAll('video').forEach(videoEl => {
                    videoEl.volume = volume;
                });

                // Update posisi slider volume agar sesuai
                const volumeSlider = document.getElementById("volume-slider");
                if (volumeSlider) {
                    volumeSlider.value = volume;
                }

                // --- Kirim pesan ke dalam webview ---
                const webview = document.getElementById('external-webview');
                if (webview && webview.getWebContentsId()) {
                    webview.send('set-webview-volume', volume);
                }

                console.log(`Renderer menerapkan volume global: ${volume}`);
            }

            // --- Listener untuk volume siaran dari main.js ---
            ipcRenderer.on('global-volume-changed', (event, volume) => {
                currentGlobalVolume = volume;
                applyGlobalVolume(volume);
            });

            // Wallpaper saat diubah
            wallpaperSelect.addEventListener("change", (e) => {
                sessionStorage.setItem("savedWallpaper", e.target.textContent.replace("Current: ", ""));
            });

            // Pendengar untuk pengaturan wallpaper yang tersembunyi
            if (darknessSliderHidden) {
                darknessSliderHidden.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedDarkness", e.target.value);
                    ipcRenderer.send("save-settings", { darkness: e.target.value });
                    // Biar slider di panel opsi tetap sinkron
                    if (optionsPaneDarknessSlider) optionsPaneDarknessSlider.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (blurSliderHidden) {
                blurSliderHidden.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedBlur", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperBlur: e.target.value });
                    if (optionsPaneBlurSlider) optionsPaneBlurSlider.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (grayscaleSliderHidden) {
                grayscaleSliderHidden.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedGrayscale", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperGrayscale: e.target.value });
                    if (optionsPaneGrayscaleSlider) optionsPaneGrayscaleSlider.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (zoomSliderHidden) {
                zoomSliderHidden.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedZoom", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperZoom: e.target.value });
                    if (optionsPaneZoomSlider) optionsPaneZoomSlider.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (autoChangeCheckboxHidden) {
                autoChangeCheckboxHidden.addEventListener("change", (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem("savedAutoChangeWallpaper", isEnabled);
                    ipcRenderer.send("save-settings", { autoChangeWallpaper: isEnabled });
                    if (optionsPaneAutoChangeCheckbox) optionsPaneAutoChangeCheckbox.checked = isEnabled;

                    if (isEnabled) {
                        startAutoChangeWallpaper();
                    } else {
                        stopAutoChangeWallpaper();
                    }
                });
            }
            if (autoChangeIntervalInputHidden) {
                autoChangeIntervalInputHidden.addEventListener("change", (e) => {
                    const interval = e.target.value;
                    sessionStorage.setItem("savedAutoChangeInterval", interval);
                    ipcRenderer.send("save-settings", { autoChangeInterval: interval });
                    if (optionsPaneAutoChangeIntervalInput) optionsPaneAutoChangeIntervalInput.value = interval;

                    if (sessionStorage.getItem("savedAutoChangeWallpaper") === "true") {
                        startAutoChangeWallpaper(); // Restart dengan interval baru
                    }
                });
            }
            if (randomOrderCheckboxHidden) {
                randomOrderCheckboxHidden.addEventListener("change", (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem("savedRandomWallpaperOrder", isEnabled);
                    ipcRenderer.send("save-settings", { randomWallpaperOrder: isEnabled });
                    if (optionsPaneRandomOrderCheckbox) optionsPaneRandomOrderCheckbox.checked = isEnabled;
                });
            }

            if (followMusicCheckboxHidden) {
                followMusicCheckboxHidden.addEventListener("change", (e) => {
                    sessionStorage.setItem("savedFollowMusic", e.target.checked);
                    ipcRenderer.send("save-settings", { followMusic: e.target.checked });
                    if (optionsPaneFollowMusicCheckbox) optionsPaneFollowMusicCheckbox.checked = e.target.checked;
                });
            }

            // options modal wallpaper
            if (optionsPaneDarknessSlider) {
                optionsPaneDarknessSlider.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedDarkness", e.target.value);
                    ipcRenderer.send("save-settings", { darkness: e.target.value });
                    if (darknessSliderHidden) darknessSliderHidden.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (optionsPaneBlurSlider) {
                optionsPaneBlurSlider.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedBlur", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperBlur: e.target.value });
                    if (blurSliderHidden) blurSliderHidden.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (optionsPaneGrayscaleSlider) {
                optionsPaneGrayscaleSlider.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedGrayscale", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperGrayscale: e.target.value });
                    if (grayscaleSliderHidden) grayscaleSliderHidden.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (optionsPaneZoomSlider) {
                optionsPaneZoomSlider.addEventListener("input", (e) => {
                    sessionStorage.setItem("savedZoom", e.target.value);
                    ipcRenderer.send("save-settings", { wallpaperZoom: e.target.value });
                    if (zoomSliderHidden) zoomSliderHidden.value = e.target.value;
                    applyWallpaperStyles();
                });
            }
            if (optionsPaneAutoChangeCheckbox) {
                optionsPaneAutoChangeCheckbox.addEventListener("change", (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem("savedAutoChangeWallpaper", isEnabled);
                    ipcRenderer.send("save-settings", { autoChangeWallpaper: isEnabled });
                    if (autoChangeCheckboxHidden) autoChangeCheckboxHidden.checked = isEnabled;

                    if (isEnabled) {
                        startAutoChangeWallpaper();
                    } else {
                        stopAutoChangeWallpaper();
                    }
                });
            }
            if (optionsPaneAutoChangeIntervalInput) {
                optionsPaneAutoChangeIntervalInput.addEventListener("change", (e) => {
                    const interval = e.target.value;
                    sessionStorage.setItem("savedAutoChangeInterval", interval);
                    ipcRenderer.send("save-settings", { autoChangeInterval: interval });
                    if (autoChangeIntervalInputHidden) autoChangeIntervalInputHidden.value = interval;

                    if (sessionStorage.getItem("savedAutoChangeWallpaper") === "true") {
                        startAutoChangeWallpaper(); // Restart 
                    }
                });
            }
            if (optionsPaneRandomOrderCheckbox) {
                optionsPaneRandomOrderCheckbox.addEventListener("change", (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem("savedRandomWallpaperOrder", isEnabled);
                    ipcRenderer.send("save-settings", { randomWallpaperOrder: isEnabled });
                    if (randomOrderCheckboxHidden) randomOrderCheckboxHidden.checked = isEnabled;
                });
            }

            if (optionsPaneFollowMusicCheckbox) {
                optionsPaneFollowMusicCheckbox.addEventListener("change", (e) => {
                    sessionStorage.setItem("savedFollowMusic", e.target.checked);
                    ipcRenderer.send("save-settings", { followMusic: e.target.checked });
                    // Biar checkbox di panel tersembunyi tetap sinkron
                    if (followMusicCheckboxHidden) followMusicCheckboxHidden.checked = e.target.checked;
                });
            }

            // Checkbox baru untuk mengaktifkan pengaturan tersembunyi
            if (enableHiddenSettingsCheckbox) {
                enableHiddenSettingsCheckbox.addEventListener("change", (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem("savedEnableHiddenSettings", isEnabled);
                    ipcRenderer.send("save-settings", { enableHiddenWallpaperSettings: isEnabled }); // Simpan pengaturan

                    if (wallpaperSettingsPanel) {
                        if (isEnabled) {
                            wallpaperSettingsPanel.classList.remove('disabled');
                            // Pasang lagi event hover-nya
                            triggerZone.addEventListener('mouseenter', showPanel);
                            triggerZone.addEventListener('mouseleave', hidePanel);
                            wallpaperSettings.addEventListener('mouseenter', showPanel);
                            wallpaperSettings.addEventListener('mouseleave', hidePanel);
                        } else {
                            wallpaperSettingsPanel.classList.add('disabled');
                            wallpaperSettingsPanel.classList.remove('show');

                            triggerZone.removeEventListener('mouseenter', showPanel);
                            triggerZone.removeEventListener('mouseleave', hidePanel);
                            wallpaperSettings.removeEventListener('mouseenter', showPanel);
                            wallpaperSettings.removeEventListener('mouseleave', hidePanel);
                        }
                    }
                });
            }

            if (snowEffectCheckbox) {
                snowEffectCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem('savedSnowEffect', isEnabled);
                    ipcRenderer.send('set-snow-feature-enabled', isEnabled);
                    ipcRenderer.send('save-settings', { snowFeatureEnabled: isEnabled });
                    if (isEnabled) {
                        ipcRenderer.send('show-snow-effect');
                    } else {
                        ipcRenderer.send('hide-snow-effect');
                    }
                });
            }

            const savedMiniPlayerEffect = sessionStorage.getItem('savedMiniPlayerEffect');
            if (savedMiniPlayerEffect !== null) {
                const isMiniPlayerEnabled = savedMiniPlayerEffect === 'true';
                if (miniPlayerEffectCheckbox) miniPlayerEffectCheckbox.checked = isMiniPlayerEnabled;
                ipcRenderer.send('set-mini-player-feature-enabled', isMiniPlayerEnabled);
            }

            if (miniPlayerEffectCheckbox) {
                miniPlayerEffectCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem('savedMiniPlayerEffect', isEnabled);
                    ipcRenderer.send('set-mini-player-feature-enabled', isEnabled);
                    ipcRenderer.send('save-settings', { miniPlayerFeatureEnabled: isEnabled });
                });
            }

            // untuk Hide on Cursor checkbox
            const miniPlayerHideCheckbox = document.getElementById('mini-player-hide-on-cursor');
            console.log('[DEBUG] miniPlayerHideCheckbox element:', miniPlayerHideCheckbox);
            if (miniPlayerHideCheckbox) {
                miniPlayerHideCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    console.log('[DEBUG] Hide on Cursor checkbox changed:', isEnabled);
                    ipcRenderer.send('set-mini-player-hide-on-cursor', isEnabled);
                    ipcRenderer.send('save-settings', { miniPlayerHideOnCursor: isEnabled });
                });
                console.log('[DEBUG] Hide on Cursor listener attached successfully');
            } else {
                console.warn('[DEBUG] miniPlayerHideCheckbox NOT FOUND!');
            }

            //------------------- ( GIF Overlay Handler untuk Game Mode ) -------------------------//

            // === Fungsi Preset GIF untuk Game Mode ===

            // Muat daftar preset dari main process
            async function loadGamePresetsList() {
                try {
                    gamePresetsList = await ipcRenderer.invoke('gif-preset-list');
                    console.log(`[Game Mode] Memuat ${gamePresetsList.length} preset GIF`);
                    renderGamePresetDropdown();

                    // Sync dropdown dengan preset aktif
                    try {
                        const activeId = await ipcRenderer.invoke('gif-preset-get-active');
                        if (gameGifPresetSelect) {
                            gameGifPresetSelect.value = activeId || "";
                            console.log(`[Game Mode] Preset dropdown synced to: ${activeId || 'None'}`);
                        }
                    } catch (err) {
                        console.warn('[Game Mode] Failed to sync active preset:', err);
                    }
                } catch (e) {
                    console.error('[Game Mode] Gagal memuat daftar preset:', e);
                }
            }

            // Render dropdown preset
            function renderGamePresetDropdown() {
                if (!gameGifPresetSelect) return;
                gameGifPresetSelect.innerHTML = '<option value="">-- Pilih Preset --</option>';

                gamePresetsList.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.presetId;
                    option.textContent = `${preset.name} (${preset.overlays.length} GIF)`;
                    gameGifPresetSelect.appendChild(option);
                });
            }

            // Terapkan preset yang dipilih
            async function applyGameSelectedPreset() {
                const selectedId = gameGifPresetSelect.value;
                if (!selectedId) {
                    alert('Pilih preset terlebih dahulu');
                    return;
                }

                const result = await ipcRenderer.invoke('gif-preset-apply', selectedId);
                if (result.success) {
                    console.log('[Game Mode] Preset berhasil diterapkan');

                    // Reload UI - hapus semua row dan muat ulang dari settings
                    gameGifListContainer.innerHTML = '';
                    gameGifSettingsMap.clear();

                    // Muat settings baru
                    const settings = await ipcRenderer.invoke('gif-settings-load');
                    if (settings.gifOverlays && Array.isArray(settings.gifOverlays)) {
                        settings.gifOverlays.forEach(overlay => {
                            const row = createGameGifInputRow(overlay.id, overlay.path, overlay.settings);
                            gameGifListContainer.appendChild(row);
                        });
                    }

                    if (result.missingFiles && result.missingFiles.length > 0) {
                        alert(`Peringatan: ${result.missingFiles.length} file GIF tidak ditemukan dan dilewati.`);
                    }
                } else {
                    alert(`Gagal menerapkan preset: ${result.error}`);
                }
            }

            // Event listener untuk preset
            if (gameGifPresetApplyBtn) {
                gameGifPresetApplyBtn.addEventListener('click', applyGameSelectedPreset);
            }

            // Muat daftar preset saat startup
            loadGamePresetsList();

            // Fungsi untuk membuat row GIF baru di Game mode
            function createGameGifInputRow(overlayId = null, gifPath = '', settings = null) {
                const row = document.createElement('div');
                row.className = 'game-gif-input-row';
                if (overlayId) row.dataset.overlayId = overlayId.toString();

                const fileName = gifPath ? gifPath.split(/[\\/]/).pop() : '';

                // Cek apakah ada kondisi yang sudah di-set (bukan 'always')
                const hasCondition = settings && settings.condition && settings.condition !== 'always';

                row.innerHTML = `
                    <input type="text" class="game-gif-path" value="${fileName}" placeholder="Pilih file GIF..." readonly />
                    <button type="button" class="game-gif-browse-btn" title="Pilih file GIF"></button>
                    <button type="button" class="game-gif-settings-btn${hasCondition ? ' has-condition' : ''}" title="Pengaturan kondisi tampil"></button>
                    <button type="button" class="game-gif-remove-btn" title="Hapus GIF"></button>

                `;

                // Simpan settings ke map jika ada
                const keyId = overlayId ? overlayId.toString() : null;
                if (keyId && settings) {
                    gameGifSettingsMap.set(keyId, settings);
                    console.log(`[GIF Overlay] Stored settings for overlay #${keyId}:`, settings);
                }

                // Handler tombol browse - dengan copy ke folder internal
                row.querySelector('.game-gif-browse-btn').addEventListener('click', async () => {
                    const result = await ipcRenderer.invoke('gif-overlay-browse-file');
                    if (result && result.filePath) {
                        // Copy file ke folder internal aplikasi
                        const importResult = await ipcRenderer.invoke('gif-overlay-import-file', result.filePath);

                        if (!importResult.success) {
                            console.error('[GIF Overlay] Gagal mengimport file:', importResult.error);
                            alert(`Gagal mengimport file: ${importResult.error}`);
                            return;
                        }

                        // Tampilkan peringatan jika file besar (hanya log, tidak memblokir)
                        if (importResult.warning) {
                            console.warn(`[GIF Overlay] ${importResult.warning}`);
                        }

                        const internalPath = importResult.internalPath;
                        const newFileName = internalPath.split(/[\\/]/).pop();
                        row.querySelector('.game-gif-path').value = newFileName;

                        // Jika belum punya overlayId, buat overlay baru
                        if (!row.dataset.overlayId) {
                            const newOverlayId = await ipcRenderer.invoke('create-new-gif-overlay', internalPath);
                            if (newOverlayId) {
                                row.dataset.overlayId = newOverlayId.toString();
                                // Inisialisasi settings default
                                gameGifSettingsMap.set(newOverlayId.toString(), { condition: 'always', value: '', opacity: 1, rotation: 0, hideOnCursor: false });
                            }
                        } else {
                            // Update path overlay yang sudah ada
                            ipcRenderer.send('set-gif-overlay-image-by-id', { id: parseInt(row.dataset.overlayId), path: internalPath });
                        }
                    }
                });

                // Handler tombol settings ()
                row.querySelector('.game-gif-settings-btn').addEventListener('click', (e) => {
                    e.stopPropagation();  // Mencegah event bubbling
                    console.log('[GIF Settings] Button diklik, membuka modal...');
                    openGameGifSettingsModal(row);
                });

                // Handler tombol hapus
                row.querySelector('.game-gif-remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Mencegah event bubbling ke modal close listener
                    const overlayIdToRemove = row.dataset.overlayId;
                    if (overlayIdToRemove) {
                        console.log(`[Game Mode] Menghapus GIF overlay ID: ${overlayIdToRemove}`);
                        ipcRenderer.send('close-gif-overlay-by-id', {
                            id: parseInt(overlayIdToRemove),
                            deleteFile: true  // Hapus file dari gif-storage
                        });
                        gameGifSettingsMap.delete(overlayIdToRemove);
                    }
                    row.remove();
                    updateGameGifStatus();
                });

                return row;
            }

            // Fungsi untuk update status bar GIF di Game mode
            function updateGameGifStatus() {
                const statusEl = document.querySelector('.game-gif-status');
                if (!statusEl) return;
                const count = document.querySelectorAll('.game-gif-input-row').length;
                statusEl.textContent = `${count} GIF aktif`;
            }



            // Fungsi untuk sinkronisasi info musik terkini dari player (Webview atau Local)
            function syncGameCurrentMusicInfo() {
                try {
                    // Cek variabel global yang mungkin ada
                    const _controlMode = typeof controlMode !== 'undefined' ? controlMode : 'local';

                    if (_controlMode === 'webview') {
                        // Ambil info dari elemen UI atau variabel global webview
                        const titleEl = document.getElementById('now-playing-song');
                        // Prioritas: elemen UI -> legacy variable -> string kosong
                        const title = titleEl ? titleEl.textContent : (typeof latestWebviewTitle !== 'undefined' ? latestWebviewTitle : '');
                        const artist = typeof webviewArtist !== 'undefined' ? webviewArtist : '';

                        gameCurrentMusicInfo.title = title || '';
                        gameCurrentMusicInfo.artist = artist || '';
                    } else {
                        // Mode Local
                        if (typeof songs !== 'undefined' && typeof currentSongIndex !== 'undefined' && songs[currentSongIndex]) {
                            const song = songs[currentSongIndex];
                            gameCurrentMusicInfo.title = song.title || '';
                            gameCurrentMusicInfo.artist = song.artist || '';
                        }
                    }
                    console.log('[GIF Overlay] Synced music info:', gameCurrentMusicInfo);
                } catch (e) {
                    console.warn('[GIF Overlay] Error syncing music info:', e);
                }
            }

            // Fungsi untuk update teks opsi dropdown berdasarkan musik yang sedang diputar dan/atau settings tersimpan
            function updateGameDropdownOptionsText(savedSettings = null) {
                // Sinkronisasi data terbaru sebelum update UI
                syncGameCurrentMusicInfo();

                const conditionSelect = document.getElementById('game-gif-condition-type');
                if (!conditionSelect) return;

                const titleOption = conditionSelect.querySelector('option[value="music-title"]');
                const artistOption = conditionSelect.querySelector('option[value="music-artist"]');
                const warningEl = document.getElementById('game-no-music-warning');

                const hasTitle = gameCurrentMusicInfo.title && gameCurrentMusicInfo.title.trim() !== '';
                const hasArtist = gameCurrentMusicInfo.artist && gameCurrentMusicInfo.artist.trim() !== '';

                // Cek apakah ada saved value yang berbeda dari musik saat ini
                const savedCondition = savedSettings?.condition;
                const savedValue = savedSettings?.value;

                // Update teks opsi judul
                if (titleOption) {
                    // Jika settings tersimpan adalah music-title dengan value berbeda dari musik saat ini
                    if (savedCondition === 'music-title' && savedValue && savedValue !== gameCurrentMusicInfo.title) {
                        const truncatedSavedTitle = savedValue.length > 20
                            ? savedValue.substring(0, 20) + '...'
                            : savedValue;
                        titleOption.textContent = ` Tersimpan: "${truncatedSavedTitle}"`;
                        titleOption.disabled = false;
                    } else if (hasTitle) {
                        const truncatedTitle = gameCurrentMusicInfo.title.length > 25
                            ? gameCurrentMusicInfo.title.substring(0, 25) + '...'
                            : gameCurrentMusicInfo.title;
                        titleOption.textContent = `Saat judul musik "${truncatedTitle}"`;
                        titleOption.disabled = false;
                    } else {
                        titleOption.textContent = titleOption.dataset.defaultText || 'Saat judul musik mengandung...';
                        titleOption.disabled = savedCondition !== 'music-title'; // Disable hanya jika bukan saved condition
                    }
                }

                // Update teks opsi artis
                if (artistOption) {
                    // Jika settings tersimpan adalah music-artist dengan value berbeda dari musik saat ini
                    if (savedCondition === 'music-artist' && savedValue && savedValue !== gameCurrentMusicInfo.artist) {
                        const truncatedSavedArtist = savedValue.length > 20
                            ? savedValue.substring(0, 20) + '...'
                            : savedValue;
                        artistOption.textContent = ` Tersimpan: "${truncatedSavedArtist}"`;
                        artistOption.disabled = false;
                    } else if (hasArtist) {
                        const truncatedArtist = gameCurrentMusicInfo.artist.length > 25
                            ? gameCurrentMusicInfo.artist.substring(0, 25) + '...'
                            : gameCurrentMusicInfo.artist;
                        artistOption.textContent = `Saat artis musik "${truncatedArtist}"`;
                        artistOption.disabled = false;
                    } else {
                        artistOption.textContent = artistOption.dataset.defaultText || 'Saat artis musik mengandung...';
                        artistOption.disabled = savedCondition !== 'music-artist'; // Disable hanya jika bukan saved condition
                    }
                }

                // Tampilkan/sembunyikan warning
                const hasMusic = hasTitle || hasArtist || (savedCondition && savedValue);
                if (warningEl) {
                    warningEl.style.display = hasMusic ? 'none' : 'block';
                }
            }

            // Fungsi untuk buka modal settings per-GIF di Game mode
            let currentGameGifRow = null;
            let isGameGifConditionDirty = false;

            function openGameGifSettingsModal(row) {
                console.log('[GIF Settings] openGameGifSettingsModal() dipanggil');
                console.log('[GIF Settings] Modal element:', gameGifSettingsModal);

                currentGameGifRow = row;
                isGameGifConditionDirty = false;
                const overlayId = row.dataset.overlayId || null;

                // Coba ambil settings dengan string key atau number key
                let existingSettings = gameGifSettingsMap.get(overlayId) || gameGifSettingsMap.get(overlayId?.toString());
                if (!existingSettings && overlayId) {
                    existingSettings = gameGifSettingsMap.get(parseInt(overlayId));
                }

                // Fallback ke default jika tidak ada
                existingSettings = existingSettings || {
                    condition: 'always',
                    value: '',
                    opacity: 1,
                    rotation: 0,
                    hideOnCursor: false
                };

                console.log(`[GIF Overlay] Opening settings for overlay #${overlayId}:`, existingSettings);

                // Update teks dropdown berdasarkan musik saat ini DAN settings tersimpan
                updateGameDropdownOptionsText(existingSettings);

                // Set nilai modal
                document.getElementById('game-gif-condition-type').value = existingSettings.condition || 'always';

                // Opacity (handle both decimal and percentage format)
                const opacityVal = existingSettings.opacity !== undefined ? existingSettings.opacity : 1;
                const opacityDecimal = opacityVal > 1 ? opacityVal / 100 : opacityVal; // Convert if in percentage
                document.getElementById('game-gif-opacity').value = opacityDecimal;
                document.getElementById('game-gif-opacity-value').textContent = `${Math.round(opacityDecimal * 100)}%`;

                // Rotation
                const rotationVal = existingSettings.rotation !== undefined ? existingSettings.rotation : 0;
                document.getElementById('game-gif-rotation').value = rotationVal;
                document.getElementById('game-gif-rotation-value').textContent = `${rotationVal}`;

                // Hide on cursor
                const hideOnCursorCheckbox = document.getElementById('game-gif-hide-on-cursor');
                if (hideOnCursorCheckbox) {
                    hideOnCursorCheckbox.checked = existingSettings.hideOnCursor === true;
                }

                // Animation settings
                const animSettings = existingSettings.animation || { type: 'none', speed: 2, enabled: true };
                const animTypeSelect = document.getElementById('game-gif-animation-type');
                const animSpeedContainer = document.getElementById('game-gif-animation-speed-container');
                const animSpeedSlider = document.getElementById('game-gif-animation-speed');
                const animSpeedValue = document.getElementById('game-gif-animation-speed-value');

                if (animTypeSelect) {
                    animTypeSelect.value = animSettings.type || 'none';
                    if (animSpeedContainer) {
                        animSpeedContainer.style.display = (animSettings.type && animSettings.type !== 'none') ? 'block' : 'none';
                    }
                }

                if (animSpeedSlider) {
                    const speedVal = animSettings.speed || 2;
                    animSpeedSlider.value = speedVal;
                    if (animSpeedValue) animSpeedValue.textContent = speedVal;
                }

                console.log('[GIF Settings] Menampilkan modal...');
                gameGifSettingsModal.classList.add('visible');
                console.log('[GIF Settings] Modal classList:', gameGifSettingsModal.classList.toString());
            }

            // Fungsi tutup modal settings per-GIF di Game mode
            function closeGameGifSettingsModal() {
                gameGifSettingsModal.classList.remove('visible');
                currentGameGifRow = null;
            }

            // Fungsi simpan settings per-GIF di Game mode
            function saveGameGifSettings() {
                if (!currentGameGifRow) return;
                const overlayId = currentGameGifRow.dataset.overlayId || null;
                if (!overlayId) {
                    console.warn('[GIF Overlay] Tidak bisa menyimpan settings: overlayId tidak ada');
                    closeGameGifSettingsModal();
                    return;
                }

                const settingsBtn = currentGameGifRow.querySelector('.game-gif-settings-btn');
                const conditionType = document.getElementById('game-gif-condition-type').value;

                // Load saved settings
                let savedSettings = gameGifSettingsMap.get(overlayId) || gameGifSettingsMap.get(overlayId?.toString()) || {};

                // 1. Tentukan Value Kondisi (Prioritaskan yang tersimpan kecuali user mengubahnya)
                let conditionValue = savedSettings.value || '';

                const conditionChanged = (savedSettings.condition !== conditionType);
                const valueNeeded = (conditionType === 'music-title' || conditionType === 'music-artist');

                // Update value ke 'Musik Saat Ini' HANYA jika:
                // - User mengubah dropdown (dirty flag)
                // - Tipe kondisi berubah
                // - Value dibutuhkan tapi kosong
                if (isGameGifConditionDirty || conditionChanged || (valueNeeded && !conditionValue)) {
                    if (conditionType === 'music-title') {
                        conditionValue = gameCurrentMusicInfo.title || '';
                    } else if (conditionType === 'music-artist') {
                        conditionValue = gameCurrentMusicInfo.artist || '';
                    } else {
                        conditionValue = '';
                    }
                    console.log(`[Game GIF] Updating condition value to current music: "${conditionValue}"`);
                } else {
                    console.log(`[Game GIF] Retaining saved condition value: "${conditionValue}"`);
                }

                const opacityDecimal = parseFloat(document.getElementById('game-gif-opacity').value);
                const rotationVal = parseInt(document.getElementById('game-gif-rotation').value) || 0;
                const hideOnCursorCheckbox = document.getElementById('game-gif-hide-on-cursor');
                const hideOnCursor = hideOnCursorCheckbox ? hideOnCursorCheckbox.checked : false;

                const animTypeSelect = document.getElementById('game-gif-animation-type');
                const animSpeedSlider = document.getElementById('game-gif-animation-speed');

                const settings = {
                    condition: conditionType,
                    value: conditionValue,
                    opacity: opacityDecimal,
                    rotation: rotationVal,
                    hideOnCursor: hideOnCursor,
                    animation: {
                        type: animTypeSelect ? animTypeSelect.value : 'none',
                        speed: animSpeedSlider ? parseInt(animSpeedSlider.value) : 2,
                        enabled: true
                    }
                };

                // Simpan ke map lokal
                gameGifSettingsMap.set(overlayId, settings);

                // Update visual indicator pada button
                if (settings.condition !== 'always') {
                    settingsBtn?.classList.add('has-condition');
                } else {
                    settingsBtn?.classList.remove('has-condition');
                }

                // Kirim ke main process
                ipcRenderer.send('update-gif-overlay-settings', { id: parseInt(overlayId), settings: settings });

                console.log(`[GIF Overlay] Settings disimpan untuk overlay ${overlayId}:`, settings);
                closeGameGifSettingsModal();
            }

            // Event handlers untuk GIF Overlay checkbox utama
            if (enableGifOverlayCheckbox) {
                // Load saved state
                const savedGifOverlay = sessionStorage.getItem('savedGifOverlayEnabled');
                if (savedGifOverlay !== null) {
                    const isEnabled = savedGifOverlay === 'true';
                    enableGifOverlayCheckbox.checked = isEnabled;
                    if (gifOverlaySubOptions) {
                        gifOverlaySubOptions.style.display = isEnabled ? 'block' : 'none';
                    }
                    ipcRenderer.send('set-gif-overlay-enabled', isEnabled);
                }

                enableGifOverlayCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;
                    sessionStorage.setItem('savedGifOverlayEnabled', isEnabled);
                    if (gifOverlaySubOptions) {
                        gifOverlaySubOptions.style.display = isEnabled ? 'block' : 'none';
                    }
                    ipcRenderer.send('set-gif-overlay-enabled', isEnabled);
                    ipcRenderer.send('save-settings', { gifOverlayEnabled: isEnabled });
                });
            }

            // Handler tombol tambah GIF
            if (addGameGifBtn) {
                addGameGifBtn.addEventListener('click', () => {
                    const row = createGameGifInputRow();
                    if (gameGifListContainer) gameGifListContainer.appendChild(row);
                    updateGameGifStatus();
                });
            }

            // Handler checkbox lock GIF overlay
            if (gameGifInteractionLock) {
                // Load saved state
                const savedGifLocked = sessionStorage.getItem('savedGifOverlayLocked');
                if (savedGifLocked !== null) {
                    gameGifInteractionLock.checked = savedGifLocked === 'true';
                    ipcRenderer.send('set-gif-overlay-locked', savedGifLocked === 'true');
                }

                gameGifInteractionLock.addEventListener('change', (e) => {
                    const isLocked = e.target.checked;
                    sessionStorage.setItem('savedGifOverlayLocked', isLocked);
                    ipcRenderer.send('set-gif-overlay-locked', isLocked);
                    ipcRenderer.send('save-settings', { gifOverlayLocked: isLocked });
                });
            }

            // Modal event handlers
            if (gameGifSettingsModal) {
                // Handler slider opacity
                document.getElementById('game-gif-opacity')?.addEventListener('input', (e) => {
                    document.getElementById('game-gif-opacity-value').textContent = `${Math.round(e.target.value * 100)}%`;
                });

                // Handler slider rotation
                document.getElementById('game-gif-rotation')?.addEventListener('input', (e) => {
                    document.getElementById('game-gif-rotation-value').textContent = `${e.target.value}`;
                });

                // Dirty tracker for condition type
                document.getElementById('game-gif-condition-type')?.addEventListener('change', () => {
                    isGameGifConditionDirty = true;
                });

                // Handler tombol simpan
                document.getElementById('game-gif-settings-save')?.addEventListener('click', saveGameGifSettings);

                // Animation UI Controls
                const gameGifAnimType = document.getElementById('game-gif-animation-type');
                const gameGifAnimSpeedContainer = document.getElementById('game-gif-animation-speed-container');
                const gameGifAnimSpeed = document.getElementById('game-gif-animation-speed');
                const gameGifAnimSpeedValue = document.getElementById('game-gif-animation-speed-value');

                if (gameGifAnimType) {
                    gameGifAnimType.addEventListener('change', () => {
                        if (gameGifAnimSpeedContainer) {
                            gameGifAnimSpeedContainer.style.display = (gameGifAnimType.value !== 'none') ? 'block' : 'none';
                        }
                    });
                }

                if (gameGifAnimSpeed) {
                    gameGifAnimSpeed.addEventListener('input', () => {
                        if (gameGifAnimSpeedValue) {
                            gameGifAnimSpeedValue.textContent = gameGifAnimSpeed.value;
                        }
                    });
                }

                // Handler tombol batal
                document.getElementById('game-gif-settings-cancel')?.addEventListener('click', closeGameGifSettingsModal);

                // Handler klik di luar modal untuk tutup
                gameGifSettingsModal.addEventListener('click', (e) => {
                    if (e.target === gameGifSettingsModal) {
                        closeGameGifSettingsModal();
                    }
                });

                // Handler tombol Escape untuk tutup modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && gameGifSettingsModal.classList.contains('visible')) {
                        closeGameGifSettingsModal();
                    }
                });
            }

            // Listener untuk update info musik dari player (offline mode)
            // Note: Di game mode, musik biasanya dari audio player lokal, jadi ini mungkin perlu disesuaikan
            ipcRenderer.on('playback-update', (event, data) => {
                if (data) {
                    gameCurrentMusicInfo.title = data.title || '';
                    gameCurrentMusicInfo.artist = data.artist || '';
                    gameCurrentMusicInfo.isPlaying = data.isPlaying || false;
                    // Update teks dropdown jika modal sedang terbuka
                    if (gameGifSettingsModal && gameGifSettingsModal.classList.contains('visible')) {
                        updateGameDropdownOptionsText();
                    }
                }
            });

            // === Load saved GIF overlays dari settings ===
            async function loadSavedGifOverlays() {
                try {
                    const settings = await ipcRenderer.invoke('load-settings');
                    if (!settings || typeof settings !== 'object') return;

                    console.log('[GIF Overlay] Loading saved settings:', settings);

                    // Restore enabled state
                    if (settings.gifOverlayEnabled !== undefined && enableGifOverlayCheckbox) {
                        enableGifOverlayCheckbox.checked = settings.gifOverlayEnabled === true;
                        if (gifOverlaySubOptions) {
                            gifOverlaySubOptions.style.display = settings.gifOverlayEnabled ? 'block' : 'none';
                        }
                        ipcRenderer.send('set-gif-overlay-enabled', settings.gifOverlayEnabled);
                    }

                    // Restore locked state
                    if (settings.gifOverlayLocked !== undefined && gameGifInteractionLock) {
                        gameGifInteractionLock.checked = settings.gifOverlayLocked === true;
                        ipcRenderer.send('set-gif-overlay-locked', settings.gifOverlayLocked);
                    }

                    // Restore UI List dengan settings per-GIF
                    if (!gameGifUIRestored && settings.gifOverlays && Array.isArray(settings.gifOverlays) && settings.gifOverlays.length > 0) {
                        if (gameGifListContainer) gameGifListContainer.innerHTML = '';

                        settings.gifOverlays.forEach(item => {
                            console.log(`[GIF Overlay] Creating row for #${item.id}:`, item.settings);
                            const row = createGameGifInputRow(item.id, item.path, item.settings);
                            if (gameGifListContainer) gameGifListContainer.appendChild(row);
                        });

                        console.log(`[GIF Overlay] Restored ${settings.gifOverlays.length} GIF overlay UI items`);
                        gameGifUIRestored = true;
                    }
                } catch (e) {
                    console.warn('[GIF Overlay] Failed to load saved settings:', e);
                }
            }

            // Load saved GIF overlays on startup
            loadSavedGifOverlays();
            //------------------- ( end GIF Overlay Handler untuk Game Mode ) -------------------------//

            //------------------- ( bersihin tombol back bawaan (kalau muncul) ) -------------------------//
            const backButton = document.querySelector('.back-button');
            if (backButton) {
                backButton.remove();
            }

            if (window.location.pathname.endsWith('index.html')) {
                const observer = new MutationObserver((mutationsList) => {
                    for (const mutation of mutationsList) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.classList && node.classList.contains('back-button')) {
                                node.remove();
                            }
                        });
                    }
                });
                observer.observe(document.body, { childList: true, subtree: true });
            }

            setTimeout(warmUpUI, 1000);
            //------------------- ( end bersihin tombol back bawaan (kalau muncul) ) -------------------------//
        });
        //------------------- ( end inisialisasi & load saat DOM ready ) -------------------------//

        //------------------- load settings dari electron main process -------------------------//
        ipcRenderer.invoke("load-settings").then((settings) => {
            const followMusicCheckboxHidden = document.getElementById("follow-music-title");
            const darknessSliderHidden = document.getElementById("wallpaper-darkness");
            const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
            const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
            const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings');
            const wallpaperSettingsPanel = document.getElementById('wallpaper-settings');

            const autoChangeCheckboxHidden = document.getElementById("auto-change-wallpaper");
            const autoChangeIntervalInputHidden = document.getElementById("auto-change-interval");
            const randomOrderCheckboxHidden = document.getElementById("random-wallpaper-order");
            const optionsPaneAutoChangeCheckbox = document.querySelector('#wallpaper-options-pane .auto-change-wallpaper');
            const optionsPaneAutoChangeIntervalInput = document.querySelector('#wallpaper-options-pane .auto-change-interval');
            const optionsPaneRandomOrderCheckbox = document.querySelector('#wallpaper-options-pane .random-wallpaper-order');

            const snowEffectCheckbox = document.getElementById('snow-effect-checkbox');
            const miniPlayerEffectCheckbox = document.getElementById('mini-player-effect-checkbox');

            if (settings.webgpuVisualizerStyle !== undefined) {
                sessionStorage.setItem('savedWebGPUVisualizerStyle', String(settings.webgpuVisualizerStyle));
            }

            if (settings.rpcEnabled !== undefined) {
                enableRpcCheckbox.checked = settings.rpcEnabled;
            }

            document.getElementById("wallpaper-name").textContent = `Current: ${settings.wallpaper}`;

            if (settings.followMusic !== undefined) {
                if (followMusicCheckboxHidden) followMusicCheckboxHidden.checked = settings.followMusic;
                if (optionsPaneFollowMusicCheckbox) optionsPaneFollowMusicCheckbox.checked = settings.followMusic;
            }

            if (settings.darkness !== undefined) {
                if (darknessSliderHidden) darknessSliderHidden.value = settings.darkness;
                if (optionsPaneDarknessSlider) optionsPaneDarknessSlider.value = settings.darkness;
            }
            if (settings.wallpaperBlur !== undefined) {
                if (blurSliderHidden) blurSliderHidden.value = settings.wallpaperBlur;
                if (optionsPaneBlurSlider) optionsPaneBlurSlider.value = settings.wallpaperBlur;
            }
            if (settings.wallpaperGrayscale !== undefined) {
                if (grayscaleSliderHidden) grayscaleSliderHidden.value = settings.wallpaperGrayscale;
                if (optionsPaneGrayscaleSlider) optionsPaneGrayscaleSlider.value = settings.wallpaperGrayscale;
            }
            if (settings.wallpaperZoom !== undefined) {
                if (zoomSliderHidden) zoomSliderHidden.value = settings.wallpaperZoom;
                if (optionsPaneZoomSlider) optionsPaneZoomSlider.value = settings.wallpaperZoom;
            }

            if (settings.autoChangeWallpaper !== undefined) {
                if (autoChangeCheckboxHidden) autoChangeCheckboxHidden.checked = settings.autoChangeWallpaper;
                if (optionsPaneAutoChangeCheckbox) optionsPaneAutoChangeCheckbox.checked = settings.autoChangeWallpaper;
                sessionStorage.setItem("savedAutoChangeWallpaper", settings.autoChangeWallpaper);
                if (settings.autoChangeWallpaper) {
                    startAutoChangeWallpaper();
                }
            }
            if (settings.autoChangeInterval !== undefined) {
                if (autoChangeIntervalInputHidden) autoChangeIntervalInputHidden.value = settings.autoChangeInterval;
                if (optionsPaneAutoChangeIntervalInput) optionsPaneAutoChangeIntervalInput.value = settings.autoChangeInterval;
                sessionStorage.setItem("savedAutoChangeInterval", settings.autoChangeInterval);
            }
            if (settings.randomWallpaperOrder !== undefined) {
                if (randomOrderCheckboxHidden) randomOrderCheckboxHidden.checked = settings.randomWallpaperOrder;
                if (optionsPaneRandomOrderCheckbox) optionsPaneRandomOrderCheckbox.checked = settings.randomWallpaperOrder;
                sessionStorage.setItem("savedRandomWallpaperOrder", settings.randomWallpaperOrder);
            }

            applyWallpaperStyles();

            // Load and apply
            if (settings.enableHiddenWallpaperSettings !== undefined) {
                const isEnabled = settings.enableHiddenWallpaperSettings;
                // Apply setting langsung ke checkbox dan panel
                if (wallpaperSettingsPanel) {
                    if (isEnabled) {
                        wallpaperSettingsPanel.classList.remove('disabled');
                        // Re-attach hover jika sebelumnya di-enable
                        triggerZone.addEventListener('mouseenter', showPanel);
                        triggerZone.addEventListener('mouseleave', hidePanel);
                        wallpaperSettings.addEventListener('mouseenter', showPanel);
                        wallpaperSettings.addEventListener('mouseleave', hidePanel);
                    } else {
                        wallpaperSettingsPanel.classList.add('disabled');
                        // Hide the panel langsung jika sedang terbuka
                        wallpaperSettingsPanel.classList.remove('show');
                        // Remove hover listeners untuk mencegah interaksi
                        triggerZone.removeEventListener('mouseenter', showPanel);
                        triggerZone.removeEventListener('mouseleave', hidePanel);
                        wallpaperSettings.removeEventListener('mouseenter', showPanel);
                        wallpaperSettings.removeEventListener('mouseleave', hidePanel);
                    }
                }
            } else {
                // Jika belum ada di setting tersimpan: defaultnya dimatiin aja biar aman
                if (enableHiddenSettingsCheckbox) enableHiddenSettingsCheckbox.checked = false;
                sessionStorage.setItem("savedEnableHiddenSettings", false);
                ipcRenderer.send("save-settings", { enableHiddenWallpaperSettings: false });
                if (wallpaperSettingsPanel) wallpaperSettingsPanel.classList.add('disabled');
            }

            // Load and apply salah satu fitur baru: Snow Effect
            if (settings.snowFeatureEnabled !== undefined) {
                const isSnowEnabled = settings.snowFeatureEnabled;
                if (snowEffectCheckbox) snowEffectCheckbox.checked = isSnowEnabled;
                if (isSnowEnabled) {
                    ipcRenderer.send('show-snow-effect');
                } else {
                    ipcRenderer.send('hide-snow-effect');
                }
            } else {
                // jika tidak ada di setting tersimpan: default dimatiin aja
                if (snowEffectCheckbox) snowEffectCheckbox.checked = false;
                ipcRenderer.send('set-snow-feature-enabled', false);
                ipcRenderer.send('hide-snow-effect');
            }

            if (settings.miniPlayerFeatureEnabled !== undefined) {
                const isMiniEnabled = settings.miniPlayerFeatureEnabled === true;
                if (miniPlayerCheckboxInOptions) miniPlayerCheckboxInOptions.checked = isMiniEnabled;
                sessionStorage.setItem('savedMiniPlayerEffect', isMiniEnabled);
                ipcRenderer.send('set-mini-player-feature-enabled', isMiniEnabled);
            } else {
                // Default disable jika tidak ada di setting tersimpan
                sessionStorage.setItem('savedMiniPlayerEffect', false);
                ipcRenderer.send('set-mini-player-feature-enabled', false);
            }

            if (enableAdSkipperCheckbox && settings.adSkipperEnabled !== undefined) {
                enableAdSkipperCheckbox.checked = settings.adSkipperEnabled;
            } else if (enableAdSkipperCheckbox) {
                enableAdSkipperCheckbox.checked = false;
            }

            if (settings.globalVolume !== undefined) {
                applyGlobalVolume(settings.globalVolume);
            }

            // Load Ad Skipper Settings
            if (settings.adSkipperEnabled !== undefined) {
                enableAdSkipperCheckbox.checked = settings.adSkipperEnabled;
                if (settings.adSkipperEnabled) {
                    document.getElementById('ad-skipper-sub-options').classList.add('visible');
                }
            }

            // Load Sub-Options
            if (settings.autoMuteAds !== undefined) {
                document.getElementById('auto-mute-ads-checkbox').checked = settings.autoMuteAds;
            }
            if (settings.autoSkipAds !== undefined) {
                document.getElementById('auto-skip-ads-checkbox').checked = settings.autoSkipAds;
            }

            // webview menerima config AdSkipper yang sudah di-load (anti race dengan dom-ready)
            const webview = document.getElementById('external-webview');
            if (webview && webview.getWebContentsId()) {
                webview.send('setting-update', {
                    adSkipperEnabled: settings.adSkipperEnabled === true,
                    autoMuteAds: settings.autoMuteAds === true,
                    autoSkipAds: settings.autoSkipAds === true
                });
            }


            document.getElementById('idle-return-checkbox').checked = settings.idleReturn;
            if (settings.idleReturn) resetIdleTimer();
        });
        //------------------- end load settings dari electron main process -------------------------//

        // ================================ ( End Pengaturan User ) ================================ //

        // ================================ ( Logika Game Editor ) ================================ //
        //------------------- inisialisasi elemen editor -------------------------//
        const gameEditorScreen = document.getElementById('game-editor-screen');
        const gameEditorButton = document.getElementById('game-editor'); // Tombol di main menu
        const backToMainMenuEditorBtn = document.getElementById('back-to-main-menu-editor');
        const saveEditorChangesBtn = document.getElementById('save-editor-changes');

        let isEditorDirty = false; // Flag untuk melacak perubahan yang belum disimpan

        // Daftar semua ID elemen yang bisa diedit dan ID input kontainernya
        const editableSections = [
            { elementId: 'warning-screen', previewId: 'preview-warning-screen', livePreviewContentId: 'warning-screen-preview-content' },
            { elementId: 'developer-screen', previewId: 'preview-developer-screen', livePreviewContentId: 'developer-screen-preview-content' },
            { elementId: 'concept-screen', previewId: 'preview-concept-screen', livePreviewContentId: 'concept-screen-preview-content' },
            { elementId: 'title-screen', previewId: 'preview-title-screen', livePreviewContentId: 'title-screen-preview-content' },
            { elementId: 'profile-section', previewId: 'preview-profile-section', livePreviewContentId: 'profile-section-preview-content' },
            { elementId: 'character-menu', previewId: 'preview-character-menu-box' }

        ];

        // Deteksi perubahan pada input di dalam editor
        if (gameEditorScreen) {
            gameEditorScreen.addEventListener('input', (e) => {
                // target adalah elemen input yang relevan
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    isEditorDirty = true;
                }
            });
            // Tangkap event change juga untuk input file atau checkbox yang mungkin tidak memicu input terus menerus
            gameEditorScreen.addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    isEditorDirty = true;
                }
            });
        }
        //------------------- end inisialisasi elemen editor -------------------------//

        // Utility kecil untuk menyusun ulang teks judul utama (membuat <span> per karakter)
        function setTitleHeadingText(targetHeading, textValue) {
            if (!targetHeading) return;
            const safeText = textValue || '';
            targetHeading.innerHTML = '';
            safeText.split('').forEach(char => {
                const span = document.createElement('span');
                span.textContent = char;
                targetHeading.appendChild(span);
            });
        }

        //------------------- fungsi update preview -------------------------//
        // update semua preview
        function updateAllPreviews(fromInput = false) {
            editableSections.forEach(section => {
                updateSpecificPreview(section.elementId, fromInput);
            });
        }

        // update preview spesifik
        function updateSpecificPreview(elementId, fromInput = false) {
            const sectionConfig = editableSections.find(s => s.elementId === elementId);
            if (!sectionConfig) return;

            const previewBox = document.getElementById(sectionConfig.previewId);
            if (!previewBox) {
                console.warn(`Preview box with ID ${sectionConfig.previewId} not found.`);
                return;
            }

            // Dapatkan pembungkus konten pratinjau. Untuk sebagian besar layar, ini adalah .live-preview-content
            const livePreviewWrapper = previewBox.querySelector('.live-preview-content');

            if (elementId === 'warning-screen') {
                // Target elemen <p> di dalam .screen yang ada di dalam .live-preview-content di dalam previewBox
                const screenInPreview = livePreviewWrapper ? livePreviewWrapper.querySelector('.screen') : null;
                if (screenInPreview) {
                    const pElements = screenInPreview.querySelectorAll('p');
                    if (pElements.length >= 2) {
                        if (fromInput) {
                            pElements[0].textContent = document.getElementById('edit-warning-text-1').value;
                            pElements[1].textContent = document.getElementById('edit-warning-text-2').value;
                        } else {
                            const originalEl = screens.find(s => s.id === 'warning-screen');
                            if (originalEl) {
                                pElements[0].textContent = originalEl.querySelectorAll('p')[0]?.textContent;
                                pElements[1].textContent = originalEl.querySelectorAll('p')[1]?.textContent;
                            }
                        }
                    }
                }
            } else if (elementId === 'developer-screen') {
                const screenInPreview = livePreviewWrapper ? livePreviewWrapper.querySelector('.screen') : null;
                if (screenInPreview) {
                    const h2Element = screenInPreview.querySelector('h2');
                    const h4Element = screenInPreview.querySelector('h4');
                    if (h2Element && h4Element) {
                        if (fromInput) {
                            h2Element.textContent = document.getElementById('edit-developer-title').value;
                            h4Element.textContent = document.getElementById('edit-developer-subtitle').value;
                        } else {
                            const originalEl = screens.find(s => s.id === 'developer-screen');
                            if (originalEl) {
                                h2Element.textContent = originalEl.querySelector('h2')?.textContent;
                                h4Element.textContent = originalEl.querySelector('h4')?.textContent;
                            }
                        }
                    }
                }
            } else if (elementId === 'concept-screen') {
                const screenInPreview = livePreviewWrapper ? livePreviewWrapper.querySelector('.screen') : null;
                if (screenInPreview) {
                    const h2Element = screenInPreview.querySelector('h2');
                    const pElement = screenInPreview.querySelector('p');
                    if (h2Element && pElement) {
                        if (fromInput) {
                            h2Element.textContent = document.getElementById('edit-disclaimer-title').value;
                            pElement.textContent = document.getElementById('edit-disclaimer-text').value;
                        } else {
                            const originalEl = screens.find(s => s.id === 'concept-screen');
                            if (originalEl) {
                                h2Element.textContent = originalEl.querySelector('h2')?.textContent;
                                pElement.textContent = originalEl.querySelector('p')?.textContent;
                            }
                        }
                    }
                }
            } else if (elementId === 'title-screen') {
                const screenInPreview = livePreviewWrapper ? livePreviewWrapper.querySelector('.screen') : null;
                if (screenInPreview) {
                    const h1InPreview = screenInPreview.querySelector('h1');
                    const h3InPreview = screenInPreview.querySelector('h3');
                    const pInPreview = screenInPreview.querySelector('p');

                    if (h1InPreview && h3InPreview && pInPreview) {
                        if (fromInput) {
                            const mainTitle = document.getElementById('edit-title-main').value;
                            setTitleHeadingText(h1InPreview, mainTitle);
                            h3InPreview.textContent = document.getElementById('edit-title-subtitle').value;
                            pInPreview.textContent = document.getElementById('edit-title-press-start').value;
                        } else {
                            const originalEl = screens.find(s => s.id === 'title-screen');
                            if (originalEl) {
                                const originalH1 = originalEl.querySelector('h1');
                                const originalMainTitle = originalH1 ? originalH1.textContent : '';
                                setTitleHeadingText(h1InPreview, originalMainTitle);
                                h3InPreview.textContent = originalEl.querySelector('h3')?.textContent;
                                const originalPressStartP = Array.from(originalEl.querySelectorAll('p')).pop();
                                if (originalPressStartP) {
                                    pInPreview.textContent = originalPressStartP.textContent;
                                }
                            }
                        }
                    }
                }
            } else if (elementId === 'profile-section') {
                const previewBox = document.getElementById('preview-profile-section'); // ID dari .preview-box
                if (!previewBox) {
                    console.warn(`Preview box with ID preview-profile-section not found.`);
                    return;
                }

                // Target elemen #profile-section di dalam previewBox
                const profileSectionInPreview = previewBox.querySelector('#profile-section');
                if (profileSectionInPreview) {
                    const nameElPreview = profileSectionInPreview.querySelector('#profile-name');
                    const levelElPreview = profileSectionInPreview.querySelector('#profile-level');
                    const descriptionElPreview = profileSectionInPreview.querySelector('#profile-description');
                    const imageElPreview = profileSectionInPreview.querySelector('img');

                    if (nameElPreview && levelElPreview && descriptionElPreview && imageElPreview) {
                        if (fromInput) {
                            // Ambil nilai dari field input editor
                            nameElPreview.textContent = document.getElementById('edit-profile-name').value;
                            levelElPreview.textContent = document.getElementById('edit-profile-level').value;
                            descriptionElPreview.textContent = document.getElementById('edit-profile-description').value;
                            // Ambil src gambar dari pratinjau kecil di area input
                            imageElPreview.src = document.getElementById('edit-profile-image-preview').src;
                        } else {
                            // Ambil nilai dari elemen game asli (saat load awal atau setelah save)
                            nameElPreview.textContent = document.getElementById('profile-name').textContent; // ID elemen game asli
                            levelElPreview.textContent = document.getElementById('profile-level').textContent; // ID elemen game asli
                            descriptionElPreview.textContent = document.getElementById('profile-description').textContent; // ID elemen game asli
                            imageElPreview.src = document.getElementById('profile-picture').src; // ID elemen game asli
                        }
                    }
                }
            } else if (elementId === 'character-menu') {
                const previewArea = document.getElementById('live-preview-character-menu-content');
                if (!previewArea) return;

                if (!fromInput) {
                    setupCharacterMenuPreview();
                    return;
                }

                const formItems = document.querySelectorAll('#characterEditorListContainer .character-edit-item');
                const tempCharacters = [];

                formItems.forEach(item => {
                    const id = item.dataset.characterId;
                    const name = item.querySelector('.char-name-input')?.value || '';
                    const description = item.querySelector('.char-desc-input')?.value || '';
                    const extendedDescription = item.querySelector('.char-ext-desc-input')?.value || '';
                    const mediaThumb = item.querySelector('.media-thumbnail-preview');

                    let mediaSrc = mediaThumb ? mediaThumb.src : '';
                    let mediaType = mediaThumb ? (mediaThumb.dataset.newMediaType || mediaThumb.tagName.toLowerCase()) : 'image';

                    if (mediaThumb && mediaThumb.dataset.newMediaDataUrl) {
                        mediaSrc = mediaThumb.dataset.newMediaDataUrl;
                    }

                    if (!mediaSrc && gameCharacters.length > 0) {
                        const fallback = gameCharacters.find(char => char.id === id);
                        if (fallback) {
                            mediaSrc = fallback.mediaSrc;
                            mediaType = fallback.mediaType;
                        }
                    }

                    tempCharacters.push({ id, name, description, extendedDescription, mediaSrc, mediaType });
                });

                // Jika belum ada form (misal baru membuka), gunakan data karakter yang sudah ada
                const charactersToRender = tempCharacters.length > 0 ? tempCharacters : gameCharacters;

                previewArea.innerHTML = '';
                const container = document.createElement('div');
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.display = 'flex';
                container.style.flexDirection = 'row';
                container.style.overflow = 'hidden';
                container.style.backgroundColor = '#000';

                charactersToRender.forEach(charData => {
                    const card = document.createElement('div');
                    card.className = 'image-preview';
                    card.style.flex = '1';
                    card.style.borderRight = '1px solid #222';

                    const mediaType = (charData.mediaType || '').toLowerCase();
                    const isVideo = mediaType === 'video' || (charData.mediaSrc && charData.mediaSrc.match(/\.(mp4|webm|ogg)$/i));

                    if (isVideo) {
                        const video = document.createElement('video');
                        video.className = 'video';
                        video.src = charData.mediaSrc || '';
                        video.muted = true;
                        video.loop = true;
                        video.style.width = '100%';
                        video.style.height = '100%';
                        video.style.objectFit = 'cover';
                        card.appendChild(video);
                    } else {
                        const img = document.createElement('img');
                        img.className = 'video character-image';
                        img.src = charData.mediaSrc || './aset/placeholder.png';
                        img.alt = `Deskripsi Gambar ${charData.name || ''}`;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        card.appendChild(img);
                    }

                    const overlay = document.createElement('div');
                    overlay.className = 'overlay';
                    overlay.style.height = '35%';
                    overlay.style.padding = '10px';

                    const desc = document.createElement('div');
                    desc.className = 'desc';

                    const nameHeading = document.createElement('h1');
                    nameHeading.textContent = charData.name || 'New Character';
                    nameHeading.style.fontSize = '0.7rem';
                    nameHeading.style.marginBottom = '3px';
                    desc.appendChild(nameHeading);

                    if (charData.description) {
                        const summaryP = document.createElement('p');
                        summaryP.className = 'summary';
                        summaryP.textContent = charData.description;
                        summaryP.style.fontSize = '0.6rem';
                        summaryP.style.lineHeight = '1.2';
                        desc.appendChild(summaryP);
                    }

                    if (charData.extendedDescription) {
                        const extendedDiv = document.createElement('div');
                        extendedDiv.className = 'extended-content';
                        const extendedP = document.createElement('p');
                        extendedP.textContent = charData.extendedDescription;
                        extendedDiv.appendChild(extendedP);
                        desc.appendChild(extendedDiv);

                        const moreBtn = document.createElement('button');
                        moreBtn.className = 'more-button';
                        moreBtn.textContent = 'More';
                        moreBtn.style.fontSize = '0.6rem';
                        moreBtn.style.padding = '2px 4px';
                        moreBtn.style.marginTop = '4px';
                        desc.appendChild(moreBtn);
                    }

                    overlay.appendChild(desc);
                    card.appendChild(overlay);
                    container.appendChild(card);
                });

                if (container.lastElementChild) {
                    container.lastElementChild.style.borderRight = 'none';
                }

                previewArea.appendChild(container);
                initializeCharacterMenuLogic(container);
            }
        }
        //------------------- end fungsi update preview -------------------------//

        //------------------- fungsi load data ke input editor -------------------------//
        // Fungsi untuk memuat semua data ke input editor
        function loadAllDataToEditorInputs() {
            editableSections.forEach(section => {
                const elementId = section.elementId;
                if (elementId === 'warning-screen') {
                    const el = screens.find(s => s.id === 'warning-screen');
                    if (el) {
                        document.getElementById('edit-warning-text-1').value = el.querySelectorAll('p')[0]?.textContent || '';
                        document.getElementById('edit-warning-text-2').value = el.querySelectorAll('p')[1]?.textContent || '';
                    }
                } else if (elementId === 'developer-screen') {
                    const el = screens.find(s => s.id === 'developer-screen');
                    if (el) {
                        document.getElementById('edit-developer-title').value = el.querySelector('h2')?.textContent || '';
                        document.getElementById('edit-developer-subtitle').value = el.querySelector('h4')?.textContent || '';
                    }
                } else if (elementId === 'concept-screen') {
                    const el = screens.find(s => s.id === 'concept-screen');
                    if (el) {
                        document.getElementById('edit-disclaimer-title').value = el.querySelector('h2')?.textContent || '';
                        document.getElementById('edit-disclaimer-text').value = el.querySelector('p')?.textContent || '';
                    }
                } else if (elementId === 'title-screen') {
                    const el = screens.find(s => s.id === 'title-screen');
                    if (el) {
                        const h1 = el.querySelector('h1');
                        document.getElementById('edit-title-main').value = h1 ? h1.textContent || '' : '';
                        document.getElementById('edit-title-subtitle').value = el.querySelector('h3')?.textContent || '';
                        document.getElementById('edit-title-press-start').value = el.querySelector('p')?.textContent || '';
                    }
                } else if (elementId === 'profile-section') {
                    document.getElementById('edit-profile-name').value = document.getElementById('profile-name')?.textContent || '';
                    document.getElementById('edit-profile-level').value = document.getElementById('profile-level')?.textContent || '';
                    document.getElementById('edit-profile-description').value = document.getElementById('profile-description')?.textContent || '';
                }
            });
            const profileSectionConfig = editableSections.find(s => s.elementId === 'profile-section');
            if (profileSectionConfig) { // section 'profile-section' ada di config
                document.getElementById('edit-profile-name').value = document.getElementById('profile-name')?.textContent || '';
                document.getElementById('edit-profile-level').value = document.getElementById('profile-level')?.textContent || '';
                document.getElementById('edit-profile-description').value = document.getElementById('profile-description')?.textContent || '';

                // Muat gambar profil ke pratinjau kecil di area input
                const actualProfilePicSrc = document.getElementById('profile-picture')?.src;
                const editorImagePreview = document.getElementById('edit-profile-image-preview');
                if (editorImagePreview) {
                    editorImagePreview.src = actualProfilePicSrc || './aset/ikon.jpg'; // Fallback ke default jika tidak ada
                }
            }

            // Render rotating texts editor
            if (typeof renderRotatingTextsEditor === 'function') {
                renderRotatingTextsEditor();
            }
            
            updateAllPreviews(false); // Update semua preview berdasarkan data game asli yang baru dimuat ke input
        }
        //------------------- end fungsi load data ke input editor -------------------------//

        //------------------- logika character menu editor -------------------------//
        // Data struktur untuk menyimpan karakter game
        let gameCharacters = []; // Array global untuk menyimpan data karakter
        const CHARACTER_DATA_KEY = 'gameCharacterEditorData'; // Kunci untuk localStorage

        // Fungsi untuk menghasilkan ID unik sederhana
        function generateUniqueId() {
            return `char_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Helper untuk mendapatkan teks konten dengan aman
        function getText(element, selector) {
            const el = element.querySelector(selector);
            return el ? el.textContent.trim() : '';
        }

        // Helper untuk mendapatkan atribut dengan aman
        function getAttr(element, selector, attribute) {
            const el = element.querySelector(selector);
            return el ? el.getAttribute(attribute) : null; // Kembalikan null jika tidak ada
        }

        // Fungsi untuk mengekstrak data karakter dari DOM #character-menu
        function extractCharactersFromDOM() {
            console.log("Extracting characters from DOM...");
            const existingCharacters = [];
            const characterMenuMainContainer = document.querySelector('#character-menu .main-container');
            if (!characterMenuMainContainer) {
                console.error("#character-menu .main-container not found for extraction.");
                return existingCharacters; // Kembalikan array kosong jika kontainer tidak ditemukan
            }

            const characterCards = characterMenuMainContainer.querySelectorAll('.image-preview');
            characterCards.forEach((card, index) => {
                const name = getText(card, '.overlay .desc h1');
                // Mencoba mengambil deskripsi dari beberapa kemungkinan struktur
                let description = getText(card, '.overlay .desc p.summary');
                if (!description) { // Jika tidak ada p.summary, coba ambil dari p umum pertama
                    description = getText(card, '.overlay .desc p');
                }
                let extendedDescription = '';
                const extendedContentP = card.querySelector('.overlay .desc .extended-content p');
                if (extendedContentP) {
                    extendedDescription = extendedContentP.textContent.trim();
                }


                let mediaSrc = getAttr(card, 'img.character-image', 'src') || getAttr(card, 'video.video', 'src');
                let mediaType = 'unknown';
                if (mediaSrc) {
                    const mediaElement = card.querySelector('img.character-image, video.video');
                    if (mediaElement) {
                        mediaType = mediaElement.tagName.toLowerCase() === 'img' ? 'image' : 'video';
                        // Jika src adalah path lokal, coba buat path absolut sederhana (ini mungkin perlu penyesuaian)
                        if (mediaSrc.startsWith('./')) {
                            // Untuk tujuan demo, kita akan biarkan seperti ini,
                            // tapi idealnya path harus dikelola dengan lebih baik di Electron
                        }
                    }
                } else {
                    mediaSrc = './aset/placeholder.png'; // Fallback jika tidak ada media
                    mediaType = 'image';
                }


                existingCharacters.push({
                    id: generateUniqueId() + `_${index}`, // ID unik untuk setiap karakter
                    name: name || `Character ${index + 1}`,
                    description: description,
                    extendedDescription: extendedDescription,
                    mediaSrc: mediaSrc,
                    mediaType: mediaType,
                    originalElement: card.cloneNode(true) // Simpan klon elemen asli untuk referensi jika perlu
                });
            });
            console.log("Extracted characters:", existingCharacters);
            return existingCharacters;
        }


        // Fungsi untuk membuat dan menampilkan formulir edit untuk satu karakter
        function renderCharacterEditForm(characterData) {
            const listContainer = document.getElementById('characterEditorListContainer');
            if (!listContainer) return;

            const placeholder = listContainer.querySelector('.character-list-empty-placeholder');
            if (placeholder) placeholder.style.display = 'none'; // Sembunyikan placeholder

            const characterId = characterData.id || generateUniqueId();

            let mediaPreviewHTML;
            if (characterData.mediaType === 'video') {
                mediaPreviewHTML = `
        <video class="media-thumbnail-preview" id="mediaThumb_${characterId}" src="${characterData.mediaSrc || ''}" muted autoplay loop playsinline>
        </video>`;
            } else {
                mediaPreviewHTML = `
        <img src="${characterData.mediaSrc || './aset/placeholder.png'}" alt="Media Preview" class="media-thumbnail-preview" id="mediaThumb_${characterId}">`;
            }

            const mediaInputGroupHTML = `
            <div class="form-group">
                <label>Character Media:</label>
                <div class="media-input-wrapper">
                    <div class="media-preview-container" style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                        ${mediaPreviewHTML}
                        <span class="current-media-file-display" style="font-size: 0.8rem; color: #aaa; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            Current: ${characterData.mediaSrc ? characterData.mediaSrc.split('/').pop() : 'None'}
                        </span>
                    </div>
                    <div class="media-input-controls">
                        <input type="file" id="charMedia_${characterId}" class="char-media-input" accept="image/*,video/*">
                        <label for="charMedia_${characterId}" class="custom-file-input-label">
                            Choose File...
                        </label>
                    </div>
                </div>
            </div>
            `;

            // Gabungkan semua bagian HTML untuk character-edit-item
            const itemHTML = `
                <div class="character-edit-item" data-character-id="${characterId}">
                    <div class="character-edit-header">
                        <span class="character-edit-name-display">${characterData.name || 'New Character'}</span>
                        <button class="button-remove-character" data-id="${characterId}" title="Remove this character">Remove</button>
                    </div>
                    <div class="character-edit-body">
                        <div class="form-group">
                            <label for="charName_${characterId}">Character Name:</label>
                            <input type="text" id="charName_${characterId}" class="char-name-input" value="${characterData.name || ''}" placeholder="Enter character name">
                        </div>
                        <div class="form-group">
                            <label for="charDesc_${characterId}">Description (Summary):</label>
                            <textarea id="charDesc_${characterId}" class="char-desc-input" placeholder="Enter short description">${characterData.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="charExtDesc_${characterId}">Extended Description (Optional):</label>
                            <textarea id="charExtDesc_${characterId}" class="char-ext-desc-input" placeholder="Enter extended description (for 'More' button)">${characterData.extendedDescription || ''}</textarea>
                        </div>

                        ${mediaInputGroupHTML}

                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', itemHTML);

            // Tambahkan event listener untuk input file pada item yang baru dibuat
            const fileInput = listContainer.querySelector(`#charMedia_${characterId}`);
            const formGroup = fileInput.closest('.form-group'); // Dapatkan parent .form-group

            if (fileInput && formGroup) {
                fileInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const dataURL = e.target.result;
                            let existingPreview = formGroup.querySelector('.media-thumbnail-preview');
                            let newPreviewElement;

                            // Hapus pratinjau lama jika ada
                            if (existingPreview) {
                                existingPreview.remove();
                            }

                            if (file.type.startsWith('video/')) {
                                newPreviewElement = document.createElement('video');
                                newPreviewElement.src = dataURL;
                                newPreviewElement.muted = true;
                                newPreviewElement.autoplay = true;
                                newPreviewElement.loop = true;
                                newPreviewElement.playsInline = true;
                                newPreviewElement.textContent = "Browser Anda tidak mendukung tag video."; // Fallback
                            } else if (file.type.startsWith('image/')) {
                                newPreviewElement = document.createElement('img');
                                newPreviewElement.src = dataURL;
                                newPreviewElement.alt = "Media Preview";
                            } else {
                                // Tipe file tidak didukung, mungkin tampilkan placeholder
                                newPreviewElement = document.createElement('img');
                                newPreviewElement.src = './aset/placeholder.png'; // Placeholder umum
                                newPreviewElement.alt = "Unsupported File Type";
                            }

                            if (newPreviewElement) {
                                newPreviewElement.className = 'media-thumbnail-preview'; // Terapkan kelas CSS yang sama
                                newPreviewElement.id = `mediaThumb_${characterId}`; // Berikan ID yang konsisten
                                // Terapkan style inline yang penting jika tidak semua ada di CSS
                                newPreviewElement.style.width = "80px";
                                newPreviewElement.style.height = "160px";
                                newPreviewElement.style.objectFit = "cover";
                                newPreviewElement.style.backgroundColor = "#2a2c2e";
                                newPreviewElement.style.borderRadius = "4px";
                                newPreviewElement.style.marginTop = "8px";
                                newPreviewElement.style.display = "block";
                                newPreviewElement.style.border = "1px solid #383a3c";

                                // Simpan informasi file baru untuk disimpan nanti
                                newPreviewElement.dataset.newMediaDataUrl = dataURL;
                                newPreviewElement.dataset.newMediaName = file.name;
                                newPreviewElement.dataset.newMediaType = file.type.startsWith('video/') ? 'video' : 'image';


                                // Sisipkan elemen pratinjau baru sebelum span .current-media-file-display
                                const currentMediaDisplaySpan = formGroup.querySelector('.current-media-file-display');
                                const previewContainer = formGroup.querySelector('.media-preview-container');

                                if (previewContainer && currentMediaDisplaySpan) {
                                    previewContainer.insertBefore(newPreviewElement, currentMediaDisplaySpan);
                                } else if (currentMediaDisplaySpan) {
                                    currentMediaDisplaySpan.insertAdjacentElement('beforebegin', newPreviewElement);
                                } else {
                                    // Fallback jika span tidak ada
                                    const wrapper = formGroup.querySelector('.media-input-wrapper');
                                    if (wrapper) wrapper.prepend(newPreviewElement);
                                }

                                if (newPreviewElement.tagName.toLowerCase() === 'video') {
                                    newPreviewElement.play().catch(err => console.log("Autoplay video preview gagal:", err));
                                }

                                updateSpecificPreview('character-menu', true);
                            }
                        }
                        reader.readAsDataURL(file);

                        const currentMediaDisplay = fileInput.closest('.media-input-wrapper').querySelector('.current-media-file-display');
                        if (currentMediaDisplay) currentMediaDisplay.textContent = `New: ${file.name}`;
                    }
                });
            }
            // Tambahkan event listener untuk tombol remove
            const removeButton = listContainer.querySelector(`.button-remove-character[data-id="${characterId}"]`);
            if (removeButton) {
                removeButton.addEventListener('click', function () {
                    const charIdToRemove = this.dataset.id;
                    const itemToRemove = document.querySelector(`.character-edit-item[data-character-id="${charIdToRemove}"]`);
                    if (itemToRemove) {
                        itemToRemove.remove();
                        // Juga hapus dari array gameCharacters
                        gameCharacters = gameCharacters.filter(char => char.id !== charIdToRemove);
                        console.log(`Character ${charIdToRemove} removed.`);
                        if (listContainer.children.length === 1 && listContainer.querySelector('.character-list-empty-placeholder')) { // Jika hanya placeholder yg tersisa
                            listContainer.querySelector('.character-list-empty-placeholder').style.display = 'block';
                        }
                        updateSpecificPreview('character-menu', true);
                    }
                });
            }
        }

        function loadCharacterDataForEditor() {
            console.log("Loading character data for editor...");
            const listContainer = document.getElementById('characterEditorListContainer');
            if (!listContainer) {
                console.error("#characterEditorListContainer not found.");
                return;
            }
            // Kosongkan kontainer sebelum memuat (kecuali placeholder)
            listContainer.innerHTML = `<p class="character-list-empty-placeholder" style="display: none; text-align: center; color: #777; margin: 20px 0;">Belum ada karakter. Klik "Tambah Karakter Baru" untuk memulai.</p>`;


            // Coba muat dari localStorage dulu
            const savedCharsString = localStorage.getItem(CHARACTER_DATA_KEY);
            if (savedCharsString) {
                try {
                    gameCharacters = JSON.parse(savedCharsString);
                    console.log("Loaded characters from localStorage:", gameCharacters);
                } catch (e) {
                    console.error("Error parsing characters from localStorage, will extract from DOM:", e);
                    gameCharacters = extractCharactersFromDOM(); // Fallback ke ekstraksi DOM jika parse gagal
                }
            } else if (gameCharacters.length === 0) { // Jika tidak ada di LS dan array kosong, ekstrak dari DOM
                gameCharacters = extractCharactersFromDOM();
            }


            if (gameCharacters.length === 0) {
                const placeholder = listContainer.querySelector('.character-list-empty-placeholder');
                if (placeholder) placeholder.style.display = 'block';
                console.log("No characters to display in editor.");
            } else {
                gameCharacters.forEach(charData => {
                    renderCharacterEditForm(charData);
                });
            }

            updateSpecificPreview('character-menu', true);
        }

        function moreButtonHandler(e) {
            e.stopPropagation();
            const btn = e.currentTarget;
            const desc = btn.closest('.desc');
            const extended = desc.querySelector('.extended-content');
            if (extended) {
                extended.classList.toggle('show');
                btn.textContent = extended.classList.contains('show') ? 'Less' : 'More';
            }
        }

        function bindMoreButtons(root = document) {
            root.querySelectorAll('.more-button').forEach(button => {
                // Hapus listener lama (jika ada), lalu pasang yang baru
                button.removeEventListener('click', moreButtonHandler);
                button.addEventListener('click', moreButtonHandler);
            });
        }

        // Fungsi untuk menyimpan data karakter (kerangka dasar)
        window.saveCharacterMenuData = function () {
            console.log("Saving character data...");
            const updatedCharacters = [];
            const editItems = document.querySelectorAll('#characterEditorListContainer .character-edit-item');

            editItems.forEach(item => {
                const id = item.dataset.characterId;
                const nameInput = item.querySelector('.char-name-input');
                const descInput = item.querySelector('.char-desc-input');
                const extDescInput = item.querySelector('.char-ext-desc-input');
                const mediaThumb = item.querySelector('.media-thumbnail-preview'); // Untuk mendapatkan mediaSrc yang mungkin baru

                // Temukan karakter asli untuk mempertahankan mediaSrc jika tidak diubah
                const originalCharacter = gameCharacters.find(char => char.id === id) || {};
                let currentMediaSrc = originalCharacter.mediaSrc || '';
                let currentMediaType = originalCharacter.mediaType || 'image';
                let currentMediaName = currentMediaSrc.split('/').pop();

                if (mediaThumb.dataset.newMediaDataUrl) { // Jika ada file baru yang dipilih
                    currentMediaSrc = mediaThumb.dataset.newMediaDataUrl; // Gunakan Data URL untuk penyimpanan sederhana
                    // Tentukan tipe berdasarkan nama file baru jika mungkin, atau default ke image
                    currentMediaType = mediaThumb.dataset.newMediaName.match(/\.(mp4|webm|ogg)$/i) ? 'video' : 'image';
                    currentMediaName = mediaThumb.dataset.newMediaName;
                }

                if (mediaThumb && mediaThumb.dataset.newMediaType) { // Jika ada file baru yang dipilih
                    currentMediaSrc = mediaThumb.dataset.newMediaDataUrl;
                    currentMediaType = mediaThumb.dataset.newMediaType; // Gunakan tipe dari file baru
                    currentMediaName = mediaThumb.dataset.newMediaName;
                } else if (mediaThumb) { // Jika tidak ada file baru, coba deteksi dari tag yang ada
                    currentMediaType = mediaThumb.tagName.toLowerCase() === 'video' ? 'video' : 'image';
                    currentMediaSrc = mediaThumb.src; // src dari elemen yang ada
                }

                const charData = {
                    id: id,
                    name: nameInput ? nameInput.value : 'Unknown Name',
                    description: descInput ? descInput.value : '',
                    extendedDescription: extDescInput ? extDescInput.value : '',
                    mediaSrc: currentMediaSrc,
                    mediaType: currentMediaType
                };
                updatedCharacters.push(charData);
            });

            gameCharacters = updatedCharacters; // Update array global
            try {
                localStorage.setItem(CHARACTER_DATA_KEY, JSON.stringify(gameCharacters));
                console.log("Character data saved to localStorage:", gameCharacters);
                showNotification('Character data saved successfully!', 'notification-success');

                // Setelah menyimpan, perbarui DOM menu karakter utama dan pratinjau editor
                updateOriginalCharacterMenuDOM();
                setupCharacterMenuPreview();      // Perbarui pratinjau di editor

            } catch (e) {
                console.error("Error saving character data to localStorage:", e);
                showNotification('Error saving character data!', 'notification-error');
            }
        }


        // untuk memperbarui DOM #character-menu berdasarkan array gameCharacters
        function updateOriginalCharacterMenuDOM() {
            const mainMenuContainer = document.querySelector('#character-menu .main-container');
            if (!mainMenuContainer) {
                console.error("Cannot update original character menu: .main-container not found.");
                return;
            }
            mainMenuContainer.innerHTML = ''; // Kosongkan kontainer utama

            if (gameCharacters.length === 0) {
                mainMenuContainer.innerHTML = '<p style="color: #555; text-align: center; padding: 20px;">No characters defined.</p>';
                return;
            }

            gameCharacters.forEach(charData => {

                let mediaElementHTML;
                if (charData.mediaType === 'video') {
                    mediaElementHTML = `<video muted loop class="video" src="${charData.mediaSrc}"></video>`;
                } else { // default ke image
                    mediaElementHTML = `<img class="video character-image" src="${charData.mediaSrc}" alt="Deskripsi Gambar ${charData.name}">`;
                }

                const summaryHTML = charData.description ? `<p class="summary">${charData.description}</p>` : '';
                let extendedContentHTML = '';
                let moreButtonHTML = '';

                if (charData.extendedDescription) {
                    extendedContentHTML = `
                <div class="extended-content">
                  <p>${charData.extendedDescription}</p>
                </div>`;
                    moreButtonHTML = `<button class="more-button">More</button>`;
                }

                const cardHTML = `
            <div class="image-preview">
                ${mediaElementHTML}
                <div class="overlay">
                    <div class="desc">
                        <div class="name-and-role">
                            <h1>${charData.name}</h1>
                        </div>
                        ${summaryHTML}
                        ${extendedContentHTML}
                        ${moreButtonHTML}
                    </div>
                </div>
            </div>
        `;
                mainMenuContainer.insertAdjacentHTML('beforeend', `
        <div class="image-preview">
            ${mediaElementHTML}
            <div class="overlay">
            <div class="desc">
                <h1>${charData.name}</h1>
                ${summaryHTML}
                ${extendedContentHTML}
                ${moreButtonHTML}
            </div>
            </div>
        </div>
        `);
            });

            bindMoreButtons(mainMenuContainer);

            // Re-inisialisasi logika untuk menu karakter utama (hover, dll.)
            // initializeCharacterMenuLogic dapat menangani elemen yang baru dibuat
            const originalCharMenu = document.getElementById('character-menu');
            if (originalCharMenu) {
                initializeCharacterMenuLogic(originalCharMenu);
            }
            // Juga re-inisialisasi logika untuk gambar yang mungkin video
            const imagePreviewsInMainMenu = document.querySelectorAll("#character-menu .image-preview");
            imagePreviewsInMainMenu.forEach(preview => {
                let mediaElement = preview.querySelector(".video"); // Bisa jadi img atau video dengan class .video
                if (mediaElement) {
                    let src = mediaElement.getAttribute("src");
                    if (src && (mediaElement.tagName.toLowerCase() === 'video' && src.match(/\.(jpg|jpeg|png|gif|webp)$/i))) {
                        // Jika ini tag video tapi src-nya gambar, ganti jadi img
                        let imgElement = document.createElement("img");
                        imgElement.src = src;
                        imgElement.classList.add("character-image", "video");
                        imgElement.style.width = "100%";
                        imgElement.style.height = "100%";
                        imgElement.style.objectFit = "cover";
                        mediaElement.replaceWith(imgElement);
                    }
                }
            });
            initializeCharacterMenuLogic(mainMenuContainer);
        }

        // Event listener untuk tombol "Tambah Karakter Baru"
        const addNewCharButton = document.getElementById('buttonAddNewCharacter');
        if (addNewCharButton) {
            addNewCharButton.addEventListener('click', () => {
                const newCharData = {
                    id: generateUniqueId(), // ID unik untuk karakter baru
                    name: '',
                    description: '',
                    extendedDescription: '',
                    mediaSrc: './aset/default-character.png', // Path ke gambar placeholder
                    mediaType: 'image'
                };
                // Tambahkan ke array global dulu, meskipun masih kosong
                // Ini penting jika pengguna menyimpan tanpa mengubah apa pun
                gameCharacters.push(newCharData);
                renderCharacterEditForm(newCharData); // Tampilkan formulir kosong
                console.log("Added new blank character form.");
                updateSpecificPreview('character-menu', true);
            });
        }

        function initializeCharacterMenuLogic(rootElement) {
            if (!rootElement) return;

            const imagePreviews = rootElement.querySelectorAll(".image-preview");

            imagePreviews.forEach(previewCard => {
                let mediaElement = previewCard.querySelector("video, img.character-image");

                // Event listener untuk efek hover (memperbesar/memperkecil kartu)
                previewCard.addEventListener("mouseenter", () => {
                    if (rootElement.classList.contains("animating")) return;

                    imagePreviews.forEach(p => {
                        if (p === previewCard) {
                            p.style.flexGrow = "1.5";
                            p.classList.remove("dim");
                        } else {
                            p.style.flexGrow = "0.8";
                            p.classList.add("dim");
                            let otherMedia = p.querySelector("video");
                            if (otherMedia) otherMedia.pause();
                        }
                    });

                    if (mediaElement && mediaElement.tagName.toLowerCase() === "video" && mediaElement.paused) {
                        mediaElement.play().catch(e => console.warn("Pratinjau: Video play gagal", e));
                    }
                });

                // Event listener untuk mengembalikan ukuran saat kursor keluar
                rootElement.addEventListener("mouseleave", () => {
                    imagePreviews.forEach(p => {
                        p.style.flexGrow = "1";
                        p.classList.remove("dim");
                        let otherMedia = p.querySelector("video");
                        if (otherMedia) otherMedia.pause();
                    });
                });

                previewCard.addEventListener("mouseleave", () => {
                    imagePreviews.forEach(other => {
                        // other.style.flexGrow = "1"; // Kembali ke flex-grow default
                        other.classList.remove("dim");
                        other.classList.remove('preview-expanded'); // Hapus class expand
                        let otherMedia = other.querySelector("video");
                        if (otherMedia) otherMedia.pause();
                    });
                });

                const moreButton = previewCard.querySelector('.more-button');
                if (moreButton) {
                    if (!moreButton.hasAttribute('data-listener-added')) {
                        moreButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Mencegah event lain terpicu
                            const desc = moreButton.closest('.desc');
                            const extended = desc.querySelector('.extended-content');
                            if (extended) {
                                extended.classList.toggle('show');
                                moreButton.textContent = extended.classList.contains('show') ? 'Less' : 'More';
                            }
                        });
                        moreButton.setAttribute('data-listener-added', 'true');
                    }
                }
            });
            // Inisialisasi untuk video yang diganti gambar (jika ada)
            rootElement.querySelectorAll(".image-preview").forEach(preview => {
                let mediaElement = preview.querySelector(".video");
                if (mediaElement) {
                    let src = mediaElement.getAttribute("src");
                    if (src && src.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        let imgElement = document.createElement("img");
                        imgElement.src = src;
                        imgElement.classList.add("character-image"); // tambahkan class yang sama seperti di Character Menu asli
                        imgElement.classList.add("video"); // Tetap beri class "video" agar selector lain masih bekerja
                        imgElement.style.width = "100%";
                        imgElement.style.height = "100%";
                        imgElement.style.objectFit = "cover";
                        mediaElement.replaceWith(imgElement);
                    }
                }
            });
        }

        // Panggil fungsi ini untuk character-menu asli saat DOM siap
        document.addEventListener("DOMContentLoaded", () => {
            const originalCharMenu = document.getElementById('character-menu');
            if (originalCharMenu) {
                initializeCharacterMenuLogic(originalCharMenu);
            }
        });

                //------------------- ( Rotating Texts Editor Logic ) -------------------------//
        const ROTATING_TEXTS_KEY = 'gameRotatingTexts'; // Key untuk localStorage

        // Render semua rotating text items ke editor
        function renderRotatingTextsEditor() {
            const container = document.getElementById('rotating-texts-list-container');
            if (!container) return;

            container.innerHTML = '';

            if (rotatingTexts.length === 0) {
                container.innerHTML = '<p style="color: #777; text-align: center; padding: 10px;">Belum ada rotating text. Klik tombol di bawah untuk menambah.</p>';
                return;
            }

            rotatingTexts.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'rotating-text-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <span class="drag-handle" title="Drag untuk mengurutkan"></span>
                    <input type="text" class="rotating-text-input" value="${escapeHtml(text)}" placeholder="Masukkan teks..." />
                    <button type="button" class="remove-rotating-text-btn" title="Hapus"></button>
                `;
                container.appendChild(item);
            });

            // Add event listeners
            container.querySelectorAll('.rotating-text-input').forEach((input, index) => {
                input.addEventListener('input', () => {
                    rotatingTexts[index] = input.value;
                    isEditorDirty = true;
                });
            });

            container.querySelectorAll('.remove-rotating-text-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    rotatingTexts.splice(index, 1);
                    renderRotatingTextsEditor();
                    isEditorDirty = true;
                });
            });
        }

        // Helper untuk escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listener untuk tombol tambah rotating text
        document.addEventListener('DOMContentLoaded', () => {
            const addBtn = document.getElementById('add-rotating-text-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    rotatingTexts.push('');
                    renderRotatingTextsEditor();
                    isEditorDirty = true;
                    // Focus ke input terakhir
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('#rotating-texts-list-container .rotating-text-input');
                        if (inputs.length > 0) {
                            inputs[inputs.length - 1].focus();
                        }
                    }, 50);
                });
            }
        });

        // Load rotating texts dari localStorage atau character_data.json
        async function loadRotatingTexts() {
            // Coba load dari localStorage dulu
            const savedTexts = localStorage.getItem(ROTATING_TEXTS_KEY);
            if (savedTexts) {
                try {
                    const parsed = JSON.parse(savedTexts);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        rotatingTexts = parsed;
                        console.log('[RotatingTexts] Loaded from localStorage:', rotatingTexts);
                        return;
                    }
                } catch (e) {
                    console.error('[RotatingTexts] Error parsing localStorage:', e);
                }
            }

            // Fallback: load dari character_data.json
            try {
                const response = await fetch('./aset/konten/character_data.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.rotatingTexts && Array.isArray(data.rotatingTexts) && data.rotatingTexts.length > 0) {
                        rotatingTexts = data.rotatingTexts;
                        console.log('[RotatingTexts] Loaded from character_data.json:', rotatingTexts);
                    }
                }
            } catch (e) {
                console.error('[RotatingTexts] Error loading from JSON:', e);
            }
        }

        // Save rotating texts ke localStorage
        function saveRotatingTextsToLocalStorage() {
            // Filter out empty strings
            const textsToSave = rotatingTexts.filter(text => text.trim() !== '');
            localStorage.setItem(ROTATING_TEXTS_KEY, JSON.stringify(textsToSave));
            rotatingTexts = textsToSave;
            console.log('[RotatingTexts] Saved to localStorage:', textsToSave);
        }

        // Load rotating texts saat halaman dimuat
        document.addEventListener('DOMContentLoaded', async () => {
            await loadRotatingTexts();
        });
        //------------------- ( End Rotating Texts Editor Logic ) -------------------------//

        function setupCharacterMenuPreview() {
            console.log("Memulai setupCharacterMenuPreview (versi replika konten)...");

            const originalCharMenuMainContainer = document.querySelector('#character-menu .main-container');
            const previewContentArea = document.getElementById('live-preview-character-menu-content');
            const previewBox = document.getElementById('preview-character-menu-box'); // Box luar untuk referensi ukuran jika perlu

            if (!originalCharMenuMainContainer) {
                console.error("Elemen asli '#character-menu .main-container' tidak ditemukan.");
                if (previewContentArea) previewContentArea.innerHTML = '<p style="color:red;">Error: Konten asli tidak ditemukan.</p>';
                return;
            }
            if (!previewContentArea) {
                console.error("Elemen '#live-preview-character-menu-content' untuk pratinjau tidak ditemukan.");
                return;
            }
            if (!previewBox) {
                console.error("Elemen '.preview-box' (#preview-character-menu-box) tidak ditemukan.");
                return;
            }

            // 1. Bersihkan area pratinjau
            previewContentArea.innerHTML = '';

            // 2. Kloning .main-container dari #character-menu asli
            const clonedMainContainer = originalCharMenuMainContainer.cloneNode(true);

            // 3. Modifikasi ID dan style dasar untuk kloningan agar pas di preview box
            clonedMainContainer.id = 'character-menu-preview-instance'; // ID unik untuk instance pratinjau
            clonedMainContainer.style.width = '100%';
            clonedMainContainer.style.height = '100%';
            clonedMainContainer.style.display = 'flex'; // Sudah ada dari CSS asli, tapi untuk memastikan
            clonedMainContainer.style.flexDirection = 'row'; // Sudah ada dari CSS asli
            clonedMainContainer.style.overflow = 'hidden'; // Penting agar konten tidak meluber
            clonedMainContainer.style.backgroundColor = '#000'; // Latar belakang untuk kontainer pratinjau
            clonedMainContainer.style.position = 'relative'; // Memastikan posisi absolut anak-anaknya relatif terhadap ini

            // 4. Sesuaikan kartu-kartu di dalam kloningan
            const previewCards = clonedMainContainer.querySelectorAll('.image-preview');
            previewCards.forEach(card => {
                // Hapus animasi asli dan pastikan kartu terlihat
                card.style.animation = 'none';
                card.style.opacity = '1';

                // Sesuaikan ukuran font untuk teks di overlay agar lebih kecil dan terbaca
                const descElements = card.querySelectorAll('.overlay .desc h1, .overlay .desc p');
                descElements.forEach(textEl => {
                    if (textEl.tagName === 'H1') {
                        textEl.style.fontSize = '0.7rem'; // Ukuran font nama karakter
                        textEl.style.marginBottom = '3px';
                    } else if (textEl.tagName === 'P') {
                        textEl.style.fontSize = '0.6rem'; // Ukuran font deskripsi
                        textEl.style.lineHeight = '1.2';
                    }
                });
                const moreButton = card.querySelector('.more-button');
                if (moreButton) {
                    moreButton.style.fontSize = '0.6rem';
                    moreButton.style.padding = '2px 4px';
                    moreButton.style.marginTop = '4px';
                }

                const overlayElement = card.querySelector('.overlay');
                if (overlayElement) {
                    // Mungkin perlu mengurangi tinggi overlay agar video/gambar lebih terlihat
                    overlayElement.style.height = '35%'; // Misalnya
                    overlayElement.style.padding = '10px'; // Kurangi padding
                }

                // video di-mute dan di-loop, serta di-pause awalnya
                const video = card.querySelector('video');
                if (video) {
                    video.muted = true;
                    video.loop = true;
                    video.pause();
                    video.style.borderRight = 'none'; // Hapus border jika ada dari style asli
                }
                const image = card.querySelector('img.character-image');
                if (image) {
                    image.style.borderRight = 'none';
                }
                card.style.borderRight = '1px solid #222';
            });
            if (previewCards.length > 0) {
                previewCards[previewCards.length - 1].style.borderRight = 'none'; // Hapus border di kartu terakhir
            }


            previewContentArea.appendChild(clonedMainContainer);

            initializeCharacterMenuLogic(clonedMainContainer);

            console.log("setupCharacterMenuPreview (versi replika konten) selesai.");
        }

        // --- FUNGSI UNTUK MENYIMPAN SEMUA PERUBAHAN DARI SEMUA INPUT FIELD ---
        function saveAllEditorChanges() {
            editableSections.forEach(section => {
                const elementId = section.elementId;
                if (elementId === 'warning-screen') {
                    const el = screens.find(s => s.id === 'warning-screen');
                    if (el) {
                        el.querySelectorAll('p')[0].textContent = document.getElementById('edit-warning-text-1').value;
                        el.querySelectorAll('p')[1].textContent = document.getElementById('edit-warning-text-2').value;
                    }
                } else if (elementId === 'developer-screen') {
                    const el = screens.find(s => s.id === 'developer-screen');
                    if (el) {
                        el.querySelector('h2').textContent = document.getElementById('edit-developer-title').value;
                        el.querySelector('h4').textContent = document.getElementById('edit-developer-subtitle').value;
                    }
                } else if (elementId === 'concept-screen') {
                    const el = screens.find(s => s.id === 'concept-screen');
                    if (el) {
                        el.querySelector('h2').textContent = document.getElementById('edit-disclaimer-title').value;
                        el.querySelector('p').textContent = document.getElementById('edit-disclaimer-text').value;
                    }
                } else if (elementId === 'title-screen') {
                    const el = screens.find(s => s.id === 'title-screen');
                    if (el) {
                        const h1El = el.querySelector('h1');
                        setTitleHeadingText(h1El, document.getElementById('edit-title-main').value);
                        el.querySelector('h3').textContent = document.getElementById('edit-title-subtitle').value;
                        el.querySelector('p').textContent = document.getElementById('edit-title-press-start').value;
                    }
                } else if (elementId === 'profile-section') {
                    // Simpan teks
                    const profileNameElement = document.getElementById('profile-name'); // Elemen game asli
                    if (profileNameElement) profileNameElement.textContent = document.getElementById('edit-profile-name').value;

                    const profileLevelElement = document.getElementById('profile-level'); // Elemen game asli
                    if (profileLevelElement) profileLevelElement.textContent = document.getElementById('edit-profile-level').value;

                    const profileDescriptionElement = document.getElementById('profile-description'); // Elemen game asli
                    if (profileDescriptionElement) profileDescriptionElement.textContent = document.getElementById('edit-profile-description').value;

                    // Simpan gambar profil
                    const actualProfilePicElement = document.getElementById('profile-picture'); // Elemen game asli
                    const editorImagePreviewSrc = document.getElementById('edit-profile-image-preview').src; // Ambil src dari pratinjau input
                    if (actualProfilePicElement && editorImagePreviewSrc) {
                        actualProfilePicElement.src = editorImagePreviewSrc;
                    }
                }
                updateSpecificPreview(elementId, false); // Update preview berdasarkan data game asli yang baru saja diubah
            });

            // Simpan rotating texts
            if (typeof saveRotatingTextsToLocalStorage === 'function') {
                saveRotatingTextsToLocalStorage();
            }

            saveAllEditableContentToLocalStorage();
            showNotification('All changes saved successfully!', 'notification-success');
            updateAllPreviews(false); // Update pratinjau kiri setelah menyimpan
        }

        // Event listener untuk tombol "Save Changes"
        if (saveEditorChangesBtn) {
            saveEditorChangesBtn.addEventListener('click', () => {
                saveAllEditorChanges();
                if (typeof window.saveCharacterMenuData === 'function') {
                    window.saveCharacterMenuData();
                }
                isEditorDirty = false; // Reset flag setelah menyimpan
            });
        }

        // Tombol untuk membuka Game Editor dari Main Menu
        if (gameEditorButton) {
            gameEditorButton.addEventListener('click', () => {
                const mainMenu = document.getElementById('main-menu');
                if (mainMenu) mainMenu.style.display = 'none';

                // Sembunyikan elemen lain jika perlu (characterMenu, optionsModal, dll.)
                const characterMenu = document.getElementById('character-menu');
                if (characterMenu) characterMenu.style.display = 'none';
                const optionsModal = document.getElementById('options-modal');
                if (optionsModal) { optionsModal.classList.add('hidden'); optionsModal.classList.remove('open'); }
                const quitModal = document.getElementById('quit-modal');
                if (quitModal) quitModal.classList.add('hidden');
                const menuPopup = document.getElementById('menu-popup');
                if (menuPopup) menuPopup.style.display = 'none';


                gameEditorScreen.style.display = 'flex';
                gameEditorScreen.style.animation = 'fadeIn 0.5s forwards';

                loadAllEditableContentFromLocalStorage(); // Muat dari LS dulu
                loadAllDataToEditorInputs(); // Kemudian isi semua input & update preview
                if (characterMenu) {
                    characterMenu.style.display = 'block'; // Atau 'flex' tergantung main-container
                    characterMenu.style.opacity = '1';
                    console.log("Explicitly setting originalCharMenu to display:block and opacity:1 before setupCharacterMenuPreview timeout.");
                }
                setTimeout(setupCharacterMenuPreview, 100);
                setTimeout(() => {
                    loadCharacterDataForEditor();
                }, 0);

                // Reset dan jalankan animasi 'click-to-continue' di preview warning screen
                const previewContinue = document.querySelector('#preview-warning-screen .click-to-continue');
                if (previewContinue) {
                    previewContinue.classList.remove('visible');
                    setTimeout(() => {
                        // Cek apakah editor masih terbuka agar tidak error/aneh jika sudah ditutup
                        if (gameEditorScreen.style.display === 'flex') {
                            previewContinue.classList.add('visible');
                        }
                    }, 5000);
                }
            });
        }

        // Tombol untuk kembali ke Main Menu dari Game Editor
        if (backToMainMenuEditorBtn) {
            backToMainMenuEditorBtn.addEventListener('click', () => {
                if (isEditorDirty) {
                    const confirmLeave = confirm("Anda memiliki perubahan yang belum disimpan. Apakah Anda yakin ingin kembali ke Menu Utama tanpa menyimpan?");
                    if (!confirmLeave) {
                        return; // Batalkan aksi kembali
                    }
                    isEditorDirty = false; // Reset flag jika pengguna memilih untuk melanjutkan
                }

                console.log("Back from Editor: #character-menu display BEFORE hide:", document.getElementById('character-menu').style.display);
                gameEditorScreen.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => {
                    gameEditorScreen.style.display = 'none';

                    const characterMenu = document.getElementById('character-menu');
                    if (characterMenu) {
                        // Kembalikan character-menu ke state awalnya (tersembunyi)
                        characterMenu.style.display = 'none';
                        characterMenu.style.opacity = '0';
                        characterMenu.style.animation = ''; // Hapus inline style animasi
                        // Reset juga animasi pada kartu-kartunya jika perlu, agar saat dibuka lagi normal
                        characterMenu.querySelectorAll('.image-preview').forEach(card => {
                            card.style.opacity = '0'; // Sesuai CSS awal
                            card.style.animation = ''; // Agar animasi swipeUp bisa berjalan lagi nanti
                        });
                        console.log("Back from Editor: #character-menu display AFTER hide:", characterMenu.style.display);
                    } else {
                        console.warn("Back from Editor: #character-menu element not found to hide.");
                    }

                    const mainMenu = document.getElementById('main-menu');
                    if (mainMenu) {
                        console.log("Back from Editor: #main-menu display BEFORE show:", mainMenu.style.display);
                        mainMenu.style.display = 'flex';
                        mainMenu.style.animation = 'fadeIn 0.5s forwards';
                        mainMenu.style.opacity = '1';
                        console.log("Back from Editor: #main-menu display AFTER show:", mainMenu.style.display);
                    } else {
                        console.warn("Back from Editor: #main-menu element not found to show.");
                    }
                }, 500);
            });
        }

        // --- Persistensi untuk Game Editor Content ---
        let editableContent = {};

        function loadAllEditableContentFromLocalStorage() {
            const savedContentString = localStorage.getItem('gameEditableContent');
            if (savedContentString) {
                try {
                    editableContent = JSON.parse(savedContentString) || {}; // Inisialisasi jika null

                    editableSections.forEach(section => {
                        const data = editableContent[section.elementId];
                        if (!data) return;

                        const elementId = section.elementId;
                        if (elementId === 'warning-screen') {
                            const el = screens.find(s => s.id === 'warning-screen');
                            if (el) {
                                el.querySelectorAll('p')[0].textContent = data.line1 || " Health and Safety Warning ";
                                el.querySelectorAll('p')[1].textContent = data.line2 || "Take breaks regularly and play responsibly.";
                            }
                        } else if (elementId === 'developer-screen') {
                            const el = screens.find(s => s.id === 'developer-screen');
                            if (el) {
                                el.querySelector('h2').textContent = data.title || "Dev name";
                                el.querySelector('h4').textContent = data.subtitle || "sub title";
                            }
                        } else if (elementId === 'concept-screen') {
                            const el = screens.find(s => s.id === 'concept-screen');
                            if (el) {
                                el.querySelector('h2').textContent = data.title || "Disclaimer!!";
                                const p = el.querySelector('p');
                                if (p) {
                                    p.textContent = data.text || "Proyek ini dikerjakan secara part time plus kalau lagi mood aja, harap maklumi jika updatenya lama.";
                                }
                            }
                        } else if (elementId === 'title-screen') {
                            const el = screens.find(s => s.id === 'title-screen');
                            if (el) {
                                const h1El = el.querySelector('h1');
                                setTitleHeadingText(h1El, data.mainTitle || "Main Title");
                                el.querySelector('h3').textContent = data.subtitle || "Subtitle";
                                el.querySelector('p').textContent = data.pressStart || "Press Start";
                            }
                        } else if (elementId === 'profile-section') {
                            const profileNameEl = document.getElementById('profile-name');
                            if (profileNameEl) profileNameEl.textContent = data.name || "--";
                            const profileLevelEl = document.getElementById('profile-level');
                            if (profileLevelEl) profileLevelEl.textContent = data.level || "Level: --";
                            const profileDescriptionEl = document.getElementById('profile-description');
                            if (profileDescriptionEl) profileDescriptionEl.textContent = data.description || "Description...";
                            const actualProfilePic = document.getElementById('profile-picture'); // Elemen game asli
                            if (actualProfilePic) {
                                actualProfilePic.src = data.profileImageSrc || './aset/ikon.jpg'; // Fallback ke default
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error parsing saved content from localStorage:", e);
                    editableContent = {}; // Reset jika error
                }
            }
            if (document.getElementById('game-editor-screen').style.display === 'flex') {
                loadAllDataToEditorInputs();
            }
        }

        function saveAllEditableContentToLocalStorage() {
            const currentContentToSave = {};
            editableSections.forEach(section => {
                const elementId = section.elementId;
                const data = {};
                if (elementId === 'warning-screen') {
                    const el = screens.find(s => s.id === 'warning-screen');
                    if (el) { data.line1 = el.querySelectorAll('p')[0]?.textContent; data.line2 = el.querySelectorAll('p')[1]?.textContent; }
                } else if (elementId === 'developer-screen') {
                    const el = screens.find(s => s.id === 'developer-screen');
                    if (el) { data.title = el.querySelector('h2')?.textContent; data.subtitle = el.querySelector('h4')?.textContent; }
                } else if (elementId === 'concept-screen') {
                    const el = screens.find(s => s.id === 'concept-screen');
                    if (el) {
                        data.title = el.querySelector('h2')?.textContent;
                        data.text = el.querySelector('p')?.textContent;
                    }
                } else if (elementId === 'title-screen') {
                    const el = screens.find(s => s.id === 'title-screen');
                    if (el) {
                        data.mainTitle = el.querySelector('h1')?.textContent;
                        data.subtitle = el.querySelector('h3')?.textContent;
                        data.pressStart = el.querySelector('p')?.textContent;
                    }
                } else if (elementId === 'profile-section') {
                    data.name = document.getElementById('profile-name')?.textContent; // Ambil dari elemen game asli
                    data.level = document.getElementById('profile-level')?.textContent;
                    data.description = document.getElementById('profile-description')?.textContent;
                    data.profileImageSrc = document.getElementById('profile-picture')?.src; // Ambil src dari elemen gambar game asli
                }
                currentContentToSave[elementId] = data;
            });

            localStorage.setItem('gameEditableContent', JSON.stringify(currentContentToSave));
            console.log('All editable content saved to localStorage.');
            editableContent = currentContentToSave;
        }

        // --- Update Pratinjau secara Real-time saat Mengetik ---
        function addRealTimePreviewUpdaterForAllInputs() {
            editableSections.forEach(section => {
                const elementId = section.elementId;
                // Dapatkan semua input dan textarea di dalam kontainer input untuk section ini
                const inputContainer = document.getElementById(`edit-${elementId}-inputs`);
                if (inputContainer) {
                    const inputs = inputContainer.querySelectorAll('input[type="text"], textarea');
                    inputs.forEach(input => {
                        input.addEventListener('input', () => {
                            updateSpecificPreview(elementId, true); // true menandakan update dari input
                        });
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            addRealTimePreviewUpdaterForAllInputs();

            const savedCharsString = localStorage.getItem(CHARACTER_DATA_KEY);
            let charactersLoaded = false;

            if (savedCharsString) {
                try {
                    const parsedChars = JSON.parse(savedCharsString);
                    if (Array.isArray(parsedChars) && parsedChars.length > 0) {
                        gameCharacters = parsedChars;
                        console.log("Initial characters loaded from localStorage on DOMContentLoaded:", gameCharacters);
                        updateOriginalCharacterMenuDOM();
                        charactersLoaded = true;
                    } else {
                        console.log("localStorage character data is empty or invalid.");
                    }
                } catch (e) {
                    console.error("Error parsing characters from localStorage on DOMContentLoaded:", e);
                }
            }

            if (!charactersLoaded) {
                // Jika tidak ada di LS yang valid, ekstrak dari DOM #character-menu yang mungkin hardcoded
                const extractedChars = extractCharactersFromDOM();
                if (extractedChars.length > 0) {
                    gameCharacters = extractedChars;
                    console.log("Initial characters extracted from hardcoded DOM on DOMContentLoaded:", gameCharacters);
                    // Simpan ke localStorage untuk penggunaan selanjutnya jika belum ada atau tidak valid
                    localStorage.setItem(CHARACTER_DATA_KEY, JSON.stringify(gameCharacters));
                } else {
                    console.log("No characters found in hardcoded DOM either.");
                    updateOriginalCharacterMenuDOM(); // Akan menampilkan pesan "No characters defined."
                }
            }

            const profileImagePreviewInEditor = document.getElementById('edit-profile-image-preview');
            const profileImageInput = document.getElementById('edit-profile-image-input');

            if (profileImagePreviewInEditor && profileImageInput) {
                // Ketika gambar pratinjau di area input diklik, picu input file
                profileImagePreviewInEditor.addEventListener('click', () => {
                    profileImageInput.click();
                });

                // Ketika file dipilih di input file
                profileImageInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newImageSrc = e.target.result; // Ini adalah Base64 Data URL

                            profileImagePreviewInEditor.src = newImageSrc;
                            updateSpecificPreview('profile-section', true);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            const optionRows = document.querySelectorAll('#options-modal .option-row, #options-modal .option-row-checkbox');
            const descriptionTextElement = document.getElementById('option-description-text');
            const defaultDescription = 'Pilih opsi setting...';

            if (descriptionTextElement) {
                optionRows.forEach(row => {
                    // Saat kursor masuk ke area baris opsi
                    row.addEventListener('mouseenter', () => {
                        const description = row.getAttribute('data-description');
                        descriptionTextElement.style.opacity = '0';
                        setTimeout(() => {
                            descriptionTextElement.textContent = description || defaultDescription;
                            descriptionTextElement.style.opacity = '1';
                        }, 200);
                    });

                    // Saat kursor keluar dari area baris opsi
                    row.addEventListener('mouseleave', () => {
                        descriptionTextElement.style.opacity = '0';
                        setTimeout(() => {
                            descriptionTextElement.textContent = defaultDescription;
                            descriptionTextElement.style.opacity = '1';
                        }, 200);
                    });
                });
            }
        });
        //------------------- ( end logika character menu editor ) -------------------------//

        // ================================ ( End Logika Game Editor ) ================================ //


        // ================================ ( Menu Options & Quit ) ================================ //
        //------------------- ( inisialisasi elemen opsi & quit ) -------------------------//
        // Elemen modal dan tombol kontrol
        const optionsMenu = document.getElementById('options');
        const quitMenu = document.getElementById('quit');
        //------------------- elemen modal & navbar -------------------------//
        const optionsModal = document.getElementById('options-modal');
        const closeOptionsBtn = document.getElementById('close-options');
        const applyOptionsBtn = document.getElementById('apply-options');
        const rememberSettingsToggleBtn = document.getElementById('remember-settings-toggle');
        const clearRememberedSettingsBtn = document.getElementById('clear-remembered-settings');
        const resolutionSelect = document.getElementById('resolution-select');
        const fullscreenCheckbox = document.getElementById('fullscreen-checkbox');
        const idleReturnCheckbox = document.getElementById('idle-return-checkbox');
        const snowEffectCheckboxOriginal = document.getElementById('snow-effect-checkbox');
        const webgpuCheckbox = document.getElementById('webgpu-acceleration-checkbox');
        const miniPlayerCheckboxInOptions = document.getElementById('mini-player-effect-checkbox');
        const enableAdSkipperCheckbox = document.getElementById('enable-ad-skipper-checkbox');
        const webgpuVisualizerStyleRow = document.getElementById('webgpu-visualizer-style-row');
        const webgpuVisualizerStyleSelect = document.getElementById('webgpu-visualizer-style');

        // Function to toggle WebGPU Visualizer Style option based on WebGPU Acceleration
        function updateWebGPUVisualizerStyleAvailability(isWebGPUEnabled) {
            if (webgpuVisualizerStyleRow && webgpuVisualizerStyleSelect) {
                if (isWebGPUEnabled) {
                    webgpuVisualizerStyleRow.classList.remove('disabled-option');
                    webgpuVisualizerStyleSelect.disabled = false;
                } else {
                    webgpuVisualizerStyleRow.classList.add('disabled-option');
                    webgpuVisualizerStyleSelect.disabled = true;
                }
            }
        }

        // Listen to WebGPU Acceleration checkbox changes
        if (webgpuCheckbox) {
            webgpuCheckbox.addEventListener('change', (e) => {
                updateWebGPUVisualizerStyleAvailability(e.target.checked);
            });
        }





        let rememberedSettingsSaved = false;
        function updateRememberSettingsButton(saved) {
            rememberedSettingsSaved = saved === true;
            if (!rememberSettingsToggleBtn) return;
            rememberSettingsToggleBtn.classList.toggle('is-enabled', rememberedSettingsSaved);
            rememberSettingsToggleBtn.setAttribute('aria-pressed', rememberedSettingsSaved ? 'true' : 'false');
            rememberSettingsToggleBtn.title = rememberedSettingsSaved ? 'Saved' : 'Not saved';
        }

        let optionsUiBaselineSnapshot = null;

        function getOptionsUIPartialSnapshot() {
            const resValue = resolutionSelect ? resolutionSelect.value : '';
            const [width, height] = (resValue || '').split('x').map(Number);

            const isFullscreenVal = fullscreenCheckbox ? fullscreenCheckbox.checked : false;
            const idleReturnVal = idleReturnCheckbox ? idleReturnCheckbox.checked : false;
            const snowEnabledVal = snowEffectCheckboxOriginal ? snowEffectCheckboxOriginal.checked : false;
            const webgpuEnabledVal = webgpuCheckbox ? webgpuCheckbox.checked : false;
            const webgpuVisualizerStyleVal = document.getElementById('webgpu-visualizer-style')
                ? document.getElementById('webgpu-visualizer-style').value
                : (sessionStorage.getItem('savedWebGPUVisualizerStyle') || '1');
            const miniPlayerEnabledVal = miniPlayerCheckboxInOptions ? miniPlayerCheckboxInOptions.checked : false;

            const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
            const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
            const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings');

            const darknessValue = optionsPaneDarknessSlider ? optionsPaneDarknessSlider.value : 30;
            const followMusicValue = optionsPaneFollowMusicCheckbox ? optionsPaneFollowMusicCheckbox.checked : false;
            const enableHiddenSettingsValue = enableHiddenSettingsCheckbox ? enableHiddenSettingsCheckbox.checked : false;

            const adSkipperVal = document.getElementById('enable-ad-skipper-checkbox')?.checked === true;
            const autoMuteVal = document.getElementById('auto-mute-ads-checkbox')?.checked === true;
            const autoSkipVal = document.getElementById('auto-skip-ads-checkbox')?.checked === true;

            const rpcEnabledVal = (typeof enableRpcCheckbox !== 'undefined' && enableRpcCheckbox) ? enableRpcCheckbox.checked : false;
            const showLogOverlayVal = document.getElementById('toggle-log-overlay-checkbox')?.checked === true;

            const dynamicMusicPlayerCheckbox = document.getElementById('enable-dynamic-music-player-checkbox');
            const dynamicMusicPlayerVal = dynamicMusicPlayerCheckbox ? dynamicMusicPlayerCheckbox.checked : false;

            // Sub-options yang sering terlewat
            const miniPlayerHideCheckbox = document.getElementById('mini-player-hide-on-cursor');
            const miniPlayerHideVal = miniPlayerHideCheckbox ? miniPlayerHideCheckbox.checked : false;

            const overlayCheckbox = document.getElementById('enable-overlay-checkbox');
            const overlayVal = overlayCheckbox ? overlayCheckbox.checked : false;

            const dynamicThemeCheckbox = document.getElementById('enable-dynamic-theme-checkbox');
            const dynamicThemeVal = dynamicThemeCheckbox ? dynamicThemeCheckbox.checked : false;

            const dynamicThemeModeSelect = document.getElementById('dynamic-theme-mode-select');
            const dynamicThemeModeVal = dynamicThemeModeSelect ? dynamicThemeModeSelect.value : 'default';

            return {
                windowWidth: Number.isFinite(width) ? width : undefined,
                windowHeight: Number.isFinite(height) ? height : undefined,
                isFullscreen: isFullscreenVal,
                idleReturn: idleReturnVal,
                snowFeatureEnabled: snowEnabledVal,
                webgpuEnabled: webgpuEnabledVal,
                webgpuVisualizerStyle: webgpuVisualizerStyleVal,
                miniPlayerFeatureEnabled: miniPlayerEnabledVal,
                miniPlayerHideOnCursor: miniPlayerHideVal,
                darkness: darknessValue,
                followMusic: followMusicValue,
                enableHiddenWallpaperSettings: enableHiddenSettingsValue,
                rpcEnabled: rpcEnabledVal,
                showLogOverlay: showLogOverlayVal,
                adSkipperEnabled: adSkipperVal,
                autoMuteAds: autoMuteVal,
                autoSkipAds: autoSkipVal,
                dynamicMusicPlayerStylingEnabled: dynamicMusicPlayerVal,
                enableVideoWallpaper: document.getElementById('enable-video-wallpaper')?.checked,
                enableGifOverlay: document.getElementById('enable-gif-overlay-checkbox')?.checked,
                gameGifInteractionLock: document.getElementById('game-gif-interaction-lock')?.checked,
                overlayEnabled: overlayVal,
                dynamicThemeEnabled: dynamicThemeVal,
                dynamicThemeMode: dynamicThemeModeVal
            };
        }

        async function rememberSettingsSaveSnapshotFromOptionsUI() {
            const partial = getOptionsUIPartialSnapshot();

            ipcRenderer.send('save-settings', partial);
            const result = await ipcRenderer.invoke('remember-settings-save', partial);
            updateRememberSettingsButton(result && result.saved === true);

            return partial;
        }

        if (rememberSettingsToggleBtn) {
            rememberSettingsToggleBtn.addEventListener('click', async () => {
                try {
                    const beforeSettings = optionsUiBaselineSnapshot || await ipcRenderer.invoke('load-settings');
                    const partial = await rememberSettingsSaveSnapshotFromOptionsUI();
                    const diffLines = buildSettingsDiffLines(beforeSettings, partial);
                    optionsUiBaselineSnapshot = partial;
                    showNotification('Settings saved!', 'notification-success', diffLines.length > 0 ? diffLines : ['No changes detected.']);
                } catch (e) {
                    console.warn('[Remember Settings] Save failed:', e);
                    showNotification('Failed to save settings', 'notification-error');
                }
            });
        }

        if (clearRememberedSettingsBtn) {
            clearRememberedSettingsBtn.addEventListener('click', async () => {
                try {
                    const result = await ipcRenderer.invoke('remember-settings-clear');
                    updateRememberSettingsButton(result && result.saved === true);
                    showNotification('Saved settings cleared!', 'notification-success', ['Remembered settings: cleared']);
                } catch (e) {
                    console.warn('[Remember Settings] Clear failed:', e);
                    showNotification('Failed to clear saved settings', 'notification-error');
                }
            });
        }

        ipcRenderer.on('remember-settings-status-changed', (_event, saved) => {
            updateRememberSettingsButton(saved);
        });

        const quitModal = document.getElementById('quit-modal');
        const confirmQuitBtn = document.getElementById('confirm-quit');
        const cancelQuitBtn = document.getElementById('cancel-quit');

        const customQuitPopup = document.getElementById('custom-quit-popup');
        const customConfirmQuitBtn = document.getElementById('custom-confirm-quit-btn');
        const customCancelQuitBtn = document.getElementById('custom-cancel-quit-btn');
        //------------------- end elemen modal & navbar -------------------------//

        //------------------- navigasi navbar opsi -------------------------//
        // Navbar di dalam Options Menu
        const optionsNavbarItems = document.querySelectorAll('.options-navbar-item');
        const optionsContentPanes = document.querySelectorAll('.options-content-pane');

        // Tambahkan event listener untuk klik di seluruh dokumen body
        // Tambahkan event listener untuk klik di seluruh dokumen body
        document.body.addEventListener('click', (event) => {
            // Jangan tutup jika klik di dalam options modal
            if (event.target.closest('#options-modal')) return;

            // Jangan tutup jika klik di dalam game gif settings modal
            if (event.target.closest('#game-gif-settings-modal')) return;

            // Jangan tutup jika klik tombol settings (karena ini membuka modal lain)
            if (event.target.closest('.game-gif-settings-btn')) return;

            // Jangan tutup jika klik di dalam about panel atau tombol bukanya
            if (event.target.closest('#about-panel')) return;
            if (event.target.closest('#open-about-panel')) return;

            if (optionsModal.classList.contains('open')) {
                closeOptionsBtn.click();
            }
        });


        // Tutup Options Menu
        closeOptionsBtn.addEventListener('click', () => {
            optionsModal.classList.remove('open');
            setTimeout(() => {
                if (!optionsModal.classList.contains('open')) {
                    optionsModal.classList.add('hidden');
                }
            }, 200);
        });
        //------------------- end navigasi navbar opsi -------------------------//

        //------------------- kontrol fullscreen & resolution -------------------------//
        //------------------- ( sinkron status fullscreen dari main process ) -------------------------//
        ipcRenderer.on("fullscreen-status-changed", (newIsFullscreen) => {
            if (fullscreenCheckbox) {
                fullscreenCheckbox.checked = newIsFullscreen;
            }
        });

        //------------------- ( end sinkron status fullscreen dari main process ) -------------------------//

        //------------------- ( buka menu options + sync value saat dibuka ) -------------------------//
        optionsMenu.addEventListener('click', async () => {
            optionsModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                optionsModal.classList.add('open');
            });

            // Set status fullscreen saat menu dibuka
            const isFullscreen = await ipcRenderer.invoke('get-fullscreen-status');
            fullscreenCheckbox.checked = isFullscreen;

            // Set resolusi saat menu dibuka
            if (!isFullscreen) {
                const currentSize = await ipcRenderer.invoke('get-window-size');
                if (currentSize && resolutionSelect) {
                    const currentResValue = `${currentSize.width}x${currentSize.height}`;
                    // Cek apakah opsi ini ada di dropdown
                    let optionExists = false;
                    for (let i = 0; i < resolutionSelect.options.length; i++) {
                        if (resolutionSelect.options[i].value === currentResValue) {
                            optionExists = true;
                            break;
                        }
                    }
                    if (optionExists) {
                        resolutionSelect.value = currentResValue;
                    } else {
                        // Tambahkan sebagai opsi baru jika tidak ada dan tandai sebagai terpilih
                        // Atau biarkan default jika tidak ingin menambahkannya secara dinamis
                        console.warn(`Current resolution ${currentResValue} not in dropdown. Consider adding it or handling it.`);
                    }
                }
            }

            // Set status idle return & snow effect saat menu dibuka
            const currentSettings = await ipcRenderer.invoke('load-settings');
            if (currentSettings) {
                updateRememberSettingsButton(currentSettings.rememberedSettingsSaved);
                if (currentSettings.idleReturn !== undefined) {
                    idleReturnCheckbox.checked = currentSettings.idleReturn;
                } else {
                    idleReturnCheckbox.checked = sessionStorage.getItem('savedIdleReturn') === 'true';
                }
                if (currentSettings.snowFeatureEnabled !== undefined) {
                    snowEffectCheckboxOriginal.checked = currentSettings.snowFeatureEnabled;
                } else {
                    snowEffectCheckboxOriginal.checked = sessionStorage.getItem('savedSnowEffect') === 'true';
                }

                if (currentSettings.webgpuEnabled !== undefined) {
                    webgpuCheckbox.checked = currentSettings.webgpuEnabled;
                } else {
                    webgpuCheckbox.checked = sessionStorage.getItem('savedWebGPU') === 'true';
                }
                // Update WebGPU Visualizer Style availability based on loaded settings
                updateWebGPUVisualizerStyleAvailability(webgpuCheckbox.checked);

                const webgpuVisualizerStyleSelect = document.getElementById('webgpu-visualizer-style');
                if (webgpuVisualizerStyleSelect) {
                    const preferredStyle = (currentSettings.webgpuVisualizerStyle !== undefined)
                        ? String(currentSettings.webgpuVisualizerStyle)
                        : (sessionStorage.getItem('savedWebGPUVisualizerStyle') || "1");
                    webgpuVisualizerStyleSelect.value = preferredStyle;
                    sessionStorage.setItem('savedWebGPUVisualizerStyle', preferredStyle);
                }

                miniPlayerCheckboxInOptions.checked = currentSettings.miniPlayerFeatureEnabled ?? (sessionStorage.getItem('savedMiniPlayerEffect') === 'true');

                // Sync Ad Skipper settings saat menu Options dibuka (biar gak ke-save default false)
                if (enableAdSkipperCheckbox) {
                    enableAdSkipperCheckbox.checked = currentSettings.adSkipperEnabled === true;
                }
                const autoMuteCheckbox = document.getElementById('auto-mute-ads-checkbox');
                const autoSkipCheckbox = document.getElementById('auto-skip-ads-checkbox');
                if (autoMuteCheckbox) autoMuteCheckbox.checked = currentSettings.autoMuteAds === true;
                if (autoSkipCheckbox) autoSkipCheckbox.checked = currentSettings.autoSkipAds === true;

                const adSkipperSubBox = document.getElementById('ad-skipper-sub-options');
                if (adSkipperSubBox) {
                    if (enableAdSkipperCheckbox && enableAdSkipperCheckbox.checked) {
                        adSkipperSubBox.classList.add('visible');
                    } else {
                        adSkipperSubBox.classList.remove('visible');
                    }
                }
            }


            // Load wallpaper settings into the options pane when it's opened
            const savedDarkness = sessionStorage.getItem("savedDarkness") || 30; // Default to 30 if not saved
            const savedFollowMusic = sessionStorage.getItem("savedFollowMusic") === "true";
            const savedEnableHiddenSettings = sessionStorage.getItem("savedEnableHiddenSettings") === "true";


            const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
            const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
            const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings'); // New checkbox


            if (optionsPaneDarknessSlider) optionsPaneDarknessSlider.value = savedDarkness;
            if (optionsPaneFollowMusicCheckbox) optionsPaneFollowMusicCheckbox.checked = savedFollowMusic;
            if (enableHiddenSettingsCheckbox) enableHiddenSettingsCheckbox.checked = savedEnableHiddenSettings;


            // Default ke pane pertama (Game) saat membuka
            optionsNavbarItems.forEach(item => item.classList.remove('active'));
            optionsContentPanes.forEach(pane => pane.classList.remove('active'));
            document.querySelector('.options-navbar-item[data-pane="game-options"]').classList.add('active');
            document.getElementById('game-options-pane').classList.add('active');

            // Baseline snapshot untuk diff (pakai state UI pada saat menu dibuka)
            optionsUiBaselineSnapshot = getOptionsUIPartialSnapshot();

        });

        //------------------- ( end buka menu options + sync value saat dibuka ) -------------------------//

        closeOptionsBtn.addEventListener('click', () => {
            optionsModal.classList.remove('open');
            // Tambahkan penundaan untuk animasi sebelum menyembunyikan total jika diperlukan
            setTimeout(() => {
                if (!optionsModal.classList.contains('open')) { // Hanya sembunyikan jika benar-benar tertutup
                    optionsModal.classList.add('hidden');
                }
            }, 500); // Sesuaikan dengan durasi transisi CSS
        });
        //------------------- end kontrol fullscreen & resolution -------------------------//

        //------------------- switch pane navbar -------------------------//
        // Navigasi antar pane di Options Menu
        optionsNavbarItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetPaneId = item.getAttribute('data-pane') + '-pane';

                optionsNavbarItems.forEach(navItem => navItem.classList.remove('active'));
                item.classList.add('active');

                optionsContentPanes.forEach(pane => {
                    if (pane.id === targetPaneId) {
                        pane.classList.add('active');
                    } else {
                        pane.classList.remove('active');
                    }
                });
            });
        });
        //------------------- end switch pane navbar -------------------------//

        //------------------- apply pengaturan opsi -------------------------//
        // Terapkan semua pengaturan yang dipilih
        applyOptionsBtn.addEventListener('click', async () => {
            const beforeSettings = optionsUiBaselineSnapshot || await ipcRenderer.invoke('load-settings');
            const resValue = resolutionSelect.value;
            const [width, height] = resValue.split('x').map(Number);
            const isFullscreenVal = fullscreenCheckbox.checked;
            const idleReturn = idleReturnCheckbox.checked;
            const snowEnabledVal = snowEffectCheckboxOriginal.checked;
            const webgpuEnabledVal = webgpuCheckbox.checked;
            const webgpuVisualizerStyleVal = document.getElementById('webgpu-visualizer-style').value;
            const miniPlayerEnabledVal = miniPlayerCheckboxInOptions.checked;
            const rpcEnabledVal = enableRpcCheckbox.checked;

            const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
            const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
            const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings');

            const darknessValue = optionsPaneDarknessSlider ? optionsPaneDarknessSlider.value : 30;
            const followMusicValue = optionsPaneFollowMusicCheckbox ? optionsPaneFollowMusicCheckbox.checked : false;
            const enableHiddenSettingsValue = enableHiddenSettingsCheckbox ? enableHiddenSettingsCheckbox.checked : false;

            const adSkipperVal = document.getElementById('enable-ad-skipper-checkbox').checked;
            const autoMuteVal = document.getElementById('auto-mute-ads-checkbox').checked;
            const autoSkipVal = document.getElementById('auto-skip-ads-checkbox').checked;

            const dynamicMusicPlayerCheckbox = document.getElementById('enable-dynamic-music-player-checkbox');
            const dynamicMusicPlayerVal = dynamicMusicPlayerCheckbox ? dynamicMusicPlayerCheckbox.checked : false;

            const miniPlayerHideCheckbox = document.getElementById('mini-player-hide-on-cursor');
            const miniPlayerHideVal = miniPlayerHideCheckbox ? miniPlayerHideCheckbox.checked : false;

            const overlayCheckbox = document.getElementById('enable-overlay-checkbox');
            const overlayVal = overlayCheckbox ? overlayCheckbox.checked : false;

            const dynamicThemeCheckbox = document.getElementById('enable-dynamic-theme-checkbox');
            const dynamicThemeVal = dynamicThemeCheckbox ? dynamicThemeCheckbox.checked : false;

            const dynamicThemeModeSelect = document.getElementById('dynamic-theme-mode-select');
            const dynamicThemeModeVal = dynamicThemeModeSelect ? dynamicThemeModeSelect.value : 'default';

            const partial = {
                windowWidth: width,
                windowHeight: height,
                isFullscreen: isFullscreenVal,
                idleReturn,
                snowFeatureEnabled: snowEnabledVal,
                webgpuEnabled: webgpuEnabledVal,
                webgpuVisualizerStyle: webgpuVisualizerStyleVal,
                miniPlayerFeatureEnabled: miniPlayerEnabledVal,
                miniPlayerHideOnCursor: miniPlayerHideVal,
                darkness: darknessValue,
                followMusic: followMusicValue,
                enableHiddenWallpaperSettings: enableHiddenSettingsValue,
                rpcEnabled: rpcEnabledVal,
                showLogOverlay: document.getElementById('toggle-log-overlay-checkbox')?.checked === true,
                adSkipperEnabled: adSkipperVal,
                autoMuteAds: autoMuteVal,
                autoSkipAds: autoSkipVal,
                dynamicMusicPlayerStylingEnabled: dynamicMusicPlayerVal,
                enableVideoWallpaper: document.getElementById('enable-video-wallpaper')?.checked,
                enableGifOverlay: document.getElementById('enable-gif-overlay-checkbox')?.checked,
                gameGifInteractionLock: document.getElementById('game-gif-interaction-lock')?.checked,
                overlayEnabled: overlayVal,
                dynamicThemeEnabled: dynamicThemeVal,
                dynamicThemeMode: dynamicThemeModeVal
            };

            ipcRenderer.send('save-settings', partial);

            // CUKUP KIRIM 'apply-settings'. Main process akan menangani sisanya.
            ipcRenderer.send('apply-settings', {
                width,
                height,
                isFullscreen: isFullscreenVal,
                idleReturn,
                snowFeatureEnabled: snowEnabledVal,
                webgpuEnabled: webgpuEnabledVal,
                miniPlayerFeatureEnabled: miniPlayerEnabledVal,
                miniPlayerHideOnCursor: miniPlayerHideVal,
                darkness: darknessValue,
                followMusic: followMusicValue,
                enableHiddenWallpaperSettings: enableHiddenSettingsValue,
                rpcEnabled: rpcEnabledVal,
                adSkipperEnabled: adSkipperVal,
                autoMuteAds: autoMuteVal,
                autoSkipAds: autoSkipVal
            });

            // Simpan ke sessionStorage (ini oke untuk state renderer sementara)
            sessionStorage.setItem('savedIdleReturn', idleReturn);
            sessionStorage.setItem('savedSnowEffect', snowEnabledVal);
            sessionStorage.setItem('savedWebGPU', webgpuEnabledVal);
            sessionStorage.setItem('savedWebGPUVisualizerStyle', webgpuVisualizerStyleVal);
            sessionStorage.setItem('savedMiniPlayerEffect', miniPlayerEnabledVal);
            sessionStorage.setItem('savedDarkness', darknessValue);
            sessionStorage.setItem('savedFollowMusic', followMusicValue);
            sessionStorage.setItem('savedEnableHiddenSettings', enableHiddenSettingsValue);

            // Apply wallpaper brightness ke video dan gambar
            const filterValueApply = `brightness(${100 - darknessValue}%)`;
            const characterBackgroundEl = document.getElementById("character-background");
            const characterBackgroundImageEl = document.getElementById("character-background-image");
            if (characterBackgroundEl) characterBackgroundEl.style.filter = filterValueApply;
            if (characterBackgroundImageEl) characterBackgroundImageEl.style.filter = filterValueApply;

            const darknessSliderHidden = document.getElementById("wallpaper-darkness");
            const followMusicCheckboxHidden = document.getElementById("follow-music-title");
            const wallpaperSettingsPanel = document.getElementById('wallpaper-settings');

            if (darknessSliderHidden) darknessSliderHidden.value = darknessValue;
            if (followMusicCheckboxHidden) followMusicCheckboxHidden.checked = followMusicValue;

            // Apply enable/disable hidden settings
            if (wallpaperSettingsPanel) {
                if (enableHiddenSettingsValue) {
                    wallpaperSettingsPanel.classList.remove('disabled');
                    triggerZone.addEventListener('mouseenter', showPanel);
                    triggerZone.addEventListener('mouseleave', hidePanel);
                    wallpaperSettings.addEventListener('mouseenter', showPanel);
                    wallpaperSettings.addEventListener('mouseleave', hidePanel);
                } else {
                    wallpaperSettingsPanel.classList.add('disabled');
                    wallpaperSettingsPanel.classList.remove('show');
                    triggerZone.removeEventListener('mouseenter', showPanel);
                    triggerZone.removeEventListener('mouseleave', hidePanel);
                    wallpaperSettings.removeEventListener('mouseenter', showPanel);
                    wallpaperSettings.removeEventListener('mouseleave', hidePanel);
                }
            }

            // Terapkan efek salju
            ipcRenderer.send('set-snow-feature-enabled', snowEnabledVal);
            if (snowEnabledVal) {
                ipcRenderer.send('show-snow-effect');
            } else {
                ipcRenderer.send('hide-snow-effect');
            }

            ipcRenderer.send('set-mini-player-feature-enabled', miniPlayerEnabledVal);

            // Debug overlay
            ipcRenderer.send('save-settings', { showLogOverlay: toggleLogOverlayCheckbox.checked });

            if (idleReturn) {
                resetIdleTimer(); // Fungsi ini harus sudah ada dari kodemu
            } else {
                clearTimeout(idleTimer); // Fungsi ini harus sudah ada dari kodemu
            }
            const diffLines = buildSettingsDiffLines(beforeSettings, partial);
            showNotification('Settings applied!', 'notification-success', diffLines.length > 0 ? diffLines : ['No changes detected.']); // Beri feedback
            optionsUiBaselineSnapshot = partial;
        });
        //------------------- end apply pengaturan opsi -------------------------//

        //------------------- discord rpc integration -------------------------//
        // Integrasi Discord Rich Presence
        const enableRpcCheckbox = document.getElementById('enable-rpc-checkbox');
        if (enableRpcCheckbox) {
            enableRpcCheckbox.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                ipcRenderer.send('set-rpc-enabled', isEnabled);

                // Simpan juga pengaturannya agar tetap ada saat aplikasi dibuka kembali
                ipcRenderer.send("save-settings", { rpcEnabled: isEnabled });
            });
        }

        // Saat aplikasi masuk ke menu utama (misalnya, setelah intro selesai)
        function onMainMenuLoad() {
            ipcRenderer.send('update-rpc-activity', {
                details: 'Di Menu Utama',
                state: 'Mencari novel atau musik'
            });
        }

        // Saat lagu mulai diputar (di dalam fungsi loadSong atau event play)
        function onSongPlay(song) {
            ipcRenderer.send('update-rpc-activity', {
                songTitle: song.title,
                songArtist: song.artist,
                smallImageKey: 'play_icon',
                smallImageText: 'Sedang Memutar'
            });
        }

        // Saat pengguna masuk ke menu pemilihan Visual Novel
        function onVnMenuLoad() {
            ipcRenderer.send('update-rpc-activity', {
                details: 'Memilih Visual Novel',
                state: 'Mencari cerita menarik'
            });
        }

        // Saat pengguna mulai memainkan chapter sebuah novel
        function onChapterPlay(novelTitle, chapterTitle) {
            ipcRenderer.send('update-rpc-activity', {
                details: `Bermain: ${novelTitle}`,
                state: `Chapter: ${chapterTitle}`
            });
        }
        function onReturnToMainMenu() {
            ipcRenderer.send('update-rpc-activity', {
                details: 'Di Menu Utama',
                state: 'Memilih-milih menu...',
                smallImageKey: null // Hapus ikon kecil
            });
        }
        //---------------------------- End Discord RPC --------------------------//
        //------------------- end discord rpc integration -------------------------//

        //------------------- internet connection handler -------------------------//
        // Pengendali koneksi internet dengan ping monitoring
        //---------------------------- Tombol "Connect to Internet" --------------------------//
        let pingInterval = null;
        const connectButton = document.getElementById('connect-button');
        const connectionDetails = document.getElementById('connection-details');
        const disconnectButton = document.getElementById('disconnect-button');
        const buttonText = connectButton.querySelector('.button-text');
        const spinner = connectButton.querySelector('.loading-spinner');

        // Elemen di dalam modal & di header utama
        const pingValueElModal = document.querySelector('#ping-indicator-options .ping-value');
        const pingDotElModal = document.querySelector('#ping-indicator-options .ping-dot');
        const pingValueElGlobal = document.querySelector('#connection-status #ping-indicator .ping-value');
        const pingDotElGlobal = document.querySelector('#connection-status #ping-indicator .ping-dot');

        window.internetConnectionAllowed = false;

        // 2. Fungsi Terpusat untuk Mengelola Tampilan (State Machine UI)
        function updateConnectionUI(state, data = {}) {
            // Reset semua state visual
            spinner.style.display = 'none';
            connectionDetails.classList.add('hidden');
            connectButton.classList.remove('connecting', 'connected', 'disabled');
            connectButton.disabled = false;

            switch (state) {
                case 'DISCONNECTED':
                    buttonText.textContent = 'Connect to Internet';
                    if (pingValueElGlobal) pingValueElGlobal.textContent = '';
                    if (pingDotElGlobal) pingDotElGlobal.className = 'ping-dot';
                    if (pingInterval) clearInterval(pingInterval);
                    pingInterval = null;
                    break;

                case 'CONNECTING':
                    buttonText.textContent = 'Connecting...';
                    spinner.style.display = 'inline-block';
                    connectButton.classList.add('connecting');
                    connectButton.disabled = true;
                    break;

                case 'CONNECTED':
                    buttonText.textContent = `Connected (${data.latency}ms)`;
                    connectButton.classList.add('connected');
                    connectButton.disabled = true;
                    connectionDetails.classList.remove('hidden');

                    // Update kedua indikator ping
                    [pingValueElModal, pingValueElGlobal].forEach(el => { if (el) el.textContent = `${data.latency}ms`; });
                    [pingDotElModal, pingDotElGlobal].forEach(el => { if (el) el.className = `ping-dot ${data.dotClass}`; });
                    break;

                case 'OFFLINE':
                    buttonText.textContent = 'Connection Lost';
                    connectButton.classList.add('disabled');
                    connectButton.disabled = true;

                    // Update kedua indikator ping
                    [pingValueElModal, pingValueElGlobal].forEach(el => { if (el) el.textContent = 'Offline'; });
                    [pingDotElModal, pingDotElGlobal].forEach(el => { if (el) el.className = 'ping-dot poor'; });

                    if (pingInterval) clearInterval(pingInterval);
                    pingInterval = null;
                    break;
            }
        }

        // 3. Fungsi Inti yang Sudah Dirapikan
        function connectToInternet() {
            if (!navigator.onLine) {
                showNotification('Tidak ada koneksi jaringan.', 'notification-error');
                updateConnectionUI('OFFLINE');
                return;
            }
            updateConnectionUI('CONNECTING');

            fetch('https://www.google.com', { mode: 'no-cors', cache: 'no-store', signal: AbortSignal.timeout(4000) })
                .then(() => {
                    const latency = Date.now() - (start || 0); // Ambil waktu start dari scope luar
                    let dotClass = 'poor';
                    if (latency < 150) dotClass = 'good';
                    else if (latency < 400) dotClass = 'moderate';

                    updateConnectionUI('CONNECTED', { latency, dotClass });

                    if (!pingInterval) {
                        pingInterval = setInterval(updatePingStatus, 2500);
                    }
                })
                .catch(() => {
                    showNotification('Gagal terhubung ke internet.', 'notification-error');
                    updateConnectionUI('DISCONNECTED');
                });
            const start = Date.now();
        }

        function updatePingStatus() {
            if (!window.internetConnectionAllowed || !navigator.onLine) {
                updateConnectionUI('OFFLINE');
                return;
            }
            const start = Date.now();
            fetch('https://www.google.com', { mode: 'no-cors', cache: 'no-store', signal: AbortSignal.timeout(4000) })
                .then(() => {
                    const latency = Date.now() - start;
                    let dotClass = 'poor';
                    if (latency < 150) dotClass = 'good';
                    else if (latency < 400) dotClass = 'moderate';

                    // Cukup update teks, tidak perlu mengubah state 'CONNECTED' lagi
                    buttonText.textContent = `Connected (${latency}ms)`;
                    [pingValueElModal, pingValueElGlobal].forEach(el => { if (el) el.textContent = `${latency}ms`; });
                    [pingDotElModal, pingDotElGlobal].forEach(el => { if (el) el.className = `ping-dot ${dotClass}`; });
                })
                .catch(() => updateConnectionUI('OFFLINE'));
        }

        // 4. Event Listeners yang Sudah Dirapikan dan Ditambah
        connectButton.addEventListener('click', () => {
            ipcRenderer.send('connect-to-internet');
            window.internetConnectionAllowed = true;
            connectToInternet();
        });

        disconnectButton.addEventListener('click', () => {
            window.internetConnectionAllowed = false;
            ipcRenderer.send('disconnect-from-internet'); // Kirim sinyal jika perlu
            updateConnectionUI('DISCONNECTED');
            showNotification('Koneksi internet diputus oleh aplikasi.');
        });

        window.addEventListener('offline', () => {
            showNotification('Koneksi internet terputus!', 'notification-error');
            updateConnectionUI('OFFLINE');
        });

        window.addEventListener('online', () => {
            if (window.internetConnectionAllowed) {
                showNotification('Koneksi kembali, mencoba menyambungkan ulang...', 'notification-warning');
                connectToInternet();
            }
        });

        // Inisialisasi tampilan koneksi awal
        updateConnectionUI(navigator.onLine ? 'DISCONNECTED' : 'OFFLINE');

        //----------------------------- End Tombol "Connect to Internet" -----------------------------//
        //------------------- end internet connection handler -------------------------//

        //------------------- debug overlay window -------------------------//
        // Debug logging window untuk memantau aplikasi
        //--------------------------------------- Debug ---------------------------------------------//
        document.addEventListener('DOMContentLoaded', () => {
            const logWindow = document.getElementById('log-window-container');
            const titleBar = logWindow.querySelector('.log-title-bar');
            const logContent = document.getElementById('log-content');
            const toggleLogCheckbox = document.getElementById('toggle-log-overlay-checkbox');
            let isDragging = false, isResizing = false;
            let offsetX, offsetY, startWidth, startHeight, startX, startY;

            let logBuffer = [];
            const MAX_BUFFER_SIZE = 500;

            // --- Logika Dragging dan Resizing tetap sama ---
            titleBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - logWindow.offsetLeft;
                offsetY = e.clientY - logWindow.offsetTop;
                document.addEventListener('mousemove', onMouseMoveDrag);
                document.addEventListener('mouseup', onMouseUpDrag);
            });

            function onMouseMoveDrag(e) {
                if (!isDragging) return;
                // Hitung posisi baru jendela
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;
                logWindow.style.left = `${newX}px`;
                logWindow.style.top = `${newY}px`;
            }

            function onMouseUpDrag() {
                isDragging = false;
                // Hapus listener dari document setelah drag selesai
                document.removeEventListener('mousemove', onMouseMoveDrag);
                document.removeEventListener('mouseup', onMouseUpDrag);
            }

            // --- LOGIKA RESIZING JENDELA ---
            const resizer = logWindow.querySelector('.resizer-se');
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Mencegah event lain seperti text selection
                isResizing = true;
                // Simpan ukuran dan posisi awal
                startWidth = logWindow.offsetWidth;
                startHeight = logWindow.offsetHeight;
                startX = e.clientX;
                startY = e.clientY;

                document.addEventListener('mousemove', onMouseMoveResize);
                document.addEventListener('mouseup', onMouseUpResize);
            });

            function onMouseMoveResize(e) {
                if (!isResizing) return;
                // Hitung perubahan lebar dan tinggi
                const newWidth = startWidth + (e.clientX - startX);
                const newHeight = startHeight + (e.clientY - startY);
                logWindow.style.width = `${newWidth}px`;
                logWindow.style.height = `${newHeight}px`;
            }

            function onMouseUpResize() {
                isResizing = false;
                document.removeEventListener('mousemove', onMouseMoveResize);
                document.removeEventListener('mouseup', onMouseUpResize);
            }

            // MERENDER SATU BARIS LOG KE DOM ---
            function renderLogLine(logItem) {
                if (!logContent) return;
                const line = document.createElement('div');
                line.className = 'log-line';
                line.textContent = `[${logItem.timestamp.toLocaleTimeString()}] ${logItem.message}`;

                if (logItem.type === 'warn') line.style.color = '#ffee77';
                if (logItem.type === 'error') line.style.color = '#ff7777';

                logContent.appendChild(line);
                logContent.scrollTop = logContent.scrollHeight; // Otomatis scroll ke bawah
            }

            // --- append log dengan buffer ---
            const origLog = console.log;
            const origWarn = console.warn;
            const origError = console.error;

            function appendLogToBufferAndUI(type, args) {
                // Format pesan dan selalu simpan ke buffer
                const message = args.map(a => {
                    if (typeof a === 'object' && a !== null) {
                        try {
                            return JSON.stringify(a, null, 2);
                        } catch (e) {
                            try {
                                return String(a);
                            } catch (e2) {
                                return '[Object]';
                            }
                        }
                    }
                    return a;
                }).join(' ');

                const logItem = { type, message, timestamp: new Date() };
                logBuffer.push(logItem);

                // Batasi ukuran buffer
                if (logBuffer.length > MAX_BUFFER_SIZE) {
                    logBuffer.shift();
                }

                // Hanya tampilkan di UI jika jendela sedang aktif
                if (toggleLogCheckbox.checked) {
                    renderLogLine(logItem);
                }
            }

            // Ganti fungsi console global untuk menggunakan buffer
            if (!console.isPatched) {
                console.log = (...args) => { origLog.apply(console, args); appendLogToBufferAndUI('log', args); };
                console.warn = (...args) => { origWarn.apply(console, args); appendLogToBufferAndUI('warn', args); };
                console.error = (...args) => { origError.apply(console, args); appendLogToBufferAndUI('error', args); };
                console.isPatched = true;
            }

            if (toggleLogCheckbox) {
                toggleLogCheckbox.addEventListener('change', e => {
                    const isEnabled = e.target.checked;
                    logWindow.classList.toggle('hidden', !isEnabled);

                    if (isEnabled) {
                        // Saat jendela dibuka, "flush" semua log dari buffer ke UI
                        console.log(`[Debug] Jendela Log diaktifkan. Memuat ${logBuffer.length} log dari buffer...`);
                        logContent.innerHTML = ''; // bersih sebelum memuat
                        logBuffer.forEach(logItem => renderLogLine(logItem)); // Render semua log yang sudah ada
                    } else {
                        // Saat jendela ditutup, cukup kosongkan UI. Buffer tetap menyimpan data.
                        console.log(`[Debug] Jendela Log dinonaktifkan.`);
                        if (logContent) {
                            logContent.innerHTML = '';
                        }
                    }
                });
            }
        });
        //------------------------------------------ End debug ----------------------------------------------//
        //------------------- end debug overlay window -------------------------//

        //------------------- audio muffled effect system -------------------------//
        // Sistem efek suara "muffled/terpendam" untuk quit popup
        // Filter dan gain node dibuat di chain audio utama (saat audioCtx init)
        // Variabel ini akan diisi saat audio context pertama kali diinisialisasi
        let quitPopupAudioContext = null;
        let quitPopupLowpassFilter = null;
        let quitPopupGainNode = null;
        let quitPopupAudioConnected = false;

        // Fungsi untuk mengaktifkan efek muffled (dipanggil saat quit popup muncul)
        // Filter sudah terhubung di chain audio utama, fungsi ini hanya mengubah parameter
        function applyQuitPopupMuffledEffect() {
            // Kirim pesan ke webview untuk menerapkan efek muffled di sana juga
            // Ini untuk musik online dari YouTube Music dll
            const webview = document.getElementById('external-webview');
            if (webview) {
                try {
                    webview.send('apply-muffled-effect');
                    console.log('[QuitPopup Audio] Mengirim apply-muffled-effect ke webview');
                } catch (e) {
                    console.warn('[QuitPopup Audio] Gagal mengirim ke webview:', e);
                }
            }

            // Cek apakah audio chain lokal sudah di-setup
            if (!quitPopupAudioConnected || !quitPopupLowpassFilter || !quitPopupGainNode || !quitPopupAudioContext) {
                console.warn('[QuitPopup Audio] Audio chain lokal belum ready, skip efek muffled untuk musik lokal.');
                return;
            }

            try {
                // Resume context kalau suspended
                if (quitPopupAudioContext.state === 'suspended') {
                    quitPopupAudioContext.resume();
                }

                // Terapkan efek muffled dengan transisi smooth
                const currentTime = quitPopupAudioContext.currentTime;
                const transitionDuration = 0.3; // 300ms transisi

                // Turunkan cutoff frequency untuk efek "terpendam" (potong frekuensi tinggi)
                // 400-600Hz memberikan kesan seperti suara dari balik dinding/air
                quitPopupLowpassFilter.frequency.cancelScheduledValues(currentTime);
                quitPopupLowpassFilter.frequency.setValueAtTime(
                    quitPopupLowpassFilter.frequency.value,
                    currentTime
                );
                quitPopupLowpassFilter.frequency.linearRampToValueAtTime(500, currentTime + transitionDuration);

                // Naikkan Q sedikit untuk bass boost (bikin bass lebih "berasa")
                quitPopupLowpassFilter.Q.cancelScheduledValues(currentTime);
                quitPopupLowpassFilter.Q.setValueAtTime(quitPopupLowpassFilter.Q.value, currentTime);
                quitPopupLowpassFilter.Q.linearRampToValueAtTime(2.5, currentTime + transitionDuration);

                // Kurangi volume sedikit untuk efek "jauh/terpendam"
                quitPopupGainNode.gain.cancelScheduledValues(currentTime);
                quitPopupGainNode.gain.setValueAtTime(quitPopupGainNode.gain.value, currentTime);
                quitPopupGainNode.gain.linearRampToValueAtTime(0.7, currentTime + transitionDuration);

                console.log('[QuitPopup Audio] Efek muffled diaktifkan - suara akan terdengar terpendam dengan bass boost');
            } catch (error) {
                console.error('[QuitPopup Audio] Gagal menerapkan efek muffled:', error);
            }
        }

        // Fungsi untuk menghilangkan efek muffled dan mengembalikan audio normal
        function removeQuitPopupMuffledEffect() {
            // Kirim pesan ke webview untuk menghapus efek muffled di sana juga
            const webview = document.getElementById('external-webview');
            if (webview) {
                try {
                    webview.send('remove-muffled-effect');
                    console.log('[QuitPopup Audio] Mengirim remove-muffled-effect ke webview');
                } catch (e) {
                    console.warn('[QuitPopup Audio] Gagal mengirim ke webview:', e);
                }
            }

            // Proses audio lokal
            if (!quitPopupAudioContext || !quitPopupAudioConnected) {
                return;
            }

            try {
                const currentTime = quitPopupAudioContext.currentTime;
                const transitionDuration = 0.25; // 250ms transisi balik

                // Kembalikan cutoff frequency ke full range
                quitPopupLowpassFilter.frequency.cancelScheduledValues(currentTime);
                quitPopupLowpassFilter.frequency.setValueAtTime(
                    quitPopupLowpassFilter.frequency.value,
                    currentTime
                );
                quitPopupLowpassFilter.frequency.linearRampToValueAtTime(22050, currentTime + transitionDuration);

                // Kembalikan Q ke normal
                quitPopupLowpassFilter.Q.cancelScheduledValues(currentTime);
                quitPopupLowpassFilter.Q.setValueAtTime(quitPopupLowpassFilter.Q.value, currentTime);
                quitPopupLowpassFilter.Q.linearRampToValueAtTime(0.7, currentTime + transitionDuration);

                // Kembalikan volume ke 100%
                quitPopupGainNode.gain.cancelScheduledValues(currentTime);
                quitPopupGainNode.gain.setValueAtTime(quitPopupGainNode.gain.value, currentTime);
                quitPopupGainNode.gain.linearRampToValueAtTime(1.0, currentTime + transitionDuration);

                console.log('[QuitPopup Audio] Efek muffled dinonaktifkan - audio kembali normal');
            } catch (error) {
                console.error('[QuitPopup Audio] Gagal menghapus efek muffled:', error);
            }
        }
        //------------------- end audio muffled effect system -------------------------//

        //------------------- quit button handler -------------------------//
        // Penanganan tombol Quit
        //------------- Tombol Quit ------------//
        // Event listener untuk tombol "Quit" di MAIN MENU
        quitMenu.addEventListener('click', () => {
            if (optionsModal && optionsModal.classList.contains('open')) {
                if (closeOptionsBtn) {
                    closeOptionsBtn.click();
                } else {
                    optionsModal.classList.remove('open');
                    setTimeout(() => {
                        if (!optionsModal.classList.contains('open')) {
                            optionsModal.classList.add('hidden');
                        }
                    }, 200);
                }
            }

            // Tampilkan custom quit popup yang baru + aktifkan efek audio muffled
            if (customQuitPopup) {
                customQuitPopup.classList.remove('hidden');
                requestAnimationFrame(() => {
                    customQuitPopup.classList.add('visible');
                });
                // Aktifkan efek suara "terpendam" untuk drama effect
                applyQuitPopupMuffledEffect();
            }
        });

        // Event listener untuk tombol "Batal" di custom quit popup
        if (customCancelQuitBtn) {
            customCancelQuitBtn.addEventListener('click', () => {
                // Kembalikan audio ke normal dulu
                removeQuitPopupMuffledEffect();

                if (customQuitPopup) {
                    customQuitPopup.classList.remove('visible', 'quitting');
                    setTimeout(() => {
                        customQuitPopup.classList.add('hidden');
                    }, 250);
                }
            });
        }

        if (customConfirmQuitBtn) {
            customConfirmQuitBtn.addEventListener('click', () => {
                // Kembalikan audio ke normal sebelum keluar (opsional, tapi biar konsisten)
                removeQuitPopupMuffledEffect();

                // Tambahkan class quitting untuk memicu animasi lucu
                if (customQuitPopup) {
                    customQuitPopup.classList.add('quitting');

                    // Tunggu animasi selesai (1.8s untuk animasi kaomoji) sebelum quit
                    setTimeout(() => {
                        ipcRenderer.send('quit-application');
                        customQuitPopup.classList.remove('visible', 'quitting');
                        customQuitPopup.classList.add('hidden');
                    }, 2500); // sinkron dengan durasi animasi CSS (2.4s)
                } else {
                    // Fallback kalau popup gak ketemu
                    ipcRenderer.send('quit-application');
                }
            });
        }
        //---------- End Tombol Quit ----------//


        /* -------------------------------------------------- */
        /* Fungsi2 pendukung: update UI musik, next wallpaper */
        /* -------------------------------------------------- */
        // Membatasi jumlah karakter agar tampilan tetap rapi di berbagai ukuran layar
        const truncateMusicTitle = (text, maxLength = 120) => {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        };
        const audioElement = document.getElementById('background-audio');
        const titleElement = document.getElementById('music-title');
        const titleElementExpand = document.getElementById('now-playing-song');
        const progressBar = document.getElementById('progress-bar');
        const musicControl = document.getElementById('music-control');
        const expandCollapseButton = document.getElementById('expand-collapse');
        const playlistElement = document.getElementById('playlist');

        // Get elements from the hidden wallpaper settings panel
        const followMusicCheckboxHidden = document.getElementById('follow-music-title');
        const darknessSliderHidden = document.getElementById('wallpaper-darkness');

        const enableVideoWallpaperCheckbox = document.getElementById('enable-video-wallpaper');
        const wallpaperVideo = document.getElementById("character-background");
        const wallpaperImage = document.getElementById("character-background-image");
        const wallpaperControl = document.getElementById('wallpaper-control');
        const pauseWallpaperButton = document.getElementById("pause-wallpaper");
        const triggerZone = document.querySelector('#wallpaper-control .trigger-zone');
        const wallpaperSettings = document.getElementById('wallpaper-settings');

        // Get elements from the options modal wallpaper pane
        const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
        const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
        const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings'); // New checkbox

        const enableOverlayCheckbox = document.getElementById('enable-overlay-checkbox');
        const enableDynamicThemeCheckbox = document.getElementById('enable-dynamic-theme-checkbox');
        const dynamicThemeSubOptions = document.getElementById('dynamic-theme-sub-options');
        const dynamicThemeModeSelect = document.getElementById('dynamic-theme-mode-select');

        function sanitizeDynamicThemeMode(mode) {
            if (!mode) return 'default';
            return mode === 'unified' ? 'overlay' : mode;
        }

        function toggleDynamicThemeSubOptions() {
            if (!dynamicThemeSubOptions || !enableDynamicThemeCheckbox) return;
            dynamicThemeSubOptions.style.display = enableDynamicThemeCheckbox.checked ? 'block' : 'none';
        }

        function applyDynamicThemeState() {
            const webview = document.getElementById('external-webview');
            const isEnabled = enableDynamicThemeCheckbox ? enableDynamicThemeCheckbox.checked : false;
            const selectedMode = dynamicThemeModeSelect ? sanitizeDynamicThemeMode(dynamicThemeModeSelect.value) : 'default';

            toggleDynamicThemeSubOptions();

            ipcRenderer.send('save-settings', {
                dynamicThemeEnabled: isEnabled,
                dynamicThemeMode: selectedMode
            });

            const isWebviewActive = (typeof webviewActive !== 'undefined') ? webviewActive : false;
            if (!isWebviewActive || !webview) return;

            const runWhenReady = (fn) => {
                try {
                    if (webview.isLoading && webview.isLoading()) {
                        webview.addEventListener('did-finish-load', () => fn(), { once: true });
                        return;
                    }
                } catch (_) { }
                fn();
            };

            if (!isEnabled) {
                runWhenReady(() => {
                    webview.executeJavaScript(`
                try {
                    if (typeof window.disableDynamicTheme === 'function') {
                        window.disableDynamicTheme();
                        true;
                    } else {
                        false;
                    }
                } catch (e) {
                    console.error('[DynamicTheme] disableDynamicTheme() failed:', e);
                    false;
                }
            `).catch(() => { });
                });
                return;
            }

            runWhenReady(() => {
                webview.executeJavaScript(`
            try {
                // IMPORTANT: enabling must call enableDynamicTheme() (it clears internal disabled state).
                // updateThemeMode() only switches mode and won't re-enable after disableDynamicTheme().
                if (typeof window.enableDynamicTheme === 'function') {
                    window.enableDynamicTheme('${selectedMode}');
                    true;
                } else if (typeof window.updateThemeMode === 'function') {
                    window.updateThemeMode('${selectedMode}');
                    true;
                } else {
                    false;
                }
            } catch (e) {
                console.error('[DynamicTheme] apply failed:', e);
                false;
            }
        `).then((handled) => {
                    if (!handled) {
                        if (typeof injectDynamicTheme === 'function') {
                            injectDynamicTheme(webview, selectedMode);
                        }
                    }
                }).catch(() => {
                    if (typeof injectDynamicTheme === 'function') {
                        injectDynamicTheme(webview, selectedMode);
                    }
                });
            });
        }

        let currentWallpaperIndex = 0;
        let isWallpaperPaused = false;
        let isManuallyPaused = false;
        let hideTimeout;
        let autoChangeTimer = null;

        // Variabel untuk menyimpan source video title screen (untuk restore setelah di-unload)
        let titleVideoSource = null;

        ipcRenderer.on('fade-music-and-transition', () => {
            const fadeDuration = 4000;
            const fadeStep = 0.001;

            document.body.classList.add('fade-out');

            // Mulai fade-out musik menggunakan sistem volume global
            let fadeInterval = setInterval(() => {
                // Cek variabel global, bukan audioElement.volume
                if (currentGlobalVolume > fadeStep) {
                    // Hitung volume baru
                    const newVolume = Math.max(currentGlobalVolume - fadeStep, 0);
                    // Kirim perintah untuk mengubah volume global
                    ipcRenderer.send('set-global-volume', newVolume);
                } else {
                    // Proses selesai
                    clearInterval(fadeInterval);
                    audioElement.pause(); // Tetap pause audio lokal untuk sicurezza
                    // Kirim sinyal ke backend untuk pindah halaman
                    ipcRenderer.send('navigate-to-vn');
                }
            }, fadeDuration * fadeStep);
        });

        function startAutoChangeWallpaper() {
            if (autoChangeTimer) clearInterval(autoChangeTimer);
            const intervalMinutes = parseInt(sessionStorage.getItem("savedAutoChangeInterval")) || 5;
            const intervalMs = intervalMinutes * 60 * 1000;

            console.log(`[Wallpaper] Starting auto change every ${intervalMinutes} minutes.`);
            autoChangeTimer = setInterval(() => {
                changeWallpaper(true);
            }, intervalMs);
        }

        function stopAutoChangeWallpaper() {
            if (autoChangeTimer) {
                clearInterval(autoChangeTimer);
                autoChangeTimer = null;
                console.log(`[Wallpaper] Auto change stopped.`);
            }
        }

        function changeWallpaper(isAuto = false) {
            // Skip jika fitur video wallpaper dinonaktifkan
            if (!enableVideoWallpaperCheckbox || !enableVideoWallpaperCheckbox.checked) {
                console.log('[Wallpaper] Skip change, fitur dinonaktifkan');
                return;
            }

            // Fade out elemen yang sedang aktif
            wallpaperVideo.classList.add('fade-out');
            wallpaperImage.classList.add('fade-out');

            setTimeout(() => {
                const isRandom = sessionStorage.getItem("savedRandomWallpaperOrder") === "true";
                let nextIndex;

                if (isRandom) {
                    nextIndex = Math.floor(Math.random() * wallpapers.length);
                    if (nextIndex === currentWallpaperIndex && wallpapers.length > 1) {
                        nextIndex = (nextIndex + 1) % wallpapers.length;
                    }
                } else {
                    nextIndex = (currentWallpaperIndex + 1) % wallpapers.length;
                }

                currentWallpaperIndex = nextIndex;
                const newWallpaper = wallpapers[currentWallpaperIndex];

                displayWallpaper(newWallpaper);

                document.getElementById('wallpaper-name').textContent = `Current: ${newWallpaper.name}`;

                // Fade in elemen yang baru aktif
                setTimeout(() => {
                    wallpaperVideo.classList.remove('fade-out', 'fade-in');
                    wallpaperImage.classList.remove('fade-out', 'fade-in');
                }, 250);
            }, 250);
        }

        // Helper untuk menampilkan wallpaper sesuai tipe media (video atau gambar)
        function displayWallpaper(wp) {
            if (!wp) return;

            const isVideo = (wp.mediaType === 'video') || (!wp.mediaType && wp.type && wp.type.startsWith('video'));

            if (isVideo) {
                // Sembunyikan gambar, tampilkan video
                wallpaperImage.style.display = 'none';
                wallpaperVideo.style.display = 'block';
                wallpaperVideo.src = wp.src;
                wallpaperVideo.type = wp.type;
                wallpaperVideo.load();
                if (!isManuallyPaused) {
                    wallpaperVideo.play();
                }
                wallpaperVideo.classList.add('fade-in');

                // Tombol pause relevan untuk video
                pauseWallpaperButton.style.display = 'block';
            } else {
                // Sembunyikan video, tampilkan gambar
                wallpaperVideo.pause();
                wallpaperVideo.style.display = 'none';
                wallpaperImage.style.display = 'block';
                wallpaperImage.src = wp.src;
                wallpaperImage.classList.add('fade-in');

                // Tombol pause tidak relevan untuk gambar
                pauseWallpaperButton.style.display = 'none';
            }
        }

        document.getElementById('next-wallpaper').addEventListener('click', () => changeWallpaper(false));

        // -------- yang mengangani Wallpaper setting, dan menu tersembunyi itu ---------- //
        pauseWallpaperButton.addEventListener("click", () => {
            if (isWallpaperPaused) {
                wallpaperVideo.play();
                pauseWallpaperButton.textContent = "";
                isManuallyPaused = false;
            } else {
                wallpaperVideo.pause();
                pauseWallpaperButton.textContent = "";
                isManuallyPaused = true;
            }
            isWallpaperPaused = !isWallpaperPaused;
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateMusicUI();
            }
        });

        // Listener for the hidden wallpaper settings checkbox
        if (followMusicCheckboxHidden) {
            followMusicCheckboxHidden.addEventListener("change", () => {
                // Skip jika fitur wallpaper dinonaktifkan
                if (!enableVideoWallpaperCheckbox || !enableVideoWallpaperCheckbox.checked) return;

                if (followMusicCheckboxHidden.checked) {
                    const currentSongTitle = songs[currentSongIndex]?.title;
                    const matchedWallpaper = wallpapers.find(wallpaper => wallpaper.name === currentSongTitle);
                    if (matchedWallpaper) {
                        displayWallpaper(matchedWallpaper);
                        document.getElementById("wallpaper-name").textContent = `Current: ${matchedWallpaper.name}`;
                    }
                }
            });
        }

        // Listener for the options modal wallpaper pane checkbox
        if (optionsPaneFollowMusicCheckbox) {
            optionsPaneFollowMusicCheckbox.addEventListener("change", () => {
                // Skip jika fitur wallpaper dinonaktifkan
                if (!enableVideoWallpaperCheckbox || !enableVideoWallpaperCheckbox.checked) return;

                if (optionsPaneFollowMusicCheckbox.checked) {
                    const currentSongTitle = songs[currentSongIndex]?.title;
                    const matchedWallpaper = wallpapers.find(wallpaper => wallpaper.name === currentSongTitle);
                    if (matchedWallpaper) {
                        displayWallpaper(matchedWallpaper);
                        document.getElementById("wallpaper-name").textContent = `Current: ${matchedWallpaper.name}`;
                    }
                }
            });
        }


        audioElement.addEventListener('play', () => {
            // Check both checkboxes when music starts playing
            // Hanya set wallpaper jika fitur video wallpaper AKTIF
            const isWallpaperFeatureEnabled = enableVideoWallpaperCheckbox && enableVideoWallpaperCheckbox.checked;
            if (isWallpaperFeatureEnabled && ((followMusicCheckboxHidden && followMusicCheckboxHidden.checked) || (optionsPaneFollowMusicCheckbox && optionsPaneFollowMusicCheckbox.checked))) {
                const currentSongTitle = songs[currentSongIndex]?.title;
                const matchedWallpaper = wallpapers.find(wallpaper => wallpaper.name === currentSongTitle);
                if (matchedWallpaper) {
                    displayWallpaper(matchedWallpaper);
                    document.getElementById("wallpaper-name").textContent = `Current: ${matchedWallpaper.name}`;
                }
            }
            sendDataToMiniPlayer();
            broadcastPlayerState();
        });

        // Simpan data wallpaper terakhir untuk restore saat diaktifkan kembali
        let lastWallpaperData = null;

        function applyVideoWallpaperState(isEnabled) {
            // Disable interaction with brightness, etc if disabled
            const sliders = document.querySelectorAll('.wallpaper-darkness, .wallpaper-blur, .wallpaper-grayscale, .wallpaper-zoom');
            sliders.forEach(slider => {
                slider.disabled = !isEnabled;
                const row = slider.closest('.option-row');
                if (row) {
                    row.style.opacity = isEnabled ? '1' : '0.5';
                    row.style.pointerEvents = isEnabled ? 'auto' : 'none';
                }
            });

            if (isEnabled) {
                wallpaperControl.style.display = 'flex';

                // Restore wallpaper jika ada data tersimpan
                if (lastWallpaperData) {
                    displayWallpaper(lastWallpaperData);
                } else if (wallpapers.length > 0) {
                    // Atau tampilkan wallpaper pertama
                    displayWallpaper(wallpapers[0]);
                }
            } else {
                // Simpan data wallpaper sebelum dinonaktifkan
                if (currentWallpaperIndex >= 0 && currentWallpaperIndex < wallpapers.length) {
                    lastWallpaperData = wallpapers[currentWallpaperIndex];
                }

                // Hentikan video dan lepas GPU decoder
                wallpaperVideo.pause();
                wallpaperVideo.removeAttribute('src');
                wallpaperVideo.load();

                // Sembunyikan keduanya
                wallpaperVideo.style.display = 'none';
                wallpaperImage.style.display = 'none';
                wallpaperControl.style.display = 'none';
                console.log('[Wallpaper] Wallpaper dinonaktifkan, resource dibebaskan');
            }
        }
        if (enableVideoWallpaperCheckbox) {
            enableVideoWallpaperCheckbox.addEventListener('change', (event) => {
                const isEnabled = event.target.checked;
                applyVideoWallpaperState(isEnabled);

                ipcRenderer.send('save-settings', { videoWallpaperEnabled: isEnabled });
            });
        }

        const openMainDevtoolsBtn = document.getElementById('open-main-devtools');
        if (openMainDevtoolsBtn) {
            openMainDevtoolsBtn.addEventListener('click', () => {
                ipcRenderer.send('open-main-devtools');
            });
        }

        // Listener for the hidden wallpaper settings slider
        if (darknessSliderHidden) {
            darknessSliderHidden.addEventListener('input', (event) => {
                const brightness = 100 - event.target.value;
                const filterValue = `brightness(${brightness}%)`;
                wallpaperVideo.style.filter = filterValue;
                wallpaperImage.style.filter = filterValue;
            });
        }

        // Listener for the options modal wallpaper pane slider
        if (optionsPaneDarknessSlider) {
            optionsPaneDarknessSlider.addEventListener('input', (event) => {
                const brightness = 100 - event.target.value;
                const filterValue = `brightness(${brightness}%)`;
                wallpaperVideo.style.filter = filterValue;
                wallpaperImage.style.filter = filterValue;
            });
        }


        function showPanel() {
            // Only show the panel if it's not disabled
            if (wallpaperSettings && !wallpaperSettings.classList.contains('disabled')) {
                clearTimeout(hideTimeout);
                wallpaperSettings.classList.add('show');
            }
        }

        function hidePanel() {
            hideTimeout = setTimeout(() => {
                wallpaperSettings.classList.remove('show');
            }, 1600);
        }

        triggerZone.addEventListener('mouseenter', showPanel);
        triggerZone.addEventListener('mouseleave', hidePanel);
        wallpaperSettings.addEventListener('mouseenter', showPanel);
        wallpaperSettings.addEventListener('mouseleave', hidePanel);

        /* ------------------------ Bagian Musik Player ---------------------*/
        // --- Engine Musik Player --- //
        let currentSongIndex = 0;
        let isShuffleOn = false;
        let controlMode = 'local';
        let shufflePlaylist = [];
        let playedHistory = [];
        let currentVisualizerData = [];
        let lastWebviewState = null;
        let latestOnlinePlaylistData = [];
        let isInitialOnlineLoad = true; // Flag untuk menandai pemuatan pertama
        let lastKnownOnlinePlaylistId = null;
        let isManuallySwitchingSong = false;

        let webviewIsPlaying = false;
        let webviewCurrentTime = 0;
        let webviewDuration = 0;
        let webviewProgressPercent = 0;

        let latestWebviewTitle = '';
        let isRetryingSkip = false;

        const volumeSlider = document.getElementById('volume-slider');
        const currentTimeExpanded = document.getElementById('current-time-expanded');
        const durationExpanded = document.getElementById('duration-expanded');
        const nowPlayingSongText = document.getElementById('now-playing-song');
        const musicVisualizer = document.getElementById("music-visualizer");
        const playPauseBtnCollapsed = document.getElementById('play-pause');
        const playPauseBtnExpanded = document.getElementById('play-pause-expanded');

        const playlistToggleButton = document.getElementById('playlist-toggle-btn');

        // --- Prosedur Fungsi-Fungsi Musik Player --- //
        function updateMusicUI() {
            if (controlMode === 'local') {
                updatePlaylistHighlight();
                if (!audioElement.paused) {
                    playPauseBtnCollapsed.textContent = '';
                    playPauseBtnExpanded.textContent = '';
                    musicDisk.style.animationPlayState = 'running';
                } else {
                    playPauseBtnCollapsed.textContent = '';
                    playPauseBtnExpanded.textContent = '';
                    musicDisk.style.animationPlayState = 'paused';
                }
            } else if (controlMode === 'webview') {
                if (webviewIsPlaying) {
                    playPauseBtnCollapsed.textContent = '';
                    playPauseBtnExpanded.textContent = '';
                    musicDisk.style.animationPlayState = 'running';
                } else {
                    playPauseBtnCollapsed.textContent = '';
                    playPauseBtnExpanded.textContent = '';
                    musicDisk.style.animationPlayState = 'paused';
                }

                progressBarExpanded.style.width = `${webviewProgressPercent}%`;
                const formatTime = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60).toString().padStart(2, '0');
                    return `${minutes}:${remainingSeconds}`;
                };
                currentTimeExpanded.textContent = formatTime(webviewCurrentTime);
                durationExpanded.textContent = formatTime(webviewDuration);

                updatePlaylistHighlight();
            }
        }

        function generateShufflePlaylist() {
            shufflePlaylist = songs.map((_, idx) => idx).filter(idx => idx !== currentSongIndex);

            for (let i = shufflePlaylist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shufflePlaylist[i], shufflePlaylist[j]] = [shufflePlaylist[j], shufflePlaylist[i]];
            }
        }

        function getNextShuffleSongIndex() {
            if (!shufflePlaylist || shufflePlaylist.length === 0) {
                generateShufflePlaylist();
            }
            return shufflePlaylist.shift();
        }

        // Render Playlist Lokal
        function renderPlaylist() {
            playlistElement.innerHTML = '';
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.textContent = song.title;

                li.addEventListener('click', () => {
                    controlMode = 'local';

                    // Hentikan webview jika sedang berjalan
                    if (webviewActive && webviewIsPlaying) {
                        webview.executeJavaScript('window.playerAPI.playPause()');
                    }

                    currentSongIndex = index;
                    loadSong(currentSongIndex);
                    audioElement.play();
                });
                playlistElement.appendChild(li);
            });
            updatePlaylistHighlight();
        }

        function renderOnlinePlaylist() {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = `
        <li style="text-align: center; color: #888; cursor: default; padding: 20px 0;">
            Playlist dikelola di dalam<br>browser online.
            <br><br>
            Buka panel Online Music<br>untuk melihat daftar putar.
        </li>
    `;
        }

        // Listener utama pada tombol toggle
        playlistToggleButton.addEventListener('click', () => {
            if (activePlaylistSource === 'local') {
                switchToOnlineView();
                if (webviewActive) {
                    webview.executeJavaScript('window.playerAPI.scanPlaylist()').catch(err => console.error("Gagal meminta data playlist:", err));
                }
            } else {
                switchToLocalView(true);
            }
        });

        function switchToLocalView(isManualSwitch = false) {
            activePlaylistSource = 'local';
            playlistToggleButton.textContent = 'Local Playlist';
            playlistToggleButton.classList.remove('online-mode');
            renderPlaylist();

            if (isManualSwitch) {
                lastKnownOnlinePlaylistId = null;
                console.log('[Manual Switch] Beralih ke Local, `lastKnownOnlinePlaylistId` direset.');
            }
        }

        function switchToOnlineView() {
            activePlaylistSource = 'online';
            playlistToggleButton.textContent = 'Online Playlist';
            playlistToggleButton.classList.add('online-mode');

            renderOnlinePlaylist(latestOnlinePlaylistData);

            if (webviewActive && webview) {
                console.log('[Updater] Meminta update playlist di latar belakang.');
                // Check if webview is ready before executing JS
                if (webview.getWebContentsId) { // Simple check if it's attached
                    webview.executeJavaScript('window.playerAPI.scanPlaylist()').catch(err => {
                        // Ignore "WebView must be attached" error if it happens during init
                        if (!err.message.includes('WebView must be attached')) {
                            console.error("Gagal meminta data playlist:", err);
                        }
                    });
                }
            }
        }

        function playOnlineSongByTitle(targetTitle) {
            if (controlMode !== 'webview' || !audioElement.paused) {
                console.log("Mengalihkan ke mode webview, menghentikan pemutar lokal.");
                controlMode = 'webview';
                audioElement.pause();
                audioElement.src = '';
                updateMusicUI();
            }

            // AKTIFKAN FLAG: Beri tahu sistem bahwa kita sedang ganti lagu manual
            isManuallySwitchingSong = true;
            console.log('[Scroll Control] Mengganti lagu manual, scroll otomatis akan diabaikan untuk update berikutnya.');

            // Reset flag setelah jeda singkat, agar deteksi playlist baru bisa berjalan normal lagi nanti
            setTimeout(() => {
                isManuallySwitchingSong = false;
                console.log('[Scroll Control] Flag `isManuallySwitchingSong` direset.');
            }, 2500); // Jeda 2.5 detik seharusnya cukup untuk semua proses update selesai.

            if (isRetryingSkip) {
                console.log('Proses klik sedang berjalan, klik lain diabaikan.');
                return;
            }

            isRetryingSkip = true;
            console.log(`Memulai percobaan klik langsung ke: "${targetTitle}"`);

            let retryCount = 0;
            const maxRetries = 3;
            const retryIntervalMs = 1000;
            let retryInterval = null;

            const stopRetry = (reason) => {
                console.log(`Menghentikan percobaan. Alasan: ${reason}`);
                clearInterval(retryInterval);
                isRetryingSkip = false;
            };

            const attemptDirectClick = async () => {
                if (latestWebviewTitle.includes(targetTitle)) {
                    stopRetry('Sukses, judul lagu telah berubah.');
                    return;
                }

                if (retryCount >= maxRetries) {
                    stopRetry('Gagal setelah beberapa kali percobaan.');
                    showNotification('Gagal memutar lagu, coba putar manual dari webview sekali aja.', 'notification-error');
                    ipcRenderer.send('request-global-notification', {
                        title: 'Gagal Memutar Lagu',
                        message: 'Coba putar manual dari YT Music Webview !!',
                        type: 'error'
                    });
                    return;
                }

                console.log(`Percobaan klik langsung ke-${retryCount + 1}...`);
                retryCount++;

                try {
                    await webview.executeJavaScript(`window.playerAPI.clickPlayButtonOnSong(${JSON.stringify(targetTitle)})`);
                } catch (err) {
                    console.error('Error saat mencoba klik langsung:', err);
                }
            };

            attemptDirectClick();
            retryInterval = setInterval(attemptDirectClick, retryIntervalMs);
        }

        function updatePlaylistHighlight() {
            const playlistItems = document.querySelectorAll("#playlist li");
            playlistItems.forEach((item, index) => {
                if (index === currentSongIndex) {
                    item.classList.add("active");
                } else {
                    item.classList.remove("active");
                }
            });
        }

        function loadSong(index) {
            if (songs.length === 0) return; // Jangan lakukan apa-apa jika tidak ada lagu
            currentSongIndex = index; // currentSongIndex jadi terupdate

            if (controlMode === 'local') {
                const song = songs[index];
                if (!song) return; // Jika lagu tidak ditemukan

                const fullTitleText = `Now Playing: ${song.title}${song.artist ? ' - ' + song.artist : ''}`;
                audioElement.src = song.src;
                // Update UI Utama
                titleElement.textContent = fullTitleText;
                titleElement.title = fullTitleText; // untuk tooltip
                titleElementExpand.textContent = truncateMusicTitle(`${song.title}${song.artist ? ' - ' + song.artist : ''}`);
                const musicDisk = document.getElementById("music-disk");
                if (musicDisk) {
                    musicDisk.src = song.cover || "./aset/musik.png";
                }
                progressBar.style.width = '0%';

                onSongPlay(song);

                updatePlaylistHighlight();
            } else {
                audioElement.pause();
                audioElement.src = '';
                songStartTimestamp = null;
                updatePlaylistHighlight(); // Hapus highlight dari lagu lokal

                if (lastWebviewState && lastWebviewState.title) {
                    const fullTitleText = `Now Playing: ${lastWebviewState.title}`;
                    // Jika ada, gunakan data dari catatan tersebut
                    console.log('Restoring last webview state to UI:', lastWebviewState.title);
                    titleElement.textContent = fullTitleText;
                    titleElement.title = fullTitleText; //  untuk tooltip
                    titleElementExpand.textContent = truncateMusicTitle(`${lastWebviewState.title}${lastWebviewState.artist ? ' - ' + lastWebviewState.artist : ''}`);
                    const musicDisk = document.getElementById("music-disk");
                    if (musicDisk) {
                        musicDisk.src = lastWebviewState.thumbnail || "./aset/musik.png";
                    }
                } else {
                    titleElement.textContent = `Now Playing: Online`;
                    titleElement.title = `Now Playing: Online`;
                    titleElementExpand.textContent = 'Online Music';
                }
            }
            broadcastPlayerState();
        }

        function broadcastFullPlayerState() {
            if (!ipcRenderer) return;

            let fullState = {
                title: "No Music",
                artist: "",
                coverSrc: './aset/musik.png',
                currentTime: 0,
                duration: 0,
                progressPercent: 0,
                isPlaying: false,
                playlist: songs,
                currentSongIndex: currentSongIndex,
                volume: audioElement.volume,
                visualizerData: currentVisualizerData || []
            };

            if (controlMode === 'local' && songs.length > 0 && songs[currentSongIndex]) {
                const currentSong = songs[currentSongIndex];
                fullState.title = currentSong.title;
                fullState.artist = currentSong.artist;
                fullState.coverSrc = currentSong.cover || './aset/musik.png';
                fullState.currentTime = audioElement.currentTime;
                fullState.duration = audioElement.duration;
                fullState.progressPercent = (audioElement.currentTime / audioElement.duration) * 100;
                fullState.isPlaying = !audioElement.paused;

            } else if (controlMode === 'webview') {
                fullState.title = document.getElementById('now-playing-song')?.textContent || "Online Music";
                fullState.artist = webviewArtist;
                fullState.coverSrc = document.getElementById('music-disk')?.src || './aset/musik.png';
                fullState.currentTime = webviewCurrentTime || 0;
                fullState.duration = webviewDuration || 0;
                fullState.progressPercent = webviewProgressPercent || 0;
                fullState.isPlaying = webviewIsPlaying || false;
            }

            ipcRenderer.send('update-mini-player-data', fullState);
            ipcRenderer.send('player-state-update-to-overlay', fullState);
        }

        let actualMiniPlayerFeatureEnabled = false;

        function sendDataToMiniPlayer() {
            if (!actualMiniPlayerFeatureEnabled) return;

            let songData = {
                title: "No Title",
                artist: "",
                coverSrc: './aset/musik.png',
                currentTime: 0,
                duration: 0,
                progressPercent: 0,
                isPlaying: false,
                visualizerData: []
            };

            if (controlMode === 'local' && songs.length > 0 && songs[currentSongIndex]) {
                const currentSong = songs[currentSongIndex];
                songData = {
                    title: currentSong.title || "No Title",
                    artist: currentSong.artist || "",
                    coverSrc: currentSong.cover || './aset/musik.png',
                    currentTime: audioElement.currentTime,
                    duration: audioElement.duration || 0,
                    progressPercent: (audioElement.duration && audioElement.currentTime) ? (audioElement.currentTime / audioElement.duration) * 100 : 0,
                    isPlaying: !audioElement.paused,
                    visualizerData: currentVisualizerData
                };
            } else if (controlMode === 'webview') {
                songData = {
                    title: document.getElementById('now-playing-song')?.textContent || "Online Music",
                    artist: webviewArtist,
                    coverSrc: document.getElementById('music-disk')?.src || './aset/musik.png',
                    currentTime: webviewCurrentTime || 0,
                    duration: webviewDuration || 0,
                    progressPercent: webviewProgressPercent || 0,
                    isPlaying: webviewIsPlaying || false,
                    visualizerData: currentVisualizerData
                };
            } else {
                // Jika tidak ada mode atau lagu tidak valid, kirim data default/kosong
                songData.visualizerData = currentVisualizerData; // Tetap kirim data visualizer (yang akan jadi 0)
            }
            ipcRenderer.send('update-mini-player-data', songData);
        }

        // ---- Listener elemen Musik Player saat tidak ter-Expand ---- //
        document.getElementById('prev-music').addEventListener('click', () => {
            currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            loadSong(currentSongIndex);
            audioElement.play();
            updateMusicUI();
            document.getElementById('prev-music').addEventListener('click', () => {
                if (controlMode === 'webview') {
                    webview.send('remote-prev');
                } else {
                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                    loadSong(currentSongIndex);
                    audioElement.play();
                    updateMusicUI();
                }
                broadcastPlayerState();
            });
        });

        document.getElementById('next-music').addEventListener('click', () => {
            if (isShuffleOn) {
                currentSongIndex = getNextShuffleSongIndex();
                document.getElementById('next-music').addEventListener('click', () => {
                    if (controlMode === 'webview') {
                        webview.send('remote-next');
                    } else {
                        if (isShuffleOn) currentSongIndex = getNextShuffleSongIndex();
                        else currentSongIndex = (currentSongIndex + 1) % songs.length;
                        loadSong(currentSongIndex);
                        audioElement.play();
                        updateMusicUI();
                    }
                    broadcastPlayerState();
                });
            } else {
                currentSongIndex = (currentSongIndex + 1) % songs.length;
            }
            loadSong(currentSongIndex);
            audioElement.play();
            updateMusicUI(); // Ini biar tombol play pause nya ke update statusnya
        });


        document.getElementById('shuffle-music').addEventListener('click', () => {
            if (controlMode === 'webview') {
                console.warn("Shuffle control for webview not fully implemented.");
            } else {
                isShuffleOn = !isShuffleOn;
                const shuffleButton = document.getElementById('shuffle-music');

                if (!shuffleButton.querySelector('.shuffle-text')) {
                    shuffleButton.innerHTML = ' <span class="shuffle-text"></span>';
                }

                const shuffleText = shuffleButton.querySelector('.shuffle-text');

                shuffleButton.style.color = isShuffleOn ? 'cyan' : 'white';
                shuffleText.textContent = isShuffleOn ? 'ON' : 'OFF';

                // Tampilkan teks dengan opacity
                shuffleText.style.opacity = '1';
                shuffleText.style.transition = 'opacity 0.5s ease-in';

                // Hilangkan teks setelah beberapa detik
                setTimeout(() => {
                    shuffleText.style.transition = 'opacity 0.5s ease-out';
                    shuffleText.style.opacity = '0';
                    setTimeout(() => {
                        shuffleText.textContent = '';
                    }, 500);
                }, 1500);

                if (isShuffleOn) {
                    playedHistory = [];
                }
            }
        });

        // --- Listener elemen Musik Player saat ada webview (tidak ter-Expand) --- //
        document.getElementById('play-pause').addEventListener('click', () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.playPause()');
            } else {
                const isPlayingAfterClick = audioElement.paused;
                ipcRenderer.send('update-rpc-activity', {
                    songTitle: songs[currentSongIndex].title,
                    songArtist: songs[currentSongIndex].artist,
                    smallImageKey: isPlayingAfterClick ? 'play_icon' : 'pause_icon',
                    smallImageText: isPlayingAfterClick ? 'Sedang Memutar' : 'Dijeda'
                });

                if (audioElement.paused) {
                    audioElement.play();
                } else {
                    audioElement.pause();
                }
                updateMusicUI();
            }
        });

        document.getElementById('prev-music').addEventListener('click', () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.prev()');
            } else {
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                loadSong(currentSongIndex);
                audioElement.play();
                updateMusicUI();
            }
        });

        document.getElementById('next-music').addEventListener('click', () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.next()');
            } else {
                if (isShuffleOn) {
                    currentSongIndex = getNextShuffleSongIndex();
                } else {
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                loadSong(currentSongIndex);
                audioElement.play();
                updateMusicUI();
            }
        });

        // ---- Listener elemen Musik Player saat ter-Expand ---- //
        let isExpanded = false;
        let activePlaylistSource = 'local';
        let onlinePlaylistData = [];
        let rapidPlaylistUpdater = null;
        let rapidUpdateStopper = null;

        expandCollapseButton.addEventListener('click', () => {
            isExpanded = !isExpanded;
            if (isExpanded) {
                musicControl.classList.remove('collapsed');
                musicControl.classList.add('expanded');
                expandCollapseButton.textContent = '';
            } else {
                musicControl.classList.remove('expanded');
                musicControl.classList.add('collapsed');
                expandCollapseButton.textContent = '';
            }
            /* Geser wallpaper control jika perlu */
            const musicControlHeight = isExpanded ? 300 : 100;
            const wallpaperOffset = isExpanded ? 235 : 20;
            wallpaperControl.style.bottom = `${musicControlHeight + wallpaperOffset}px`;
        });

        /* Expanded button di dalam player */
        document.getElementById("play-pause-expanded").addEventListener("click", () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.playPause()');
            } else {
                const isPlayingAfterClick = audioElement.paused;
                ipcRenderer.send('update-rpc-activity', {
                    songTitle: songs[currentSongIndex].title,
                    songArtist: songs[currentSongIndex].artist,
                    smallImageKey: isPlayingAfterClick ? 'play_icon' : 'pause_icon',
                    smallImageText: isPlayingAfterClick ? 'Sedang Memutar' : 'Dijeda'
                });

                if (audioElement.paused) {
                    audioElement.play();
                } else {
                    audioElement.pause();
                }
                updateMusicUI();
            }
        });

        document.getElementById('prev-music-expanded').addEventListener('click', () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.prev()');
            } else {
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                loadSong(currentSongIndex);
                audioElement.play();
                updatePlaylistHighlight();
            }
        });

        document.getElementById("next-music-expanded").addEventListener("click", () => {
            if (controlMode === 'webview') {
                webview.executeJavaScript('window.playerAPI.next()');
            } else {
                if (isShuffleOn) currentSongIndex = Math.floor(Math.random() * songs.length);
                else currentSongIndex = (currentSongIndex + 1) % songs.length;
                loadSong(currentSongIndex);
                audioElement.play();
                updatePlaylistHighlight();
            }
        });

        document.getElementById("shuffle-music-expanded").addEventListener("click", () => {
            if (controlMode === 'webview') {
                console.warn("Shuffle control for webview not fully implemented.");
            } else {
                isShuffleOn = !isShuffleOn;
                const shuffleButton = document.getElementById("shuffle-music-expanded");

                if (!shuffleButton.querySelector(".shuffle-text")) {
                    shuffleButton.innerHTML = " <span class='shuffle-text'></span>";
                }

                const shuffleText = shuffleButton.querySelector(".shuffle-text");

                shuffleButton.style.color = isShuffleOn ? "cyan" : "white";
                shuffleText.textContent = isShuffleOn ? "ON" : "OFF";

                // Tampilkan teks dengan opacity
                shuffleText.style.opacity = "1";
                shuffleText.style.transition = "opacity 0.5s ease-in";

                // Hilangkan teks setelah beberapa detik
                setTimeout(() => {
                    shuffleText.style.transition = "opacity 0.5s ease-out";
                    shuffleText.style.opacity = "0";
                    setTimeout(() => {
                        shuffleText.textContent = "";
                    }, 500);
                }, 1500);

                if (isShuffleOn) {
                    playedHistory = [];
                }
            }
        });

        // Volume
        volumeSlider.addEventListener('input', (e) => {
            audioElement.volume = e.target.value;
        });

        /* Progress bar */
        audioElement.addEventListener('timeupdate', () => {
            if (controlMode === 'local' && !isNaN(audioElement.duration)) {
                const progressPercent = (audioElement.currentTime / audioElement.duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                // Expanded
                const progressBarExp = document.getElementById('progress-bar-expanded');
                if (progressBarExp) {
                    progressBarExp.style.width = `${progressPercent}%`;
                }
                const currentMin = Math.floor(audioElement.currentTime / 60);
                const currentSec = Math.floor(audioElement.currentTime % 60).toString().padStart(2, '0');
                const durationMin = Math.floor(audioElement.duration / 60);
                const durationSec = Math.floor(audioElement.duration % 60).toString().padStart(2, '0');

                document.getElementById('current-time').textContent = `${currentMin}:${currentSec}`;
                document.getElementById('duration').textContent = `${durationMin}:${durationSec}`;
                document.getElementById('current-time-expanded').textContent = `${currentMin}:${currentSec}`;
                document.getElementById('duration-expanded').textContent = `${durationMin}:${durationSec}`;

                sendDataToMiniPlayer();
            }
            broadcastPlayerState();
        });

        document.getElementById('progress-container').addEventListener('click', (e) => {
            if (controlMode === 'webview') {
                console.warn("Seek control for webview not fully implemented.");
                const containerWidth = e.currentTarget.offsetWidth;
                const clickX = e.offsetX;
                const seekTime = (clickX / containerWidth) * webviewDuration; // Use webviewDuration
                webview.executeJavaScript(`window.playerAPI.seek(${seekTime})`);
            } else {
                // Local seek logic
                if (!isNaN(audioElement.duration)) {
                    const pct = e.offsetX / e.currentTarget.offsetWidth;
                    const newTime = pct * audioElement.duration;
                    audioElement.currentTime = newTime;
                }
            }
        });

        document.getElementById('progress-container-expanded').addEventListener('click', (e) => {
            if (controlMode === 'webview') {
                const containerWidth = e.currentTarget.offsetWidth;
                const clickX = e.offsetX;
                const seekTime = (clickX / containerWidth) * webviewDuration;
                webview.executeJavaScript(`window.playerAPI.seek(${seekTime})`);
            } else {
                if (!isNaN(audioElement.duration)) {
                    const containerWidth = e.currentTarget.offsetWidth;
                    const clickX = e.offsetX;
                    audioElement.currentTime = (clickX / containerWidth) * audioElement.duration;
                }
            }
        });

        /* On ended -> next track */
        audioElement.addEventListener('ended', () => {
            if (controlMode === 'local') {
                if (isShuffleOn) {
                    currentSongIndex = Math.floor(Math.random() * songs.length);
                } else {
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                loadSong(currentSongIndex);
                audioElement.play();
            }
        });

        /* Visualizer */
        document.addEventListener("DOMContentLoaded", () => {
            let webviewAnalyserData = new Uint8Array(32).fill(0);
            let audioCtx, analyser;

            const NUM_BARS_LOCAL = 40;
            const NUM_BARS_WEBVIEW = 42;
            const MAX_BARS = Math.max(NUM_BARS_LOCAL, NUM_BARS_WEBVIEW);
            const bars = [];

            // Listener terpusat untuk semua pesan dari webview
            webview.addEventListener('ipc-message', (e) => {
                if (e.channel === 'ad-status-update') {
                    // Ambil 'details' dari argumen event
                    const { state, bounds: targetBounds, details } = e.args[0];

                    let webviewBounds = null;

                    // Jika skippable, dapatkan juga bounds webview
                    if (state === 'skippable' && targetBounds) {
                        webviewBounds = webview.getBoundingClientRect();
                        webviewBounds = { x: webviewBounds.x, y: webviewBounds.y };
                    }

                    // Sertakan 'details' saat mengirim ke main process
                    ipcRenderer.send('ad-status-update', { state, targetBounds, webviewBounds, details });

                } else if (e.channel === 'analyser-data') {
                    const { data } = e.args[0];
                    if (data && data.length > 0) {
                        webviewAnalyserData = new Uint8Array(data);
                    }
                }
                if (e.channel === 'request-auto-skip-instant') {
                    const coords = e.args[0]; // Ambil koordinat langsung dari preload

                    // --- LOGIKA KLIK LANGSUNG DI SINI ---
                    const webview = document.getElementById('external-webview');

                    // 1. Hitung Zoom Factor
                    const zoomFactor = webview.getZoomFactor();
                    const scaledX = Math.round(coords.x * zoomFactor);
                    const scaledY = Math.round(coords.y * zoomFactor);

                    console.log(`[Instant Skip] Melakukan klik di: ${scaledX}, ${scaledY}`);

                    // 2. Eksekusi InputEvent LANGSUNG tanpa ke Main Process
                    // Mouse Down
                    webview.sendInputEvent({
                        type: 'mouseDown',
                        button: 'left',
                        x: scaledX,
                        y: scaledY,
                        clickCount: 1
                    });

                    // Mouse Up (Beri jeda sangat kecil agar terbaca sebagai klik)
                    setTimeout(() => {
                        webview.sendInputEvent({
                            type: 'mouseUp',
                            button: 'left',
                            x: scaledX,
                            y: scaledY,
                            clickCount: 1
                        });
                    }, 50);
                }
            });

            // Inisialisasi awal
            renderPlaylist();
            loadSong(currentSongIndex);

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
            } catch (err) {
                console.error("Web Audio API tidak didukung:", err);
            }

            if (audioCtx && analyser) {
                const source = audioCtx.createMediaElementSource(audioElement);

                // Tambahkan lowpass filter dan gain node untuk efek muffled quit popup
                // Filter ini selalu terhubung, tapi parameter-nya akan diatur saat popup muncul
                quitPopupLowpassFilter = audioCtx.createBiquadFilter();
                quitPopupLowpassFilter.type = 'lowpass';
                quitPopupLowpassFilter.frequency.value = 22050; // Full range default (tidak memfilter apa-apa)
                quitPopupLowpassFilter.Q.value = 0.7; // Q rendah = tidak ada resonance boost

                quitPopupGainNode = audioCtx.createGain();
                quitPopupGainNode.gain.value = 1.0; // Volume 100% default

                // Chain: source -> lowpassFilter -> gainNode -> analyser -> destination
                source.connect(quitPopupLowpassFilter);
                quitPopupLowpassFilter.connect(quitPopupGainNode);
                quitPopupGainNode.connect(analyser);
                analyser.connect(audioCtx.destination);

                // Simpan referensi audioCtx untuk fungsi muffled effect
                quitPopupAudioContext = audioCtx;
                quitPopupAudioConnected = true;

                console.log('[Audio Chain] Audio graph dengan support untuk efek muffled berhasil di-setup');
            }

            const visualizerContainer = document.getElementById("music-visualizer");
            visualizerContainer.innerHTML = '';
            for (let i = 0; i < MAX_BARS; i++) {
                const barEl = document.createElement("div");
                barEl.className = "bar";
                bars.push(barEl);
                visualizerContainer.appendChild(barEl);
            }

            // WebGPU Visualizer Init
            const webgpuVisualizer = new WebGPUVisualizer("music-visualizer", MAX_BARS);
            let isWebGPUInitialized = false;
            let wasWebGPUEnabled = false;
            let currentWebGPUStyle = -1; // Track current style
            const previousVisualizerValues = new Array(MAX_BARS).fill(1);

            let lastVisualizerDataStr = "";
            let visualizerIdleCounter = 0;

            function animateVisualizer() {
                currentVisualizerData = [];

                const activeNumBars = (controlMode === 'local') ? NUM_BARS_LOCAL : NUM_BARS_WEBVIEW;
                let hasActivity = false;

                // Check WebGPU setting
                const webgpuCheckbox = document.getElementById('webgpu-acceleration-checkbox');
                const useWebGPU = webgpuCheckbox && webgpuCheckbox.checked;

                // Check Style setting
                const savedStyle = sessionStorage.getItem('savedWebGPUVisualizerStyle');
                const targetStyle = savedStyle !== null ? parseInt(savedStyle) : 1; // Default Modern (1)

                // Handle switching
                if (useWebGPU !== wasWebGPUEnabled) {
                    if (useWebGPU) {
                        if (!isWebGPUInitialized) {
                            webgpuVisualizer.init().then(success => {
                                if (success) {
                                    isWebGPUInitialized = true;
                                    webgpuVisualizer.enable();
                                    webgpuVisualizer.setStyle(targetStyle); // Set initial style
                                    currentWebGPUStyle = targetStyle;
                                    bars.forEach(b => b.style.display = 'none');
                                }
                            });
                        } else {
                            webgpuVisualizer.enable();
                            webgpuVisualizer.setStyle(targetStyle);
                            currentWebGPUStyle = targetStyle;
                            bars.forEach(b => b.style.display = 'none');
                        }
                    } else {
                        if (isWebGPUInitialized) {
                            webgpuVisualizer.disable();
                            visualizerContainer.innerHTML = '';
                            bars.forEach(b => visualizerContainer.appendChild(b));
                        }
                    }
                    wasWebGPUEnabled = useWebGPU;
                }

                // Update style if changed while enabled
                if (useWebGPU && isWebGPUInitialized && currentWebGPUStyle !== targetStyle) {
                    webgpuVisualizer.setStyle(targetStyle);
                    currentWebGPUStyle = targetStyle;
                }

                if (!useWebGPU) {
                    bars.forEach((bar, index) => {
                        bar.style.display = index < activeNumBars ? 'block' : 'none';
                    });
                }

                if (controlMode === 'local' && analyser) {
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(dataArray);
                    const effectiveFrequencyDataLength = analyser.frequencyBinCount;
                    const relevantDataSlice = dataArray.slice(0, Math.min(64, effectiveFrequencyDataLength));

                    for (let i = 0; i < activeNumBars; i++) {
                        const dataIndex = Math.floor((i / activeNumBars) * relevantDataSlice.length);
                        const rawValue = relevantDataSlice[dataIndex] || 0;

                        const maxScaleMain = 65;
                        const baseScaleMain = 1;
                        const newCalculatedScaleMain = baseScaleMain + (rawValue / 255) * maxScaleMain;

                        let currentAppliedScaleMain = previousVisualizerValues[i] || baseScaleMain;

                        let finalDisplayScaleMain;
                        if (newCalculatedScaleMain > currentAppliedScaleMain) {
                            finalDisplayScaleMain = newCalculatedScaleMain;
                        } else {
                            finalDisplayScaleMain = currentAppliedScaleMain * 0.85;
                        }
                        finalDisplayScaleMain = Math.max(baseScaleMain, finalDisplayScaleMain);
                        previousVisualizerValues[i] = finalDisplayScaleMain;

                        if (!useWebGPU) {
                            if (bars[i]) {
                                bars[i].style.transform = `scaleY(${finalDisplayScaleMain})`;
                            }
                        }

                        if (finalDisplayScaleMain > 1.01) hasActivity = true;

                        let normalizedFactor = (finalDisplayScaleMain - baseScaleMain) / maxScaleMain;
                        currentVisualizerData.push(Math.max(0, Math.min(1, normalizedFactor)));
                    }

                } else if (controlMode === 'webview') {
                    const dataArray = webviewAnalyserData;
                    const relevantDataSlice = dataArray.slice(0, Math.min(32, dataArray.length));

                    for (let i = 0; i < activeNumBars; i++) {
                        const dataIndex = Math.floor((i / activeNumBars) * relevantDataSlice.length);
                        const rawValue = relevantDataSlice[dataIndex] || 0;

                        const maxScaleMain = 55;
                        const baseScaleMain = 1;
                        const newCalculatedScaleMain = baseScaleMain + (rawValue / 255) * maxScaleMain;

                        let currentAppliedScaleMain = previousVisualizerValues[i] || baseScaleMain;

                        let finalDisplayScaleMain;
                        if (newCalculatedScaleMain > currentAppliedScaleMain) {
                            finalDisplayScaleMain = newCalculatedScaleMain;
                        } else {
                            finalDisplayScaleMain = currentAppliedScaleMain * 0.85; // Faktor peluruhan sama
                        }
                        finalDisplayScaleMain = Math.max(baseScaleMain, finalDisplayScaleMain);
                        previousVisualizerValues[i] = finalDisplayScaleMain;

                        if (!useWebGPU) {
                            if (bars[i]) {
                                bars[i].style.transform = `scaleY(${finalDisplayScaleMain})`;
                            }
                        }

                        if (finalDisplayScaleMain > 1.01) hasActivity = true;

                        let normalizedFactor = (finalDisplayScaleMain - baseScaleMain) / maxScaleMain;
                        currentVisualizerData.push(Math.max(0, Math.min(1, normalizedFactor)));
                    }

                } else {
                    const baseScaleMain = 1;
                    for (let i = 0; i < activeNumBars; i++) {
                        let currentAppliedScaleMain = previousVisualizerValues[i] || baseScaleMain;
                        let finalDisplayScaleMain = currentAppliedScaleMain * 0.85;
                        finalDisplayScaleMain = Math.max(baseScaleMain, finalDisplayScaleMain);
                        previousVisualizerValues[i] = finalDisplayScaleMain;

                        if (!useWebGPU) {
                            if (bars[i]) {
                                bars[i].style.transform = `scaleY(${finalDisplayScaleMain})`;
                            }
                        }
                        currentVisualizerData.push(0);
                    }
                }

                if (useWebGPU && isWebGPUInitialized && currentVisualizerData.length > 0) {
                    const dataForGPU = new Uint8Array(MAX_BARS);
                    for (let i = 0; i < currentVisualizerData.length; i++) {
                        dataForGPU[i] = Math.floor(currentVisualizerData[i] * 255);
                    }
                    webgpuVisualizer.render(dataForGPU);
                }

                // Optimization: Reduce IPC calls when idle
                if (!hasActivity) {
                    visualizerIdleCounter++;
                    if (visualizerIdleCounter > 10) { // Allow a few frames to settle
                        // Send one last zero-frame then stop sending
                        if (visualizerIdleCounter === 11) {
                            ipcRenderer.send('visualizer-data-stream', currentVisualizerData);
                        }
                        return;
                    }
                } else {
                    visualizerIdleCounter = 0;
                }

                ipcRenderer.send('visualizer-data-stream', currentVisualizerData);

                if (actualMiniPlayerFeatureEnabled) {
                    sendDataToMiniPlayer();
                }
            }

            // Loop animasi menggunakan requestAnimationFrame, Ini jangan pernah diubah metode nya biar visualizer ga throttling kalau aplikasi utama di minimize
            setInterval(animateVisualizer, 1200 / 100);

            // Event listener untuk audio lokal
            audioElement.addEventListener('play', () => {
                if (controlMode === 'local') {
                    updateMusicUI();
                    sendDataToMiniPlayer();
                    broadcastPlayerState();
                    if (audioCtx && audioCtx.state === "suspended") {
                        audioCtx.resume();
                    }
                }
            });

            audioElement.addEventListener('pause', () => {
                if (controlMode === 'local') {
                    updateMusicUI();
                    sendDataToMiniPlayer();
                    broadcastPlayerState();
                }
            });

            // Event listener untuk tombol play/pause (untuk resume AudioContext)
            document.getElementById("play-pause").addEventListener("click", () => {
                if (controlMode === 'local' && audioCtx && audioCtx.state === "suspended") {
                    audioCtx.resume();
                }
            });

            document.getElementById("play-pause-expanded").addEventListener("click", () => {
                if (controlMode === 'local' && audioCtx && audioCtx.state === "suspended") {
                    audioCtx.resume();
                }
            });
        });

        // ================================ ( End Menu Options & Quit ) ================================ //


        // ================================ ( Overlay Musik Player ) ================================ //
        if (enableOverlayCheckbox) {
            enableOverlayCheckbox.addEventListener('change', (event) => {
                const isEnabled = event.target.checked;
                ipcRenderer.send('set-overlay-feature', isEnabled);
                ipcRenderer.send('save-settings', { overlayEnabled: isEnabled });
            });
        }

        if (enableDynamicThemeCheckbox) {
            enableDynamicThemeCheckbox.addEventListener('change', (event) => {
                console.log('[DynamicTheme] Checkbox changed:', event.target.checked);
                applyDynamicThemeState();
            });
        }

        if (dynamicThemeModeSelect) {
            dynamicThemeModeSelect.addEventListener('change', () => {
                applyDynamicThemeState();
            });
        }

        toggleDynamicThemeSubOptions();

        function broadcastPlayerState() {
            // state default
            let state = {
                title: "No Music",
                artist: "",
                coverSrc: './aset/musik.png',
                currentTime: 0,
                duration: 0,
                progressPercent: 0,
                isPlaying: false,
                playlist: songs,
                onlinePlaylist: latestOnlinePlaylistData,
                playlistMode: activePlaylistSource,
                currentSongIndex: currentSongIndex,
                volume: audioElement.volume,
                visualizerData: currentVisualizerData || []
            };

            if (controlMode === 'webview') {
                state.title = document.getElementById('now-playing-song')?.textContent || "Online Music";
                state.artist = typeof webviewArtist !== 'undefined' ? webviewArtist : "";
                state.coverSrc = document.getElementById('music-disk')?.src || './aset/musik.png';
                state.currentTime = webviewCurrentTime || 0;
                state.duration = webviewDuration || 0;
                state.progressPercent = state.duration > 0 ? (state.currentTime / state.duration) * 100 : 0;
                state.isPlaying = webviewIsPlaying || false;

            } else { // 'local'
                if (songs.length > 0 && songs[currentSongIndex]) {
                    const currentSong = songs[currentSongIndex];
                    state.title = currentSong.title;
                    state.artist = currentSong.artist;
                    state.coverSrc = currentSong.cover || './aset/musik.png';
                    state.currentTime = audioElement.currentTime;
                    state.duration = audioElement.duration || 0;
                    state.progressPercent = state.duration > 0 ? (state.currentTime / state.duration) * 100 : 0;
                    state.isPlaying = !audioElement.paused;
                }
            }

            // Kirim state yang sudah benar ke main process
            ipcRenderer.send('update-shared-player-state', state);
        }

        ipcRenderer.on('request-player-state-for-overlay', () => {
            console.log("Main window received request for initial state from overlay.");
            broadcastPlayerState(); // Kirim status terkini saat diminta
        });

        ipcRenderer.on('execute-internal-webview-click', async (event, coords) => {
            const webview = document.getElementById('external-webview');
            if (webview && coords) {

                //------------------- ( penting: biar klik overlay gak meleset pas webview lagi zoom ) -------------------------//
                //------------------- ( mulai penyesuaian koordinat dengan zoomFactor ) -------------------------//
                // 1. Dapatkan zoom factor yang sedang aktif (misal: 0.85)
                const zoomFactor = webview.getZoomFactor();

                // 2. Terapkan zoom factor ke koordinat yang diterima (koordinat 100%)
                const scaledX = Math.round(coords.x * zoomFactor);
                const scaledY = Math.round(coords.y * zoomFactor);

                console.log(`[Renderer] Menerima perintah klik. Coords Asli: (${coords.x}, ${coords.y}), Zoom: ${zoomFactor}, Coords Discalakan: (${scaledX}, ${scaledY})`);

                // 3. Buat event mouse 'down' dengan koordinat yang sudah discalakan
                const mouseDownEvent = {
                    type: 'mouseDown',
                    button: 'left',
                    x: scaledX, // <-- Gunakan scaledX
                    y: scaledY, // <-- Gunakan scaledY
                    clickCount: 1
                };

                // 4. Buat event mouse 'up' dengan koordinat yang sudah discalakan
                const mouseUpEvent = {
                    type: 'mouseUp',
                    button: 'left',
                    x: scaledX, // <-- Gunakan scaledX
                    y: scaledY, // <-- Gunakan scaledY
                    clickCount: 1
                };
                //------------------- ( end penyesuaian koordinat dengan zoomFactor ) -------------------------//
                //------------------- ( end penting: biar klik overlay gak meleset pas webview lagi zoom ) -------------------------//

                try {
                    // Kirim simulasi klik (down lalu up) LANGSUNG ke webview
                    webview.sendInputEvent(mouseDownEvent);

                    // Beri jeda sangat singkat agar OS bisa memprosesnya
                    await new Promise(resolve => setTimeout(resolve, 50));

                    webview.sendInputEvent(mouseUpEvent);

                    console.log('[Renderer] Klik virtual (down/up) berhasil dikirim ke webview.');

                } catch (err) {
                    console.error('[Renderer] Error saat execute sendInputEvent di webview:', err);
                }
            }
        });

        ipcRenderer.on('forwarded-player-control-action', (event, action) => {
            // Cek apakah action adalah string
            if (typeof action === 'string') {
                switch (action) {
                    case 'toggle-playlist-mode':
                        document.getElementById('playlist-toggle-btn').click();
                        break;
                    case 'play-pause':
                        // Cukup klik salah satu tombol saja (Expanded atau Collapsed sama saja logikanya)
                        // Kita gunakan play-pause-expanded karena itu yang utama
                        const playBtn = document.getElementById('play-pause-expanded') || document.getElementById('play-pause');
                        if (playBtn) playBtn.click();
                        break;
                    case 'next':
                        const nextBtn = document.getElementById('next-music-expanded') || document.getElementById('next-music');
                        if (nextBtn) nextBtn.click();
                        break;
                    case 'prev':
                        const prevBtn = document.getElementById('prev-music-expanded') || document.getElementById('prev-music');
                        if (prevBtn) prevBtn.click();
                        break;
                }
            } else if (typeof action === 'object' && action.type) {
                // Cek jika action adalah object (untuk volume / seek / playlist)
                switch (action.type) {
                    case 'set-volume':
                        // Langsung set ke main process, slider akan update via listener global-volume-changed
                        ipcRenderer.send('set-global-volume', action.value);
                        break;
                    case 'seek':
                        if (controlMode === 'local') {
                            if (!isNaN(audioElement.duration)) {
                                const newTime = action.percentage * audioElement.duration;
                                audioElement.currentTime = newTime;
                            }
                        } else if (controlMode === 'webview') {
                            if (webviewDuration > 0) {
                                const seekTime = action.percentage * webviewDuration;
                                webview.executeJavaScript(`window.playerAPI.seek(${seekTime})`);
                            }
                        }
                        break;
                    case 'play-from-playlist':
                        if (webviewActive && webviewIsPlaying) {
                            webview.executeJavaScript('window.playerAPI.playPause()');
                        }
                        controlMode = 'local';
                        currentSongIndex = action.index;
                        loadSong(currentSongIndex);
                        audioElement.play();
                        updatePlaylistHighlight();
                        updateMusicUI();
                        break;
                    case 'play-online-from-playlist':
                        if (latestOnlinePlaylistData && latestOnlinePlaylistData[action.index]) {
                            const songToPlay = latestOnlinePlaylistData[action.index];
                            playOnlineSongByTitle(songToPlay.title);
                        }
                        break;
                }
            }
        });

        // ================================ ( End Overlay Musik Player ) ================================ //


        // ================================ ( Online Music Webview ) ================================ //
        //------------------- ( elemen utama webview + overlay ) -------------------------//
        const overlay = document.getElementById('external-browser-container');
        const win = document.getElementById('webview-window');
        const titleBar = win.querySelector('.title-bar');
        const closeBtn = document.getElementById('close-webview');
        const webview = document.getElementById('external-webview');
        const loader = document.getElementById('webview-loader');
        const onlineIcons = document.querySelectorAll('.online-icon');

        const webviewForScroll = document.getElementById('external-webview');
        //------------------- ( end elemen utama webview + overlay ) -------------------------//

        //------------------- ( elemen UI player yang ikut dipakai mode online ) -------------------------//
        const nowPlayingText = document.getElementById('now-playing-text');
        const musicDisk = document.getElementById('music-disk');
        const progressBarExpanded = document.getElementById('progress-bar-expanded');

        let trackDuration = 0; // durasi track terakhir dari event track-changed
        //------------------- ( end elemen UI player yang ikut dipakai mode online ) -------------------------//

        //------------------- ( state internal webview: status & kontrol scroll ) -------------------------//
        let webviewActive = false;
        let onlineCurrentIndex = -1;
        let isScrolling = false;
        let skipAutoScroll = false;
        let shouldSkipScroll = false;
        let recheckTimeout = null;
        //------------------- ( end state internal webview: status & kontrol scroll ) -------------------------//

        //------------------- ( util kecil: delay buat loop scroll otomatis ) -------------------------//
        const sleep = ms => new Promise(res => setTimeout(res, ms));
        //------------------- ( end util kecil: delay buat loop scroll otomatis ) -------------------------//

        function showLoader() { loader.classList.remove('hidden'); }
        function hideLoader() { loader.classList.add('hidden'); }


        //------------------- ( indikator loading webview ) -------------------------//
        webview.addEventListener('did-start-loading', () => showLoader());
        webview.addEventListener('did-stop-loading', () => hideLoader());
        webview.addEventListener('did-fail-load', () => {
            hideLoader();
            showNotification('Gagal memuat halaman!', 'notification-error');
        });

        //------------------- ( scroll otomatis: biar playlist online ke-scan semua ) -------------------------//
        async function startWebviewScrollLoop() {
            if (isScrolling) return;
            isScrolling = true;

            const webview = document.getElementById('external-webview');
            // Selector menargetkan area scroll di kedua kemungkinan layout di yt music
            const selector = 'ytmusic-player-queue#queue, ytmusic-tab-renderer#tab-renderer.scroller';

            const scrollAmount = 450;
            const scrollDelay = 165;

            try {
                console.log('[Renderer] Memulai scroll ke BAWAH (versi lebih cepat)...');
                while (true) {
                    const scrollState = await webview.executeJavaScript(`
                    (() => {
                        const el = document.querySelector('${selector}');
                        return el ? { scrollTop: el.scrollTop, scrollHeight: el.scrollHeight, clientHeight: el.clientHeight } : null;
                    })();
                `);
                    if (!scrollState || (scrollState.scrollTop >= (scrollState.scrollHeight - scrollState.clientHeight - 1))) {
                        break;
                    }
                    await webview.executeJavaScript(`document.querySelector('${selector}').scrollBy(0, ${scrollAmount});`);
                    await sleep(scrollDelay);
                }
                console.log('[Renderer] Scroll ke bawah SELESAI.');
                await sleep(500);

                console.log('[Renderer] Memulai scroll ke ATAS...');
                while (true) {
                    const scrollState = await webview.executeJavaScript(`
                    (() => {
                        const el = document.querySelector('${selector}');
                        return el ? { scrollTop: el.scrollTop } : null;
                    })();
                `);
                    if (!scrollState || scrollState.scrollTop === 0) {
                        break;
                    }
                    await webview.executeJavaScript(`document.querySelector('${selector}').scrollBy(0, -${scrollAmount});`);
                    await sleep(scrollDelay);
                }
                console.log('[Renderer] Scroll ke atas SELESAI.');

            } catch (error) {
                console.error('[Renderer] Error saat scroll satu kali:', error);
            } finally {
                isScrolling = false;
                console.log('[Renderer] Prosedur scroll selesai, flag direset.');
            }
        }

        //------------------- ( end scroll otomatis: biar playlist online ke-scan semua ) -------------------------//

        closeBtn.addEventListener('click', () => {
            if (isScrolling) {
                console.log('[Renderer] Webview ditutup, menghentikan loop scroll.');
                isScrolling = false;
            }
            lastKnownOnlinePlaylistId = null;
            overlay.classList.add('hidden');
            updateMusicUI();
        });

        //------------------- ( cek ulang cover yang masih "setengah matang" ) -------------------------//

        function scheduleCoverRecheck() {
            clearTimeout(recheckTimeout);

            recheckTimeout = setTimeout(() => {
                const incompleteItems = document.querySelectorAll('#playlist li .incomplete-cover');
                if (incompleteItems.length > 0) {
                    // Kumpulkan judul lagu yang kovernya belum lengkap
                    const titlesToRescan = Array.from(incompleteItems).map(item => {
                        return item.getAttribute('data-title');
                    }).filter(Boolean); // Filter null/undefined titles

                    console.log(`[Cover Check] Meminta scan ulang untuk ${titlesToRescan.length} kover:`, titlesToRescan);

                    if (webviewActive && webview && titlesToRescan.length > 0) {
                        // Panggil API lagi di webview dengan daftar judul
                        webview.executeJavaScript(`window.playerAPI.rescanSpecificCovers(${JSON.stringify(titlesToRescan)})`).catch(err => {
                            console.error("Gagal meminta scan kover spesifik:", err);
                        });
                    }
                }
            }, 3000);
        }

        //------------------- ( end cek ulang cover yang masih "setengah matang" ) -------------------------//

        //------------------- ( inject Dynamic Theme ke YT Music ) -------------------------//
        function injectDynamicTheme(webview, themeMode = 'default') {
            console.log('[DynamicTheme] Attempting to inject...');
            try {
                if (themeMode === 'unified') themeMode = 'overlay';
                const vibrantPath = path.join(__dirname, 'aset/js/vibrant.min.js');
                const stylingPath = path.join(__dirname, 'aset/js/dynamic-ytm-styling.js');

                console.log('[DynamicTheme] Vibrant Path:', vibrantPath);
                console.log('[DynamicTheme] Styling Path:', stylingPath);

                if (fs.existsSync(vibrantPath) && fs.existsSync(stylingPath)) {
                    const vibrantCode = fs.readFileSync(vibrantPath, 'utf-8');
                    const stylingCode = fs.readFileSync(stylingPath, 'utf-8');

                    // Wrap styling code to catch errors
                    const wrappedStylingCode = `
                window.DYNAMIC_THEME_MODE = '${themeMode}';
                try {
                    ${stylingCode}
                } catch (e) {
                    console.error("[DynamicTheme Internal Error]", e);
                    throw e;
                }
            `;

                    // If already injected, don't inject again (this breaks flexible toggling).
                    // Just switch mode / enable on demand.
                    webview.executeJavaScript(`
                (function(){
                    try {
                        const already = (window.__gapDynamicThemeLoaded === true) ||
                            (typeof window.enableDynamicTheme === 'function') ||
                            (typeof window.updateThemeMode === 'function') ||
                            (document.getElementById('ts-base-styles') != null);
                        return already;
                    } catch (e) {
                        return false;
                    }
                })();
            `).then((alreadyInjected) => {
                        if (alreadyInjected) {
                            console.log('[DynamicTheme] Already injected; skipping script injection.');
                            // Ensure desired mode is applied.
                            return webview.executeJavaScript(`
                        try {
                            if (typeof window.enableDynamicTheme === 'function') {
                                window.enableDynamicTheme('${themeMode}');
                            } else if (typeof window.updateThemeMode === 'function') {
                                window.updateThemeMode('${themeMode}');
                            }
                            true;
                        } catch (e) {
                            console.error('[DynamicTheme] Failed to apply mode after skip:', e);
                            false;
                        }
                    `);
                        }

                        return webview.executeJavaScript(vibrantCode)
                            .then(() => {
                                console.log('[DynamicTheme] Vibrant.js injected successfully.');
                                // Ensure Vibrant is available globally
                                return webview.executeJavaScript(`
                            if (typeof Vibrant === 'undefined') {
                                console.error('[DynamicTheme] Vibrant is undefined after injection!');
                                // Try to recover if it was assigned to module.exports (unlikely but possible)
                                if (typeof module !== 'undefined' && module.exports && module.exports.Vibrant) {
                                    window.Vibrant = module.exports.Vibrant;
                                    console.log('[DynamicTheme] Recovered Vibrant from module.exports');
                                }
                            }
                        `);
                            })
                            .then(() => webview.executeJavaScript(wrappedStylingCode))
                            .then(() => console.log('[DynamicTheme] Dynamic Theme Injected'));
                    }).catch(err => console.error('[DynamicTheme] Failed to inject Dynamic Theme:', err));
                } else {
                    console.warn("[DynamicTheme] Dynamic Theme files not found");
                }
            } catch (e) {
                console.error("[DynamicTheme] Error reading Dynamic Theme files:", e);
            }
        }

        //------------------- ( end inject Dynamic Theme ke YT Music ) -------------------------//

        //------------------- ( lifecycle webview: dom-ready ) -------------------------//
        webview.addEventListener('dom-ready', async () => {
            webview.setZoomFactor(0.85);
            applyWebviewScrollbarMode();

            webviewActive = true;
            controlMode = 'webview';

            // --- Ambil setting yang paling valid (prioritas: main process / remembered settings) ---
            let loadedSettings = null;
            try {
                loadedSettings = await ipcRenderer.invoke('load-settings');
            } catch (e) {
                loadedSettings = null;
            }

            const adSkipperSetting = (loadedSettings && loadedSettings.adSkipperEnabled !== undefined)
                ? loadedSettings.adSkipperEnabled === true
                : (enableAdSkipperCheckbox ? enableAdSkipperCheckbox.checked : false);

            const autoMuteSetting = (loadedSettings && loadedSettings.autoMuteAds !== undefined)
                ? loadedSettings.autoMuteAds === true
                : (document.getElementById('auto-mute-ads-checkbox') ? document.getElementById('auto-mute-ads-checkbox').checked : false);

            const autoSkipSetting = (loadedSettings && loadedSettings.autoSkipAds !== undefined)
                ? loadedSettings.autoSkipAds === true
                : (document.getElementById('auto-skip-ads-checkbox') ? document.getElementById('auto-skip-ads-checkbox').checked : false);
            const dynamicThemeSetting = enableDynamicThemeCheckbox ? enableDynamicThemeCheckbox.checked : false;

            console.log('[Webview DOM-Ready] Fired.');
            console.log('[Webview DOM-Ready] Dynamic Theme Setting:', dynamicThemeSetting);

            // Kirim paket lengkap
            webview.send('setting-update', {
                adSkipperEnabled: adSkipperSetting,
                autoMuteAds: autoMuteSetting,
                autoSkipAds: autoSkipSetting
            });

            // terapkan Dynamic styling/theme ke webview
            if (dynamicThemeSetting) {
                applyDynamicThemeState();
            } else {
                console.log('[Webview DOM-Ready] Dynamic Theme is disabled, skipping injection.');
                applyDynamicThemeState();
            }

            audioElement.pause();
            skipAutoScroll = false;

            webview.executeJavaScript('window.playerAPI.requestMetadata()');
            webview.executeJavaScript('window.playerAPI.scanPlaylist()');
        });

        //------------------- ( end lifecycle webview: dom-ready ) -------------------------//

        //------------------- ( penting: anti race condition buat Dynamic Theme ) -------------------------//
        // Kadang dom-ready/did-finish-load suka beda timing pas reload, jadi kita sediain beberapa "titik cadangan".
        webview.addEventListener('did-start-loading', () => {
            console.log('[Webview] did-start-loading fired.');
        });

        webview.addEventListener('did-stop-loading', () => {
            console.log('[Webview] did-stop-loading fired.');
            // Titik injeksi cadangan kalau-kalau yang utama kelewat
            const dynamicThemeSetting = enableDynamicThemeCheckbox ? enableDynamicThemeCheckbox.checked : false;
            if (dynamicThemeSetting) {
                console.log('[Webview did-stop-loading] Checking/Injecting Dynamic Theme...');
                applyDynamicThemeState();
            }
        });

        webview.addEventListener('did-fail-load', (e) => {
            console.error('[Webview] did-fail-load fired.', e);
        });

        webview.addEventListener('console-message', (e) => {
            // Saring log kalau perlu, atau cetak semuanya saja
            // console.log('[Webview Console]', e.message);
            // Cuma log error atau pesan tertentu aja biar gak berantakan
            if (e.level === 2 || e.message.includes('Error')) {
                console.error('[Webview Console Error]', e.message, 'Line:', e.line, 'Source:', e.sourceId);
            }
        });

        webview.addEventListener('did-finish-load', () => {
            console.log('Webview did-finish-load, menerapkan ulang mode scrollbar.');
            sendScrollbarModeToWebview(webviewResizeMode);

            // Injeksi cadangan kalau dom-ready kelewat (misalnya pas di-reload)
            const dynamicThemeSetting = enableDynamicThemeCheckbox ? enableDynamicThemeCheckbox.checked : false;
            if (dynamicThemeSetting) {
                console.log('[Webview did-finish-load] Checking/Injecting Dynamic Theme...');
                // Kita panggil injeksi lagi aja, executeJavaScript biasanya aman kok dipanggil berkali-kali, 
                // tapi idealnya script-nya harus bisa nanganin re-injeksi sendiri sih.
                // Buat sekarang, kita andalin dom-ready dulu, ini cuma buat jaga-jaga aja.
                applyDynamicThemeState();
            }
        });

        // Panggil lagi jika pengguna bernavigasi ke halaman LAIN di dalam webview
        webview.addEventListener('did-navigate', () => {
            console.log('Webview did-navigate, menerapkan ulang mode scrollbar.');
            sendScrollbarModeToWebview(webviewResizeMode);
        });

        //------------------- ( end penting: anti race condition buat Dynamic Theme ) -------------------------//

        //------------------- ( IPC dari preload webview ) -------------------------//
        webview.addEventListener('ipc-message', async (e) => {
            // console.log("Pesan dari webview:", e.channel, e.args);

            if (e.channel === 'analyser-data') {
                const { isPlaying, data } = e.args[0];
                // console.log('[Main App] MENERIMA data analyser:', data.slice(0, 5));
                if (data && data.length > 0) {
                    webviewAnalyserData = new Uint8Array(data);
                }
            }

            if (e.channel === 'online-playlist-update') {
                const { playlistId, songs, currentIndex } = e.args[0];

                latestOnlinePlaylistData = songs;
                onlineCurrentIndex = currentIndex;
                if (activePlaylistSource === 'online') {
                    renderOnlinePlaylist(songs);
                }

                // Ini Flag Utama buat nyari tau apakah playlist di yt Musc masih sama atau engga.
                if (playlistId && playlistId !== lastKnownOnlinePlaylistId && !isManuallySwitchingSong) {
                    console.log(`[Playlist Refresh & Scroll] Playlist baru terdeteksi. ID: "${playlistId}". Menjalankan scroll otomatis.`);
                    lastKnownOnlinePlaylistId = playlistId;

                    if (!isScrolling) {
                        await startWebviewScrollLoop();
                    }

                    setTimeout(() => {
                        console.log("[Playlist Refresh] Memulai refresh: Beralih ke Lokal -> Online.");
                        switchToLocalView();
                        setTimeout(() => {
                            switchToOnlineView();
                            console.log("[Playlist Refresh] Proses refresh selesai.");
                        }, 65);
                    }, 3800);
                }

                latestOnlinePlaylistData = songs;
                onlineCurrentIndex = currentIndex;

                if (activePlaylistSource === 'online') {
                    renderOnlinePlaylist(songs);
                }
            }

            if (e.channel === 'specific-covers-updated') {
                const updatedCovers = e.args[0];
                console.log('[Cover Update] Menerima update kover spesifik:', updatedCovers);

                Object.keys(updatedCovers).forEach(title => {
                    const newCoverUrl = updatedCovers[title];
                    // Cari elemen <li> yang sesuai berdasarkan data-title
                    const itemElement = document.querySelector(`.online-playlist-item[data-title="${CSS.escape(title)}"]`);

                    if (itemElement) {
                        const imgElement = itemElement.querySelector('img');
                        if (imgElement && newCoverUrl) {
                            imgElement.src = newCoverUrl; // Langsung perbarui src gambar
                            itemElement.classList.remove('incomplete-cover'); // Hapus class penanda
                        }
                    }
                });

                // Setelah update, cek lagi apakah masih ada yang belum lengkap untuk dijadwalkan ulang
                const remainingIncomplete = document.querySelectorAll('#playlist li .incomplete-cover').length;
                if (remainingIncomplete > 0) {
                    console.log(`[Cover Check] Masih ada ${remainingIncomplete} kover yang belum termuat. Menjadwalkan pengecekan ulang.`);
                    scheduleCoverRecheck();
                } else {
                    console.log('[Cover Check] Semua kover berhasil diperbarui.');
                    clearTimeout(recheckTimeout); // Hentikan timer jika semua sudah lengkap
                }
            }

            if (e.channel === 'track-changed') {
                const { title, thumbnail, duration, artist } = e.args[0];
                webviewArtist = artist || '';
                lastWebviewState = e.args[0];
                latestWebviewTitle = title;

                // Discord rpc
                ipcRenderer.send('update-rpc-activity', {
                    songTitle: title,
                    songArtist: artist,
                    smallImageKey: 'play_icon',
                    smallImageText: 'Sedang Memutar (Online)'
                });

                // --- Update judul collapsed ---
                const musicTitleElement = document.getElementById('music-title');
                if (musicTitleElement) {
                    musicTitleElement.textContent = `Now Playing: ${title}`;
                }

                // --- Update judul expanded ---
                const nowPlayingSongTextElement = document.getElementById('now-playing-song');
                if (nowPlayingSongTextElement) {
                    nowPlayingSongTextElement.textContent = truncateMusicTitle(title);
                }

                // --- Update cover disk ---
                const musicDiskElement = document.getElementById('music-disk');
                if (musicDiskElement) {
                    musicDiskElement.src = thumbnail;
                }

                // Simpan durasi untuk nanti (misal digunakan di seek)
                trackDuration = duration;
                webview.executeJavaScript('window.playerAPI.requestMetadata()');

                // Refresh UI (tombol play/pause, animasi disk, dsb.)
                updateMusicUI();
            }

            if (e.channel === 'playback-update') {
                if (controlMode !== 'webview') return; // Jika bukan mode webview, abaikan pesan ini

                const { isPlaying, currentTime, duration, progressPercent, timeText, title, thumbnail, artist } = e.args[0];
                latestWebviewTitle = title;
                webviewArtist = artist || '';

                // Discord rpc
                ipcRenderer.send('update-rpc-activity', {
                    songTitle: title,
                    songArtist: artist,
                    smallImageKey: isPlaying ? 'play_icon' : 'pause_icon',
                    smallImageText: isPlaying ? 'Memutar (Online)' : 'Dijeda (Online)'
                });

                // simpan state
                webviewIsPlaying = isPlaying;
                webviewCurrentTime = currentTime;
                webviewDuration = duration;
                webviewProgressPercent = progressPercent;

                // console.log(`Playback update - playing:${isPlaying}, time:${currentTime}/${duration}, progress:${progressPercent}%, text:${timeText}`);
                broadcastFullPlayerState();

                // --- Collapsed UI updates ---
                const currentTimeCollapsed = document.getElementById('current-time');
                const durationCollapsed = document.getElementById('duration');
                const progressBarCollapsed = document.getElementById('progress-bar');

                if (currentTimeCollapsed) currentTimeCollapsed.textContent = timeText.split(' / ')[0];
                if (durationCollapsed) durationCollapsed.textContent = timeText.split(' / ')[1];
                if (progressBarCollapsed) progressBarCollapsed.style.width = `${progressPercent}%`;

                // --- Expanded UI updates ---
                const currentTimeExpanded = document.getElementById('current-time-expanded');
                const durationExpanded = document.getElementById('duration-expanded');
                const progressBarExpanded = document.getElementById('progress-bar-expanded');

                if (currentTimeExpanded) currentTimeExpanded.textContent = timeText.split(' / ')[0];
                if (durationExpanded) durationExpanded.textContent = timeText.split(' / ')[1];
                if (progressBarExpanded) progressBarExpanded.style.width = `${progressPercent}%`;

                if (webviewIsPlaying && controlMode === 'webview' && !audioElement.paused) {
                    console.log('Webview is playing, pausing local audio.');
                    audioElement.pause();
                }

                // Update icon/tombol dan animasi disk sesuai state play/pause
                updateMusicUI();
                broadcastPlayerState();
            }

            if (e.channel === 'playback-update') {
                const { isPlaying, currentTime, duration, progressPercent, timeText, title, thumbnail, artist } = e.args[0];
                webviewArtist = artist || '';

                // simpan state
                webviewIsPlaying = isPlaying;
                webviewCurrentTime = currentTime;
                webviewDuration = duration;
                webviewProgressPercent = progressPercent;

                // console.log(`Playback update - playing:${isPlaying}, time:${currentTime}/${duration}, progress:${progressPercent}%, text:${timeText}`);
                broadcastFullPlayerState();

                // --- Collapsed UI updates ---
                const currentTimeCollapsed = document.getElementById('current-time');
                const durationCollapsed = document.getElementById('duration');
                const progressBarCollapsed = document.getElementById('progress-bar');

                if (currentTimeCollapsed) currentTimeCollapsed.textContent = timeText.split(' / ')[0];
                if (durationCollapsed) durationCollapsed.textContent = timeText.split(' / ')[1];
                if (progressBarCollapsed) progressBarCollapsed.style.width = `${progressPercent}%`;

                // --- Expanded UI updates ---
                const currentTimeExpanded = document.getElementById('current-time-expanded');
                const durationExpanded = document.getElementById('duration-expanded');
                const progressBarExpanded = document.getElementById('progress-bar-expanded');

                if (currentTimeExpanded) currentTimeExpanded.textContent = timeText.split(' / ')[0];
                if (durationExpanded) durationExpanded.textContent = timeText.split(' / ')[1];
                if (progressBarExpanded) progressBarExpanded.style.width = `${progressPercent}%`;

                if (webviewIsPlaying && controlMode === 'webview' && !audioElement.paused) {
                    console.log('Webview is playing, pausing local audio.');
                    audioElement.pause();
                }

                // Update icon/tombol dan animasi disk sesuai state play/pause
                updateMusicUI();
                broadcastPlayerState();
            }

            if (e.channel === 'play-state') {
                const { playing } = e.args[0];
                webviewIsPlaying = playing;
                updateMusicUI();
            }

            if (webviewIsPlaying && controlMode === 'webview' && !audioElement.paused) {
                console.log('Webview play-state is true, pausing local audio.');
                audioElement.pause();
            }
        });

        //------------------- ( end IPC dari preload webview ) -------------------------//

        //------------------- ( render playlist online ke UI app ) -------------------------//
        function renderOnlinePlaylist(songsData = []) {
            const existingItems = playlistElement.querySelectorAll('.online-playlist-item');
            const oldThumbnails = new Map();
            existingItems.forEach(item => {
                const titleEl = item.querySelector('.title');
                const thumbEl = item.querySelector('img');
                if (titleEl && thumbEl && thumbEl.src && !thumbEl.src.includes('base64') && !thumbEl.src.includes('gstatic')) {
                    oldThumbnails.set(titleEl.title, thumbEl.src);
                }
            });

            playlistElement.innerHTML = '';

            if (!songsData || songsData.length === 0) {
                playlistElement.innerHTML = `
                <li style="text-align: center; color: #888; cursor: default; padding: 20px 0;">
                    Memuat playlist online...<br>Buka webview untuk memuat playlist online.
                </li>
            `;
                return;
            }

            // Hitung item yang tidak lengkap
            let incompleteCount = 0;

            songsData.forEach((song, index) => {
                const li = document.createElement('li');
                li.style.padding = '5px 0';
                li.style.cursor = 'pointer';

                const preservedThumbnailSrc = oldThumbnails.get(song.title) || song.thumbnail;

                // Periksa apakah kover tidak lengkap
                const isCoverIncomplete = !preservedThumbnailSrc || preservedThumbnailSrc.includes('gstatic') || preservedThumbnailSrc.endsWith('/aset/musik.png');
                if (isCoverIncomplete) {
                    incompleteCount++;
                }

                li.innerHTML = `
                <div class="online-playlist-item ${isCoverIncomplete ? 'incomplete-cover' : ''}" style="display: flex; align-items: center; gap: 15px;" data-title="${song.title}">
                    <img src="${preservedThumbnailSrc}" onerror="this.onerror=null;this.src='./aset/musik.png';" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;">
                    <div class="song-info" style="flex-grow: 1; display: flex; flex-direction: column; text-align: left; overflow: hidden;">
                        <span class="title" style="color: white; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${song.title}">${song.title}</span>
                        <span class="artist" style="color: #aaa; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${song.artist}</span>
                    </div>
                    <span class="duration" style="color: #aaa; font-size: 0.9rem; padding-left: 10px;">${song.duration}</span>
                </div>
            `;

                li.addEventListener('mouseenter', () => li.style.backgroundColor = 'rgba(0, 255, 255, 0.1)');
                li.addEventListener('mouseleave', () => li.style.backgroundColor = 'transparent');

                li.addEventListener('click', () => {
                    playOnlineSongByTitle(song.title);
                });

                playlistElement.appendChild(li);
            });

            // Catat jumlah item tidak lengkap dan jadwalkan pengecekan ulang jika perlu
            if (incompleteCount > 0) {
                console.log(`[Cover Check] Ditemukan ${incompleteCount} lagu dengan informasi kover tidak lengkap.`);
                scheduleCoverRecheck();
            } else {
                console.log('[Cover Check] Semua kover musik berhasil dimuat dengan lengkap.');
                clearTimeout(recheckTimeout); // Hentikan timer jika semua sudah lengkap
            }
        }

        //------------------- ( end render playlist online ke UI app ) -------------------------//

        if (webviewForScroll) {
            webviewForScroll.addEventListener('ipc-message', async (event) => {
                if (event.channel === 'online-playlist-update'
                    && activePlaylistSource === 'online'
                    && !isScrolling
                    && !shouldSkipScroll
                ) {
                    console.log('[Renderer] Playlist updated  scroll.');
                    await startWebviewScrollLoop();
                }
                if (event.channel === 'special-element-found') {
                    console.log('[Renderer] Elemen pemicu scroll ditemukan. Menunggu update playlist untuk memulai scroll.');
                }

                if (event.channel === 'online-playlist-update') {
                    const { songs, currentIndex } = event.args[0];
                    const payload = event.args[0];
                    if (payload && payload.songs) {
                        onlinePlaylistData = payload.songs; // Simpan data terbaru

                        if (activePlaylistSource === 'online') {
                            renderOnlinePlaylist(onlinePlaylistData);
                        }
                    }
                    latestOnlinePlaylistData = songs;
                    onlineCurrentIndex = currentIndex;

                    if (activePlaylistSource === 'online' && !isScrolling && !skipAutoScroll) {
                        console.log('[Renderer] Playlist diperbarui. Menampilkan overlay...');
                        webviewForScroll.send('show-loading-overlay');

                        console.log('[Renderer] Memulai dan menunggu proses scroll...');
                        await startWebviewScrollLoop();

                        console.log('[Renderer] Proses scroll telah selesai. Menyembunyikan overlay.');
                        webviewForScroll.send('hide-loading-overlay');
                    }
                }
            });
        }

        //------------------- ( buka webview + pastiin mode online ke-sync ) -------------------------//
        async function openExternalWebview(url) {
            if (!window.internetConnectionAllowed) {
                showNotification("Connect to Internet dulu dimenu Option -> Network!", 'notification-warning');
                return;
            }

            // Cek apakah webview sudah aktif dan memuat URL yang sama
            const isAlreadyLoaded = webviewActive && webview.src && webview.src.startsWith(url);

            // Tetap atur mode dan UI utama karena kita akan menampilkan webview
            controlMode = 'webview';
            webviewActive = true;
            loadSong(); // Memperbarui UI utama ke mode 'Online'
            updateMusicUI(); // Memastikan tombol play/pause sesuai

            // Selalu tampilkan container webview
            overlay.classList.remove('hidden');
            webview.focus();

            // Jika sudah dimuat, tidak perlu melakukan apa-apa lagi.
            if (isAlreadyLoaded) {
                console.log('[Webview] Konten sudah dimuat. Hanya menampilkan kembali tanpa reload.');
                // Beralih ke tampilan playlist online jika belum
                if (activePlaylistSource !== 'online') {
                    switchToOnlineView(true);
                }
                return;
            }

            console.log('[Webview] Memuat URL baru atau pertama kali:', url);
            webview.src = url;

            // Panggil switchToOnlineView untuk memastikan UI playlist konsisten
            switchToOnlineView(false); // Lakukan burst refresh karena ini pemuatan baru
        }

        //------------------- ( end buka webview + pastiin mode online ke-sync ) -------------------------//

        //------------------- ( tombol close webview ) -------------------------//
        closeBtn.addEventListener('click', () => {
            if (overlay.classList.contains('hidden')) {
                console.log("Webview already hidden.");
                return;
            }

            overlay.classList.add('hidden');
            updateMusicUI();
        });

        //------------------- ( end tombol close webview ) -------------------------//

        //------------------- ( toggle DevTools webview ) -------------------------//
        const openWebviewDevToolsBtn = document.getElementById('openWebviewDevTools');

        if (webview && openWebviewDevToolsBtn) {
            // Event listener saat webview siap (DOM dimuat)
            webview.addEventListener('dom-ready', () => {
                console.log('Webview DOM is ready.');
            });

            // listener tombol "Toggle Webview DevTools"
            openWebviewDevToolsBtn.addEventListener('click', () => {
                if (webview.isDevToolsOpened()) {
                    webview.closeDevTools();
                    console.log('Webview DevTools closed.');
                } else {
                    webview.openDevTools();
                    console.log('Webview DevTools opened.');
                }
            });
        } else {
            console.warn('Webview element or DevTools button not found!');
        }

        //------------------- ( end toggle DevTools webview ) -------------------------//

        //------------------- ( drag window webview ) -------------------------//
        let isDragging = false, offsetX = 0, offsetY = 0;

        // Fungsi-fungsi ini didefinisikan di luar agar bisa ditambah/dihapus
        function onDragMouseMove(e) {
            if (!isDragging) return;
            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;

            // Batasi pergerakan
            x = Math.max(0, Math.min(x, window.innerWidth - win.offsetWidth));
            y = Math.max(0, Math.min(y, window.innerHeight - win.offsetHeight));

            win.style.left = x + 'px';
            win.style.top = y + 'px';
        }

        function onDragMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onDragMouseMove);
            document.removeEventListener('mouseup', onDragMouseUp);
        }

        titleBar.addEventListener('mousedown', e => {
            isDragging = true;

            const rect = win.getBoundingClientRect();

            win.style.transform = 'none';
            win.style.top = `${rect.top}px`;
            win.style.left = `${rect.left}px`;
            win.style.right = 'auto';
            win.style.bottom = 'auto';

            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;

            document.addEventListener('mousemove', onDragMouseMove);
            document.addEventListener('mouseup', onDragMouseUp);
        });

        //------------------- ( end drag window webview ) -------------------------//

        //------------------- ( preset mode: desktop vs smartphone ) -------------------------//
        const webviewWindow = document.getElementById('webview-window');
        const presetNormalBtn = document.getElementById('preset-normal');
        const presetVerticalBtn = document.getElementById('preset-vertical');
        let webviewResizeMode = 'normal';

        function sendScrollbarModeToWebview(mode) {
            if (webview && webview.getWebContentsId()) {
                console.log(`[Index] Mengirim mode scrollbar '${mode}' ke webview.`);
                webview.send('set-scrollbar-mode', { mode: mode });
            } else {
                console.log('[Index] Webview belum siap, pesan mode scrollbar ditunda.');
            }
        }

        // Set batas minimal biar gak kekecilan
        webviewWindow.style.minWidth = '800px';
        webviewWindow.style.minHeight = '600px';

        //------------------- ( manajemen CSS scrollbar di dalam webview ) -------------------------//
        const verticalScrollbarCSS = "html::-webkit-scrollbar, body::-webkit-scrollbar, *::-webkit-scrollbar { display: none !important; }";
        let injectedCSSKey = null;

        // Fungsi helper untuk menerapkan/menghapus CSS (dipanggil saat dom-ready & saat ganti preset)
        async function applyWebviewScrollbarMode() {
            // memastikan webview sudah dimuat dan siap
            if (!webview || !webview.getWebContentsId()) return;

            try {
                if (webviewResizeMode === 'vertical') {
                    // Mode Vertikal: Hapus dulu (jika ada) lalu suntikkan yang baru.
                    // Ini untuk mencegah duplikasi jika ada error
                    if (injectedCSSKey) {
                        await webview.removeInsertedCSS(injectedCSSKey);
                    }
                    injectedCSSKey = await webview.insertCSS(verticalScrollbarCSS);
                    console.log('CSS Scrollbar Vertikal Diterapkan.');
                } else {
                    // Mode Normal: Hapus jika ada.
                    if (injectedCSSKey) {
                        await webview.removeInsertedCSS(injectedCSSKey);
                        injectedCSSKey = null;
                        console.log('CSS Scrollbar Vertikal Dihapus.');
                    }
                }
            } catch (err) {
                console.error('Gagal memanipulasi CSS webview:', err);
                // Reset key jika gagal
                injectedCSSKey = null;
            }
        }
        //------------------- ( end manajemen CSS scrollbar di dalam webview ) -------------------------//

        if (presetNormalBtn && presetVerticalBtn && webviewWindow) {
            presetNormalBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Hentikan event agar tidak ter-trigger drag
                webviewResizeMode = 'normal';

                // Kembalikan ke style default (top-right)
                webviewWindow.style.width = '1250px';
                webviewWindow.style.height = '73%';
                webviewWindow.style.top = '10px';
                webviewWindow.style.right = '10px';
                webviewWindow.style.left = 'auto';
                webviewWindow.style.transform = 'none';
                webviewWindow.style.minWidth = '800px';
                webviewWindow.style.minHeight = '600px';

                presetNormalBtn.classList.add('active');
                presetVerticalBtn.classList.remove('active');

                sendScrollbarModeToWebview('normal'); //(kirim pesan)
            });

            presetVerticalBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Hentikan event agar tidak ter-trigger drag
                webviewResizeMode = 'vertical';

                webviewWindow.style.width = '400px';  // Lebar smartphone
                webviewWindow.style.height = '750px'; // Tinggi smartphone
                webviewWindow.style.top = '50%';
                webviewWindow.style.left = '50%';
                webviewWindow.style.right = 'auto';
                webviewWindow.style.transform = 'translate(-50%, -50%)';
                webviewWindow.style.minWidth = '320px';
                webviewWindow.style.minHeight = '500px';

                presetVerticalBtn.classList.add('active');
                presetNormalBtn.classList.remove('active');

                sendScrollbarModeToWebview('vertical'); //(kirim pesan)
            });
        }

        //------------------- ( end preset mode: desktop vs smartphone ) -------------------------//

        //------------------- ( resize window webview ) -------------------------//
        const webviewResizer = webviewWindow.querySelector('.resizer-se');
        let isResizingWebview = false;
        let startWebviewWidth, startWebviewHeight, startWebviewX, startWebviewY;

        if (webviewResizer) {
            webviewResizer.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Mencegah event lain seperti text selection
                e.stopPropagation(); // (Hentikan agar tidak memicu drag title bar)

                isResizingWebview = true;

                // Dapatkan ukuran pixel saat ini
                startWebviewWidth = webviewWindow.offsetWidth;
                startWebviewHeight = webviewWindow.offsetHeight;
                startWebviewX = e.clientX;
                startWebviewY = e.clientY;

                // Tambahkan listener global
                document.addEventListener('mousemove', onWebviewResizeMove);
                document.addEventListener('mouseup', onWebviewResizeUp);
            });
        }

        function onWebviewResizeMove(e) {
            if (!isResizingWebview) return;

            let newWidth;
            let newHeight;

            // (Logika berdasarkan mode)
            if (webviewResizeMode === 'normal') {
                // Mode normal: Resize bebas dengan batasan minimal
                newWidth = startWebviewWidth + (e.clientX - startWebviewX);
                newHeight = startWebviewHeight + (e.clientY - startWebviewY);

                newWidth = Math.max(800, newWidth); // Min width 800px
                newHeight = Math.max(600, newHeight); // Min height 600px

            } else if (webviewResizeMode === 'vertical') {
                // Mode vertikal ( smartphone )
                const deltaX = e.clientX - startWebviewX;
                const deltaY = e.clientY - startWebviewY;

                // Dapatkan aspect ratio saat drag dimulai (misal: 400 / 750 = 0.53)
                const aspectRatio = startWebviewWidth / startWebviewHeight;

                // Tentukan sumbu utama (perubahan X atau Y yang lebih besar)
                // Ini menentukan apakah ukuran baru dihitung berdasarkan pergeseran mouse horizontal atau vertikal
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    // Perubahan Lebar (X) lebih dominan
                    newWidth = startWebviewWidth + deltaX;
                    newHeight = newWidth / aspectRatio; // Hitung tinggi berdasarkan lebar
                } else {
                    // Perubahan Tinggi (Y) lebih dominan
                    newHeight = startWebviewHeight + deltaY;
                    newWidth = newHeight * aspectRatio; // Hitung lebar berdasarkan tinggi
                }

                // Terapkan batasan minimal, *setelah* rasio dihitung
                if (newWidth < 320) {
                    newWidth = 320;
                    newHeight = newWidth / aspectRatio;
                }
                if (newHeight < 500) {
                    newHeight = 500;
                    newWidth = newHeight * aspectRatio;
                }
            }

            // Terapkan ukuran baru dalam pixel
            webviewWindow.style.width = `${newWidth}px`;
            webviewWindow.style.height = `${newHeight}px`;
            // (Ini otomatis menghapus 'height: 73%' dari mode normal)
        }

        function onWebviewResizeUp() {
            isResizingWebview = false;
            // Hapus listener global
            document.removeEventListener('mousemove', onWebviewResizeMove);
            document.removeEventListener('mouseup', onWebviewResizeUp);
        }

        //------------------- ( end resize window webview ) -------------------------//

        //------------------- ( klik ikon musik online ) -------------------------//
        onlineIcons.forEach(icon => {
            icon.addEventListener('click', () => {
                const url = icon.getAttribute('data-url');
                if (url) openExternalWebview(url);
            });
        });

        //------------------- ( end klik ikon musik online ) -------------------------//

        // ================================ ( End Online Music Webview ) ================================ //


        // ================================ ( Title Screen: Animasi & Alur Screen ) ================================ //
        //------------------- ( animasi judul + teks muter ) -------------------------//
        function startTitleScreenAnimation() {
            const titleH1 = document.querySelectorAll("#title-screen h1 span");
            titleH1.forEach((letter, index) => {
                letter.style.animationDelay = `${index * 0.2}s`;
            });
            const titleH3 = document.querySelector("#title-screen h3");
            setTimeout(() => {
                titleH3.style.animationPlayState = "running";
            }, titleH1.length * 200 + 2000);
            startRotatingText();
        }

        //------------------- ( end animasi judul + teks muter ) -------------------------//

        let currentScreen = 0;
        let skipScene = false;
        let timeoutId;

        ipcRenderer.on('configure-scene', (event, config) => {
            skipScene = config.skipScene;
            console.log("Skip Scene:", skipScene);

            if (skipScene && timeoutId) {
                clearTimeout(timeoutId);
                console.log("Timeout dibatalkan karena opsi skip scene diaktifkan.");
            }
            const savedSettings = config.settings;
            if (savedSettings && enableVideoWallpaperCheckbox && enableOverlayCheckbox) {
                const videoEnabled = savedSettings.videoWallpaperEnabled ?? true;

                enableVideoWallpaperCheckbox.checked = videoEnabled;
                applyVideoWallpaperState(videoEnabled);

                const overlayEnabled = savedSettings.overlayEnabled ?? false;
                enableOverlayCheckbox.checked = overlayEnabled;
                ipcRenderer.send('set-overlay-feature', overlayEnabled);

                const dynamicThemeEnabled = savedSettings.dynamicThemeEnabled ?? false;
                if (enableDynamicThemeCheckbox) {
                    enableDynamicThemeCheckbox.checked = dynamicThemeEnabled;
                }
            }
        });

        ipcRenderer.on('window-minimized', () => {
            console.log('Renderer received: window-minimized');
            if (!isWallpaperPaused) {
                wallpaperVideo.pause();
                pauseWallpaperButton.textContent = "";
            }
        });

        ipcRenderer.on('window-restored', () => {
            console.log('Renderer received: window-restored');
            // Hanya resume jika tidak dipause manual DAN fitur wallpaper aktif
            if (!isManuallyPaused && enableVideoWallpaperCheckbox.checked) {
                wallpaperVideo.play();
                pauseWallpaperButton.textContent = "";
            }
        });

        const audio = document.getElementById("background-audio");
        timeoutId = null; // Diatur ulang nanti setelah klik warning screen

        function showNextScreen() {
            if (currentScreen < screens.length) {
                screens[currentScreen].style.animation = "fadeOut 1s forwards";
                setTimeout(() => {
                    screens[currentScreen].style.display = "none";
                    if (currentScreen === 3) hideBackgroundVideo();
                    currentScreen++;
                    if (currentScreen < screens.length) {
                        screens[currentScreen].style.display = "flex";
                        screens[currentScreen].style.animation = "fadeIn 1s forwards";
                        if (currentScreen === 3) {
                            startTitleScreenAnimation();
                            setTimeout(showBackgroundVideo, 4000);
                        }
                    }
                }, 1000);
            }
        }

        //------------------- ( rotating text di title-screen ) -------------------------//
        let rotatingTexts = [
            "sentence 1",
            "sentence 2",
            "sentence 3",
            "sentence 4",
            "sentence 5"
        ];

        let currentTextIndex = 0;
        function startRotatingText() {
            const rotatingTextElement = document.getElementById("rotating-text");

            setTimeout(() => {
                if (rotatingTexts.length === 0) {
                    rotatingTextElement.textContent = "";
                    return;
                }
                rotatingTextElement.textContent = rotatingTexts[currentTextIndex];

                rotatingTextElement.classList.add("cycling");

                rotatingTextElement.addEventListener('animationiteration', () => {
                    if (rotatingTexts.length === 0) return;
                    currentTextIndex = (currentTextIndex + 1) % rotatingTexts.length;
                    rotatingTextElement.textContent = rotatingTexts[currentTextIndex];
                    console.log("Teks diganti pada animationiteration menjadi:", rotatingTexts[currentTextIndex]);
                });

            }, 8000);
        }

        //------------------- ( end rotating text di title-screen ) -------------------------//

        function showBackgroundVideo() {
            const video = document.getElementById("background-video");

            // Restore source video jika sebelumnya di-unload
            if (titleVideoSource && !video.src) {
                const sourceEl = video.querySelector('source');
                if (sourceEl) {
                    sourceEl.src = titleVideoSource.src;
                    sourceEl.type = titleVideoSource.type;
                } else {
                    video.src = titleVideoSource.src;
                }
                video.load();
            }

            video.play();
            video.style.opacity = "1";
        }

        function hideBackgroundVideo() {
            const video = document.getElementById("background-video");
            video.style.opacity = "0";

            // Optimalisasi: hentikan video dan lepas GPU decoder
            video.pause();
            video.removeAttribute('src');
            const sourceEl = video.querySelector('source');
            if (sourceEl) {
                sourceEl.removeAttribute('src');
            }
            video.load(); // Ini akan melepas video decoder dari GPU
            console.log('[Title Screen] Video source dihapus untuk membebaskan GPU decoder');
        }

        //------------------- ( debu bintang ala-ala di title screen ) -------------------------//
        function createFallingStarsLeftToRight(numStars) {
            const titleScreen = document.getElementById("title-screen");
            for (let i = 0; i < numStars; i++) {
                const starContainer = document.createElement("div");
                starContainer.classList.add("star-container");
                const star = document.createElement("div");
                star.classList.add("star");

                const startX = Math.random() * -20 + "vw";
                const startY = Math.random() * 100 + "vh";
                const endX = Math.random() * 100 + 120 + "vw";
                const endY = Math.random() * 100 - 50 + "vh";
                const duration = Math.random() * 3 + 4 + "s";

                starContainer.style.setProperty("--start-x", startX);
                starContainer.style.setProperty("--start-y", startY);
                starContainer.style.setProperty("--end-x", endX);
                starContainer.style.setProperty("--end-y", endY);
                starContainer.style.animationDuration = duration;

                starContainer.appendChild(star);
                titleScreen.appendChild(starContainer);
            }
        }
        createFallingStarsLeftToRight(15);

        //------------------- ( end debu bintang ala-ala di title screen ) -------------------------//

        // ================================ ( End Title Screen: Animasi & Alur Screen ) ================================ //

        // ================================ ( Character Menu: Toggle & Hover ) ================================ //
        //------------------- ( elemen & state UI character menu ) -------------------------//
        const characterMenuButton = document.getElementById('character-menu-button');
        const characterMenu = document.getElementById('character-menu');
        const mainMenu = document.getElementById('main-menu');
        const backToMainMenuBtn = document.getElementById('back-to-main-menu');

        const imagePreviews = document.querySelectorAll('#character-menu .image-preview');
        const videos = document.querySelectorAll('#character-menu .image-preview .video');

        //------------------- ( end elemen & state UI character menu ) -------------------------//

        //------------------- ( convert media: kalau source gambar, ganti jadi <img> ) -------------------------//
        document.addEventListener("DOMContentLoaded", () => {
            const imagePreviews = document.querySelectorAll("#character-menu .image-preview");

            imagePreviews.forEach(preview => {
                let mediaElement = preview.querySelector(".video");

                if (mediaElement) {
                    let src = mediaElement.getAttribute("src");

                    // Cek ekstensi file
                    if (src.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        let imgElement = document.createElement("img");
                        imgElement.src = src;
                        imgElement.classList.add("character-image");
                        imgElement.style.width = "100%";
                        imgElement.style.height = "100%";
                        imgElement.style.objectFit = "cover";

                        mediaElement.replaceWith(imgElement);
                    }
                }
            });

            // Set flexGrow default untuk tiap kartu
            imagePreviews.forEach(preview => {
                preview.style.flexGrow = "1";
            });

            // Event hover pada tiap kartu
            imagePreviews.forEach((preview) => {
                preview.addEventListener("mouseenter", () => {
                    // Jangan aktifkan hover jika animasi masih berlangsung
                    if (characterMenu.classList.contains("animating")) return;

                    preview.style.flexGrow = "1.5";

                    let media = preview.querySelector("video, img");
                    if (media.tagName.toLowerCase() === "video") {
                        media.play();
                    } else {
                        media.classList.add("hover-effect");
                    }

                    // Kartu lain mengecil dan redup
                    imagePreviews.forEach(other => {
                        if (other !== preview) {
                            other.style.flexGrow = "0.8";
                            other.classList.add("dim");
                            let otherMedia = other.querySelector("video");
                            if (otherMedia) {
                                otherMedia.pause();
                            }
                        }
                    });
                });

                preview.addEventListener("mouseleave", () => {
                    imagePreviews.forEach(other => {
                        other.style.flexGrow = "1";
                        other.classList.remove("dim");
                        let otherMedia = other.querySelector("video");
                        if (otherMedia) {
                            otherMedia.pause();
                        }
                    });

                    let media = preview.querySelector("video, img");
                    if (media.tagName.toLowerCase() === "img") {
                        media.classList.remove("hover-effect");
                    }
                });
            });


        });

        //------------------- ( end convert media: kalau source gambar, ganti jadi <img> ) -------------------------//

        //------------------- ( masuk ke Character Menu ) -------------------------//
        characterMenuButton.addEventListener('click', () => {
            // Jangan langsung sembunyikan main menu, biarkan tetap terlihat
            // Tampilkan character menu di atas main menu dengan background awal transparan
            characterMenu.style.display = 'block';
            characterMenu.style.zIndex = '100'; // Ensure it's on top
            characterMenu.style.backgroundColor = 'transparent';
            characterMenu.style.animation = "fadeInCharacter 0.5s forwards";
            characterMenu.style.opacity = 1;
            characterMenu.classList.add("animating");

            // Animasi munculnya image-preview (swipeUp) akan terjadi secara staggered (diatur dari CSS)
            const previews = document.querySelectorAll("#character-menu .image-preview");
            let animationsCompleted = 0;
            const totalAnimations = previews.length;

            // Jika tidak ada kartu karakter sama sekali
            if (totalAnimations === 0) {
                // Langsung selesaikan transisi menu utama
                characterMenu.style.backgroundColor = "black"; // Atur background
                characterMenu.classList.remove("animating");
                mainMenu.style.display = "none"; // Sembunyikan main menu

                // Aktifkan kembali tombol back
                backToMainMenuBtn.disabled = false;
                backToMainMenuBtn.style.pointerEvents = 'auto';
                backToMainMenuBtn.style.opacity = '1';
                return; // Keluar dari fungsi karena tidak ada animasi kartu
            }

            previews.forEach(preview => {
                preview.style.animation = '';

                preview.addEventListener("animationend", function handler(e) {
                    // Hanya tangani event untuk animasi 'swipeUp'
                    if (e.animationName === "swipeUp") {
                        preview.removeEventListener("animationend", handler); // Hapus listener setelah dipanggil sekali
                        preview.style.opacity = '1'; // Ensure opacity stays at 1
                        animationsCompleted++;

                        if (animationsCompleted === totalAnimations) {
                            // Semua animasi kartu selesai
                            characterMenu.style.backgroundColor = "black"; // Finalisasi background
                            characterMenu.classList.remove("animating");
                            mainMenu.style.display = "none";

                            // Aktifkan kembali tombol back SEKARANG
                            backToMainMenuBtn.disabled = false;
                            backToMainMenuBtn.style.pointerEvents = 'auto';
                            backToMainMenuBtn.style.opacity = '1';
                        }
                    }
                });
            });
        });

        //------------------- ( end masuk ke Character Menu ) -------------------------//

        //------------------- ( balik ke Main Menu ) -------------------------//
        backToMainMenuBtn.addEventListener('click', () => {
            mainMenu.style.display = 'flex'; // Tampilkan main menu dulu agar tidak blank
            mainMenu.style.opacity = '1';
            mainMenu.style.animation = 'fadeIn 0.5s forwards'; // Animasi masuk main menu

            characterMenu.style.animation = "fadeOutCharacter 0.5s forwards";

            setTimeout(() => {
                characterMenu.style.display = 'none';
                characterMenu.style.opacity = '0'; // Reset opacity sesuai CSS awal

                characterMenu.querySelectorAll('.image-preview').forEach(card => {
                    card.style.opacity = '0'; // Sesuai CSS awal
                    card.style.animation = ''; // Hapus inline style animasi agar CSS bisa berlaku lagi
                });
            }, 500); // Sesuai durasi fadeOutCharacter
        });

        //------------------- ( end balik ke Main Menu ) -------------------------//

        // ================================ ( End Character Menu: Toggle & Hover ) ================================ //

        // ================================ ( Start Game: Pilih Mode ) ================================ //
        //------------------- ( modal pilih mode game/vn ) -------------------------//
        const startGameButton = document.getElementById('start-game');
        const gameModeModal = document.getElementById('game-mode-modal');
        const closeGameModeModalBtn = document.getElementById('close-game-mode-modal');

        if (startGameButton) {
            startGameButton.addEventListener('click', () => {
                if (gameModeModal) {
                    gameModeModal.classList.remove('hidden');
                }
            });
        }

        if (closeGameModeModalBtn) {
            closeGameModeModalBtn.addEventListener('click', () => {
                if (gameModeModal) {
                    gameModeModal.classList.add('hidden');
                }
            });
        }

        // Klik di luar area modal untuk menutup
        if (gameModeModal) {
            gameModeModal.addEventListener('click', (event) => {
                if (event.target === gameModeModal) {
                    gameModeModal.classList.add('hidden');
                }
            });
        }

        // Ganti ID 'visual-novel' menjadi 'start-visual-novel'
        const startVisualNovelBtn = document.getElementById('start-visual-novel');
        if (startVisualNovelBtn) {
            startVisualNovelBtn.addEventListener('click', () => {
                ipcRenderer.send('load-visual-novel');
            });
        }

        //------------------- ( end modal pilih mode game/vn ) -------------------------//
        // ================================ ( End Start Game: Pilih Mode ) ================================ //

        // ================================ ( Shortcut Keyboard ) ================================ //
        //------------------- ( Enter: lompat ke main menu dari title ) -------------------------//
        document.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                const titleScreen = document.getElementById('title-screen');

                if (titleScreen.style.display === 'flex') {
                    titleScreen.style.display = 'none';
                    const mainMenu = document.getElementById('main-menu');
                    mainMenu.style.display = 'flex';
                    mainMenu.style.animation = 'fadeIn 1s forwards';
                    onMainMenuLoad();
                }
            }
        });

        //------------------- ( end Enter: lompat ke main menu dari title ) -------------------------//

        //------------------- ( Escape: prioritas tutup modal dulu, baru balik title ) -------------------------//
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (optionsModal.classList.contains('open')) {
                    closeOptionsBtn.click();
                } else if (customQuitPopup.classList.contains('visible')) { // Cek class .visible untuk popup quit
                    customCancelQuitBtn.click();
                } else if (gameModeModal && !gameModeModal.classList.contains('hidden')) { // Cek modal game mode
                    closeGameModeModalBtn.click();
                }
                else {
                    returnToTitleScreen();
                }
            }
        });

        //------------------- ( end Escape: prioritas tutup modal dulu, baru balik title ) -------------------------//
        // ================================ ( End Shortcut Keyboard ) ================================ //

        let idleTimer;
        const IDLE_TIMEOUT = 20000;

        // ================================ ( Idle Return: Balik ke Title Kalau Nganggur ) ================================ //
        //------------------- ( reset timer idle ) -------------------------//
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            const idleCheckbox = document.getElementById('idle-return-checkbox');
            if (idleCheckbox && idleCheckbox.checked) {
                idleTimer = setTimeout(returnToTitleScreen, IDLE_TIMEOUT);
            }
        }

        //------------------- ( end reset timer idle ) -------------------------//

        //------------------- ( aktivitas user yang dianggap "nggak nganggur" ) -------------------------//
        ['mousemove', 'keydown', 'click'].forEach(event => {
            document.addEventListener(event, resetIdleTimer);
        });

        //------------------- ( end aktivitas user yang dianggap "nggak nganggur" ) -------------------------//

        function returnToTitleScreen() {
            if (mainMenu.style.display === 'flex' &&
                !optionsModal.classList.contains('open') &&
                !customQuitPopup.classList.contains('visible') &&
                (!gameModeModal || gameModeModal.classList.contains('hidden'))) {

                screens.forEach(screen => screen.style.display = 'none');
                const titleScreen = document.getElementById('title-screen');
                titleScreen.style.display = 'flex';
                titleScreen.style.animation = 'fadeIn 1s forwards';
            }
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('mousemove', (e) => {
                if (e.target.closest('.modal-content')) {
                    resetIdleTimer(); // Reset timer jika interaksi dalam modal
                }
            });
        });

        // ================================ ( End Idle Return: Balik ke Title Kalau Nganggur ) ================================ //

        // ================================ ( Sinkronisasi Scene dari Main Process ) ================================ //
        //------------------- ( konfigurasi scene + muat asset awal ) -------------------------//
        ipcRenderer.on('configure-scene', (event, config) => {
            const {
                skipScene,
                songs: dynamicSongs,
                wallpapers: dynamicWallpapers,
                defaultSong,
                defaultTitleVideo,
                settings: savedSettings
            } = config;

            if (dynamicSongs) {
                songs = dynamicSongs;
                renderPlaylist();
            }
            if (dynamicWallpapers) {
                wallpapers = dynamicWallpapers;
                if (typeof changeWallpaper === 'function') changeWallpaper();
            }

            console.log("Skip Scene:", skipScene);

            const bgAudio = document.getElementById('background-audio');
            if (defaultSong && defaultSong.src) {
                bgAudio.src = defaultSong.src;
                const defaultIndex = songs.findIndex(song => song.src === defaultSong.src);
                if (defaultIndex !== -1) {
                    currentSongIndex = defaultIndex;
                    if (typeof loadSong === 'function') loadSong(currentSongIndex);
                }
            } else if (songs.length > 0) {
                bgAudio.src = songs[0].src;
                currentSongIndex = 0;
                if (typeof loadSong === 'function') loadSong(currentSongIndex);
            }

            if (defaultTitleVideo && defaultTitleVideo.src) {
                // Simpan source untuk restore nanti
                titleVideoSource = { src: defaultTitleVideo.src, type: defaultTitleVideo.type };

                const bgVideo = document.getElementById('background-video');
                if (bgVideo) {
                    const sourceEl = bgVideo.querySelector('source');
                    if (sourceEl) {
                        sourceEl.src = defaultTitleVideo.src;
                        sourceEl.type = defaultTitleVideo.type;
                        bgVideo.load();
                    } else {
                        bgVideo.src = defaultTitleVideo.src;
                        bgVideo.type = defaultTitleVideo.type;
                        bgVideo.load();
                    }
                }
            }

            // daftar screen
            screens = [
                document.getElementById('warning-screen'),
                document.getElementById('developer-screen'),
                document.getElementById('concept-screen'),
                document.getElementById('title-screen'),
                document.getElementById('main-menu')
            ].filter(screenEl => screenEl !== null);

            // Panggil loadAllEditableContent DI SINI, setelah `screens` diinisialisasi/diperbarui
            loadAllEditableContentFromLocalStorage();

            if (enableAdSkipperCheckbox) {
                enableAdSkipperCheckbox.addEventListener('change', (e) => {
                    const isEnabled = e.target.checked;

                    // Ambil status sub-opsi juga agar tidak ter-reset jadi undefined di preload
                    const autoMuteVal = document.getElementById('auto-mute-ads-checkbox').checked;
                    const autoSkipVal = document.getElementById('auto-skip-ads-checkbox').checked;

                    sessionStorage.setItem('savedAdSkipper', isEnabled);

                    // Kirim ke main process (update userSettings global)
                    ipcRenderer.send('save-settings', {
                        adSkipperEnabled: isEnabled,
                        autoMuteAds: autoMuteVal,
                        autoSkipAds: autoSkipVal
                    });

                    // Kirim paket lengkap ke webview
                    const webview = document.getElementById('external-webview');
                    if (webview && webview.getWebContentsId()) {
                        webview.send('setting-update', {
                            adSkipperEnabled: isEnabled,
                            autoMuteAds: autoMuteVal,
                            autoSkipAds: autoSkipVal
                        });
                    }
                });
            }

            // Apply loaded settings segera setelah screens diinisialisasi
            if (savedSettings) {
                const followMusicCheckboxHidden = document.getElementById("follow-music-title");
                const darknessSliderHidden = document.getElementById("wallpaper-darkness");
                const optionsPaneFollowMusicCheckbox = document.querySelector('#wallpaper-options-pane .follow-music-title');
                const optionsPaneDarknessSlider = document.querySelector('#wallpaper-options-pane .wallpaper-darkness');
                const enableHiddenSettingsCheckbox = document.getElementById('enable-hidden-wallpaper-settings');
                const wallpaperSettingsPanel = document.getElementById('wallpaper-settings');
                const volumeSliderEl = document.getElementById("volume-slider");
                const characterBackgroundEl = document.getElementById("character-background");
                const idleReturnCheckboxEl = document.getElementById('idle-return-checkbox');
                const snowEffectCheckboxEl = document.getElementById('snow-effect-checkbox');

                const snowEffectCheckbox = document.getElementById('snow-effect-checkbox');
                const miniPlayerCheckbox = document.getElementById('mini-player-effect-checkbox');


                if (volumeSliderEl && savedSettings.volume !== undefined) {
                    volumeSliderEl.value = savedSettings.volume;
                    if (bgAudio) bgAudio.volume = savedSettings.volume;
                }

                if (document.getElementById("wallpaper-name") && savedSettings.wallpaper !== undefined) {
                    document.getElementById("wallpaper-name").textContent = `Current: ${savedSettings.wallpaper}`;
                }

                if (savedSettings.followMusic !== undefined) {
                    if (followMusicCheckboxHidden) followMusicCheckboxHidden.checked = savedSettings.followMusic;
                    if (optionsPaneFollowMusicCheckbox) optionsPaneFollowMusicCheckbox.checked = savedSettings.followMusic;
                }

                if (savedSettings.darkness !== undefined) {
                    if (darknessSliderHidden) darknessSliderHidden.value = savedSettings.darkness;
                    if (optionsPaneDarknessSlider) optionsPaneDarknessSlider.value = savedSettings.darkness;
                    const brightnessFilter = `brightness(${100 - savedSettings.darkness}%)`;
                    if (characterBackgroundEl) characterBackgroundEl.style.filter = brightnessFilter;
                    const characterBackgroundImageEl = document.getElementById("character-background-image");
                    if (characterBackgroundImageEl) characterBackgroundImageEl.style.filter = brightnessFilter;
                }

                if (wallpaperSettingsPanel && enableHiddenSettingsCheckbox && savedSettings.enableHiddenWallpaperSettings !== undefined) {
                    const isEnabled = savedSettings.enableHiddenWallpaperSettings;
                    enableHiddenSettingsCheckbox.checked = isEnabled;

                    if (isEnabled) {
                        wallpaperSettingsPanel.classList.remove('disabled');
                        if (typeof showPanel === 'function' && typeof hidePanel === 'function' && typeof triggerZone !== 'undefined' && typeof wallpaperSettings !== 'undefined') {
                            triggerZone.addEventListener('mouseenter', showPanel);
                            triggerZone.addEventListener('mouseleave', hidePanel);
                            wallpaperSettings.addEventListener('mouseenter', showPanel);
                            wallpaperSettings.addEventListener('mouseleave', hidePanel);
                        }
                    } else {
                        wallpaperSettingsPanel.classList.add('disabled');
                        wallpaperSettingsPanel.classList.remove('show');
                        if (typeof showPanel === 'function' && typeof hidePanel === 'function' && typeof triggerZone !== 'undefined' && typeof wallpaperSettings !== 'undefined') {
                            triggerZone.removeEventListener('mouseenter', showPanel);
                            triggerZone.removeEventListener('mouseleave', hidePanel);
                            wallpaperSettings.removeEventListener('mouseenter', showPanel);
                            wallpaperSettings.removeEventListener('mouseleave', hidePanel);
                        }
                    }
                }

                if (idleReturnCheckboxEl && savedSettings.idleReturn !== undefined) {
                    idleReturnCheckboxEl.checked = savedSettings.idleReturn;
                    if (savedSettings.idleReturn && typeof resetIdleTimer === 'function') resetIdleTimer();
                }

                // Terapkan pengaturan salju saat konfigurasi scene
                if (snowEffectCheckboxEl && savedSettings.snowFeatureEnabled !== undefined) {
                    snowEffectCheckboxEl.checked = savedSettings.snowFeatureEnabled;
                    ipcRenderer.send('set-snow-feature-enabled', savedSettings.snowFeatureEnabled);
                    if (savedSettings.snowFeatureEnabled) {
                        ipcRenderer.send('show-snow-effect');
                    } else {
                        ipcRenderer.send('hide-snow-effect');
                    }
                } else if (snowEffectCheckboxEl) { // Default jika tidak ada di savedSettings
                    snowEffectCheckboxEl.checked = false;
                    ipcRenderer.send('set-snow-feature-enabled', false);
                    ipcRenderer.send('hide-snow-effect');
                }

                if (miniPlayerCheckbox && savedSettings.miniPlayerFeatureEnabled !== undefined) {
                    miniPlayerCheckbox.checked = savedSettings.miniPlayerFeatureEnabled;
                } else if (miniPlayerCheckbox) {
                    miniPlayerCheckbox.checked = false;
                }

                // Toggle sub-options visibility saat checkbox utama berubah
                const miniPlayerSubOptions = document.getElementById('mini-player-sub-options');
                if (miniPlayerCheckbox && miniPlayerSubOptions) {
                    // Set initial visibility
                    miniPlayerSubOptions.style.display = miniPlayerCheckbox.checked ? 'block' : 'none';

                    // Add change listener jika belum ada
                    if (!miniPlayerCheckbox.dataset.listenerAdded) {
                        miniPlayerCheckbox.addEventListener('change', () => {
                            miniPlayerSubOptions.style.display = miniPlayerCheckbox.checked ? 'block' : 'none';
                        });
                        miniPlayerCheckbox.dataset.listenerAdded = 'true';
                    }
                }

                const miniPlayerHideCheckbox = document.getElementById('mini-player-hide-on-cursor');
                if (miniPlayerHideCheckbox) {
                    if (savedSettings && savedSettings.miniPlayerHideOnCursor !== undefined) {
                        miniPlayerHideCheckbox.checked = savedSettings.miniPlayerHideOnCursor;
                    } else {
                        miniPlayerHideCheckbox.checked = false;
                    }
                    // Listener handled globally in DOMContentLoaded
                }

                if (enableRpcCheckbox && savedSettings.rpcEnabled !== undefined) {
                    enableRpcCheckbox.checked = savedSettings.rpcEnabled;
                } else if (enableRpcCheckbox) {
                    enableRpcCheckbox.checked = false;
                }

                if (dynamicThemeModeSelect) {
                    const savedMode = sanitizeDynamicThemeMode(savedSettings.dynamicThemeMode ?? 'default');
                    dynamicThemeModeSelect.value = savedMode;
                    toggleDynamicThemeSubOptions();
                }

                // Load Dynamic Music Player Styling setting
                const dynamicMusicPlayerCheckbox = document.getElementById('enable-dynamic-music-player-checkbox');
                if (dynamicMusicPlayerCheckbox && savedSettings.dynamicMusicPlayerStylingEnabled !== undefined) {
                    dynamicMusicPlayerCheckbox.checked = savedSettings.dynamicMusicPlayerStylingEnabled;
                    dynamicMusicPlayerEnabled = savedSettings.dynamicMusicPlayerStylingEnabled;
                    console.log('[Dynamic Music Player] Loaded saved setting:', dynamicMusicPlayerEnabled);

                    // Apply styling if enabled
                    if (dynamicMusicPlayerEnabled) {
                        applyDynamicMusicPlayerStyling();
                    }
                } else if (dynamicMusicPlayerCheckbox) {
                    dynamicMusicPlayerCheckbox.checked = false;
                    dynamicMusicPlayerEnabled = false;
                }
            }

            actualMiniPlayerFeatureEnabled = config.settings?.miniPlayerFeatureEnabled || false;
            const miniPlayerCheckbox = document.getElementById('mini-player-effect-checkbox');
            if (miniPlayerCheckbox) {
                miniPlayerCheckbox.checked = actualMiniPlayerFeatureEnabled;
            }

            if (skipScene) {
                screens.forEach(screen => { if (screen) screen.style.display = 'none'; });
                const mainMenuEl = document.getElementById('main-menu');
                if (mainMenuEl) {
                    mainMenuEl.style.display = 'flex';
                    mainMenuEl.style.animation = "fadeIn 1s forwards";
                    mainMenuEl.style.opacity = '1';
                }
                if (bgAudio && bgAudio.paused) {
                    bgAudio.currentTime = 0;
                    bgAudio.play().catch(err => {
                        console.warn("Autoplay diblokir??. Err:", err);
                        setTimeout(sendDataToMiniPlayer, 100);
                    });
                }
            } else {
                if (typeof startTitleScreenAnimation === 'function') startTitleScreenAnimation();
                if (typeof showNextScreen === 'function') {
                    setTimeout(() => {
                        const continueText = document.getElementById('warning-continue-text');
                        if (continueText) continueText.classList.add('visible');

                        const warningScreen = document.getElementById('warning-screen');
                        if (warningScreen) {
                            warningScreen.onclick = () => {
                                warningScreen.onclick = null; // Hapus listener agar tidak diklik ganda
                                showNextScreen(); // Pindah ke Dev Screen immediately

                                // Jadwalkan screen berikutnya (Dev -> Concept)
                                // Dev screen duration: 5.5s
                                setTimeout(showNextScreen, 5500);

                                // Jadwalkan musik (11.5s setelah klik)
                                // 5.5s (Dev) + 6s offset
                                setTimeout(() => {
                                    if (!skipScene) {
                                        audio.play();
                                        console.log("musik diputar setelah 11.5 detik (dari klik).");
                                    } else {
                                        console.log("musik tidak diputar karena skip scene.");
                                    }
                                }, 11500);

                                // Jadwalkan Concept -> Title
                                // 5.5s (Dev) + 10s (Concept) = 15.5s
                                setTimeout(showNextScreen, 15500);
                            };
                        }
                    }, 5000);
                }
            }
        });

        //------------------- ( end konfigurasi scene + muat asset awal ) -------------------------//

        //------------------- ( status fitur salju/mini-player dari main process ) -------------------------//
        ipcRenderer.on('snow-feature-status-changed', (event, isEnabled) => {
            const snowEffectCheckbox = document.getElementById('snow-effect-checkbox');
            if (snowEffectCheckbox) {
                snowEffectCheckbox.checked = isEnabled;
            }
        });

        ipcRenderer.on('mini-player-feature-status-changed', (event, isEnabled) => {
            console.log('Mini Player status changed from main:', isEnabled);
            actualMiniPlayerFeatureEnabled = isEnabled; // Update status global
            const miniPlayerEffectCheckbox = document.getElementById('mini-player-effect-checkbox');
            if (miniPlayerEffectCheckbox) {
                miniPlayerEffectCheckbox.checked = isEnabled;
            }
            if (isEnabled) {
                sendDataToMiniPlayer();
            }
        });

        //------------------- ( end status fitur salju/mini-player dari main process ) -------------------------//

        //------------------- ( setting-update: forward paket AdSkipper ke webview ) -------------------------//
        ipcRenderer.on('setting-update', (event, settings) => {
            console.log('[Index] Menerima setting dari Main:', settings);

            if (settings.adSkipperEnabled !== undefined) {
                const webview = document.getElementById('external-webview');

                // memastikan webview siap
                if (webview && webview.getWebContentsId()) {
                    console.log('[Index] Meneruskan paket lengkap ke Webview...');

                    // Jangan filter properti, kirimkan object settings apa adanya
                    // atau definisikan ulang satu per satu dengan lengkap
                    webview.send('setting-update', {
                        adSkipperEnabled: settings.adSkipperEnabled,
                        autoMuteAds: settings.autoMuteAds,
                        autoSkipAds: settings.autoSkipAds
                    });
                }
            }
        });

        //------------------- ( end setting-update: forward paket AdSkipper ke webview ) -------------------------//

        // ================================ ( End Sinkronisasi Scene dari Main Process ) ================================ //

        // ================================ ( Lifecycle Halaman ) ================================ //
        //------------------- ( beforeunload: efek fade-out biar halus ) -------------------------//
        window.addEventListener('beforeunload', () => {
            document.body.classList.add('fade-out');
        });

        //------------------- ( end beforeunload: efek fade-out biar halus ) -------------------------//

        const visualNovelBtn = document.getElementById('visual-novel');
        if (visualNovelBtn) {
            visualNovelBtn.addEventListener('click', () => {
                ipcRenderer.send('load-visual-novel');
            });
        } else {
            console.warn('[Index] visual-novel button not found');
        }


        // ================================ ( End Lifecycle Halaman ) ================================ //

        console.log('[Index] Script execution reached Profile CSS Editor section');
        // ================================ ( Editor CSS Profil ) ================================ //
        function initProfileCSSEditor() {
            console.log('[Profile CSS Editor] Initializing...');

            const toggleBtn = document.getElementById('toggle-profile-css-editor');
            const editorPanel = document.getElementById('profile-css-editor-panel');
            const cssCodeTextarea = document.getElementById('profile-css-code');
            const applyBtn = document.getElementById('apply-profile-css');
            const resetBtn = document.getElementById('reset-profile-css');

            console.log('[Profile CSS Editor] Elements found:', {
                toggleBtn: !!toggleBtn,
                editorPanel: !!editorPanel,
                cssCodeTextarea: !!cssCodeTextarea,
                applyBtn: !!applyBtn,
                resetBtn: !!resetBtn
            });

            const STORAGE_KEY = 'profile-section-custom-css';
            let customStyleElement = null;

            // Fungsi untuk mengambil CSS saat ini dari profile-section
            function extractCurrentCSS() {
                const profileSection = document.getElementById('profile-section');
                if (!profileSection) {
                    console.warn('[Profile CSS Editor] profile-section element not found');
                    return '';
                }

                const computedStyle = window.getComputedStyle(profileSection);

                // Ambil properti CSS yang penting-penting saja
                const cssProperties = [
                    'background',
                    'background-color',
                    'background-image',
                    'border',
                    'border-radius',
                    'padding',
                    'margin',
                    'width',
                    'height',
                    'display',
                    'flex-direction',
                    'align-items',
                    'justify-content',
                    'gap',
                    'box-shadow',
                    'opacity',
                    'transform',
                    'transition'
                ];

                let cssText = '#profile-section {\n';
                cssProperties.forEach(prop => {
                    const value = computedStyle.getPropertyValue(prop);
                    if (value && value !== 'none' && value !== 'normal' && value !== 'rgba(0, 0, 0, 0)') {
                        cssText += `    ${prop}: ${value};\n`;
                    }
                });
                cssText += '}';

                return cssText;
            }

            // Atur visibilitas panel (buka/tutup)
            if (toggleBtn && editorPanel) {
                toggleBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const isHidden = editorPanel.style.display === 'none';

                    if (isHidden) {
                        editorPanel.style.display = 'block';
                        toggleBtn.classList.add('active');

                        // Automatis isi pake CSS yang ada kalau textarea-nya masih kosong
                        if (cssCodeTextarea && !cssCodeTextarea.value.trim()) {
                            // Cek dulu apakah ada CSS yang tersimpan
                            const savedCSS = localStorage.getItem(STORAGE_KEY);
                            if (savedCSS) {
                                cssCodeTextarea.value = savedCSS;
                                console.log('[Profile CSS Editor] Loaded saved CSS');
                            } else {
                                // Kalau gak ada, kita ambil aja CSS computed yang sekarang lagi dipake
                                const currentCSS = extractCurrentCSS();
                                cssCodeTextarea.value = currentCSS;
                                console.log('[Profile CSS Editor] Extracted current CSS from profile-section');
                            }
                        }
                    } else {
                        editorPanel.style.display = 'none';
                        toggleBtn.classList.remove('active');
                    }
                });
            }

            // Terapkan CSS kustom hasil editan
            if (applyBtn && cssCodeTextarea) {
                applyBtn.addEventListener('click', function () {
                    const customCSS = cssCodeTextarea.value.trim();

                    // Hapus style kustom yang lama kalau emang ada
                    if (customStyleElement) {
                        customStyleElement.remove();
                    }

                    // Buat elemen style baru
                    if (customCSS) {
                        customStyleElement = document.createElement('style');
                        customStyleElement.id = 'profile-section-custom-style';
                        customStyleElement.textContent = customCSS;
                        document.head.appendChild(customStyleElement);

                        // Simpan setting-nya ke localStorage biar gak ilang
                        try {
                            localStorage.setItem(STORAGE_KEY, customCSS);
                            console.log('[Profile CSS Editor] CSS diterapkan dan disimpan');

                            // Kasih umpan balik visual
                            const originalText = applyBtn.textContent;
                            applyBtn.textContent = ' Applied!';
                            applyBtn.style.background = 'linear-gradient(135deg, #059669, #047857)';
                            setTimeout(() => {
                                applyBtn.textContent = originalText;
                                applyBtn.style.background = '';
                            }, 2000);
                        } catch (error) {
                            console.error('[Profile CSS Editor] Error saving CSS:', error);
                            alert('Error saving CSS: ' + error.message);
                        }
                    }
                });
            }

            // Tombol untuk memuat CSS yang sedang aktif
            const loadCurrentBtn = document.getElementById('load-current-css');
            if (loadCurrentBtn && cssCodeTextarea) {
                loadCurrentBtn.addEventListener('click', function () {
                    const currentCSS = extractCurrentCSS();
                    cssCodeTextarea.value = currentCSS;
                    console.log('[Profile CSS Editor] Loaded current CSS from profile-section');

                    // Tampilkan umpan balik
                    const originalText = loadCurrentBtn.textContent;
                    loadCurrentBtn.textContent = ' Loaded!';
                    setTimeout(() => {
                        loadCurrentBtn.textContent = originalText;
                    }, 2000);
                });
            }

            // Reset kembali ke pengaturan awal
            if (resetBtn && cssCodeTextarea) {
                resetBtn.addEventListener('click', function () {
                    if (confirm('Are you sure you want to reset the profile section CSS to default?')) {
                        // Kosongkan textarea
                        cssCodeTextarea.value = '';

                        // Hapus elemen style kustom
                        if (customStyleElement) {
                            customStyleElement.remove();
                            customStyleElement = null;
                        }

                        // Hapus data dari localStorage
                        try {
                            localStorage.removeItem(STORAGE_KEY);
                            console.log('[Profile CSS Editor] CSS reset to default');

                            // Tampilkan umpan balik
                            const originalText = resetBtn.textContent;
                            resetBtn.textContent = ' di-Reset!';
                            setTimeout(() => {
                                resetBtn.textContent = originalText;
                            }, 2000);
                        } catch (error) {
                            console.error('[Profile CSS Editor] Error removing CSS:', error);
                        }
                    }
                });
            }

            // Muat CSS yang tersimpan saat halaman dibuka
            function loadSavedCSS() {
                try {
                    const savedCSS = localStorage.getItem(STORAGE_KEY);
                    if (savedCSS && cssCodeTextarea) {
                        cssCodeTextarea.value = savedCSS;

                        // Terapkan CSS yang sudah disimpan
                        customStyleElement = document.createElement('style');
                        customStyleElement.id = 'profile-section-custom-style';
                        customStyleElement.textContent = savedCSS;
                        document.head.appendChild(customStyleElement);

                        console.log('[Profile CSS Editor] Loaded and applied saved CSS');
                    }
                } catch (error) {
                    console.error('[Profile CSS Editor] Error loading saved CSS:', error);
                }
            }

            // Jalankan fungsi muat CSS saat DOM sudah siap
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadSavedCSS);
            } else {
                loadSavedCSS();
            }
        }

        console.log('[Profile CSS Editor] Script loaded, preparing to initialize...');

        // Kasih jeda dikit baru inisialisasi biar yakin DOM-nya udah beneran siap
        // Dipanggil lagi juga pas game editor dibuka biar aman
        console.log('[Profile CSS Editor] Setting up delayed initialization (500ms)');
        setTimeout(function () {
            console.log('[Profile CSS Editor] Delayed init triggered');
            initProfileCSSEditor();
        }, 500);

        // Inisialisasi ulang pas tombol game editor diklik
        console.log('[Profile CSS Editor] Looking for game-editor button...');
        const gameEditorBtn = document.getElementById('game-editor');
        console.log('[Profile CSS Editor] Game editor button found:', !!gameEditorBtn);

        if (gameEditorBtn) {
            console.log('[Profile CSS Editor] Attaching click listener to game-editor button');
            gameEditorBtn.addEventListener('click', function () {
                console.log('[Profile CSS Editor] Game editor button clicked! Re-initializing in 300ms...');
                setTimeout(function () {
                    console.log('[Profile CSS Editor] Re-init triggered from game editor click');
                    initProfileCSSEditor();
                }, 300);
            });
        } else {
            console.warn('[Profile CSS Editor] Game editor button not found!');
        }

        // Coba inisialisasi pas dokumen bener-bener udah kelar dimuat
        console.log('[Profile CSS Editor] Document readyState:', document.readyState);
        if (document.readyState === 'loading') {
            console.log('[Profile CSS Editor] Document still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', function () {
                console.log('[Profile CSS Editor] DOMContentLoaded fired, initializing...');
                initProfileCSSEditor();
            });
        } else {
            console.log('[Profile CSS Editor] Document already loaded');
        }

        // ================================ ( Akhir Editor CSS Profil ) ================================ //

    </script>
    <div id="log-window-container" class="hidden">
        <div class="log-title-bar">
            <span>Debug Log</span>
        </div>
        <div id="log-content">
        </div>
        <div class="resizer resizer-se"></div>
    </div>
</body>

</html>
