<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>GAP Visual Novel Player | v0.0.0.8 Alpha</title>
    <script src="./vnLib/Sortable.min.js"></script>
    <style>
        /* ================== Global Reset & Fonts ====================== */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Hanya berlaku untuk body dan html */
            font-family: 'Lexend', sans-serif;
        }

        input,
        textarea {
            -webkit-user-select: auto;
            user-select: auto;
        }

        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 300;
            src: url('../fonts/lexend-v26-latin-300.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 400;
            src: url('../fonts/lexend-v26-latin-regular.woff2') format('woff2');
        }

        @font-face {
            font-family: 'Lexend';
            font-style: normal;
            font-weight: 700;
            src: url('../fonts/lexend-v26-latin-700.woff2') format('woff2');
        }

        /* ================== Custom Scrollbar Styling ================== */
        /* Scrollbar untuk seluruh editor - tema gelap dengan accent cyan */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #3a3a3a, #4a4a4a);
            border-radius: 5px;
            border: 2px solid rgba(30, 30, 30, 0.8);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #4a4a4a, #5a5a5a);
        }

        ::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #00aaaa, #00cccc);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(30, 30, 30, 0.8);
        }

        /* ================== End Custom Scrollbar ================== */

        /*------ Notifikasi ------*/
        #notification-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(200%);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            opacity: 0;
            transition: all 0.5s ease-in-out;
            pointer-events: none;
            background-color: #f3557a;
            box-shadow: 0 4px 15px rgba(243, 85, 122, 0.4);
        }

        #notification-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        #notification-toast.success {
            background-color: #f3557a;
            box-shadow: 0 4px 15px rgba(243, 85, 122, 0.4);
        }

        #notification-toast.error {
            background-color: #f3557a;
            box-shadow: 0 4px 15px rgba(243, 85, 122, 0.4);
        }

        /*------ End Notifikasi ------*/

        /*------ confirmation ------*/
        #confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        #confirmation-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #confirmation-modal-box {
            background: #2c2c2c;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        #confirmation-modal-overlay.visible #confirmation-modal-box {
            transform: scale(1);
        }

        #confirmation-modal-text {
            margin: 0;
            margin-bottom: 25px;
            font-size: 1.2em;
            color: #eee;
            max-width: 400px;
        }

        .confirmation-modal-buttons button {
            padding: 10px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin: 0 10px;
            transition: transform 0.1s ease;
        }

        .confirmation-modal-buttons button:active {
            transform: scale(0.95);
        }

        #confirm-yes-btn {
            background-color: #e74c3c;
            color: white;
        }

        #confirm-no-btn {
            background-color: #555;
            color: #fff;
        }

        /*------ End confirmation ------*/

        #drag-tooltip {
            display: none;
            position: fixed;
            background-color: #c0392b;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 99999999;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, 25px);
        }

        body.invalid-drag-state #drag-tooltip {
            display: block;
        }

        body.invalid-drag-state * {
            cursor: not-allowed !important;
        }

        /* ================== End Global Reset & Fonts ====================== */


        /* ================ Black Screen ======================== */
        .black-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2000;
        }

        @keyframes swipeOut {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .black-scene.swipe-out {
            animation: swipeOut 0.3s ease forwards;
        }

        /* ======================= End Black Screen ======================= */


        /* ====================== Scene Intro ============================== */
        .intro-scene {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #FFA07A, #FFDAB9);
            z-index: 1000;
            overflow: hidden;
            padding: 20px;
        }

        .tips-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        .tips-header {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .tips-content {
            font-size: 1.2rem;
            color: #555;
            text-align: center;
            line-height: 1.5;
        }

        .continue-section {
            position: absolute;
            bottom: 60px;
            right: 260px;
            display: flex;
            align-items: center;
            cursor: pointer;
            overflow: visible;
        }

        @keyframes jump-high {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes jump-low {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .character-image-small {
            width: 260px;
            height: 240px;
            object-fit: contain;
            margin-right: 10px;
        }

        .continue-text {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .character-image {
            max-width: 30%;
            height: auto;
            object-fit: contain;
        }

        /*------ gambar karakter Responsif resolusi 720 ke bawah -------*/
        @media screen and (max-width: 1280px) {
            .character-image-small {
                width: 150px;
                height: 165px;
            }
        }

        /*---- End gambar karakter Responsif resolusi 720 ke bawah -----*/

        /* ======================= End Scene Intro ======================= */

        /* === TRANSFORM CONTROLS GROUP (Ukuran + Posisi X) === */
        .transform-controls-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
        }

        .transform-controls-group .transform-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .transform-controls-group .transform-row:last-child {
            border-bottom: none;
        }

        .transform-controls-group .transform-label {
            font-size: 0.85em;
            color: #aaa;
            min-width: 75px;
            white-space: nowrap;
        }

        .transform-controls-group .transform-slider {
            flex-grow: 1;
            cursor: pointer;
            accent-color: #f3557a;
        }

        .transform-controls-group .transform-value {
            min-width: 40px;
            text-align: right;
            font-weight: bold;
            font-size: 0.85em;
            color: #f3557a;
        }

        .scale-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .position-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .scale-slider,
        .sprite-position-slider,
        .extra-sprite-x,
        .extra-sprite-scale {
            flex-grow: 1;
            cursor: pointer;
            accent-color: #f3557a;
        }

        .scale-value-display,
        .position-value-display {
            min-width: 45px;
            text-align: right;
            font-weight: bold;
            color: #f3557a;
        }

        /* === SPRITE TRANSITION CONTROLS === */
        .sprite-transition-controls {
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 206, 209, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 6px;
            display: none;
            /* Disembunyikan secara default, muncul saat terdeteksi perbedaan */
        }

        .sprite-transition-controls.visible {
            display: block;
            animation: fadeInTransition 0.3s ease-out;
        }

        @keyframes fadeInTransition {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sprite-transition-controls .transition-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .sprite-transition-controls .transition-header label {
            color: #00CED1;
            font-size: 0.85em;
            font-weight: bold;
            margin: 0;
        }

        .sprite-transition-controls .transition-hint {
            font-size: 0.75em;
            color: #888;
            font-style: italic;
        }

        .sprite-transition-controls .transition-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .sprite-transition-controls .transition-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .sprite-transition-controls .transition-toggle-wrapper input[type="checkbox"] {
            accent-color: #00CED1;
            cursor: pointer;
        }

        .sprite-transition-controls .transition-duration-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .sprite-transition-controls .transition-duration-control span {
            font-size: 0.8em;
            color: #aaa;
        }

        .sprite-transition-controls .transition-duration-slider {
            flex: 1;
            accent-color: #00CED1;
            cursor: pointer;
        }

        .sprite-transition-controls .transition-duration-slider:disabled {
            accent-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .sprite-transition-controls .transition-duration-control.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .sprite-transition-controls .transition-duration-value {
            min-width: 50px;
            font-size: 0.85em;
            color: #00CED1;
            font-weight: bold;
            text-align: right;
        }

        .sprite-transition-controls .prev-value-hint {
            font-size: 0.7em;
            color: #FF6B6B;
            margin-top: 4px;
        }

        /* ======================= Main Screen (Layar Utama) ========================== */
        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .background-video {
            position: fixed;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* ----------------------- Navbar ----------------------- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 999;
        }

        .navbar h1 {
            font-size: 1.5rem;
            cursor: default;
            margin-left: 20px;
        }

        .layout-switch {
            position: absolute;
            top: 50%;
            left: calc(230px + 0.5rem);
            transform: translateY(-50%);
        }

        #switchLayoutBtn {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            font-size: 0.7rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #switchLayoutBtn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .navbar .search-container {
            display: flex;
            align-items: center;
        }

        .navbar input[type="text"] {
            padding: 6px 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #222;
            color: #eee;
            margin-right: 10px;
            width: 200px;
            transition: all 0.3s ease;
        }

        .navbar input[type="text"]:focus {
            outline: none;
            border-color: #00ffff;
        }

        .navbar button {
            padding: 6px 12px;
            background: #00ffff;
            color: #000;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .navbar button:hover {
            background: #00cccc;
        }

        /* -------------------- End Navbar -------------------- */

        .menu-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            text-align: center;
            padding: 60px 40px;
            padding-bottom: 480px;
            z-index: 0;
            box-sizing: border-box;
            /* Scroll pintar: hanya muncul saat diperlukan */
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Sembunyikan scroll saat carousel-layout aktif */
        .menu-container:has(.carousel-layout) {
            overflow: hidden;
            padding-bottom: 0;
        }

        /* Styling scrollbar untuk tampilan yang lebih baik */
        .menu-container::-webkit-scrollbar {
            width: 8px;
        }

        .menu-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .menu-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .menu-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .menu-title {
            margin-bottom: 30px;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* ----------------------- Story Grid & Card ----------------------- */
        .story-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 30px;
            width: 100%;
            margin: 0 auto;
            overflow: visible;
            padding: 0 20px;
        }

        /* Responsive: Large Desktop (1600px and above) */
        @media screen and (min-width: 1600px) {
            .story-grid {
                grid-template-columns: repeat(5, 1fr);
                max-width: 1600px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        /* Responsive: Standard Desktop (1280px - 1599px) */
        @media screen and (min-width: 1280px) and (max-width: 1599px) {
            .story-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 1400px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        /* Responsive: Compact Desktop (1024px - 1279px) */
        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-grid {
                grid-template-columns: repeat(3, 1fr);
                max-width: 1100px;
                margin-left: auto;
                margin-right: auto;
            }

            .menu-title {
                font-size: 2em;
            }

            .menu-container {
                padding: 50px 30px;
            }
        }

        .story-card {
            position: relative;
            width: 100%;
            aspect-ratio: 3 / 4;
            min-height: 320px;
            max-height: 450px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            cursor: pointer;
        }

        /* Responsive story card height untuk berbagai ukuran desktop */
        @media screen and (min-width: 1600px) {
            .story-card {
                max-height: 480px;
            }
        }

        @media screen and (min-width: 1280px) and (max-width: 1599px) {
            .story-card {
                max-height: 420px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-card {
                max-height: 380px;
                min-height: 300px;
            }
        }

        .story-card:hover {
            transform: scale(1.04);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.7);
        }

        .delete-novel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 990;
            font-size: 16px;
        }

        .story-card:hover .delete-novel-btn {
            opacity: 1;
        }

        .delete-novel-btn:hover {
            background-color: #ff4d4d;
            color: white;
            transform: scale(1.1);
        }

        /* Responsive hover effect */
        @media screen and (min-width: 1600px) {
            .story-card:hover {
                transform: scale(1.06);
                box-shadow: 0 8px 24px rgba(0, 255, 255, 0.8);
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-card:hover {
                transform: scale(1.03);
                box-shadow: 0 6px 16px rgba(0, 255, 255, 0.6);
            }
        }

        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            width: 100%;
            margin: 0 auto;
            overflow: visible;
            padding: 0 20px;
        }

        .carousel-layout {
            position: relative;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 0 auto;
            overflow: visible;
            padding: 50px 40px;
            transition: transform 0.5s ease;
            box-sizing: border-box;
        }

        /* Responsive carousel gap dan padding */
        @media screen and (min-width: 1600px) {
            .carousel-layout {
                gap: 30px;
                padding: 50px 60px;
            }
        }

        @media screen and (min-width: 1280px) and (max-width: 1599px) {
            .carousel-layout {
                gap: 25px;
                padding: 50px 50px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .carousel-layout {
                gap: 20px;
                padding: 40px 30px;
            }
        }

        .carousel-layout .story-card {
            flex: 0 0 auto;
            width: 240px;
            aspect-ratio: 3 / 4;
            margin: 0;
            transition: transform 0.3s ease;
            overflow: hidden;
            border-radius: 10px;
        }

        /* Responsive carousel card width */
        @media screen and (min-width: 1600px) {
            .carousel-layout .story-card {
                width: 280px;
            }
        }

        @media screen and (min-width: 1280px) and (max-width: 1599px) {
            .carousel-layout .story-card {
                width: 260px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .carousel-layout .story-card {
                width: 240px;
            }
        }

        /* -------------- Tombol Arrow Carousel --------------- */
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            font-size: 0.9em;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 6px;
            z-index: 1000;
            transition: background 0.3s ease, transform 0.2s ease;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }

        .carousel-arrow.left {
            left: 15px;
        }

        .carousel-arrow.right {
            right: 15px;
        }

        /* Responsive carousel arrow positioning dan ukuran */
        @media screen and (min-width: 1600px) {
            .carousel-arrow {
                font-size: 1em;
                padding: 14px 18px;
            }

            .carousel-arrow.left {
                left: 25px;
            }

            .carousel-arrow.right {
                right: 25px;
            }
        }

        @media screen and (min-width: 1280px) and (max-width: 1599px) {
            .carousel-arrow {
                font-size: 0.95em;
                padding: 13px 17px;
            }

            .carousel-arrow.left {
                left: 20px;
            }

            .carousel-arrow.right {
                right: 20px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .carousel-arrow {
                font-size: 0.85em;
                padding: 11px 15px;
            }

            .carousel-arrow.left {
                left: 10px;
            }

            .carousel-arrow.right {
                right: 10px;
            }
        }

        /* -------------- End Tombol Arrow Carousel --------------- */

        /* --------- Carousel Arrow Container --------- */
        .carousel-arrow-container {
            position: relative;
            width: 100%;
            height: 0;
            pointer-events: none;
        }

        .carousel-arrow-container .carousel-arrow {
            pointer-events: auto;
        }

        /* --------- End Carousel Arrow Container --------- */

        /* -------------------- Efek Kartu Tengah -------------------- */
        .story-card.centered {
            transform: scale(1.08);
            z-index: 2;
            transition: transform 0.3s ease, z-index 0.3s ease;
        }

        /* Responsive centered card scale */
        @media screen and (min-width: 1600px) {
            .story-card.centered {
                transform: scale(1.12);
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-card.centered {
                transform: scale(1.05);
            }
        }

        .story-card .play-button {
            display: none;
            transition: opacity 0.3s ease;
        }

        .story-card.centered .play-button {
            display: inline-block;
            opacity: 1;
        }

        .overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85), transparent 50%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            color: white;
            text-align: center;
            z-index: 1;
            box-sizing: border-box;
            /* Transisi halus untuk efek hover */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Grid layout: sembunyikan overlay secara default */
        .story-grid:not(.carousel-layout) .story-card .overlay {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Grid layout: tampilkan overlay saat hover */
        .story-grid:not(.carousel-layout) .story-card:hover .overlay {
            opacity: 1;
            transform: translateY(0);
        }

        /* Carousel layout: overlay selalu terlihat */
        .carousel-layout .story-card .overlay {
            opacity: 1;
            transform: translateY(0);
        }

        .story-title {
            font-size: 1.1em;
            margin-bottom: 8px;
            line-height: 1.2;
            font-weight: 600;
        }

        /* Responsive title sizing */
        @media screen and (min-width: 1600px) {
            .story-title {
                font-size: 1.2em;
                margin-bottom: 10px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-title {
                font-size: 1em;
                margin-bottom: 6px;
            }
        }

        .story-desc {
            font-size: 0.85em;
            color: #bdc3c7;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        /* Responsive description sizing */
        @media screen and (min-width: 1600px) {
            .story-desc {
                font-size: 0.9em;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .story-desc {
                font-size: 0.8em;
                -webkit-line-clamp: 1;
            }
        }

        /* ----------------------- Tombol Play ----------------------- */
        .play-button {
            display: inline-block;
            position: relative;
            padding: 8px 18px;
            font-size: 0.95em;
            color: white;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            text-decoration: none;
            margin-top: 8px;
            overflow: hidden;
            transition: color 0.3s ease, border-color 0.3s ease;
            white-space: nowrap;
        }

        /* Responsive play button */
        @media screen and (min-width: 1600px) {
            .play-button {
                padding: 10px 20px;
                font-size: 1em;
                margin-top: 10px;
            }
        }

        @media screen and (min-width: 1024px) and (max-width: 1279px) {
            .play-button {
                padding: 7px 16px;
                font-size: 0.9em;
                margin-top: 6px;
            }
        }

        .play-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.8), transparent, rgba(255, 255, 255, 0.8));
            z-index: -1;
            opacity: 0;
            transform: skewX(-20deg);
            transition: opacity 0.3s ease;
        }

        .play-button:hover {
            border-color: rgba(255, 255, 255, 0.8);
        }

        .play-button:hover::before {
            opacity: 1;
            animation: waveSwipe 1s ease-in-out forwards;
        }

        .play-button:active {
            transform: scale(0.95);
        }

        @keyframes waveSwipe {
            0% {
                left: -100%;
            }

            50% {
                left: 0;
            }

            100% {
                left: 100%;
            }
        }

        /* ----------------------- End Tombol Play ----------------------- */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            pointer-events: none;
            z-index: -1;
            opacity: 0;
            transition: opacity 1s ease;
        }

        /* ----------------------- Version Info ----------------------- */
        #version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            pointer-events: none;
            z-index: 1000;
        }

        /* ----------------------- End Version Info ----------------------- */


        /* ----------------------- End Exit Animations ----------------------- */
        @keyframes moveTopLeft {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-150%, -150%) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes moveTopRight {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(150%, -150%) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes moveBottomLeft {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-150%, 150%) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes moveBottomRight {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(150%, 150%) scale(1.1);
                opacity: 0;
            }
        }

        .story-card.move-top-left {
            animation: moveTopLeft 0.6s ease forwards;
        }

        .story-card.move-top-right {
            animation: moveTopRight 0.6s ease forwards;
        }

        .story-card.move-bottom-left {
            animation: moveBottomLeft 0.6s ease forwards;
        }

        .story-card.move-bottom-right {
            animation: moveBottomRight 0.6s ease forwards;
        }

        @keyframes zoomIn {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.15);
            }
        }

        .story-card.focused {
            animation: zoomIn 0.6s ease forwards;
        }

        @keyframes scaleFade {
            0% {
                transform: scale(1.15);
                opacity: 1;
            }

            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .story-card.fade-out {
            animation: scaleFade 0.6s ease forwards;
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .page-fade-out {
            animation: fadeOut 0.6s ease forwards;
        }

        /* ----------------------- End Exit Animations ----------------------- */
        /* ================== MODAL ====================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-wrapper {
            display: flex;
            flex-direction: row;
            gap: 30px;
            align-items: center;
            width: 90%;
            max-width: 900px;
        }

        .modal-form-container {
            display: flex;
            flex-direction: row;
            gap: 30px;
            /* Tambah jarak antar elemen */
            margin-top: 20px;
            margin-bottom: 25px;
            align-items: flex-start;
        }

        .form-inputs-column {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            /* Tetap biarkan input mengisi ruang */
        }


        .modal-content {
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #444;
            width: 90%;
            max-width: 800px;
            text-align: left;
            transform: scale(1);
            transition: transform 0.3s ease;
            flex-grow: initial;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 8px;
            background: #222;
            color: #fff;
            font-size: 1.1rem;
        }

        .modal-content input[type="text"],
        #cover-upload-label {
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        #confirm-create-btn {
            background-color: #f3557a;
            color: #000;
        }

        #confirm-create-btn:hover {
            background-color: #d54d6d;
        }

        #cancel-create-btn {
            background-color: #444;
            color: #fff;
        }

        #cancel-create-btn:hover {
            background-color: #555;
        }

        /* ================== End CSS MODAL ====================== */

        /* ================== Card untuk tombol membuat novel ====================== */
        .create-new-card {
            background: #1c1c1c;
            border: 2px dashed #555;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #888;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-new-card:hover {
            background: #2a2a2a;
            border-color: #00ffff;
            color: #00ffff;
        }

        .create-new-card .plus-icon {
            font-size: 4rem;
            font-weight: 200;
            line-height: 1;
        }

        .create-new-card .create-text {
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        #cover-upload-label {
            display: block;
            padding: 10px;
            border: 2px dashed #444;
            border-radius: 8px;
            background-color: #222;
            color: #888;
            cursor: pointer;
            margin-bottom: 25px;
            text-align: center;
        }

        #cover-upload-label:hover {
            border-color: #00ffff;
            color: #00ffff;
        }

        #new-novel-cover-input {
            display: none;
        }

        /* Area Pratinjau Gambar dengan Overlay seperti story-card */
        #modal-image-preview {
            width: 300px;
            height: 450px;
            background-color: #222;
            border: 2px dashed #444;
            border-radius: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            overflow: hidden;
            position: relative;
        }

        #modal-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Overlay preview seperti story-card */
        #modal-image-preview .preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.6) 60%, transparent);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 40%;
        }

        #modal-image-preview .preview-title {
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            text-align: center;
            line-height: 1.2;
            word-break: break-word;
        }

        #modal-image-preview .preview-desc {
            font-size: 0.85em;
            color: #bdc3c7;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        /* Input Story Description (Tagline) */
        #new-novel-desc-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 8px;
            background: #222;
            color: #fff;
            font-size: 0.95rem;
            margin-bottom: 15px;
            resize: none;
        }

        #new-novel-desc-input:focus {
            outline: none;
            border-color: #00ffff;
        }

        #new-novel-desc-input::placeholder {
            color: #666;
        }

        /* Editor Layar Penuh - Redesigned */
        #hub-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0a0a0a;
            z-index: 4000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 0;
            overflow: hidden;
        }

        #hub-editor-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .editor-layout-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 30px;
            box-sizing: border-box;
        }

        .editor-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .editor-header-bar h1 {
            margin: 0;
            font-size: 2em;
            color: #00f371;
            text-shadow: 0 0 10px rgba(0, 243, 113, 0.3);
        }

        .editor-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .editor-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .editor-section {
            background: #161616;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .editor-section h3 {
            margin-top: 0;
            color: #eee;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .editor-actions {
            display: flex;
            gap: 15px;
        }

        .editor-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.2s;
        }

        .editor-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        #editor-save-btn {
            background-color: #00f371;
            color: black;
        }

        #editor-cancel-btn {
            background-color: #333;
            color: white;
            border: 1px solid #555;
        }

        /* Adjust existing elements */
        #editor-description {
            width: 100%;
            min-height: 150px;
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 15px;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .editor-section input[type="text"] {
            background: #222 !important;
            border: 1px solid #444 !important;
            padding: 12px !important;
            border-radius: 6px !important;
            color: white !important;
        }

        .editor-section input[type="text"]:focus,
        #editor-description:focus {
            border-color: #00f371 !important;
            outline: none;
        }

        .editor-container {
            /* Legacy class kept for compatibility if needed, but overridden by new layout */
            display: none;
        }

        .editor-chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c2c2c;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .delete-chapter-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-weight: bold;
            cursor: pointer;
            line-height: 22px;
            text-align: center;
        }

        #editor-slideshow-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            min-height: 80px;
            align-items: center;
        }

        .preview-image-container {
            flex: 1;
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image-container img {
            max-width: 100%;
            max-height: 200px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 5px;
        }

        #slideshow-inputs-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        /* Sembunyikan input file asli */
        .editor-slideshow-input {
            display: none;
        }

        /* Gaya untuk label yang berfungsi sebagai tombol */
        .file-input-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .file-input-label:hover {
            background-color: #4a4a4a;
        }

        /* Gaya khusus untuk label setelah file dipilih */
        .file-input-label.file-selected {
            background-color: #e45c7c;
            border-color: #c94b68;
        }



        /* tombol Tambah (+) */
        #add-slideshow-input {
            width: 40px;
            height: 40px;
            border: 2px dashed #555;
            background-color: transparent;
            color: #888;
            border-radius: 5px;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding-bottom: 5px;
        }

        #add-slideshow-input:hover {
            border-color: #00ffff;
            color: #00ffff;
        }

        .editor-section {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .editor-section h3 {
            margin-bottom: 15px;
        }

        .editor-section textarea,
        .editor-section input[type="text"] {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
        }

        .editor-section textarea {
            min-height: 120px;
            resize: vertical;
        }

        .editor-buttons {
            display: flex;
            gap: 12px;
        }

        .editor-buttons button {
            padding: 8px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.25s ease;
        }

        /* Save button */
        #editor-save-btn {
            background: linear-gradient(135deg, #f3557a, #d14468);
            color: #000;
            box-shadow: 0 0 10px rgba(243, 85, 122, 0.4);
        }

        #editor-save-btn:hover {
            background: linear-gradient(135deg, #ff6c91, #d14468);
            box-shadow: 0 0 14px rgba(243, 85, 122, 0.7);
        }


        /* Cancel button */
        #editor-cancel-btn {
            background: #333;
            color: #fff;
        }

        #editor-cancel-btn:hover {
            background: #444;
        }

        /* ================== End Card untuk tombol membuat novel ====================== */

        /* ===================== Editor Novel ======================== */
        #script-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(5px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
        }

        #script-editor-overlay.visible {
            opacity: 1;
        }

        .script-editor-container {
            width: 95%;
            height: 95vh;
            border-radius: 15px;
            padding: 25px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .script-editor-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #asset-preview-content video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            background-color: #000;
        }

        /* Styling untuk Indikator Loading pada Tombol Tambah Aset */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .add-asset-btn .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Saat tombol dalam mode loading */
        .add-asset-btn.loading {
            pointer-events: none;
            border-style: solid;
        }

        .add-asset-btn.loading .plus-icon {
            display: none;
        }

        .add-asset-btn.loading .spinner {
            display: block;
        }

        /* --- Tambahan untuk Tab Sidebar --- */
        .editor-sidebar {
            padding: 0;
            flex-basis: 300px;
            flex-shrink: 0;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #444;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .sidebar-tab:hover {
            color: white;
        }

        .sidebar-tab.active {
            color: #00ffff;
            border-bottom-color: #00ffff;
        }

        .sidebar-content {
            display: none;
            /* Sembunyikan panel secara default */
            padding: 15px;
            width: 100%;
            box-sizing: border-box;
            flex-direction: column;
        }

        .sidebar-content.active {
            display: flex;
        }

        /* Penjelajah Aset */
        #asset-explorer-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .asset-category {
            margin-bottom: 15px;
        }

        .asset-category h4 {
            color: #00ffff;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .asset-item .delete-asset-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            /* Sembunyi secara default */
            transition: opacity 0.2s, transform 0.2s;
            transform: scale(0.8);
        }

        .asset-item:hover .delete-asset-btn {
            opacity: 1;
            transform: scale(1);
        }

        .add-asset-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 50px;
            margin-top: 10px;
            border: 2px dashed #555;
            background-color: #2a2a2a;
            color: #888;
            font-size: 2rem;
            font-weight: 200;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-asset-btn:hover {
            border-color: #00ffff;
            color: #00ffff;
        }

        .asset-item:hover {
            background-color: #3a3a3a;
        }

        .asset-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .asset-item .file-name {
            font-size: 0.85em;
            color: #ccc;
            word-break: break-all;
        }

        .asset-item .ganti-btn {
            margin-left: auto;
            padding: 4px 10px;
            font-size: 0.8em;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .asset-item .ganti-btn:hover {
            background-color: #008080;
        }

        /* ------------------ Layout Editor Utama --------------------- */
        #script-editing-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        #global-asset-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: #888;
            text-align: center;
        }

        #global-asset-view h3 {
            margin-bottom: 10px;
        }

        #asset-preview-container {
            background-color: #111;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        /* Buat kontainer pratinjau menjadi titik acuan untuk tombol */
        #asset-preview-content {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            overflow: hidden;
            border-radius: 4px;
        }

        #asset-preview-content .ganti-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;

            opacity: 0;
            /* Sembunyi secara default */
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Tampilkan tombol saat kursor berada di atas area pratinjau */
        #asset-preview-content:hover .ganti-btn {
            opacity: 1;
            pointer-events: auto;
        }

        /* Efek hover pada tombol itu sendiri */
        #asset-preview-content .ganti-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
            background-color: rgba(0, 0, 0, 0.9);
        }

        /* --- Kategori Khusus untuk Cover Novel --- */
        .cover-preview-category {
            width: 100%;
            padding: 15px;
            background-color: #1c1c1c;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .asset-category h4 {
            color: #00ffff;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .cover-image-wrapper {
            position: relative;
            width: 100%;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .cover-image-wrapper .cover-image-full {
            width: 100%;
            height: auto;
            /* Tinggi otomatis menyesuaikan rasio */
            display: block;
            transition: transform 0.3s ease;
        }

        .cover-image-wrapper .ganti-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9em;
            font-weight: bold;

            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            /* Agar teks tidak terpotong */
        }

        /* Efek saat kursor di atas gambar cover */
        .cover-image-wrapper:hover .ganti-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .cover-image-wrapper:hover .cover-image-full {
            transform: scale(1.05);
        }

        .cover-image-wrapper .ganti-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;

            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        /* Efek saat kursor di atas gambar */
        .cover-image-wrapper:hover .ganti-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .cover-image-wrapper:hover .book-cover {
            transform: scale(1.1);
            /* Efek zoom-in pada gambar */
        }

        /* Gaya untuk nama file di bawah cover */
        .cover-container .file-name {
            font-size: 0.8em;
            color: #aaa;
        }

        #asset-preview-content img,
        #asset-preview-content audio {
            max-width: 100%;
            max-height: 400px;
            /* Batasi tinggi maksimal pratinjau */
            border-radius: 4px;
        }

        #close-asset-preview {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.8rem;
            color: #888;
            cursor: pointer;
            line-height: 1;
            transition: all 0.2s;
            z-index: 100;
        }

        #close-asset-preview:hover {
            color: #ff4d4d;
            transform: scale(1.1);
        }

        .editor-layout {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            min-height: 0;
            align-items: stretch;
        }

        .editor-sidebar {
            display: flex;
            flex-direction: column;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            transition: flex-basis 0.4s cubic-bezier(0.25, 1, 0.5, 1), padding 0.4s ease, opacity 0.3s ease, margin 0.4s ease;
            overflow: hidden;
            /* agar konten tidak bocor saat collapsed */
        }

        .editor-sidebar.collapsed {
            flex-basis: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            opacity: 0;
            pointer-events: none;
            border: none;
        }

        .editor-content {
            flex-grow: 1;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        #add-chapter-control-container {
            margin-top: 15px;
            border-top: 1px solid #444;
            padding-top: 15px;
        }

        #add-chapter-control-container button,
        #add-chapter-control-container input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
        }

        #show-add-chapter-input-btn {
            background-color: #333;
            color: #ccc;
            border: 1px solid #555;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        #show-add-chapter-input-btn:hover {
            background-color: #f3557a;
            border-color: #f3557a;
            color: white;
        }


        /* --- Area Daftar & Editor --- */
        #editor-chapter-list-editable {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 5px;
        }

        #script-editor-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #1c1c1c;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        #script-editor-controls {
            display: block;
            flex-shrink: 0;
        }

        #chapter-asset-content {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            max-height: 250px;
            overflow-y: auto;
            background-color: #1c1c1c;
            padding: 15px;
            border-radius: 8px;
        }

        /* --- Item Chapter & Dialog --- */
        .chapter-edit-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background-color: #282828;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .chapter-edit-item:hover {
            background-color: #383838;
        }

        .chapter-name-display,
        .chapter-name-input {
            flex-grow: 1;
            margin-right: 8px;
            font-size: 1rem;
            color: #eee;
        }

        .chapter-name-input {
            padding: 6px;
            border: 1px solid #555;
            border-radius: 3px;
            background-color: #333;
        }

        .chapter-item-controls {
            display: flex;
            gap: 4px;
        }

        .chapter-item-controls button {
            background-color: transparent;
            color: #bbb;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            /* Sedikit diperbesar agar ikon lebih jelas */
            line-height: 1;
            transition: color 0.2s ease;
        }

        .chapter-item-controls button:hover {
            color: #fff;
        }

        .chapter-edit-actions {
            display: flex;
            gap: 4px;
        }

        .chapter-edit-actions button {
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            /* Sedikit diperbesar */
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .chapter-edit-actions .save-chapter-btn {
            background-color: #4CAF50;
            /* Hijau */
        }

        .chapter-edit-actions .save-chapter-btn:hover {
            background-color: #45a049;
        }

        .chapter-edit-actions .cancel-edit-btn {
            background-color: #f44336;
            /* Merah */
        }

        .chapter-edit-actions .cancel-edit-btn:hover {
            background-color: #d32f2f;
        }

        .chapter-edit-item:hover,
        .chapter-edit-item.active {
            background: #f66a8a;
        }

        .dialogue-entry-card {
            background: #333;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #00ffff;
        }

        .dialogue-entry-card label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .dialogue-entry-card input[type="text"],
        .dialogue-entry-card select {
            width: 100%;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .delete-dialogue-btn {
            background: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            margin-top: 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .dialogue-main-row {
            display: flex;
            gap: 15px;
            /* Jarak antara kolom teks dan kolom voice */
            align-items: flex-start;
            /* Sejajarkan bagian atas kedua kolom */
        }

        /* Pembungkus untuk label dan textarea agar bisa jadi satu kolom */
        .dialogue-text-wrapper {
            flex-grow: 1;
            /* PENTING: Membuat kolom ini mengisi semua ruang kosong */
        }

        /* Volume control */
        .volume-control-wrapper {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            background-color: #222;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .volume-control-wrapper label {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 0;
            /* Override margin default */
        }

        .volume-control-wrapper input[type="range"] {
            flex-grow: 1;
        }

        .volume-control-wrapper .volume-percentage {
            font-size: 0.85em;
            font-weight: bold;
            color: #fff;
            min-width: 40px;
            text-align: right;
        }

        /* Styling untuk Pratinjau Audio yang Ditingkatkan */
        .audio-preview-container {
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 40px;
            margin-top: 5px;
            margin-bottom: 10px;
            width: 100%;
            /* Pastikan kontainer mengisi ruang */
        }

        .progress-wrapper {
            flex-grow: 1;
            /* Biarkan bagian ini mengisi sisa ruang */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            border: 1px solid #444;
            position: relative;
            /* PENTING: Agar elemen anak bisa diposisikan absolut */
        }

        .progress-fill,
        .progress-delay-fill {
            position: absolute;
            /* Keduanya sekarang absolut */
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
        }

        .progress-fill {
            width: 0%;
            background-color: #00ffff;
            z-index: 2;
            /* Pastikan bar biru di atas bar kuning */
            transition: width 0.1s linear;
        }

        .progress-delay-fill {
            width: 0%;
            background-color: #f1c40f;
            /* Warna kuning untuk indikator delay */
            z-index: 1;
            /* Di belakang bar biru */
            /* Transisi diatur via JavaScript untuk durasi yang dinamis */
        }

        .time-display {
            font-size: 0.8em;
            color: #aaa;
            font-family: monospace;
            white-space: nowrap;
        }

        .play-pause-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #777;
            background-color: #333;
            color: #eee;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            /* Mencegah tombol gepeng */
        }

        .play-pause-btn:hover:not(:disabled) {
            border-color: #00ffff;
            background-color: #008080;
        }

        .play-pause-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .play-pause-btn.playing {
            border-color: #ffdd57;
            background-color: #c5a934;
        }

        .play-pause-btn::before {
            content: '';
            margin-left: 2px;
            /* Penyesuaian posisi ikon play */
        }

        .play-pause-btn.playing::before {
            content: '';
            font-size: 12px;
            margin-left: 0;
            /* Reset penyesuaian posisi */
        }

        .image-preview {
            max-width: 150px;
            height: auto;
            border-radius: 4px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #555;
            background-color: #000;
            display: none;
        }

        .image-preview-container-16-9 {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #000;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            border: 1px solid #444;
        }

        .image-preview-container-16-9 .image-preview {
            /* Properti utama untuk mengisi wadah */
            width: 100%;
            height: 100%;
            object-fit: cover;

            /* Reset properti dari aturan .image-preview umum */
            max-width: none;
            margin: 0;
            border-radius: 0;
            border: none;
            display: block;
        }

        .background-mode-options {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            background-color: #222;
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            padding-left: 90px;
            position: relative;
        }

        /* Menargetkan label pertama ("Tampilan:") */
        .background-mode-options>label:first-child {
            flex-shrink: 0;
            font-weight: bold;
            /* TARIK KEMBALI LABEL PERTAMA KE KIRI */
            margin-left: -64px;
        }

        /* Menargetkan label-label opsi (Crop & Fit) */
        .background-mode-options>label:not(:first-child) {
            cursor: pointer;
            flex: 1 1 auto;
            min-width: 120px;
        }

        .background-mode-options label {
            cursor: pointer;
        }

        .audio-preview {
            width: 100%;
            height: 30px;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .dialogue-entry-card textarea {
            width: 100%;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
            margin-bottom: 8px;
            font-family: 'Lexend', sans-serif;
            resize: vertical;
        }

        /* --- Tombol-tombol --- */
        .editor-button-save {
            background: #f3557a;
            color: black;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .editor-button-cancel {
            background: #555;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #add-dialogue-btn,
        #add-scene-btn,
        #add-phase-btn {
            display: none;
        }

        .phase-card-controls {
            display: flex;
            gap: 15px;
            margin: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
            padding-top: 15px;
        }

        .phase-card-controls button {
            background-color: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .phase-card-controls button:hover {
            background-color: #008080;
            color: white;
            border-color: #00ffff;
        }

        /* Tombol "Tambah Fase Baru" yang baru dan lebih gaya */
        #add-phase-btn-styled {
            width: 100%;
            margin-top: 20px;
            padding: 30px;
            border: 2px dashed #555;
            background: #1c1c1c;
            border-radius: 10px;
            color: #888;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #add-phase-btn-styled:hover {
            background: #2a2a2a;
            border-color: #00ffff;
            color: #00ffff;
        }

        #add-phase-btn-styled .plus-icon {
            font-size: 2rem;
            font-weight: 200;
        }

        #add-phase-btn-styled .create-text {
            margin-top: 5px;
            font-weight: bold;
        }

        /* --- Phase Card (Kartu Fase Utama) --- */
        .phase-card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            /*border-left: 3px solid #00ffff;*/
            padding: 0;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Styling untuk Phase Card yang merupakan Ending */
        .phase-card.is-ending {
            border-color: #f3557a;
            background-color: #2b1e23;
            border-left-width: 3px;
        }

        /* --- Header Fase (Pengaturan Aset) --- */
        .phase-header {
            background: none;
            border: none;
            border-radius: 0;
            padding: 20px;
            /* Sekarang header yang mengatur padding atas */
            margin-bottom: 0;
            border-bottom: 1px solid #333;
            /* Garis pemisah dengan konten */
        }

        .phase-header h3 {
            margin: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-header h3 input.phase-name-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 2px dashed #555;
            transition: border-color 0.2s;
        }

        .phase-header h3 input.phase-name-input:focus {
            outline: none;
            border-color: #00ffff;
        }

        .phase-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-ending-toggle {
            margin-top: 15px;
            padding-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
            font-size: 0.9em;
        }

        .is-ending-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .delete-phase-btn {
            background-color: #555;
            color: #ccc;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: auto;
            transition: all 0.2s ease;
        }

        .delete-phase-btn:hover {
            background-color: #e74c3c;
            /* Warna merah saat di-hover */
            color: white;
            transform: scale(1.1);
        }

        .label-config-row>div {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .label-config-row>div>label {
            flex-shrink: 0;
        }

        .label-config-row>div>.file-input-group {
            flex-grow: 1;
        }

        .label-config-row {
            border-radius: 8px;
            margin-bottom: 15px;
            gap: 15px;
        }

        .label-config-row label {
            font-size: 0.85rem;
            font-weight: bold;
            color: #ccc;
            flex-shrink: 0;
            min-width: 200px;
            /* Supaya label rapi sejajar */
        }

        .label-config-row .file-input-group {
            flex-grow: 1;
        }

        .label-config-row select {
            width: 60%;
            padding: 8px 10px;
            background-color: #1c1c1c;
            border: 1px solid #444;
            color: #eee;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .label-config-row select:hover {
            background-color: #222;
            border-color: #00cccc;
        }

        .label-config-row select:focus {
            outline: none;
            border-color: #00ffff;
            background-color: #222;
        }

        .phase-assets {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .phase-assets>div {
            flex: 1;
            min-width: 0;
        }

        .phase-assets label {
            display: block;
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .phase-assets input[type="text"] {
            width: 100%;
            background-color: #1c1c1c;
            border: 1px solid #444;
            color: #eee;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;

            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-controls-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            flex-wrap: wrap;
        }

        .phase-assets input[type="text"]:focus {
            outline: none;
            border-color: #00ffff;
            background-color: #222;
        }

        .preview-placeholder {
            display: flex;
            /* Defaultnya flex agar bisa ditampilkan oleh JS */
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: #777;
            font-size: 0.9em;
            text-align: center;
            user-select: none;
            padding: 10px;
            box-sizing: border-box;
        }

        /* --- input --- */
        .file-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .file-input-group input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0 !important;
        }

        /* Grup input dengan tombol 'x' di dalamnya */
        .input-with-clear-wrapper {
            position: relative;
            display: flex;
            flex-grow: 1;
            align-items: center;
        }

        .input-with-clear-wrapper .script-input {
            padding-right: 30px;
        }

        .clear-input-btn-inside {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 5px;
            display: none;
            transition: color 0.2s ease;
        }

        .clear-input-btn-inside:hover {
            color: #ff4d4d;
        }

        .input-with-clear-wrapper.has-text .clear-input-btn-inside {
            display: block;
        }

        .browse-file-btn {
            flex-shrink: 0;
            /* Tombol tidak akan menyusut */
            padding: 8px 12px;
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .browse-file-btn:hover {
            background-color: #008080;
        }

        /* --- Konten Fase & Item Entri --- */
        .phase-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .phase-flow-control {
            background-color: #dad8d8;
            margin-top: 15px;
            padding: 15px;
            border-top: 1px solid #3a3a3a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .phase-flow-control label {
            font-weight: bold;
            color: #1a1a1a;
        }

        .phase-flow-control select {
            flex-grow: 1;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }

        /* Styling untuk Label dengan Tooltip */
        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 8px;
            /* Jarak antara teks label dan ikon '?' */
            font-weight: bold;
            color: #ccc;
        }

        .tooltip-trigger {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #777;
            color: #777;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            transition: all 0.2s ease;
        }

        .tooltip-trigger:hover {
            background-color: #777;
            color: #1a1a1a;
        }

        /* Kotak Tooltip yang Muncul */
        .tooltip-trigger .tooltip-text {
            visibility: hidden;
            opacity: 0;
            width: 300px;
            background-color: #f0f0f0;
            color: #1a1a1a;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            /* Posisi di atas ikon '?' */
            left: 5%;
            margin-left: -140px;
            /* Separuh dari lebar untuk menengahkan */
            transition: opacity 0.3s;
            font-weight: normal;
            line-height: 1.4;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Panah kecil di bawah tooltip */
        .tooltip-trigger .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #f0f0f0 transparent transparent transparent;
        }

        /* Tampilkan tooltip saat di-hover */
        .tooltip-trigger:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .entry-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background-color: #2a2a2a;
            border-radius: 6px;
            border-left: 3px solid transparent;
            position: relative;
            min-height: 48px;
        }

        .entry-item .icon {
            font-size: 1.2rem;
            color: #aaa;
            min-width: 20px;
            /* Beri lebar minimum agar teks sejajar */
            text-align: center;
        }

        .entry-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #555;
            color: #ccc;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .entry-item:hover .delete-btn {
            opacity: 1;
        }

        .entry-item .delete-btn:hover {
            background-color: #ff4d4d;
            color: white;
        }

        /* --- Styling Spesifik per Tipe Entri --- */

        /* DIALOGUE */
        .entry-item.dialogue {
            border-left-color: #00ffff;
        }

        .entry-item.dialogue .speaker {
            font-weight: bold;
            color: #00ffff;
            margin-right: 8px;
            /* Jarak antara speaker dan teks */
        }

        .entry-item.dialogue .text {
            color: #ddd;
        }

        .sprite-config-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-top: 10px;
        }

        .sprite-config-container .image-preview {
            margin: 0;
            flex-shrink: 0;
        }

        /* Wadah animasi sprite - tetap diam dengan overflow hidden */
        .sprite-anim-wrapper {
            max-width: 150px;
            height: auto;
            border-radius: 4px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #555;
            background-color: #000;
            overflow: hidden;
            flex-shrink: 0;
            display: none;
            /* Akan ditampilkan oleh JavaScript */
        }

        .sprite-anim-wrapper.visible {
            display: block;
        }

        /* Gambar di dalam wrapper - ini yang akan bergerak */
        .sprite-anim-wrapper .sprite-anim-img {
            width: 100%;
            height: auto;
            display: block;
        }

        .animation-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: #222;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;

            flex-grow: 1;
            min-width: 180px;
        }

        .animation-label {
            font-size: 0.9em;
            font-weight: bold;
            color: #f3557a;
            opacity: 0.9;
        }

        /*drag handle*/
        .drag-handle {
            cursor: grab;
            color: #888;
            font-size: 1rem;
            padding: 0 4px;
            align-self: stretch;
            display: flex;
            align-items: center;
            border-right: 1px solid #3a3a3a;
            margin-right: 12px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .dialogue-entry-card {
            display: flex;
            align-items: center;
            padding: 0;
        }

        .entry-content {
            flex-grow: 1;
            padding: 12px 12px 12px 0;
        }

        .sortable-ghost {
            background: #2a2a2a;
            border: 2px dashed #555;
            border-radius: 6px;
            opacity: 0.5;
        }

        .sortable-chosen {
            /* Jangan sembunyikan entri saat dipilih, hanya berikan highlight */
            opacity: 1 !important;
            box-shadow: 0 0 15px rgba(243, 85, 122, 0.5);
            transform: scale(1.01);
            z-index: 1000;
        }

        .sortable-drag {
            /* Elemen yang sedang di-drag */
            opacity: 0.9 !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .sortable-fallback {
            opacity: 1 !important;
            background-color: #333 !important;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3) !important;
            transition: none !important;
            z-index: 999999 !important;
        }

        /* SCENE */
        .entry-item.scene {
            border-left-color: #ffaa00;
        }

        .entry-item.scene .icon {
            color: #ffaa00;
        }

        .entry-item.scene .text {
            font-style: italic;
            color: #ccc;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            cursor: pointer;
            user-select: none;
            margin-right: 10px;
        }

        /* Sembunyikan checkbox asli */
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Latar belakang switch (slider) */
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            /* Warna saat OFF */
            transition: .3s;
            border-radius: 26px;
            /* Membuatnya bulat */
        }

        /* Bulatan (knob) switch */
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            /* Ukuran knob */
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        /* Perubahan saat checkbox tercentang (ON) */
        .toggle-switch input:checked+.toggle-slider {
            background-color: #00cccc;
            /* Warna saat ON */
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
            /* Gerakkan knob ke kanan saat ON */
        }

        /* CHOICE */
        .entry-type-scene {
            border-left-color: #00f371;
        }

        .entry-type-choice {
            border-left-color: #aa00ff;
            /* Warna ungu untuk membedakan */
        }

        .entry-type-choice .entry-title {
            font-weight: bold;
            color: #aa00ff;
            font-size: 1.1em;
        }

        .choice-options-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }

        .choice-options-container .sub-label {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 8px;
            display: block;
        }

        .choice-option-editor {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            background-color: #3c3c3c;
            padding: 8px;
            border-radius: 4px;
        }

        .choice-option-editor .jump-arrow {
            color: #aaa;
            font-weight: bold;
        }

        .add-choice-option-btn,
        .remove-option-btn {
            background-color: #555;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .add-choice-option-btn {
            margin-top: 10px;
            padding: 5px 15px;
        }

        .add-choice-option-btn:hover {
            background-color: #008080;
        }

        .remove-option-btn {
            background-color: #703d3d;
            padding: 5px 10px;
            font-weight: bold;
        }

        .remove-option-btn:hover {
            background-color: #ff4d4d;
        }

        .auto-dialogue-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .auto-dialogue-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .auto-dialogue-toggle-wrapper label {
            cursor: pointer;
            font-size: 0.9em;
            color: #ccc;
        }

        .auto-dialogue-options {
            padding-left: 25px;
            display: none;
            /* Sembunyi secara default */
        }

        .auto-dialogue-options.visible {
            display: block;
            /* Tampil jika checkbox diaktifkan */
        }

        .auto-dialogue-options label {
            font-size: 0.9em;
            color: #bbb;
            margin-left: 5px;
        }

        /* ----------------------- label ------------------ */
        .entry-type-label {
            border-left-color: #f1c40f;
            /* Warna kuning untuk label */
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .entry-type-label .entry-title {
            font-weight: bold;
            color: #f1c40f;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .entry-type-label input {
            margin-bottom: 0 !important;
        }

        .label-group-container {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .label-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background-color: rgba(241, 196, 15, 0.05);
            border-bottom: 1px solid #333;
        }

        .label-group-header .label-icon {
            font-size: 1.2rem;
            color: #f1c40f;
            /* Warna kuning khas label */
        }

        .label-group-header .label-name-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 5px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .label-group-header .label-name-input:focus {
            outline: none;
            border-color: #f1c40f;
        }

        .label-group-flow-control {
            margin-top: 15px;
            padding: 15px 10px;
            border-top: 1px solid #3a3a3a;
            /* Garis pemisah */
            background-color: rgba(241, 196, 15, 0.05);
            /* Sedikit bedakan latar belakang */
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .label-group-flow-control label {
            font-weight: bold;
            color: #ccc;
            flex-shrink: 0;
            /* Agar label tidak mengecil */
        }

        .label-group-flow-control select {
            flex-grow: 1;
            padding: 8px;
            background: #444;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }

        /* --- sub-label --- */
        .sub-label-container {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-left: 3px solid #3498db;
            /* Warna biru untuk membedakan */
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .sub-label-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background-color: rgba(52, 152, 219, 0.1);
        }

        .sub-label-header .label-icon {
            font-size: 1rem;
            color: #3498db;
        }

        .sub-label-header .sub-label-name-input {
            flex-grow: 1;
            background: none;
            border: none;
            color: #eee;
            font-size: 1rem;
            font-weight: bold;
            border-bottom: 1px dashed #555;
            padding: 2px 0;
        }

        .sub-label-header .sub-label-name-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .sub-label-content {
            padding: 5px 15px 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Mewarnai opsi di dalam dropdown */
        .option-main-label {
            background-color: rgba(241, 196, 15, 0.25);
            /* Latar belakang kuning transparan */
            color: #f0f0f0;
            /* Pastikan teks tetap cerah */
        }

        .option-sub-label {
            background-color: rgba(52, 152, 219, 0.2);
            /* Latar belakang biru transparan */
            color: #f0f0f0;
            /* Pastikan teks tetap cerah */
        }

        /* Styling untuk kotak <select> */
        select.has-main-label-selection {
            border-color: rgba(241, 196, 15, 0.7) !important;
            /* Pertegas warna bordernya */
        }

        select.has-sub-label-selection {
            border-color: rgba(52, 152, 219, 0.7) !important;
            /* Pertegas warna bordernya */
        }

        /* Tombol Tambah Sub Label di dalam Grup Label */
        .label-group-header .add-sub-label-btn {
            margin-left: auto;
            background-color: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 4px 10px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .label-group-header .add-sub-label-btn:hover {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .sub-label-flow-control {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: rgba(52, 152, 219, 0.05);
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .sub-label-flow-control label {
            font-weight: bold;
            color: #ccc;
            flex-shrink: 0;
        }

        .sub-label-flow-control select {
            flex-grow: 1;
            padding: 6px;
            background: #2a2a2a;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }

        /* Tombol preview untuk grup label */
        .preview-label-group-btn {
            background-color: transparent;
            color: #9b59b6;
            border: 1px dashed #9b59b6;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.8em;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .preview-label-group-btn:hover {
            background-color: rgba(155, 89, 182, 0.15);
            border-style: solid;
        }

        /* Tombol hapus untuk grup label */
        .delete-label-group-btn {
            background-color: transparent;
            color: #888;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .delete-label-group-btn:hover {
            background-color: #e74c3c;
            color: white;
            transform: scale(1.1);
        }

        /* Konten di dalam grup label */
        .label-group-content {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ------------------------- End label -------------------- */

        /* ================== Transisi Keluar (Exit Transition) ================== */
        .phase-exit-transition,
        .label-exit-transition {
            padding: 12px 15px;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            background-color: rgba(100, 100, 100, 0.08);
        }

        .phase-exit-transition label,
        .label-exit-transition label {
            display: block;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 6px;
        }

        .phase-exit-transition select,
        .label-exit-transition select {
            width: 100%;
            max-width: 300px;
            padding: 6px 10px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #ccc;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .phase-exit-transition select:focus,
        .label-exit-transition select:focus {
            outline: none;
            border-color: #666;
        }

        /* ================== End Transisi Keluar ================== */


        /* Tombol x Hapus */
        .entry-item .delete-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 10px;
            background-color: #3f3f3f;
            color: #aaa;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            line-height: 24px;
            text-align: center;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .entry-item:hover .delete-btn {
            opacity: 1;
        }

        .entry-item .delete-btn:hover {
            background-color: #ff4d4d;
            color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .label-group-content {
            padding-left: 15px;
            margin-top: 10px;
        }

        /* ================== End Editor Novel ====================== */

        /* === SPRITE ANIMATION PREVIEW (Editor Preview) === */
        /* Keyframes untuk animasi sprite preview di editor */
        @keyframes editorSlideFromBottom {
            from {
                opacity: 0;
                transform: translateY(15%);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes editorSlideFromLeft {
            from {
                opacity: 0;
                transform: translateX(-15%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes editorSlideFromRight {
            from {
                opacity: 0;
                transform: translateX(15%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes editorFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes editorFadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes editorSlideToBottom {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(15%);
            }
        }

        @keyframes editorPulseGlow {
            0% {
                filter: brightness(1);
            }

            100% {
                filter: brightness(1.15);
            }
        }

        @keyframes editorGentleFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes editorShake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-3px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(3px);
            }
        }

        @keyframes editorJump {

            0%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-15px);
            }

            50% {
                transform: translateY(0);
            }

            70% {
                transform: translateY(-8px);
            }
        }

        @keyframes editorPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* Kelas animasi untuk editor preview - terus berjalan (infinite) */
        .editor-anim-in-fade {
            animation: editorFadeIn 1.5s ease-in-out infinite alternate;
        }

        .editor-anim-in-slide-from-bottom {
            animation: editorSlideFromBottom 1.5s ease-in-out infinite alternate;
        }

        .editor-anim-in-slide-from-left {
            animation: editorSlideFromLeft 1.5s ease-in-out infinite alternate;
        }

        .editor-anim-in-slide-from-right {
            animation: editorSlideFromRight 1.5s ease-in-out infinite alternate;
        }

        .editor-anim-out-fade {
            animation: editorFadeOut 1.5s ease-in-out infinite alternate-reverse;
        }

        .editor-anim-out-slide-to-bottom {
            animation: editorSlideToBottom 1.5s ease-in-out infinite alternate;
        }

        .editor-anim-out-slide-to-left {
            animation: editorSlideFromRight 1.5s ease-in-out infinite alternate-reverse;
        }

        .editor-anim-out-slide-to-right {
            animation: editorSlideFromLeft 1.5s ease-in-out infinite alternate-reverse;
        }

        .editor-anim-loop-pulse-glow {
            animation: editorPulseGlow 1.5s infinite alternate;
        }

        .editor-anim-loop-gentle-float {
            animation: editorGentleFloat 2s ease-in-out infinite;
        }

        .editor-anim-loop-shake {
            animation: editorShake 0.8s ease-in-out infinite;
        }

        .editor-anim-oneshot-shake {
            animation: editorShake 0.8s ease-in-out infinite;
        }

        .editor-anim-oneshot-jump {
            animation: editorJump 1.2s ease-out infinite;
        }

        .editor-anim-loop-pulse {
            animation: editorPulse 1.5s ease-in-out infinite;
        }

        /* ======================= Main Screen (Layar Utama) ========================== */
    </style>
    <!-- Graph Visualization Libs -->
    <script src="vnLib/cytoscape.min.js"></script>
    <script src="vnLib/dagre.min.js"></script>
    <script src="vnLib/cytoscape-dagre.min.js"></script>
</head>

<body>

    <div id="black-scene" class="black-scene"></div>

    <!-- Intro Scene -->
    <div id="intro-scene" class="intro-scene">
        <div class="tips-container">
            <div class="tips-header">Info</div>
            <div class="tips-content">
                <b style="color: lightcoral;">Penting untuk di ketahui !! :</b>
                <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.85;">
                    Ini adalah versi eksperimental. Beberapa fitur dan inovasi belum diimplementasikan sepenuhnya.
                    Konsep mekanisme pembuatan dan gameplay visual novel oleh pemain suatu saat bisa berubah di versi
                    mendatang.
                </p>
                <p>Untuk saat ini masih dalam tahap penerapan hal dasar visual novel, Fitur animasi transisi pada entri
                    Scene atau animasi transisi antar label dan fase belum di uji secara mendalam, jadi mungkin masih
                    ada
                    beberapa bug atau ketidaksempurnaan.</p>
            </div>
        </div>
        <div class="continue-section">
            <img src="/aset/Harmony/char0.png" alt="Character" class="character-image-small">
            <span class="continue-text">Press Enter</span>
        </div>
    </div>

    <!-- Background Video -->
    <video class="background-video" muted></video>
    <!-- Overlay gelap di atas video -->
    <div class="video-overlay"></div>

    <!-- Navbar -->
    <div class="navbar">
        <h1>GAP VN Player</h1>
        <div class="layout-switch">
            <button id="switchLayoutBtn">Switch Layout</button>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search novel..." />
            <button id="searchBtn">Search</button>
        </div>
    </div>

    <!-- Container Menu -->
    <div class="menu-container">
        <h1 class="menu-title">Select Novels</h1>
        <div id="story-grid" class="story-grid"></div>
        <div class="carousel-arrow-container">
            <button class="carousel-arrow left" id="prevBtn" style="display:none;"></button>
            <button class="carousel-arrow right" id="nextBtn" style="display:none;"></button>
        </div>
    </div>

    <!-- Buat Novel -->
    <div id="create-novel-modal" class="modal-overlay">
        <div class="modal-wrapper">
            <div class="modal-content">
                <h2>Buat Novel Baru</h2>

                <div class="modal-form-container">
                    <div class="form-inputs-column">
                        <input type="text" id="new-novel-title-input" placeholder="Masukkan Judul Novel...">
                        <textarea id="new-novel-desc-input" placeholder="Deskripsi tagline novel... (maks 80 karakter)"
                            maxlength="80" rows="2"></textarea>
                        <input type="file" id="new-novel-cover-input" accept="image/jpeg, image/png, image/webp" hidden>
                        <label for="new-novel-cover-input" id="cover-upload-label">Pilih Gambar Cover</label>
                    </div>

                    <div id="modal-image-preview">
                        <span>Pratinjau Cover</span>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button id="cancel-create-btn">Batal</button>
                    <button id="confirm-create-btn">Lanjut</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Layar penuh -->
    <div id="hub-editor-overlay">
        <div class="editor-layout-wrapper">
            <div class="editor-header-bar">
                <h1 id="editor-title">Kustomisasi Novel</h1>
                <div class="editor-actions">
                    <button id="editor-cancel-btn">Batal</button>
                    <button id="editor-save-btn">Simpan & Selesai</button>
                </div>
            </div>

            <div class="editor-content-grid">
                <!-- Left Column -->
                <div class="editor-column">
                    <div class="editor-section">
                        <h3>Deskripsi Novel</h3>
                        <textarea id="editor-description"
                            placeholder="Tulis deskripsi singkat tentang novelmu..."></textarea>
                    </div>

                    <div class="editor-section">
                        <h3>Informasi Tambahan</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label
                                    style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa;">Genre</label>
                                <input type="text" id="editor-genre" placeholder="Contoh: Romance, Fantasy">
                            </div>
                            <div>
                                <label
                                    style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa;">Penulis</label>
                                <input type="text" id="editor-author" placeholder="Nama Penulis">
                            </div>
                            <div>
                                <label
                                    style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa;">Ilustrator</label>
                                <input type="text" id="editor-illustrator" placeholder="Nama Ilustrator">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa;">VN
                                    Mapper</label>
                                <input type="text" id="editor-vn-mapper"
                                    placeholder="Nama pembuat VN (yang mengatur scene/script)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="editor-column">
                    <div class="editor-section" style="flex: 1; display: flex; flex-direction: column;">
                        <h3>Gambar Slideshow</h3>
                        <p style="font-size: 0.9em; opacity: 0.7; margin-bottom: 15px;">Pilih beberapa gambar untuk
                            slideshow di halaman detail novel.</p>

                        <div id="slideshow-inputs-container">
                            <input type="file" class="editor-slideshow-input"
                                accept="image/jpeg, image/png, image/webp">
                        </div>

                        <button id="add-slideshow-input"
                            style="margin-top: 10px; width: 100%; padding: 12px; background: #222; border: 1px dashed #555; color: #aaa; cursor: pointer; border-radius: 6px; transition: all 0.2s;">+
                            Tambah Slot Gambar</button>

                        <div id="editor-slideshow-preview"
                            style="margin-top: 20px; flex: 1; background: #111; border-radius: 8px; padding: 15px; min-height: 120px;">
                        </div>
                    </div>

                    <div class="editor-section">
                        <h3>Video Latar Belakang Menu</h3>
                        <p style="font-size: 0.9em; opacity: 0.7; margin-bottom: 15px;">
                            Video ini akan diputar di latar belakang saat novel ini disorot di menu utama.
                        </p>
                        <input type="file" id="editor-background-video-input" accept="video/mp4,video/webm" hidden>

                        <div
                            style="display: flex; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px;">
                            <label for="editor-background-video-input" id="video-upload-label" class="file-input-label"
                                style="cursor: pointer; padding: 10px 20px; background: #333; border: 1px solid #555; border-radius: 4px; display: inline-block; color: white; transition: background 0.2s;">
                                 Pilih Video (.mp4)
                            </label>
                            <span id="video-preview-name" style="opacity: 0.8; font-style: italic; color: #aaa;">Belum
                                ada video dipilih</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Layar penuh edit cerita atau buat bagian cerita -->
    <div id="script-editor-overlay" style="display: none;">
        <div class="script-editor-container">
            <div id="editor-novel-selection-screen">
                <h2>Pilih Novel untuk Diedit</h2>
                <div id="editor-novel-list" class="story-grid"></div>
                <button id="close-editor-btn" class="editor-button-cancel">Tutup</button>
            </div>

            <div id="editor-main-screen" style="display: none;">
                <button id="back-to-novel-selection-btn" class="editor-button-cancel">Kembali ke Pilihan Novel</button>
                <h2 id="editor-main-title">Mengedit Novel: <span id="editing-novel-name"></span></h2>
                <div class="editor-layout">
                    <div class="editor-sidebar">
                        <div class="sidebar-tabs">
                            <button class="sidebar-tab" data-tab="assets">Novel</button>
                            <button class="sidebar-tab active" data-tab="chapters">Chapters</button>
                        </div>

                        <div id="sidebar-content-chapters" class="sidebar-content active">
                            <h3>Daftar Chapter</h3>
                            <div id="editor-chapter-list-editable"></div>
                            <div id="add-chapter-control-container">
                                <input type="text" id="editor-new-chapter-name"
                                    placeholder="Ketik nama chapter, tekan Enter..." style="display: none;">
                                <button id="show-add-chapter-input-btn">+ Tambah Chapter Baru</button>
                            </div>
                        </div>

                        <div id="sidebar-content-assets" class="sidebar-content">
                            <div id="asset-explorer-content">
                                <p style="opacity:0.7; font-size:0.9em;">Pilih novel untuk melihat aset...</p>
                            </div>
                        </div>
                    </div>
                    <div class="editor-content">
                        <div id="script-editing-wrapper">
                            <div class="editor-header-wrapper"
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                                <h3 id="editing-chapter-name" style="margin: 0;">Pilih chapter untuk diedit</h3>
                                <button id="btn-visualize-flow" title="Visualisasi Alur"
                                    onclick="if(typeof window.visualisasiAlur === 'function') { window.visualisasiAlur(); } else { console.error('visualisasiAlur tidak ditemukan'); }"
                                    style="background: transparent; border: 1px solid #555; color: #aaa; padding: 5px 12px; border-radius: 4px; cursor: pointer; display: none; font-size: 0.9em; transition: all 0.2s;">
                                    <span
                                        style="font-size: 1.1em; vertical-align: middle; margin-right: 5px;">Visualisasi
                                        Alur</span>
                                </button>
                            </div>

                            <div id="asset-preview-container" style="display: none;">
                                <span id="close-asset-preview" title="Tutup Pratinjau">&times;</span>
                                <div id="asset-preview-content"></div>
                            </div>

                            <div id="script-editor-area"></div>
                            <div id="script-editor-controls" style="display: none;">
                                <button id="add-dialogue-btn">Tambah Dialog</button>
                                <button id="add-scene-btn">Tambah Transisi Scene</button>
                                <button id="add-phase-btn">Tambah Fase Baru</button>
                                <button id="save-script-btn" class="editor-button-save">Simpan Perubahan</button>
                            </div>
                            <div id="chapter-asset-explorer" style="display: none;">
                                <h3>Aset Chapter Ini</h3>
                                <div id="chapter-asset-content">
                                    <p style="opacity:0.7; font-size:0.9em;">Aset untuk chapter ini akan muncul di sini.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div id="global-asset-view" style="display: none;">
                            <h3>Pratinjau Aset Global</h3>
                            <p>Pilih aset di samping untuk melihat pratinjau di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');
        let dragTooltip;

        // === DOM Elements ===
        const introScene = document.getElementById('intro-scene');
        const backgroundVideo = document.querySelector('.background-video');
        const videoOverlay = document.querySelector('.video-overlay');
        const storyGrid = document.getElementById('story-grid');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const switchLayoutBtn = document.getElementById('switchLayoutBtn');
        const storyGridElement = document.getElementById('story-grid');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        // === Create Novel Elements ===
        const createNovelModal = document.getElementById('create-novel-modal');
        const newNovelTitleInput = document.getElementById('new-novel-title-input');
        const newNovelDescInput = document.getElementById('new-novel-desc-input');
        const confirmCreateBtn = document.getElementById('confirm-create-btn');
        const cancelCreateBtn = document.getElementById('cancel-create-btn');
        const newNovelCoverInput = document.getElementById('new-novel-cover-input');
        const imagePreview = document.getElementById('modal-image-preview');
        const coverUploadLabel = document.getElementById('cover-upload-label');

        // === Hub Editor Elements
        const hubEditor = document.getElementById('hub-editor-overlay');
        const editorSaveBtn = document.getElementById('editor-save-btn');
        const editorCancelBtn = document.getElementById('editor-cancel-btn');
        const editorSlideshowPreview = document.getElementById('editor-slideshow-preview');
        const addSlideshowInputBtn = document.getElementById('add-slideshow-input');
        const slideshowInputsContainer = document.getElementById('slideshow-inputs-container');

        const editorBackgroundVideoInput = document.getElementById('editor-background-video-input');
        const videoPreviewName = document.getElementById('video-preview-name');

        // === Script Editor Elements ===
        const scriptEditorOverlay = document.getElementById('script-editor-overlay');
        const closeEditorBtn = document.getElementById('close-editor-btn');
        const editorNovelSelectionScreen = document.getElementById('editor-novel-selection-screen');
        const editorNovelList = document.getElementById('editor-novel-list');
        const editorMainScreen = document.getElementById('editor-main-screen');
        const backToNovelSelectionBtn = document.getElementById('back-to-novel-selection-btn');
        const editingNovelName = document.getElementById('editing-novel-name');
        const editorChapterListEditable = document.getElementById('editor-chapter-list-editable');
        const scriptEditorArea = document.getElementById('script-editor-area');
        const scriptEditorControls = document.getElementById('script-editor-controls');
        const saveScriptBtn = document.getElementById('save-script-btn');
        const editingChapterName = document.getElementById('editing-chapter-name');
        const editorAddNewChapterBtn = document.getElementById('editor-add-new-chapter-btn');
        const editorNewChapterNameInput = document.getElementById('editor-new-chapter-name');

        const scriptEditingWrapper = document.getElementById('script-editing-wrapper');
        const globalAssetView = document.getElementById('global-asset-view');
        const assetPreviewContainer = document.getElementById('asset-preview-container');
        const chapterAssetExplorer = document.getElementById('chapter-asset-explorer');

        // === State Variables ===
        let storiesData = [];
        let hoverTimeout = null;
        let fadeInInterval = null;
        let fadeOutInterval = null;
        let currentCenterIndex = 0;
        let defaultCenterIndex = 0;
        let currentlyEditingNovel = null;
        let extraOffsetY = 385;
        let isCreatingNewNovelFlow = false;
        let currentPreviewAudio = null;
        let defaultCenterTimeout = null; // Timeout ID untuk setDefaultCenterIndex
        let userHasInteractedWithCarousel = false; // Flag untuk menandai interaksi pengguna
        let isInitialLoad = true; // Flag untuk menandai load pertama kali
        let isNavigating = false; // Flag untuk debounce navigasi carousel
        let currentlyEditing = {
            novel: null,
            chapter: null
        };

        // ---------------------- Notifikasi -------------------- //
        let notificationTimeout;

        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notification-toast');

            clearTimeout(notificationTimeout);

            toast.textContent = message;
            toast.className = 'notification-toast';
            toast.classList.add(type);

            toast.classList.add('show');

            // menyembunyikan notifikasi setelah 3 detik
            notificationTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        // ------------------- End Notifikasi ------------------- //

        // --------------------- confirmation --------------------- //
        /**
         * Menampilkan modal konfirmasi kustom.
         * @param {string} message - Pesan yang ditampilkan di modal.
         * @param {boolean} alertOnly - Jika true, hanya menampilkan tombol OK (mode alert). Default: false.
         * @returns {Promise<boolean>} - Resolve true jika user klik Ya/OK, false jika klik Batal.
         */
        function showConfirmation(message, alertOnly = false) {
            return new Promise(resolve => {
                const overlay = document.getElementById('confirmation-modal-overlay');
                const textElement = document.getElementById('confirmation-modal-text');
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                textElement.textContent = message;
                overlay.classList.add('visible');

                // Atur visibilitas tombol berdasarkan mode
                if (alertOnly) {
                    noBtn.style.display = 'none';
                    yesBtn.textContent = 'OK';
                } else {
                    noBtn.style.display = 'inline-block';
                    yesBtn.textContent = 'Yakin';
                }

                const close = (result) => {
                    overlay.classList.remove('visible');
                    // Hapus listener agar tidak menumpuk
                    yesBtn.onclick = null;
                    noBtn.onclick = null;
                    // Reset tampilan tombol ke default
                    noBtn.style.display = 'inline-block';
                    yesBtn.textContent = 'Yakin';
                    resolve(result);
                };

                // Pasang listener untuk tombol
                yesBtn.onclick = () => close(true);
                noBtn.onclick = () => close(false);
            });
        }
        // ------------------- End confirmation ------------------- //

        // ------------------- Visualization Flow Logic ------------------- //
        let cyInstance = null;
        let vizMode = 'detail'; // 'detail' atau 'summary'

        window.visualisasiAlur = function (mode = 'detail') {
            console.log("[Visualisasi] Fungsi dipanggil. Mode:", mode);
            vizMode = mode;

            if (!currentlyEditing.novel || !currentlyEditing.chapter) {
                console.warn("[Visualisasi] Chapter belum dipilih.");
                showNotification('Buka editor chapter terlebih dahulu.', 'error');
                return;
            }

            const flowModal = document.getElementById('flow-visualization-modal');
            if (!flowModal) {
                console.error("[Visualisasi] Modal #flow-visualization-modal tidak ditemukan.");
                return;
            }

            // Tampilkan modal dengan menambahkan class visible
            flowModal.classList.add('visible');

            // Update info chapter di header
            const chapterInfo = document.getElementById('viz-chapter-info');
            if (chapterInfo) {
                chapterInfo.textContent = ` ${currentlyEditing.novel}  ${currentlyEditing.chapter}`;
            }

            console.log("[Visualisasi] Modal ditampilkan. Mulai ekstraksi...");

            try {
                // Pastikan library ada
                if (typeof cytoscape === 'undefined') {
                    throw new Error("Library Cytoscape belum dimuat. Periksa koneksi internet atau path file lokal.");
                }

                console.log("Mengekstrak data grafik...");
                const elements = extractGraphData();
                console.log("[Visualisasi] Data grafik:", elements);

                // Init dengan sedikit delay agar layout container modal stabil
                setTimeout(() => {
                    initCytoscape(elements);
                }, 100);

            } catch (e) {
                console.error("[Visualisasi] Error:", e);
                showNotification("Gagal memuat visualisasi: " + e.message, "error");
            }
        };

        function extractGraphData() {
            const nodes = [];
            const edges = [];
            const labelMap = new Map(); // name -> { id, element }
            const subLabelMap = new Map();
            const phaseList = []; // Untuk tracking urutan fase
            let nodeCounter = 0;

            // Mode: 'detail' = tampilkan semua entri, 'summary' = hanya elemen alur
            const isDetailMode = vizMode === 'detail';

            // Helper untuk generate ID unik
            const genId = (prefix) => `${prefix}_${nodeCounter++}`;

            // Helper untuk potong teks panjang
            const truncate = (text, max = 25) => {
                if (!text) return '';
                return text.length > max ? text.substring(0, max) + '...' : text;
            };

            // Node START
            nodes.push({
                data: {
                    id: 'START',
                    label: ' MULAI',
                    sublabel: 'Awal Cerita',
                    type: 'start'
                }
            });

            const phaseCards = scriptEditorArea.querySelectorAll('.phase-card');

            // === PASS 1: Collect semua Phase, Label, Sub-Label, dan Entri ===
            phaseCards.forEach((phase, pIdx) => {
                const phaseNameInput = phase.querySelector('.phase-name-input');
                const phaseName = phaseNameInput ? phaseNameInput.value.trim() : `Fase ${pIdx + 1}`;
                const phaseId = genId('phase');
                const phaseContent = phase.querySelector('.phase-content');

                // Cek apakah fase ini adalah ending
                const isEndingCheckbox = phase.querySelector('.is-ending-checkbox');
                const isEnding = isEndingCheckbox ? isEndingCheckbox.checked : false;

                // Node fase (Sebagai Parent/Container)
                nodes.push({
                    data: {
                        id: phaseId,
                        label: isEnding ? `Fase Ending : ${phaseName}` : `Fase : ${phaseName}`,
                        sublabel: isEnding ? 'ENDING' : '',
                        type: 'phase',
                        isEnding: isEnding,
                        element: phase,
                        phaseIndex: pIdx + 1
                    }
                });

                phaseList.push({ id: phaseId, name: phaseName, element: phase, isEnding: isEnding });
                let lastNodeInPhase = phaseId; // Awalnya menunjuk ke container, tapi nanti flow akan dari start ke first child

                // Inisialisasi first node tracker untuk menghubungkan fasa sebelumnya ke node pertama di fasa ini
                let firstNodeInPhase = null;

                // Fungsi helper untuk link flow
                const linkFlow = (source, target, type = 'flow') => {
                    if (source && target) {
                        // Jika source adalah phaseId (container dirinya sendiri), jangan buat edge loopback visual aneh
                        // Logikanya: Flow masuk ke Phase -> menujuk ke First Node
                        edges.push({ data: { source: source, target: target, type: type } });
                    }
                };

                // === Ambil entri langsung di fase (di luar label) ===
                const directEntries = phaseContent ? phaseContent.querySelectorAll(':scope > .dialogue-entry-card') : [];
                directEntries.forEach((entry, eIdx) => {
                    const entryType = entry.getAttribute('data-type');

                    if (!isDetailMode && entryType !== 'choice') return;

                    const entryNode = createEntryNode(entry, entryType, genId, truncate);

                    if (entryNode) {
                        entryNode.data.parent = phaseId; // Set Parent
                        nodes.push(entryNode);

                        if (!firstNodeInPhase) firstNodeInPhase = entryNode.data.id;

                        // Link dari node sebelumnya (kecuali jika node sebelumnya adalah phase itu sendiri)
                        if (lastNodeInPhase && lastNodeInPhase !== phaseId) {
                            linkFlow(lastNodeInPhase, entryNode.data.id);
                        }

                        lastNodeInPhase = entryNode.data.id;

                        if (entryType === 'choice') {
                            processChoiceOptions(entry, entryNode.data.id, phaseId, nodes, edges, genId, truncate, isDetailMode);
                        }
                    }
                });

                // === Ambil semua label dalam fase ini ===
                const labelContainers = phase.querySelectorAll(':scope > .phase-content > .label-group-container');
                let prevLabelLastNode = lastNodeInPhase;

                labelContainers.forEach((labelContainer, lIdx) => {
                    const labelNameInput = labelContainer.querySelector('.label-name-input');
                    const labelName = labelNameInput ? labelNameInput.value.trim() : '';

                    if (!labelName) return;

                    const labelId = genId('label');
                    labelMap.set(labelName, { id: labelId, element: labelContainer, phaseId: phaseId });

                    // Logikanya: Parent label selalu 'phaseId' (Label itu anaknya Phase)
                    // TAPI kalo Mode Detail, Label bakal jadi parent buat konten di dalemnya
                    nodes.push({
                        data: {
                            id: labelId,
                            label: ` Label : ${labelName}`,
                            sublabel: 'Label',
                            name: labelName,
                            type: 'label',
                            element: labelContainer,
                            parent: phaseId
                        }
                    });

                    if (!firstNodeInPhase) firstNodeInPhase = labelId;

                    if (prevLabelLastNode && prevLabelLastNode !== phaseId) {
                        linkFlow(prevLabelLastNode, labelId, 'label_flow');
                    }

                    // Di Mode Detail, node-node di dalem label ini harus jadi anak (parent-nya 'labelId').
                    // Kalo di Mode Ringkasan, biasanya nggak ditampilin, atau kalo muncul (kayak pilihan?) 
                    // mungkin mending masuk ke Phase atau Label aja.
                    // Permintaannya emang biar Mode Detail pake label sebagai parent.
                    const contentParentId = isDetailMode ? labelId : phaseId;

                    // Buat Mode Detail, alurnya *mulai* dari dalem kotak label.
                    // Mungkin nggak perlu nge-link 'labelId' -> firstContentNode kalo kotaknya udah jelas,
                    // tapi Cytoscape biasanya tetep butuh edge antar node biar alurnya nyambung.
                    // Kita asumsikan alurnya jalan terus secara linear.

                    let lastNodeInLabel = labelId; // Flow point

                    // Scan isi Label
                    const labelContent = labelContainer.querySelector('.label-group-content');
                    if (labelContent) {
                        const labelChildren = Array.from(labelContent.children);
                        labelChildren.forEach(child => {
                            // Sub-Label
                            if (child.classList.contains('sub-label-container')) {
                                const subNameInput = child.querySelector('.sub-label-name-input');
                                const subName = subNameInput ? subNameInput.value.trim() : '';

                                if (subName) {
                                    const subId = genId('sublabel');

                                    // Daftarkan dengan nama pendek
                                    subLabelMap.set(subName, { id: subId, element: child, parentLabel: labelName });

                                    // Daftarkan juga dengan nama lengkap (parentLabel.subName)
                                    // Karena jump target dari choice biasanya menggunakan format lengkap
                                    const fullSubName = `${labelName}.${subName}`;
                                    subLabelMap.set(fullSubName, { id: subId, element: child, parentLabel: labelName });

                                    nodes.push({
                                        data: {
                                            id: subId,
                                            label: `sub-label : ${subName.split('.').pop()}`,
                                            type: 'sublabel',
                                            element: child,
                                            parent: contentParentId
                                        }
                                    });

                                    linkFlow(lastNodeInLabel, subId, 'sublabel_flow');
                                    lastNodeInLabel = subId;

                                    const subContentParentId = isDetailMode ? subId : contentParentId;

                                    const subContent = child.querySelector('.sub-label-content');
                                    if (subContent) {
                                        const subEntries = Array.from(subContent.children);
                                        // Pass the correct parent ID to children
                                        const res = processEntries(subEntries, lastNodeInLabel, subContentParentId, nodes, edges, genId, truncate, isDetailMode);
                                        if (res) lastNodeInLabel = res;
                                    }
                                }
                            }
                            // Direct Dialogue Entry inside Label
                            else if (child.classList.contains('dialogue-entry-card')) {
                                const res = processSingleEntry(child, lastNodeInLabel, contentParentId, nodes, edges, genId, truncate, isDetailMode);
                                if (res) lastNodeInLabel = res;
                            }
                        });
                    }

                    // Jump/Exit logic
                    const jumpTarget = labelContainer.querySelector('.label-jump-target')?.value?.trim();
                    if (jumpTarget && !jumpTarget.startsWith('##')) {
                        edges.push({ data: { source: lastNodeInLabel, target: `pending:${jumpTarget}`, type: 'jump' } });
                    } else if (jumpTarget === '##EXIT_LABEL##') {
                        const exitId = genId('exit');
                        nodes.push({ data: { id: exitId, label: ' KELUAR', type: 'exit', parent: contentParentId } });
                        linkFlow(lastNodeInLabel, exitId, 'exit_flow');
                        lastNodeInLabel = exitId;
                    } else if (jumpTarget === '##FINISH_PARENT##') {
                        // Selesaikan label induk
                        const finishId = genId('finish_parent');
                        nodes.push({ data: { id: finishId, label: ' SELESAI INDUK', sublabel: 'Label induk selesai', type: 'cmd_finish', parent: contentParentId } });
                        linkFlow(lastNodeInLabel, finishId, 'finish_flow');
                        lastNodeInLabel = finishId;
                    } else if (jumpTarget === '##CONTINUE_PARENT##') {
                        // Lanjut di label induk
                        const continueId = genId('continue_parent');
                        nodes.push({ data: { id: continueId, label: ' LANJUT INDUK', sublabel: 'Lewati sub-label', type: 'cmd_continue', parent: contentParentId } });
                        linkFlow(lastNodeInLabel, continueId, 'continue_flow');
                        lastNodeInLabel = continueId;
                    }

                    prevLabelLastNode = lastNodeInLabel;
                });

                if (labelContainers.length > 0) {
                    lastNodeInPhase = prevLabelLastNode;
                }

                phaseList[phaseList.length - 1].firstNode = firstNodeInPhase;
                phaseList[phaseList.length - 1].lastNode = lastNodeInPhase;
            });

            // === PASS 2: Connect Phases ===
            for (let i = 0; i < phaseList.length; i++) {
                const currentPhase = phaseList[i];

                // Connect START to First Phase (visual only) or First Node of First Phase
                if (i === 0) {
                    // Prefer connecting to the first node if exists, else the phase box
                    const target = currentPhase.firstNode || currentPhase.id;
                    edges.push({ data: { source: 'START', target: target, type: 'start_flow' } });
                }

                if (i < phaseList.length - 1) {
                    const nextPhase = phaseList[i + 1];
                    const source = currentPhase.lastNode || currentPhase.id;
                    const target = nextPhase.firstNode || nextPhase.id;

                    edges.push({
                        data: { source: source, target: target, type: 'phase_flow' }
                    });
                }
            }

            // === PASS 3: Resolve Jumps ===
            const allLabels = new Map([...labelMap, ...subLabelMap]);

            // Mapping fase by name untuk resolve jump ke fase
            const phaseMap = new Map();
            phaseList.forEach(p => phaseMap.set(p.name, p));

            edges.forEach(edge => {
                if (edge.data.target && edge.data.target.startsWith('pending:')) {
                    const targetName = edge.data.target.replace('pending:', '');

                    // Cek apakah ini jump ke fase lain (pattern: "fase:NamaFase")
                    if (targetName.startsWith('fase:')) {
                        const phaseName = targetName.replace('fase:', '');
                        const targetPhase = phaseMap.get(phaseName);

                        if (targetPhase) {
                            // Fase ditemukan, arahkan ke fase tersebut atau node pertama di fase itu
                            edge.data.target = targetPhase.firstNode || targetPhase.id;
                            edge.data.type = 'phase_jump'; // Tipe khusus untuk jump antar fase
                        } else {
                            // Fase tidak ditemukan di chapter ini, buat node khusus "menuju fase"
                            const jumpToPhaseId = genId('jump_phase');
                            nodes.push({
                                data: {
                                    id: jumpToPhaseId,
                                    label: ' JUMP KE FASE',
                                    sublabel: phaseName,
                                    type: 'jump_phase'
                                }
                            });
                            edge.data.target = jumpToPhaseId;
                        }
                    } else {
                        // Jump ke label/sub-label
                        const targetInfo = allLabels.get(targetName);
                        if (targetInfo) {
                            edge.data.target = targetInfo.id;
                        } else {
                            const missingId = genId('missing');
                            nodes.push({ data: { id: missingId, label: ' 404', sublabel: targetName, type: 'missing' } });
                            edge.data.target = missingId;
                        }
                    }
                }
            });

            // === PASS 4: End Nodes (Multiple Ending Support) ===
            // Cek semua fase yang merupakan ending dan buat node END untuk masing-masing
            const endingPhases = phaseList.filter(p => p.isEnding);

            if (endingPhases.length > 0) {
                // Ada fase ending, buat node END untuk setiap ending
                endingPhases.forEach((endingPhase, idx) => {
                    const endId = genId('ending');
                    const endingName = endingPhase.name || `Ending ${idx + 1}`;
                    nodes.push({
                        data: {
                            id: endId,
                            label: `ENDING ${idx + 1}`,
                            sublabel: endingName,
                            type: 'ending',
                            endingIndex: idx + 1
                        }
                    });
                    const source = endingPhase.lastNode || endingPhase.id;
                    edges.push({ data: { source: source, target: endId, type: 'ending_flow' } });
                });
            } else {
                // Tidak ada ending khusus, gunakan fase terakhir sebagai akhir
                const lastPhase = phaseList[phaseList.length - 1];
                if (lastPhase) {
                    const endId = genId('end');
                    nodes.push({ data: { id: endId, label: ' SELESAI', type: 'end' } });
                    const source = lastPhase.lastNode || lastPhase.id;
                    edges.push({ data: { source: source, target: endId, type: 'end_flow' } });
                }
            }

            return [...nodes, ...edges];
        }

        // processEntries
        function processEntries(entryElements, startNodeId, phaseId, nodes, edges, genId, truncate, isDetailMode) {
            let lastId = startNodeId;
            entryElements.forEach(el => {
                if (el.classList.contains('dialogue-entry-card')) {
                    const res = processSingleEntry(el, lastId, phaseId, nodes, edges, genId, truncate, isDetailMode);
                    if (res) lastId = res;
                }
            });
            return lastId;
        }

        // processSingleEntry
        function processSingleEntry(entry, prevNodeId, phaseId, nodes, edges, genId, truncate, isDetailMode) {
            const entryType = entry.getAttribute('data-type');
            if (!isDetailMode && entryType !== 'choice') return prevNodeId;

            const entryNode = createEntryNode(entry, entryType, genId, truncate);
            if (entryNode) {
                entryNode.data.parent = phaseId;
                nodes.push(entryNode);

                if (prevNodeId) {
                    edges.push({ data: { source: prevNodeId, target: entryNode.data.id, type: 'flow' } });
                }

                if (entryType === 'choice') {
                    processChoiceOptions(entry, entryNode.data.id, phaseId, nodes, edges, genId, truncate, isDetailMode);
                    return null; // Branching ends linear flow locally
                }
                return entryNode.data.id;
            }
            return prevNodeId;
        }

        // Helper: Buat node untuk entri (dialog, scene, choice, dll)
        function createEntryNode(entry, entryType, genId, truncate) {
            const entryId = genId(entryType);

            const getVal = (key) => {
                const el = entry.querySelector(`.script-input[data-key="${key}"]`);
                return el ? el.value.trim() : '';
            };

            const specialTypeVal = entry.querySelector('.special-event-type')?.value || '';
            const hasSpecialEvent = specialTypeVal && specialTypeVal !== '';
            const specialIcon = hasSpecialEvent ? '' : '';

            const hasVoice = getVal('voice') !== '';
            const hasSFX = getVal('sfx') !== '' || getVal('sfxIn') !== '' || getVal('sfxOut') !== '';
            const hasBGM = getVal('bgm') !== '';

            let audioIcons = [];
            if (hasVoice) audioIcons.push('');
            if (hasSFX) audioIcons.push('');
            if (hasBGM) audioIcons.push('');
            const audioStr = audioIcons.join(' ');

            let label = 'ENTRI';
            let sublabel = '';

            switch (entryType) {
                case 'dialogue':
                    const speaker = getVal('speaker') || 'Narator';
                    const text = getVal('text');
                    label = ` ${speaker}`;
                    sublabel = `"${truncate(text, 30)}"`;
                    if (hasSpecialEvent) sublabel += `\n${specialIcon} Efek: ${specialTypeVal}`;
                    if (audioStr) sublabel += `\n${audioStr}`;
                    break;

                case 'scene':
                    const sceneTypeVal = entry.querySelector('.scene-type-selector');
                    const sceneType = sceneTypeVal ? sceneTypeVal.value : 'image';
                    let bgName = '';
                    if (sceneType === 'image') bgName = getVal('background');
                    else if (sceneType === 'video') bgName = getVal('video');
                    else if (sceneType === 'text_screen') bgName = getVal('text');

                    const transition = entry.querySelector('.scene-transition-selector')?.value || 'cut';

                    label = sceneType === 'video' ? ' VIDEO' : (sceneType === 'text_screen' ? ' TEKS' : ' SCENE');
                    sublabel = `File: ${truncate(bgName, 20)}\nTransisi: ${transition}`;
                    if (hasBGM) sublabel += `\n BGM Baru`;
                    break;

                case 'choice':
                    label = ' PILIHAN';
                    const qText = getVal('text');
                    sublabel = qText ? `"${truncate(qText, 30)}"` : 'Pilih jawaban...';
                    break;

                default:
                    label = entryType.toUpperCase();
            }

            return {
                data: {
                    id: entryId,
                    label: label,
                    sublabel: sublabel,
                    type: entryType,
                    hasSpecial: hasSpecialEvent,
                    element: entry
                }
            };
        }

        function processChoiceOptions(choiceEntry, choiceId, phaseId, nodes, edges, genId, truncate, isDetailMode) {
            const options = choiceEntry.querySelectorAll('.choice-option-editor');

            options.forEach((opt, oIdx) => {
                const txtInput = opt.querySelector('.choice-option-text');
                const jumpSelect = opt.querySelector('.choice-option-jump');

                const optText = txtInput ? txtInput.value.trim() : `Opsi ${oIdx + 1}`;
                const jumpTarget = jumpSelect ? jumpSelect.value : '';

                const optId = genId('option');

                nodes.push({
                    data: {
                        id: optId,
                        label: ` OPSI ${oIdx + 1}`,
                        sublabel: truncate(optText, 20),
                        type: 'option',
                        parent: phaseId // Anak dari Phase
                    }
                });

                edges.push({ data: { source: choiceId, target: optId, type: 'flow' } });

                if (jumpTarget && !jumpTarget.startsWith('##')) {
                    edges.push({ data: { source: optId, target: `pending:${jumpTarget}`, type: 'jump' } });
                } else if (jumpTarget === '##SKIP_ALL_LABEL##') {
                    const skipId = genId('skip');
                    nodes.push({ data: { id: skipId, label: ' SKIP LABEL', sublabel: 'Lanjut Phase', type: 'cmd', parent: phaseId } });
                    edges.push({ data: { source: optId, target: skipId, type: 'flow' } });
                } else if (jumpTarget === '##FINISH_PARENT##') {
                    // Menandakan bahwa label induk telah selesai, alur akan lanjut setelah label induk
                    const finishId = genId('finish_parent');
                    nodes.push({ data: { id: finishId, label: ' SELESAI INDUK', sublabel: 'Selesaikan label induk', type: 'cmd_finish', parent: phaseId } });
                    edges.push({ data: { source: optId, target: finishId, type: 'flow' } });
                } else if (jumpTarget === '##EXIT_LABEL##') {
                    // Keluar dari label dan lanjut ke entri berikutnya setelah label
                    const exitId = genId('exit_label');
                    nodes.push({ data: { id: exitId, label: ' KELUAR LABEL', sublabel: 'Lanjut setelah label', type: 'cmd_exit', parent: phaseId } });
                    edges.push({ data: { source: optId, target: exitId, type: 'flow' } });
                } else if (jumpTarget === '##CONTINUE_PARENT##') {
                    // Lanjut di label induk, melewati sub-label lainnya
                    const continueId = genId('continue_parent');
                    nodes.push({ data: { id: continueId, label: ' LANJUT INDUK', sublabel: 'Lewati sub-label', type: 'cmd_continue', parent: phaseId } });
                    edges.push({ data: { source: optId, target: continueId, type: 'flow' } });
                }
            });
        }

        function initCytoscape(elements) {
            try {
                if (cyInstance) cyInstance.destroy();

                if (typeof cytoscape === 'undefined') {
                    showNotification("Library Cytoscape belum dimuat.", "error");
                    return;
                }

                const container = document.getElementById('cy');

                cyInstance = cytoscape({
                    container: container,
                    elements: elements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': (ele) => ele.data('label') + (ele.data('sublabel') ? '\n' + ele.data('sublabel') : ''),
                                'color': '#ecf0f1',
                                'font-family': '"Segoe UI", Roboto, Helvetica, Arial, sans-serif',
                                'font-size': '11px',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'text-wrap': 'wrap',
                                'text-max-width': '140px',
                                'background-color': '#34495e',
                                'border-width': 1,
                                'border-color': '#7f8c8d',
                                'shape': 'round-rectangle',
                                'width': 'label',
                                'height': 'label',
                                'padding': '12px'
                            }
                        },
                        {
                            selector: 'node[type="start"]',
                            style: {
                                'background-color': '#27ae60',
                                'shape': 'ellipse',
                                'padding': '20px',
                                'font-weight': 'bold',
                                'font-size': '12px',
                                'border-width': 3,
                                'border-color': '#2ecc71'
                            }
                        },
                        {
                            selector: 'node[type="end"]',
                            style: {
                                'background-color': '#c0392b',
                                'shape': 'ellipse',
                                'padding': '20px',
                                'font-weight': 'bold',
                                'border-width': 3,
                                'border-color': '#e74c3c'
                            }
                        },
                        // Phase node (Compound Parent)
                        {
                            selector: 'node[type="phase"]',
                            style: {
                                'background-color': '#ecf0f1',
                                'background-opacity': 0.1, // Transparan
                                'border-color': '#2c3e50',
                                'border-width': 2,
                                'border-style': 'solid',
                                'shape': 'round-rectangle',
                                'text-valign': 'top',
                                'text-halign': 'center',
                                'font-size': '16px',
                                'font-weight': 'bold',
                                'color': '#ffffff',
                                'padding': '40px', // Ruang untuk anak-anak
                                'label': (ele) => ele.data('label') + (ele.data('sublabel') ? '\n' + ele.data('sublabel') : '')
                            }
                        },
                        // ENDING Phase (isEnding = true)
                        {
                            selector: 'node[type="phase"][?isEnding]',
                            style: {
                                'background-color': '#ff1493',
                                'background-opacity': 0.15,
                                'border-color': '#ff69b4',
                                'border-width': 3,
                                'border-style': 'double',
                                'color': '#ff69b4'
                            }
                        },
                        // Node Ending (trophy)
                        {
                            selector: 'node[type="ending"]',
                            style: {
                                'background-color': '#ff1493',
                                'background-opacity': 0.9,
                                'shape': 'star',
                                'padding': '25px',
                                'font-weight': 'bold',
                                'font-size': '12px',
                                'border-width': 3,
                                'border-color': '#ff69b4',
                                'color': '#fff',
                                'text-valign': 'center',
                                'text-halign': 'center'
                            }
                        },
                        {
                            selector: 'node[type="label"]',
                            style: {
                                'background-color': '#f1c40f',
                                'background-opacity': 0.1,
                                'shape': 'round-rectangle',
                                'padding': '20px',
                                'border-color': '#f1c40f',
                                'border-width': 2,
                                'border-style': 'solid',
                                'text-valign': 'top',
                                'text-halign': 'center',
                                'color': '#f1c40f',
                                'font-weight': 'bold',
                                'label': (ele) => ele.data('label')
                            }
                        },
                        {
                            selector: 'node[type="sublabel"]',
                            style: {
                                'background-color': '#3498db',
                                'background-opacity': 0.1,
                                'shape': 'round-rectangle',
                                'width': 'label',
                                'padding': '15px',
                                'border-color': '#3498db',
                                'border-width': 1,
                                'border-style': 'dashed',
                                'text-valign': 'top',
                                'color': '#3498db',
                                'font-size': '10px',
                                'label': (ele) => ele.data('label')
                            }
                        },
                        {
                            selector: 'node[type="dialogue"]',
                            style: {
                                'background-color': '#222',
                                'border-color': '#00ffff',
                                'border-width': 2,
                                'color': '#ddd',
                                'text-halign': 'center',
                                'text-valign': 'center'
                            }
                        },
                        {
                            selector: 'node[?hasSpecial]',
                            style: {
                                'border-width': 3,
                                'border-color': '#f1c40f', // Highlight kuning untuk special event
                                'border-style': 'double'
                            }
                        },
                        {
                            selector: 'node[type="scene"]',
                            style: {
                                'background-color': '#00f371',
                                'border-color': '#00d361',
                                'shape': 'hexagon',
                                'padding': '15px',
                                'color': '#000'
                            }
                        },
                        {
                            selector: 'node[type="choice"]',
                            style: {
                                'background-color': '#aa00ff',
                                'shape': 'diamond',
                                'padding': '5px',
                                'border-color': '#8800cc',
                                'border-width': 2,
                                'color': '#fff'
                            }
                        },
                        {
                            selector: 'node[type="option"]',
                            style: {
                                'background-color': '#9b59b6',
                                'shape': 'round-rectangle',
                                'font-size': '10px',
                                'width': 'label'
                            }
                        },
                        {
                            selector: 'node[type="missing"]',
                            style: {
                                'background-color': '#e74c3c',
                                'label': 'MISSING',
                                'shape': 'triangle'
                            }
                        },
                        // Node untuk special command (##FINISH_PARENT##, ##EXIT_LABEL##, ##CONTINUE_PARENT##)
                        {
                            selector: 'node[type="cmd_finish"]',
                            style: {
                                'background-color': '#16a085',
                                'shape': 'round-rectangle',
                                'border-color': '#1abc9c',
                                'border-width': 2,
                                'color': '#fff',
                                'font-size': '10px'
                            }
                        },
                        {
                            selector: 'node[type="cmd_exit"]',
                            style: {
                                'background-color': '#e67e22',
                                'shape': 'round-rectangle',
                                'border-color': '#f39c12',
                                'border-width': 2,
                                'color': '#fff',
                                'font-size': '10px'
                            }
                        },
                        {
                            selector: 'node[type="cmd_continue"]',
                            style: {
                                'background-color': '#3498db',
                                'shape': 'round-rectangle',
                                'border-color': '#2980b9',
                                'border-width': 2,
                                'color': '#fff',
                                'font-size': '10px'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#95a5a6',
                                'target-arrow-color': '#95a5a6',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'arrow-scale': 1.0
                            }
                        },
                        {
                            selector: 'edge[type="jump"]',
                            style: {
                                'line-style': 'dashed',
                                'line-color': '#e74c3c', // Merah putus-putus
                                'target-arrow-color': '#e74c3c',
                                'width': 2
                            }
                        },
                        {
                            selector: 'edge[type="phase_flow"]',
                            style: {
                                'width': 4,
                                'line-color': '#f39c12', // Tebal, orange untuk flow antar fase
                                'target-arrow-color': '#f39c12'
                            }
                        },
                        // Styling untuk jump ke fase lain
                        {
                            selector: 'node[type="jump_phase"]',
                            style: {
                                'background-color': '#00bcd4',
                                'shape': 'round-rectangle',
                                'border-color': '#0097a7',
                                'border-width': 2,
                                'color': '#fff',
                                'font-size': '10px',
                                'text-valign': 'center',
                                'text-halign': 'center'
                            }
                        },
                        {
                            selector: 'edge[type="phase_jump"]',
                            style: {
                                'line-style': 'dashed',
                                'line-color': '#00bcd4', // Biru cyan untuk jump ke fase
                                'target-arrow-color': '#00bcd4',
                                'width': 3
                            }
                        },
                        // Styling untuk edge menuju ending
                        {
                            selector: 'edge[type="ending_flow"]',
                            style: {
                                'width': 4,
                                'line-color': '#ff1493', // Pink/Magenta untuk flow ke ending
                                'target-arrow-color': '#ff1493',
                                'line-style': 'solid'
                            }
                        },
                        // Highlighted/selected
                        {
                            selector: 'node:selected',
                            style: {
                                'border-width': 4,
                                'border-color': '#ffdc00'
                            }
                        },
                        {
                            selector: 'edge:selected',
                            style: {
                                'line-color': '#ffdc00',
                                'target-arrow-color': '#ffdc00',
                                'width': 4
                            }
                        },
                        // Hover effect
                        {
                            selector: 'node.hover',
                            style: {
                                'border-width': 3,
                                'border-color': '#ffdc00',
                                'background-opacity': 0.9
                            }
                        }
                    ],
                    layout: {
                        name: 'dagre',
                        rankDir: 'TB',
                        nodeSep: 40,
                        rankSep: 60,
                        padding: 30,
                        animate: true,
                        animationDuration: 300
                    },
                    minZoom: 0.1,
                    maxZoom: 3,
                    wheelSensitivity: 0.3
                });

                // Event: Klik node untuk scroll ke elemen di editor
                cyInstance.on('tap', 'node', function (evt) {
                    const node = evt.target;
                    const element = node.data('element');

                    if (element) {
                        // Tutup modal
                        document.getElementById('flow-visualization-modal').classList.remove('visible');

                        // Scroll ke elemen
                        setTimeout(() => {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            element.style.outline = '3px solid #ffdc00';
                            setTimeout(() => {
                                element.style.outline = '';
                            }, 2000);
                        }, 300);
                    }
                });

                // Event: Hover untuk highlight
                cyInstance.on('mouseover', 'node', function (evt) {
                    const node = evt.target;
                    node.style('border-width', 4);
                    node.style('border-color', '#ffdc00');
                    container.style.cursor = 'pointer';
                });

                cyInstance.on('mouseout', 'node', function (evt) {
                    const node = evt.target;
                    const type = node.data('type');
                    if (type === 'phase') {
                        node.style('border-width', 3);
                        node.style('border-color', '#0074d9');
                    } else {
                        node.style('border-width', 2);
                        // Reset ke warna border asli berdasarkan type
                        const borderColors = {
                            'start': '#004c8c',
                            'end': '#cc6a00',
                            'label': '#1a8c28',
                            'sublabel': '#2a6b4e',
                            'dialogue': '#2d3748',
                            'scene': '#553c9a',
                            'choice': '#7b0a8c',
                            'option': '#6c3483',
                            'exit': '#a93226',
                            'finish': '#1e8449',
                            'missing': '#b32d25'
                        };
                        node.style('border-color', borderColors[type] || '#555');
                    }
                    container.style.cursor = 'default';
                });

                // Setup toolbar
                setupVisualizationToolbar();

            } catch (e) {
                console.error("Cytoscape Error:", e);
                showNotification("Gagal memuat visualisasi: " + e.message, "error");
            }
        }

        function setupVisualizationToolbar() {
            const zoomInBtn = document.getElementById('viz-zoom-in');
            const zoomOutBtn = document.getElementById('viz-zoom-out');
            const fitBtn = document.getElementById('viz-fit');
            const layoutBtn = document.getElementById('viz-layout');

            if (zoomInBtn) {
                zoomInBtn.onclick = () => cyInstance?.zoom(cyInstance.zoom() * 1.2);
            }
            if (zoomOutBtn) {
                zoomOutBtn.onclick = () => cyInstance?.zoom(cyInstance.zoom() / 1.2);
            }
            if (fitBtn) {
                fitBtn.onclick = () => cyInstance?.fit(null, 50);
            }
            if (layoutBtn) {
                layoutBtn.onclick = () => {
                    const currentDir = cyInstance?.options()?.layout?.rankDir || 'TB';
                    const newDir = currentDir === 'TB' ? 'LR' : 'TB';
                    cyInstance?.layout({
                        name: 'dagre',
                        rankDir: newDir,
                        nodeSep: 50,
                        rankSep: 80,
                        padding: 30,
                        animate: true
                    }).run();
                };
            }

            // Mode toggle buttons
            const detailBtn = document.getElementById('viz-mode-detail');
            const summaryBtn = document.getElementById('viz-mode-summary');

            function updateModeButtons() {
                if (detailBtn && summaryBtn) {
                    if (vizMode === 'detail') {
                        detailBtn.style.background = '#0074d9';
                        detailBtn.style.borderColor = '#0074d9';
                        summaryBtn.style.background = '#333';
                        summaryBtn.style.borderColor = '#555';
                    } else {
                        detailBtn.style.background = '#333';
                        detailBtn.style.borderColor = '#555';
                        summaryBtn.style.background = '#0074d9';
                        summaryBtn.style.borderColor = '#0074d9';
                    }
                }
            }

            if (detailBtn) {
                detailBtn.onclick = () => {
                    if (vizMode !== 'detail') {
                        vizMode = 'detail';
                        updateModeButtons();
                        const elements = extractGraphData();
                        initCytoscape(elements);
                    }
                };
            }

            if (summaryBtn) {
                summaryBtn.onclick = () => {
                    if (vizMode !== 'summary') {
                        vizMode = 'summary';
                        updateModeButtons();
                        const elements = extractGraphData();
                        initCytoscape(elements);
                    }
                };
            }

            updateModeButtons();
        }
        // ------------------- End Visualization Flow Logic ------------------- //

        // ------------------- Intro & Main Menu ------------------- //

        document.addEventListener("DOMContentLoaded", () => {
            const blackScene = document.getElementById('black-scene');
            const introScene = document.getElementById('intro-scene');

            loadStories();
            updateCarouselCenter();

            // Notify Main Process to update Discord RPC
            if (typeof ipcRenderer !== 'undefined') {
                ipcRenderer.send('update-rpc-activity', {
                    details: 'Memilih Visual Novel',
                    state: 'Mencari cerita menarik',
                    largeImageKey: 'vn_icon',
                    smallImageKey: 'main_icon',
                    smallImageText: 'VN Manager'
                });
            }

            // Black screen ke intro scene
            function startIntroScene() {
                blackScene.classList.add('swipe-out');
                blackScene.addEventListener('animationend', () => {
                    blackScene.remove();
                    introScene.style.display = 'block';
                });
            }
            startIntroScene();
        });

        document.addEventListener("DOMContentLoaded", () => {

            document.addEventListener('mousemove', (e) => {
                if (document.body.classList.contains('invalid-drag-state')) {
                    dragTooltip.style.left = `${e.clientX}px`;
                    dragTooltip.style.top = `${e.clientY}px`;
                }
            });

            dragTooltip = document.getElementById('drag-tooltip');

            const characterImage = document.querySelector('.character-image-small');

            function jumpHigh() {
                characterImage.style.animation = 'jump-high 0.4s ease-in-out';
                setTimeout(() => { characterImage.style.animation = ''; }, 400);
            }

            function jumpLow() {
                characterImage.style.animation = 'jump-low 0.3s ease-in-out';
                setTimeout(() => { characterImage.style.animation = ''; }, 300);
            }

            function startJumpCycle() {
                jumpHigh();
                setTimeout(() => jumpHigh(), 500);
                setTimeout(() => jumpLow(), 1200);
                setTimeout(startJumpCycle, 2000);
            }
            startJumpCycle();
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                exitIntroScene();
            }
        });

        // Intro ke konten utama
        function exitIntroScene() {
            const introScene = document.getElementById('intro-scene');
            introScene.style.animation = 'swipeOut 0.3s ease forwards';
            setTimeout(() => {
                introScene.remove();
                showMainMenu();
            }, 500);
        }

        // Tampilkan konten utama
        function showMainMenu() {
            const menuContainer = document.querySelector('.menu-container');
            menuContainer.style.display = 'block';
        }

        // Animasi swipe ke kiri
        const swipeOutAnimation = document.createElement('style');
        swipeOutAnimation.innerHTML = `
      @keyframes swipeOut {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
      }
      .intro-scene {
        animation: none;
      }
    `;
        document.head.appendChild(swipeOutAnimation);

        // ------------------- Story Loading & Rendering ------------------- //

        async function loadStories() {
            // Batalkan timeout auto-pick yang mungkin masih berjalan
            if (defaultCenterTimeout) {
                clearTimeout(defaultCenterTimeout);
                defaultCenterTimeout = null;
            }

            storiesData = await ipcRenderer.invoke('get-story-list');
            if (!storiesData) storiesData = [];
            renderStories(storiesData);

            // Hanya jalankan auto-pick pada load pertama kali
            // dan jika pengguna belum berinteraksi dengan carousel
            if (isInitialLoad && !userHasInteractedWithCarousel) {
                setDefaultCenterIndex();
                isInitialLoad = false;
            } else {
                // Pastikan posisi carousel tetap valid setelah refresh
                updateCarouselCenter();
            }
        }

        function renderStories(stories) {
            storyGrid.innerHTML = '';

            // Kartu "Buat Novel"
            const createCard = document.createElement('div');
            createCard.className = 'story-card create-new-card';
            createCard.innerHTML = `
          <div class="plus-icon">+</div>
          <div class="create-text">Buat Novel</div>
      `;
            createCard.addEventListener('click', showCreateNovelModal);
            storyGrid.appendChild(createCard);

            // "Edit Novel"
            const editCard = document.createElement('div');
            editCard.className = 'story-card create-new-card';
            editCard.innerHTML = `
          <div class="plus-icon" style="font-size: 3rem; font-weight: bold;"></div>
          <div class="create-text">Edit Novel</div>
      `;
            editCard.addEventListener('click', showScriptEditor); // Panggil fungsi editor
            storyGrid.appendChild(editCard);

            stories.forEach((story, index) => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                storyCard.dataset.title = story.title;
                // Gunakan cover yang dikirim dari main process
                const coverFile = story.cover || 'cover.jpg';
                // Gunakan encodeURIComponent untuk menangani karakter khusus pada judul folder
                storyCard.style.backgroundImage = `url('./visual_novels/${encodeURIComponent(story.title)}/${coverFile}')`;

                const overlay = document.createElement('div');
                overlay.className = 'overlay';

                const title = document.createElement('h2');
                title.className = 'story-title';
                title.textContent = story.title;

                const desc = document.createElement('p');
                desc.className = 'story-desc';
                // Gunakan storyDesc dari folder novel jika tersedia, jika tidak gunakan default
                desc.textContent = story.storyDesc || `Explore the story of ${story.title}!`;

                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.textContent = 'Play';
                playButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startPlayAnimation(storyCard, story.playPath);
                });

                overlay.appendChild(title);
                overlay.appendChild(desc);
                overlay.appendChild(playButton);
                storyCard.appendChild(overlay);
                storyGrid.appendChild(storyCard);

                setTimeout(() => {
                    storyCard.classList.add('show');
                }, index * 100);

                storyCard.addEventListener('mouseenter', () => {
                    if (storyGridElement.classList.contains('carousel-layout')) return;
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        fadeInVideo(story.title);
                    }, 1000);
                });

                storyCard.addEventListener('mouseleave', () => {
                    if (storyGridElement.classList.contains('carousel-layout')) return;
                    clearTimeout(hoverTimeout);
                    fadeOutVideo();
                });

                storyCard.addEventListener('click', (e) => {
                    if (storyGridElement.classList.contains('carousel-layout')) {
                        userHasInteractedWithCarousel = true;
                        // Gunakan navigateCarousel dengan mode absolut untuk validasi yang konsisten
                        // +2 karena ada kartu "Buat Novel" dan "Edit Novel" di awal
                        navigateCarousel(index + 2, true);
                    }
                });
            });

            // Validasi currentCenterIndex setelah render
            // Ini penting saat jumlah kartu berubah (novel baru ditambah/dihapus)
            // Hanya ambil kartu dari storyGrid
            const allCards = storyGrid.querySelectorAll('.story-card');
            const maxIndex = Math.max(0, allCards.length - 1);
            if (currentCenterIndex > maxIndex) {
                currentCenterIndex = maxIndex;
            }
            if (currentCenterIndex < 0) {
                currentCenterIndex = 0;
            }
        }

        // ------------------- Search Logic ------------------- //
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredStories = storiesData.filter(story =>
                story.title.toLowerCase().includes(searchTerm)
            );
            renderStories(filteredStories);

            // Reset carousel position if needed
            if (storyGridElement.classList.contains('carousel-layout')) {
                // Gunakan navigateCarousel dengan mode absolut untuk reset ke posisi 0
                navigateCarousel(0, true);
            }
        }

        searchInput.addEventListener('input', performSearch);
        searchBtn.addEventListener('click', performSearch);

        // ------------------- Layout & Carousel Logic ------------------- //

        storyGridElement.classList.add('carousel-layout');
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';

        switchLayoutBtn.addEventListener('click', () => {
            const isCarousel = storyGridElement.classList.contains('carousel-layout');
            storyGridElement.classList.toggle('carousel-layout', !isCarousel);
            storyGridElement.classList.toggle('grid-layout', isCarousel);
            prevBtn.style.display = isCarousel ? 'none' : 'block';
            nextBtn.style.display = isCarousel ? 'none' : 'block';

            storyGrid.querySelectorAll('.story-card .play-button').forEach(btn => {
                btn.style.display = isCarousel ? 'inline-block' : 'none';
            });

            if (isCarousel) { // Switched to Grid
                storyGrid.querySelectorAll('.story-card').forEach(card => card.classList.remove('centered'));
                storyGridElement.style.transform = '';
            } else { // Switched to Carousel
                updateCarouselCenter();
            }
        });

        function setDefaultCenterIndex() {
            // Batalkan timeout sebelumnya jika ada
            if (defaultCenterTimeout) {
                clearTimeout(defaultCenterTimeout);
            }

            defaultCenterTimeout = setTimeout(() => {
                // Jangan auto-pick jika pengguna sudah berinteraksi dengan carousel
                if (userHasInteractedWithCarousel) {
                    return;
                }

                // Hanya ambil kartu dari storyGrid
                const cards = storyGrid.querySelectorAll('.story-card');
                if (cards.length > 1) { // Pastikan ada novel selain kartu "Create"
                    const randomIndex = Math.floor(Math.random() * (cards.length - 1)) + 1;
                    defaultCenterIndex = randomIndex;
                    // Gunakan navigateCarousel dengan mode absolut untuk konsistensi
                    navigateCarousel(randomIndex, true);
                }
            }, 1500);
        }

        /**
         * Fungsi terpusat untuk navigasi carousel dengan debounce
         * @param {number} direction - Arah navigasi: -1 untuk prev, 1 untuk next, atau angka absolut untuk set langsung
         * @param {boolean} isAbsolute - Jika true, direction adalah index absolut, bukan relatif
         */
        function navigateCarousel(direction, isAbsolute = false) {
            // Debounce: abaikan klik jika masih dalam proses navigasi
            if (isNavigating) return;

            // Hanya ambil kartu dari storyGrid, bukan dari seluruh dokumen
            // (ada juga story-card di editor-novel-list yang tidak boleh dihitung)
            const cards = storyGrid.querySelectorAll('.story-card');

            // Jika tidak ada kartu, keluar
            if (cards.length === 0) return;

            const maxIndex = cards.length - 1;

            let newIndex;
            if (isAbsolute) {
                newIndex = direction;
            } else {
                newIndex = currentCenterIndex + direction;
            }

            // Clamp index ke batas yang valid
            newIndex = Math.max(0, Math.min(newIndex, maxIndex));

            // Jika sudah di batas, tidak perlu update
            if (newIndex === currentCenterIndex && !isAbsolute) {
                return;
            }

            // Set debounce
            isNavigating = true;
            currentCenterIndex = newIndex;
            updateCarouselCenter();

            // Reset debounce setelah transisi selesai (sesuaikan dengan CSS transition duration)
            setTimeout(() => {
                isNavigating = false;
            }, 100); // 100ms debounce
        }

        function updateCarouselCenter() {
            // Hanya ambil kartu dari storyGrid
            const cards = storyGrid.querySelectorAll('.story-card');
            const maxIndex = Math.max(0, cards.length - 1);

            // Validasi ketat - pastikan index selalu dalam batas
            if (currentCenterIndex < 0) currentCenterIndex = 0;
            if (currentCenterIndex > maxIndex) currentCenterIndex = maxIndex;

            // Jika tidak ada kartu, keluar
            if (cards.length === 0) return;

            cards.forEach((card, index) => {
                const isCentered = index === currentCenterIndex;
                card.classList.toggle('centered', isCentered);
                const playButton = card.querySelector('.play-button');
                if (playButton) {
                    playButton.style.display = isCentered ? 'inline-block' : 'none';
                }
            });

            if (storyGridElement.classList.contains('carousel-layout')) {
                const centerCard = cards[currentCenterIndex];
                if (centerCard && !centerCard.classList.contains('create-new-card')) {
                    const storyTitle = centerCard.querySelector('.story-title');
                    if (storyTitle) {
                        fadeInVideo(storyTitle.textContent);
                    }
                } else {
                    fadeOutVideo();
                }
            }
            updateCarouselPosition();
        }

        function updateCarouselPosition() {
            if (!storyGridElement.classList.contains('carousel-layout')) return;
            // Hanya ambil kartu dari storyGrid
            const cards = storyGrid.querySelectorAll('.story-card');
            const maxIndex = Math.max(0, cards.length - 1);

            // Validasi tambahan untuk keamanan
            if (cards.length === 0) return;
            if (currentCenterIndex < 0) currentCenterIndex = 0;
            if (currentCenterIndex > maxIndex) currentCenterIndex = maxIndex;

            const centerCard = cards[currentCenterIndex];
            if (!centerCard) return;

            const containerRect = storyGridElement.getBoundingClientRect();
            const cardRect = centerCard.getBoundingClientRect();
            const baseOffsetX = (containerRect.width / 2) - (cardRect.left - containerRect.left + cardRect.width / 2);

            storyGridElement.style.transform = `translateX(${baseOffsetX}px) translateY(${extraOffsetY}px)`;
        }

        function updateExtraOffsetY() {
            if (window.innerWidth <= 1280) extraOffsetY = 10;
            else if (window.innerWidth <= 1900) extraOffsetY = 160;
            else extraOffsetY = 385;
        }

        window.addEventListener('resize', () => {
            updateExtraOffsetY();
            updateCarouselPosition();
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 1
            const images = document.querySelectorAll('.image-container img');
            let currentIndex = 0;
            if (images.length > 1) {
                setInterval(() => {
                    images[currentIndex].style.opacity = 0;
                    currentIndex = (currentIndex + 1) % images.length;
                    images[currentIndex].style.opacity = 1;
                }, 3000);
            }

            scriptEditorArea.addEventListener('click', async (event) => {
                const target = event.target;

                // Menangani pembuatan Sub-Label
                if (target.classList.contains('add-sub-label-btn')) {
                    const parentHeader = target.closest('.label-group-header');
                    const parentLabelGroup = target.closest('.label-group-container');
                    const parentName = parentLabelGroup?.querySelector('.label-name-input')?.value.trim();
                    const parentContent = parentHeader.nextElementSibling;
                    if (parentContent && parentContent.classList.contains('label-group-content')) {
                        // [MODIFIKASI] Kirim nama induk saat membuat elemen
                        const newSubLabel = createSubLabelElement('', parentName);
                        parentContent.appendChild(newSubLabel);
                        newSubLabel.querySelector('input').focus();
                        updateAllJumpTargetDropdowns();
                    }
                    return;
                }

                // Menangani tombol "x" untuk menghapus input
                const clearBtn = target.closest('.clear-input-btn-inside');
                if (clearBtn) {
                    const wrapper = clearBtn.closest('.input-with-clear-wrapper');
                    const textInput = wrapper?.querySelector('.script-input');
                    if (textInput) {
                        textInput.value = '';
                        textInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    return;
                }

                // Menangani tombol preview label grup
                const previewLabelBtn = target.closest('.preview-label-group-btn');
                if (previewLabelBtn) {
                    const labelGroupContainer = previewLabelBtn.closest('.label-group-container');
                    if (!labelGroupContainer) return;

                    // Ekstrak nama label
                    const labelName = labelGroupContainer.querySelector('.label-name-input')?.value.trim() || 'Tanpa Nama';

                    // Bangun payload preview label dengan mengekstrak semua data yang relevan
                    const labelPreviewPayload = extractLabelPreviewData(labelGroupContainer);

                    if (labelPreviewPayload && labelPreviewPayload.entries && labelPreviewPayload.entries.length > 0) {
                        // Kirim ke main process untuk diputar
                        ipcRenderer.send('vn-engine:preview-label', labelPreviewPayload);
                        showNotification(`Preview Label: ${labelName}`, 'success');
                    } else {
                        showNotification('Label kosong, tidak ada entri untuk di-preview.', 'error');
                    }
                    return;
                }

                // Menangani semua jenis tombol hapus
                const deleteBtn = target.closest('.delete-phase-btn, .delete-label-group-btn, .delete-dialogue-btn');
                if (deleteBtn) {
                    if (deleteBtn.classList.contains('delete-phase-btn')) {
                        const phaseCard = deleteBtn.closest('.phase-card');
                        const nameInput = phaseCard?.querySelector('.phase-name-input');
                        const phaseName = nameInput ? nameInput.value.trim() : '(tanpa nama)';
                        const confirmed = await showConfirmation(`Anda yakin ingin menghapus fase "${phaseName}" beserta seluruh isinya?`);
                        if (confirmed) {
                            phaseCard.remove();
                            updateAllJumpTargetDropdowns();
                        }
                        return;
                    }
                    if (deleteBtn.classList.contains('delete-label-group-btn')) {
                        const groupToRemove = deleteBtn.closest('.label-group-container');
                        const confirmed = await showConfirmation('Anda yakin ingin menghapus label ini beserta seluruh dialog di dalamnya?');
                        if (confirmed) {
                            groupToRemove.remove();
                            updateAllJumpTargetDropdowns();
                        }
                        return;
                    }
                    if (deleteBtn.classList.contains('delete-dialogue-btn')) {
                        const cardToRemove = deleteBtn.closest('.dialogue-entry-card, .sub-label-container');
                        if (!cardToRemove) return;
                        if (cardToRemove.classList.contains('entry-type-choice') || cardToRemove.classList.contains('sub-label-container')) {
                            const type = cardToRemove.classList.contains('sub-label-container') ? 'Sub-Label ini dan semua isinya' : 'kartu Pilihan (Choice) ini';
                            const confirmed = await showConfirmation(`Yakin ingin menghapus ${type}?`);
                            if (confirmed) {
                                cardToRemove.remove();
                                updateAllJumpTargetDropdowns();
                            }
                        } else {
                            cardToRemove.remove();
                        }
                        return;
                    }
                }

                // Menangani tombol Tambah Fase
                const addPhaseBtn = target.closest('#add-phase-btn-styled');
                if (addPhaseBtn) {
                    // hapus pesan "skrip kosong" jika ada
                    const emptyMessage = scriptEditorArea.querySelector('h4');
                    if (emptyMessage && emptyMessage.textContent.includes('Skrip masih kosong')) {
                        emptyMessage.remove();
                    }

                    const isFirstPhase = scriptEditorArea.querySelectorAll('.phase-card').length === 0;
                    const newPhaseCard = createPhaseEditorCard(undefined, [], [], isFirstPhase);

                    scriptEditorArea.insertBefore(newPhaseCard, addPhaseBtn);
                    newPhaseCard.querySelector('.phase-name-input').focus();
                    updateAllJumpTargetDropdowns();
                    return;
                }

                // Menangani tombol Browse File
                const browseBtn = target.closest('.browse-file-btn');
                if (browseBtn) {
                    const wrapper = browseBtn.previousElementSibling;
                    const textInput = wrapper?.querySelector('.script-input') || wrapper;
                    const fileType = browseBtn.dataset.type;
                    browseBtn.disabled = true;
                    try {
                        const filename = await ipcRenderer.invoke('open-file-dialog', {
                            fileType: fileType,
                            storyTitle: currentlyEditing.novel,
                            chapterName: currentlyEditing.chapter
                        });
                        if (filename) {
                            textInput.value = filename;
                            textInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    } catch (error) {
                        console.error("Error selama pemilihan file:", error);
                        showConfirmation("Gagal membuka dialog pemilihan file.", true);
                    } finally {
                        browseBtn.disabled = false;
                    }
                    return;
                }

                // Menangani tombol Tambah Entri (Dialog/Label/Scene)
                const addEntryBtn = target.closest('.add-entry-btn');
                if (addEntryBtn) {
                    console.log('[Debug] Tombol .add-entry-btn terdeteksi.');

                    // Cek apakah tombol dinonaktifkan
                    if (addEntryBtn.disabled) {
                        console.warn('[Debug] AKSI DIBATALKAN: Tombol dalam keadaan nonaktif (disabled). Ini mungkin karena aturan "Transisi tidak boleh menjadi entri pertama".');
                        return;
                    }

                    const type = addEntryBtn.dataset.type;
                    console.log(`[Debug] Tipe tombol yang diklik adalah: "${type}"`);

                    let newEntryCard;
                    let targetContainer;

                    // Cari konteks terdekat (Fase, Label, atau Sub-Label)
                    const subLabelGroup = addEntryBtn.closest('.sub-label-container');
                    const labelGroup = addEntryBtn.closest('.label-group-container');
                    const phaseCard = addEntryBtn.closest('.phase-card');
                    console.log('[Debug] Mencari kontainer target...');

                    // Tentukan di mana entri baru akan ditempatkan
                    if (subLabelGroup) {
                        targetContainer = subLabelGroup.querySelector('.sub-label-content');
                        console.log('[Debug] Target ditemukan di dalam Sub-Label:', targetContainer);
                    } else if (labelGroup) {
                        targetContainer = labelGroup.querySelector('.label-group-content');
                        console.log('[Debug] Target ditemukan di dalam Label:', targetContainer);
                    } else if (phaseCard) {
                        targetContainer = phaseCard.querySelector('.phase-content');
                        console.log('[Debug] Target ditemukan di dalam Fase:', targetContainer);
                    }

                    if (!targetContainer) {
                        console.error('[Debug] KRITIS: Tidak dapat menemukan kontainer target untuk menempatkan entri baru.');
                        return;
                    }

                    // Buat kartu baru berdasarkan tipenya
                    console.log(`[Debug] Memulai pembuatan kartu untuk tipe: "${type}"...`);
                    if (type === 'label') {
                        newEntryCard = createLabelGroupElement({}, [], []);
                        if (targetContainer) {
                            targetContainer.appendChild(newEntryCard);
                            newEntryCard.querySelector('input')?.focus();
                            updateAllJumpTargetDropdowns();
                        }
                    } else if (type === 'choice') {
                        const inLabelContext = targetContainer.matches('.label-group-content, .sub-label-content');
                        newEntryCard = createEntryEditorCard(type, {}, [], inLabelContext);
                    } else if (type === 'dialogue' || type === 'scene') {
                        newEntryCard = createEntryEditorCard(type);
                    }
                    console.log('[Debug] Pembuatan kartu selesai. Hasil:', newEntryCard);


                    // Tambah kartu baru ke DOM jika berhasil dibuat
                    if (newEntryCard && targetContainer && type !== 'label') {
                        console.log('[Debug] Menambahkan kartu baru ke kontainer target...');
                        targetContainer.appendChild(newEntryCard);
                        newEntryCard.querySelector('input, textarea, select')?.focus();
                        console.log('[Debug] Kartu baru berhasil ditambahkan.');
                    } else {
                        console.warn('[Debug] Proses penambahan kartu dibatalkan. newEntryCard:', newEntryCard, 'targetContainer:', targetContainer);
                    }

                    return; // Hentikan proses setelah tombol ditangani
                }

                // Menangani tombol Tambah Opsi Pilihan
                const addOptionBtn = target.closest('.add-choice-option-btn');
                if (addOptionBtn) {
                    const parentCard = addOptionBtn.closest('.dialogue-entry-card');
                    const container = parentCard.querySelector('.choice-options-container');
                    if (!container) return;

                    // 1. Kumpulkan semua label yang ada saat ini (logika ini tetap sama)
                    const allLabels = Array.from(scriptEditorArea.querySelectorAll('.label-name-input, .sub-label-name-input')).map(input => {
                        if (input.classList.contains('sub-label-name-input')) {
                            const parentName = input.closest('.label-group-container')?.querySelector('.label-name-input')?.value.trim();
                            return parentName ? `${parentName}.${input.value.trim()}` : null;
                        }
                        return input.value.trim();
                    }).filter(Boolean);

                    const parentLabelGroup = parentCard.closest('.label-group-container');
                    const parentLabelName = parentLabelGroup?.querySelector('.label-name-input')?.value.trim();
                    const availableLabels = allLabels.filter(name => {
                        const isSubLabel = name.includes('.');
                        if (!isSubLabel) return true;
                        if (parentLabelName && name.startsWith(parentLabelName + '.')) return true;
                        return false;
                    });

                    let optionsHTML = '<option value="">Pilih Label Tujuan...</option>';
                    const inSubLabelContext = !!addOptionBtn.closest('.sub-label-container');
                    const inMainLabelContext = !!addOptionBtn.closest('.label-group-container') && !inSubLabelContext;

                    let specialCommandsHTML = '';
                    if (inMainLabelContext) {
                        // Opsi untuk Choice di dalam Label Utama
                        specialCommandsHTML = `
                    <option value="##CONTINUE_PARENT##">Lanjut di Label Induk</option>
                    <option value="##FINISH_PARENT##">Selesaikan Label Induk</option>
                    <option value="##EXIT_LABEL##">Keluar dari Label</option>
                `;
                    } else if (!inSubLabelContext) {
                        // Opsi untuk Choice di luar label (level Fase)
                        specialCommandsHTML = `
                    <option value="##SKIP_ALL_LABEL##">Lewati/skip semua label di fase ini</option>
                `;
                    }
                    // Jika 'inSubLabelContext' true, 'specialCommandsHTML' akan kosong,
                    // sehingga <optgroup> tidak akan dibuat.

                    if (specialCommandsHTML) {
                        optionsHTML += `<optgroup label="------ Perintah Khususs ------">${specialCommandsHTML}</optgroup>`;
                    }

                    if (availableLabels.length > 0) {
                        optionsHTML += `<optgroup label="------ Lompat ke Label ------">`;
                        availableLabels.forEach(name => {
                            let displayName = name;
                            let className = 'option-main-label';
                            if (name.includes('.')) {
                                displayName = ` (sub) ${name.split('.')[1]}`;
                                className = 'option-sub-label';
                            }
                            optionsHTML += `<option value="${name}" class="${className}">${displayName}</option>`;
                        });
                        optionsHTML += `</optgroup>`;
                    }

                    // 5. Buat dan tambahkan elemen opsi baru menggunakan HTML yang sudah lengkap
                    const newOption = document.createElement('div');
                    newOption.className = 'choice-option-editor';
                    newOption.innerHTML = `
                <input type="text" class="script-input choice-option-text" placeholder="Teks untuk pilihan baru">
                <span class="jump-arrow"></span>
                <select class="script-input choice-option-jump">
                    ${optionsHTML}
                </select>
                <button type="button" class="remove-option-btn"></button>
            `;
                    container.appendChild(newOption);
                    newOption.querySelector('.choice-option-text').focus();
                    return;
                }

                // Menangani tombol Hapus Opsi Pilihan
                const removeOptionBtn = target.closest('.remove-option-btn');
                if (removeOptionBtn) {
                    const optionEditorToRemove = removeOptionBtn.closest('.choice-option-editor');
                    if (optionEditorToRemove) {
                        optionEditorToRemove.remove();
                    }
                    return;
                }
            });

            scriptEditorArea.addEventListener('input', (event) => {
                const input = event.target;
                const key = input.dataset.key;

                if (input.classList.contains('persist-background-checkbox')) {
                    toggleTransitionOutControls(input);
                }

                if (key && key.toLowerCase().endsWith('delay')) {
                    console.log(`%c[DelayUpdate] Input delay diubah untuk key: "${key}"`, 'color: gold');

                    const audioKey = key.replace(/Volume|Pan|Delay/g, '');
                    console.log(`[DelayUpdate] Audio key dasar yang diekstrak: "${audioKey}"`);

                    const card = input.closest('.dialogue-entry-card, .phase-header, .label-group-header');
                    if (!card) {
                        console.error('[DelayUpdate] Gagal menemukan elemen .card induk.');
                        return;
                    }

                    const previewContainer = card.querySelector(`.audio-preview-container[data-preview-for="${audioKey}"]`);
                    if (!previewContainer) {
                        console.error(`[DelayUpdate] KRITIS: Gagal menemukan preview container untuk key "${audioKey}".`);
                        return;
                    }
                    console.log('[DelayUpdate] Menemukan preview container yang sesuai:', previewContainer);

                    const audio = previewContainer.querySelector('audio');
                    const timeDisplay = previewContainer.querySelector('.time-display');

                    if (audio && !audio.paused) {
                        audio.pause();
                    }

                    const newDelay = parseInt(input.value, 10) || 0;
                    console.log(`[DelayUpdate] Nilai delay baru: ${newDelay}ms`);

                    if (timeDisplay) {
                        if (newDelay > 0) {
                            timeDisplay.textContent = `Delay Set: ${(newDelay / 1000).toFixed(1)}s`;
                        } else {
                            timeDisplay.textContent = audio && audio.duration ? `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}` : '0:00 / 0:00';
                        }
                    }
                    return;
                }

                if (input.type === 'radio' && input.dataset.key === 'backgroundMode') {
                    const newMode = input.value; // 'cover' or 'contain'
                    // Cari elemen pratinjau gambar terdekat
                    const container = input.closest('div.phase-assets, div.entry-content');
                    if (container) {
                        const previewImage = container.querySelector('.image-preview');
                        if (previewImage) {
                            previewImage.style.objectFit = newMode;
                            console.log(`[PREVIEW] Pratinjau background diubah ke mode: ${newMode}`);
                        }
                    }
                }

                if (input.classList.contains('audio-input')) {
                    if (!key) return;

                    console.log(`%c[AudioUpdate] Blok audio-input terpicu untuk key: "${key}"`, 'color: cyan');

                    const card = input.closest('.dialogue-entry-card, .phase-header, .label-group-header');
                    if (!card) {
                        console.error('[AudioUpdate] Gagal menemukan elemen .card induk.');
                        return;
                    }

                    const selector = `.audio-preview-container[data-preview-for="${key}"]`;
                    console.log('[AudioUpdate] Mencari preview container dengan selector:', selector);

                    const previewContainer = card.querySelector(selector);
                    console.log('[AudioUpdate] Hasil pencarian previewContainer:', previewContainer);

                    if (!previewContainer) {
                        console.error('[AudioUpdate] KRITIS: Tidak dapat menemukan previewContainer. Pastikan atribut data-preview-for sudah benar di HTML.');
                        return;
                    }

                    const audio = previewContainer.querySelector('audio');
                    const playPauseBtn = previewContainer.querySelector('.play-pause-btn');
                    const timeDisplay = previewContainer.querySelector('.time-display');
                    const progressFill = previewContainer.querySelector('.progress-fill');

                    console.log('[AudioUpdate] Elemen yang ditemukan:', { audio, playPauseBtn, timeDisplay });

                    if (!audio || !playPauseBtn || !timeDisplay || !progressFill) {
                        console.error('[AudioUpdate] KRITIS: Salah satu elemen di dalam previewContainer tidak ditemukan.');
                        return;
                    }

                    const newFileName = input.value.trim();
                    console.log(`[AudioUpdate] Nama file baru dari input: "${newFileName}"`);

                    if (newFileName) {
                        const newSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${newFileName}?v=${Date.now()}`;
                        console.log('[AudioUpdate] Mengatur audio.src baru ke:', newSrc);
                        audio.src = newSrc;
                        playPauseBtn.disabled = false;
                    } else {
                        console.log('[AudioUpdate] Input kosong. Menghapus src dan menonaktifkan tombol.');
                        audio.removeAttribute('src');
                        playPauseBtn.disabled = true;
                    }

                    // Reset tampilan pratinjau
                    console.log('[AudioUpdate] Mereset tampilan pratinjau (waktu, progress bar).');
                    playPauseBtn.classList.remove('playing');
                    timeDisplay.textContent = '0:00 / 0:00';
                    progressFill.style.width = '0%';
                    if (currentPreviewAudio === audio) {
                        console.log('[AudioUpdate] Menghentikan audio lama yang sedang diputar.');
                        audio.pause();
                        currentPreviewAudio = null;
                    }
                    console.log('--- Selesai ---');
                }

                if (input.classList.contains('image-input')) {
                    updateImagePreviewUI(event.target);
                }
                // --- AWAL BLOK ELSE IF BARU UNTUK VIDEO ---
                else if (input.classList.contains('video-input')) { // Cek kelas baru kita
                    const card = input.closest('.dialogue-entry-card'); // Cari kartu scene induk
                    if (card) {
                        const previewContainer = card.querySelector('.video-preview-container');
                        const videoPreview = card.querySelector('.video-preview');
                        const placeholder = previewContainer ? previewContainer.querySelector('.preview-placeholder') : null;
                        const controlsBlock = card.querySelector('.video-controls-block'); // Cari blok kontrol

                        if (previewContainer && videoPreview && placeholder) {
                            const filename = input.value.trim();

                            // Logika visibilitas kontrol video
                            if (controlsBlock) {
                                controlsBlock.style.display = filename ? 'flex' : 'none';
                            }

                            if (filename) {
                                const newSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${filename}?v=${Date.now()}`;
                                videoPreview.src = newSrc;
                                previewContainer.style.display = 'flex'; // Tampilkan container
                                videoPreview.style.display = 'block';    // Tampilkan video
                                placeholder.style.display = 'none';     // Sembunyikan placeholder
                                videoPreview.onerror = () => { // Handle error jika file berubah ke yg tidak valid
                                    videoPreview.style.display = 'none';
                                    placeholder.style.display = 'flex';
                                    placeholder.textContent = `Error: File "${filename}" tidak ditemukan.`;
                                    previewContainer.style.display = 'flex'; // Tetap tampilkan container
                                };
                            } else {
                                // Jika input dikosongkan
                                videoPreview.src = '';
                                videoPreview.style.display = 'none';     // Sembunyikan video
                                placeholder.style.display = 'flex';      // Tampilkan placeholder
                                placeholder.textContent = 'Pilih video...';
                                previewContainer.style.display = 'none'; // Sembunyikan container
                            }
                        }
                    }
                }

                if (input.classList.contains('scene-type-selector')) {
                    const selectedCard = input.closest('.dialogue-entry-card');
                    const selectedType = input.value;

                    // Sembunyikan semua grup input spesifik scene
                    selectedCard.querySelectorAll('.scene-input-group').forEach(group => {
                        group.style.display = 'none';
                    });

                    // Tampilkan grup input yang relevan dengan tipe scene yang dipilih
                    const targetGroup = selectedCard.querySelector(`.scene-input-group[data-scene-type="${selectedType}"]`);
                    if (targetGroup) {
                        targetGroup.style.display = 'block';
                    }

                    // Update status kontrol transisi keluar
                    const activeCheckbox = targetGroup ? targetGroup.querySelector('.persist-background-checkbox') : null;
                    if (activeCheckbox) {
                        toggleTransitionOutControls(activeCheckbox);
                    } else {
                        // Fallback untuk tipe tanpa checkbox persist (seperti text_screen)
                        // Kita kirim input selector itu sendiri agar fungsi bisa menemukan card induknya
                        toggleTransitionOutControls(input);
                    }
                }

                const wrapper = input.closest('.input-with-clear-wrapper');
                if (wrapper) {
                    wrapper.classList.toggle('has-text', !!input.value);
                }

                if (event.target.classList.contains('phase-name-input') ||
                    event.target.classList.contains('label-name-input') ||
                    event.target.classList.contains('sub-label-name-input')) {

                    updateAllJumpTargetDropdowns();
                }

                if (input.classList.contains('is-ending-checkbox')) {
                    const parentCard = input.closest('.phase-card');
                    if (parentCard) {
                        parentCard.classList.toggle('is-ending', input.checked);

                        const flowControl = parentCard.querySelector('.phase-flow-control');
                        if (flowControl) {
                            flowControl.style.display = input.checked ? 'none' : 'flex';
                        }
                    }
                }

                if (input.classList.contains('auto-dialogue-toggle')) {
                    const optionsDiv = input.closest('.auto-dialogue-container').querySelector('.auto-dialogue-options');
                    if (optionsDiv) {
                        optionsDiv.classList.toggle('visible', input.checked);
                    }
                }

                const group = input.closest('.file-input-group');
                if (group) {
                    const preview = group.nextElementSibling;
                    if (!preview) return;

                    const newSrc = input.value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${input.value}` : '';
                    const cacheBustedSrc = newSrc ? `${newSrc}?v=${Date.now()}` : '';

                    if (input.classList.contains('image-input') && preview.classList.contains('image-preview')) {
                        preview.src = cacheBustedSrc;
                    }
                    if (input.classList.contains('audio-input') && preview.classList.contains('audio-preview')) {
                        preview.src = cacheBustedSrc;
                        preview.style.display = input.value ? 'block' : 'none';
                    }
                }
            });

            scriptEditorArea.addEventListener('input', (event) => {
                const slider = event.target;

                if (slider.type !== 'range' || !slider.dataset.key) return;
                if (!slider.dataset.key.toLowerCase().includes('volume') && !slider.dataset.key.toLowerCase().includes('pan')) return;
                if (!currentPreviewAudio || currentPreviewAudio.paused) return;

                const card = slider.closest('.dialogue-entry-card, .phase-header, .label-group-header');
                if (!card) return;

                const key = slider.dataset.key;
                const audioType = key.replace(/Volume|Pan/g, '');
                const fileInput = card.querySelector(`input[data-key="${audioType}"]`);
                if (!fileInput) return;

                const decodedPlayingFile = decodeURIComponent(path.basename(new URL(currentPreviewAudio.src).pathname));
                const cleanedCardFile = fileInput.value.trim().replace(/[[\]]/g, '');

                if (decodedPlayingFile === cleanedCardFile) {
                    console.log('%c[LiveEffect] File COCOK! Menerapkan efek...', 'color: lightgreen; font-weight: bold;');
                    const pannerNode = livePannerNodes.get(currentPreviewAudio);

                    // Gunakan endsWith untuk pengecekan yang lebih akurat
                    if (key.toLowerCase().endsWith('volume')) {
                        console.log('[LiveEffect] Aksi terdeteksi: VOLUME');
                        const newVolume = parseFloat(slider.value);
                        const finalVolume = globalVolume * newVolume;
                        currentPreviewAudio.volume = finalVolume;
                        console.log(`[LiveEffect] Volume diubah menjadi: ${newVolume} (Final: ${finalVolume.toFixed(2)})`);

                    } else if (key.toLowerCase().endsWith('pan') && pannerNode) {
                        console.log('[LiveEffect] Aksi terdeteksi: PAN');
                        const newPan = parseFloat(slider.value);
                        pannerNode.pan.value = newPan;
                        console.log(`[LiveEffect] Pan diubah menjadi: ${newPan.toFixed(2)}`);
                    }
                } else {
                    console.log('%c[LiveEffect] File TIDAK COCOK. Efek tidak diterapkan.', 'color: orange;');
                    console.log(`   -> BERSIH (diputar): "${decodedPlayingFile}"`);
                    console.log(`   -> BERSIH (editor):  "${cleanedCardFile}"`);
                }
                console.log('---------------------------------');
            });

            scriptEditorArea.addEventListener('blur', (event) => {
                const target = event.target;

                // Cek apakah elemen yang baru saja ditinggalkan adalah salah satu input nama
                if (target.classList.contains('phase-name-input') ||
                    target.classList.contains('label-name-input') ||
                    target.classList.contains('sub-label-name-input')) {

                    console.log(`[Blur Event] Input nama '${target.value}' selesai diedit. Memperbarui semua dropdown...`);
                    updateAllJumpTargetDropdowns();
                }
            }, true); // Gunakan 'true' (capturing) agar event ini lebih andal

            scriptEditorArea.addEventListener('change', (event) => {
                if (event.target.tagName === 'SELECT') {
                    updateSelectColor(event.target);
                }
            });

            // 2
            updateExtraOffsetY();
            updateCarouselPosition();
            console.log('DOM fully loaded. Attaching tab listener...');

            const tabsContainer = document.querySelector('.sidebar-tabs');
            console.log('Sidebar tabs container found:', tabsContainer);

            // --- Slider Listener Fix (Moved here to ensure execution) ---
            console.log('[Init] Menambahkan listener untuk slider scale (di dalam blok DOMLoaded)...');
            document.addEventListener('input', (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('scale-slider')) {
                    console.log('[Slider Debug] Nilai berubah:', e.target.value);
                    let display = e.target.nextElementSibling;

                    // Fallback: Jika nextElementSibling bukan display (misal ada spasi/text node), cari di parent
                    if (!display || !display.classList.contains('scale-value-display')) {
                        display = e.target.parentElement.querySelector('.scale-value-display');
                    }

                    if (display) {
                        display.textContent = e.target.value + '%';
                    } else {
                        console.warn('[Slider Debug] Elemen display tidak ditemukan.');
                    }
                }

                // === MULTI-SPRITE SYSTEM: Listener untuk slider Posisi X (custom + preset) ===
                if (e.target && e.target.classList &&
                    (e.target.classList.contains('extra-sprite-x') || e.target.classList.contains('sprite-position-slider'))) {
                    let display = e.target.nextElementSibling;

                    // Fallback: Jika nextElementSibling bukan display, cari di parent
                    if (!display || !display.classList.contains('position-value-display')) {
                        display = e.target.parentElement.querySelector('.position-value-display');
                    }

                    if (display) {
                        display.textContent = e.target.value + '%';
                    }
                }

                // === SPRITE TRANSITION SYSTEM: Listener untuk slider durasi transisi ===
                if (e.target && e.target.classList && e.target.classList.contains('transition-duration-slider')) {
                    const display = e.target.parentElement.querySelector('.transition-duration-value');
                    if (display) {
                        display.textContent = e.target.value + 'ms';
                    }
                }
            });

            // === SPRITE TRANSITION SYSTEM: Toggle checkbox untuk enable/disable slider durasi ===
            scriptEditorArea.addEventListener('change', (e) => {
                if (e.target && e.target.classList.contains('sprite-transition-toggle')) {
                    const transitionRow = e.target.closest('.transition-row');
                    if (transitionRow) {
                        const durationControl = transitionRow.querySelector('.transition-duration-control');
                        const durationSlider = transitionRow.querySelector('.transition-duration-slider');

                        if (e.target.checked) {
                            // Aktifkan slider durasi
                            durationControl?.classList.remove('disabled');
                            if (durationSlider) durationSlider.disabled = false;
                        } else {
                            // Nonaktifkan slider durasi
                            durationControl?.classList.add('disabled');
                            if (durationSlider) durationSlider.disabled = true;
                        }
                    }
                }
            });

            // === SPRITE TRANSITION SYSTEM: Fungsi untuk mendeteksi dan menampilkan kontrol transisi ===
            // Dibuat sebagai window function agar bisa diakses dari handler Sortable onEnd
            window.checkSpriteTransitionVisibility = function checkSpriteTransitionVisibility() {
                const cards = scriptEditorArea.querySelectorAll('.dialogue-entry-card');

                cards.forEach((card, index) => {
                    if (index === 0) {
                        // Entri pertama tidak punya entri sebelumnya, sembunyikan kontrol
                        card.querySelectorAll('.sprite-transition-controls').forEach(ctrl => {
                            ctrl.classList.remove('visible');
                        });
                        return;
                    }

                    // Cari entri sebelumnya yang memiliki sprite (bukan scene atau yang lain)
                    let prevCard = cards[index - 1];
                    let prevIndex = index - 1;

                    // Mundur sampai menemukan entri dengan sprite
                    while (prevCard && prevIndex >= 0) {
                        const hasSpriteInputs = prevCard.querySelector('[data-key="sprite"], [data-key="sprite2"], [data-key="spriteCenter"]');
                        if (hasSpriteInputs) break;
                        prevIndex--;
                        prevCard = prevIndex >= 0 ? cards[prevIndex] : null;
                    }

                    if (!prevCard) return;

                    // Cek perbedaan untuk setiap slot sprite
                    ['sprite', 'sprite2', 'spriteCenter'].forEach(slotKey => {
                        const currentScaleSlider = card.querySelector(`[data-key="${slotKey}Scale"]`);
                        const currentPosSlider = card.querySelector(`[data-key="${slotKey}X"]`);
                        const prevScaleSlider = prevCard.querySelector(`[data-key="${slotKey}Scale"]`);
                        const prevPosSlider = prevCard.querySelector(`[data-key="${slotKey}X"]`);
                        const transitionControl = card.querySelector(`.sprite-transition-controls[data-slot="${slotKey}"]`);

                        if (!transitionControl) return;

                        // Cek apakah sprite slot ini aktif (ada gambar) di entri SAAT INI
                        const spriteInput = card.querySelector(`[data-key="${slotKey}"]`);
                        const hasSpriteValue = spriteInput && spriteInput.value && spriteInput.value.trim() !== '';

                        // Cek apakah sprite slot ini juga ada di entri SEBELUMNYA
                        const prevSpriteInput = prevCard.querySelector(`[data-key="${slotKey}"]`);
                        const hasPrevSpriteValue = prevSpriteInput && prevSpriteInput.value && prevSpriteInput.value.trim() !== '';

                        // Jika sprite tidak ada di entri saat ini ATAU tidak ada di entri sebelumnya,
                        // maka kontrol transisi tidak perlu ditampilkan
                        // (karena sprite baru muncul pertama kali, gunakan animasi masuk biasa)
                        if (!hasSpriteValue || !hasPrevSpriteValue) {
                            transitionControl.classList.remove('visible');
                            return;
                        }

                        // Bandingkan nilai scale dan posisi
                        const currentScale = currentScaleSlider ? parseInt(currentScaleSlider.value) : null;
                        const prevScale = prevScaleSlider ? parseInt(prevScaleSlider.value) : null;
                        const currentPos = currentPosSlider ? parseInt(currentPosSlider.value) : null;
                        const prevPos = prevPosSlider ? parseInt(prevPosSlider.value) : null;

                        // Jika ada perbedaan, tampilkan kontrol transisi
                        const hasDifference = (currentScale !== null && prevScale !== null && currentScale !== prevScale) ||
                            (currentPos !== null && prevPos !== null && currentPos !== prevPos);

                        if (hasDifference) {
                            transitionControl.classList.add('visible');

                            // Update hint dengan info perbedaan
                            const hintEl = transitionControl.querySelector('.prev-value-hint');
                            if (hintEl) {
                                let hintText = 'Perbedaan terdeteksi: ';
                                if (currentScale !== prevScale) hintText += `Ukuran ${prevScale}%  ${currentScale}% `;
                                if (currentPos !== prevPos) hintText += `Posisi ${prevPos}%  ${currentPos}%`;
                                hintEl.textContent = hintText;
                            }
                        } else {
                            transitionControl.classList.remove('visible');
                        }
                    });
                });
            }

            // Jalankan pengecekan saat slider berubah
            scriptEditorArea.addEventListener('input', (e) => {
                if (e.target.classList.contains('scale-slider') ||
                    e.target.classList.contains('sprite-position-slider')) {
                    // Debounce untuk performa
                    clearTimeout(window.spriteTransitionCheckTimeout);
                    window.spriteTransitionCheckTimeout = setTimeout(window.checkSpriteTransitionVisibility, 300);
                }
            });

            // Observer untuk menjalankan pengecekan saat kartu baru ditambahkan
            const transitionObserver = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.addedNodes.length > 0) {
                        setTimeout(window.checkSpriteTransitionVisibility, 100);
                    }
                });
            });
            transitionObserver.observe(scriptEditorArea, { childList: true, subtree: true });

            if (tabsContainer) {
                tabsContainer.addEventListener('click', (event) => {
                    if (event.target.classList.contains('sidebar-tab')) {
                        const tabName = event.target.dataset.tab;

                        document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.sidebar-content').forEach(content => content.classList.remove('active'));
                        event.target.classList.add('active');
                        const contentPanel = document.getElementById(`sidebar-content-${tabName}`);
                        if (contentPanel) {
                            contentPanel.classList.add('active');
                        }

                        // Gunakan manajer tampilan yang baru
                        if (tabName === 'assets') {
                            updateEditorContentView('assets'); // Tampilkan placeholder aset global
                        } else { // 'chapters' tab
                            updateEditorContentView('chapters'); // Tampilkan area editor chapter
                            // Atur ulang ke tampilan default jika belum ada chapter yang dipilih
                            if (!currentlyEditing.chapter) {
                                editingChapterName.textContent = 'Pilih chapter untuk diedit';
                                scriptEditorArea.innerHTML = '';
                                scriptEditorControls.style.display = 'none';
                            }
                        }
                    }
                });
            } else {
                console.error('Error: Could not find the .sidebar-tabs container element.');
            }
        });

        prevBtn.addEventListener('click', () => {
            userHasInteractedWithCarousel = true;
            navigateCarousel(-1); // Navigasi ke sebelumnya
        });

        nextBtn.addEventListener('click', () => {
            userHasInteractedWithCarousel = true;
            navigateCarousel(1); // Navigasi ke selanjutnya
        });

        document.addEventListener('keydown', (e) => {
            if (!storyGridElement.classList.contains('carousel-layout')) return;

            if (e.key === 'ArrowLeft') {
                userHasInteractedWithCarousel = true;
                navigateCarousel(-1);
            } else if (e.key === 'ArrowRight') {
                userHasInteractedWithCarousel = true;
                navigateCarousel(1);
            }
        });

        // ------------------- Auto-Collapse Sidebar Logic ------------------- //
        const sidebar = document.querySelector('.editor-sidebar');
        const chapterControlContainer = document.getElementById('add-chapter-control-container');
        const editorTitle = document.getElementById('editor-main-title');

        if (sidebar && chapterControlContainer && editorTitle) {
            const expandThreshold = 500; // Jarak piksel dari atas untuk mulai expand

            // Observer untuk mendeteksi saat kontrol chapter keluar dari layar (scroll ke bawah)
            const collapseObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const chaptersContent = document.getElementById('sidebar-content-chapters');
                    const isChaptersActive = chaptersContent && chaptersContent.classList.contains('active');

                    // Cek posisi judul untuk mencegah collapse jika kita berada di "zona aman" (dekat atas)
                    // Ini mencegah loop collapse-expand pada sidebar pendek
                    const titleRect = editorTitle.getBoundingClientRect();
                    const isNearTop = titleRect.top > -expandThreshold;

                    // Collapse jika:
                    // 1. Elemen TIDAK terlihat (isIntersecting = false)
                    // 2. Elemen berada di ATAS viewport (boundingClientRect.top < 0)
                    // 3. Tab Chapters sedang aktif
                    // 4. TIDAK berada di dekat atas (isNearTop = false)
                    if (!entry.isIntersecting && entry.boundingClientRect.top < 0 && isChaptersActive && !isNearTop) {
                        sidebar.classList.add('collapsed');
                    }
                });
            }, { threshold: 0 });

            // Observer untuk mendeteksi saat judul editor kembali terlihat (scroll ke atas)
            // rootMargin bagian atas diperluas agar terdeteksi lebih awal
            const expandObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        sidebar.classList.remove('collapsed');
                    }
                });
            }, { rootMargin: `${expandThreshold}px 0px 0px 0px`, threshold: 0 });

            collapseObserver.observe(chapterControlContainer);
            expandObserver.observe(editorTitle);
        }

        // ------------------- Video Background Logic ------------------- //

        function fadeInVideo(storyTitle) {
            if (!storyTitle) return;
            clearInterval(fadeOutInterval);
            clearInterval(fadeInInterval);

            backgroundVideo.src = `./visual_novels/${storyTitle}/video.mp4`;
            backgroundVideo.currentTime = 0;
            backgroundVideo.muted = false;
            backgroundVideo.play();
            backgroundVideo.style.opacity = 1;
            videoOverlay.style.opacity = 1;

            let volume = 0;
            backgroundVideo.volume = 0;

            fadeInInterval = setInterval(() => {
                if (volume < 1) {
                    volume += 0.1;
                    backgroundVideo.volume = Math.min(1, parseFloat(volume.toFixed(1)));
                } else {
                    clearInterval(fadeInInterval);
                }
            }, 100);
        }

        function fadeOutVideo() {
            clearInterval(fadeInInterval);
            clearInterval(fadeOutInterval);

            let volume = backgroundVideo.volume;
            fadeOutInterval = setInterval(() => {
                if (volume > 0) {
                    volume -= 0.1;
                    backgroundVideo.volume = Math.max(0, parseFloat(volume.toFixed(1)));
                } else {
                    clearInterval(fadeOutInterval);
                    backgroundVideo.pause();
                    backgroundVideo.muted = true;
                    backgroundVideo.style.opacity = 0;
                    videoOverlay.style.opacity = 0;
                    backgroundVideo.src = '';
                }
            }, 100);
        }

        // --------------------- Create Novel Logic ------------------- //
        async function showCreateNovelModal() {
            newNovelTitleInput.value = '';
            newNovelCoverInput.value = '';
            imagePreview.innerHTML = '<span>Pratinjau Cover</span>';

            // Ambil deskripsi dari novel yang sedang di-center (jika ada) sebagai referensi
            const centerCard = document.querySelector('.story-card.center');
            const novelTitle = centerCard?.dataset?.title;

            if (novelTitle) {
                // Muat deskripsi dari novel yang sedang aktif
                const storyDescResult = await ipcRenderer.invoke('get-story-desc', novelTitle);
                if (storyDescResult.success && storyDescResult.storyDesc) {
                    newNovelDescInput.value = storyDescResult.storyDesc;
                } else {
                    newNovelDescInput.value = '';
                }
            } else {
                newNovelDescInput.value = '';
            }

            createNovelModal.classList.add('visible');
            newNovelTitleInput.focus();
        }

        // Fungsi untuk update preview story-card di modal
        function updateModalPreview() {
            const title = newNovelTitleInput.value.trim() || 'Judul Novel';
            const desc = newNovelDescInput.value.trim() || 'Deskripsi novel akan muncul di sini...';

            // Cek apakah sudah ada gambar di preview
            const existingImg = imagePreview.querySelector('img');
            if (existingImg) {
                // Hapus overlay lama jika ada
                const oldOverlay = imagePreview.querySelector('.preview-overlay');
                if (oldOverlay) oldOverlay.remove();

                // Buat overlay baru dengan data terkini
                const overlay = document.createElement('div');
                overlay.className = 'preview-overlay';
                overlay.innerHTML = `
                    <div class="preview-title">${escapeHtml(title)}</div>
                    <div class="preview-desc">${escapeHtml(desc)}</div>
                `;
                imagePreview.appendChild(overlay);
            }
        }

        // Helper function untuk escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listener untuk update preview saat input berubah
        newNovelTitleInput.addEventListener('input', updateModalPreview);
        newNovelDescInput.addEventListener('input', updateModalPreview);

        function hideCreateNovelModal() {
            createNovelModal.classList.remove('visible');
        }

        function showHubEditor(novelTitle, isNewNovel = false) {
            isCreatingNewNovelFlow = isNewNovel;
            currentlyEditingNovel = novelTitle;
            document.getElementById('editor-title').textContent = `Kustomisasi Novel: ${novelTitle}`;

            // Reset form editor
            document.getElementById('editor-description').value = '';
            document.getElementById('editor-genre').value = '';
            document.getElementById('editor-author').value = '';
            document.getElementById('editor-illustrator').value = '';
            document.getElementById('editor-vn-mapper').value = '';

            // Atur ulang kontainer input slideshow
            slideshowInputsContainer.innerHTML = '';
            createFileInput();
            editorSlideshowPreview.innerHTML = '';

            // Atur ulang input video
            editorBackgroundVideoInput.value = '';
            videoPreviewName.textContent = '';
            document.getElementById('video-upload-label').classList.remove('file-selected');

            hideCreateNovelModal();
            hubEditor.classList.add('visible');
        }

        async function handleCreateNovel() {
            const title = newNovelTitleInput.value.trim();
            const storyDesc = newNovelDescInput.value.trim();
            const coverFile = newNovelCoverInput.files[0];
            if (!title || !coverFile) {
                showConfirmation('Judul dan gambar cover harus diisi!', true);
                return;
            }

            const fileArrayBuffer = await coverFile.arrayBuffer();
            const result = await ipcRenderer.invoke('create-new-novel', {
                title: title,
                storyDesc: storyDesc,  // Kirim story description ke main process
                cover: { name: coverFile.name, buffer: fileArrayBuffer }
            });

            if (result.success) {
                // Beri tanda bahwa ini adalah alur pembuatan novel baru
                showHubEditor(title, true);
            } else {
                showConfirmation(`Error: ${result.message}`, true);
            }
        }

        async function handleUpdateNovel() {
            if (!currentlyEditingNovel) return;

            const description = document.getElementById('editor-description').value;
            const genre = document.getElementById('editor-genre').value;
            const author = document.getElementById('editor-author').value;
            const illustrator = document.getElementById('editor-illustrator').value;
            const vnMapper = document.getElementById('editor-vn-mapper').value;

            // Kumpulkan gambar slideshow
            const slideshowImageInputs = slideshowInputsContainer.querySelectorAll('input.editor-slideshow-input');
            const slideshowImages = [];
            for (const input of slideshowImageInputs) {
                if (input.files && input.files.length > 0) {
                    const file = input.files.item(0);
                    const buffer = await file.arrayBuffer();
                    slideshowImages.push({ name: file.name, buffer });
                }
            }

            // Kumpulkan video latar belakang (jika ada)
            let backgroundVideo = null;
            if (editorBackgroundVideoInput.files && editorBackgroundVideoInput.files.length > 0) {
                const file = editorBackgroundVideoInput.files[0];
                const buffer = await file.arrayBuffer();
                backgroundVideo = { name: file.name, buffer };
            }

            // Kirim semua data ke main process
            const result = await ipcRenderer.invoke('update-novel-details', {
                novelTitle: currentlyEditingNovel,
                description: description,
                genre: genre,
                author: author,
                illustrator: illustrator,
                vnMapper: vnMapper,
                slideshowImages: slideshowImages,
                backgroundVideo: backgroundVideo
            });

            if (result.success) {
                showNotification(result.message, 'success');
                hubEditor.classList.remove('visible');

                // lalu buka editor langsung
                showScriptEditor();
                // Langsung muat novel yang baru saja kita simpan
                await loadNovelForEditing(currentlyEditingNovel);

                isCreatingNewNovelFlow = false; // Reset flag setelah berhasil
                await loadStories(); // Tetap refresh daftar di latar belakang
            } else {
                showNotification(`Error: ${result.message}`, 'error');
            }
        }

        newNovelCoverInput.addEventListener('change', () => {
            const file = newNovelCoverInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Tampilkan gambar lalu tambahkan overlay
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Pratinjau">`;
                    // Trigger update preview untuk menambahkan overlay dengan data terkini
                    updateModalPreview();
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.innerHTML = '<span>Pratinjau Cover</span>';
            }
        });

        editorBackgroundVideoInput.addEventListener('change', () => {
            if (editorBackgroundVideoInput.files.length > 0) {
                const fileName = editorBackgroundVideoInput.files[0].name;
                videoPreviewName.textContent = `File dipilih: ${fileName}`;
                document.getElementById('video-upload-label').classList.add('file-selected');
            } else {
                videoPreviewName.textContent = '';
                document.getElementById('video-upload-label').classList.remove('file-selected');
            }
        });

        slideshowInputsContainer.addEventListener('change', (event) => {
            // Pastikan event berasal dari input file kita
            if (event.target.classList.contains('editor-slideshow-input')) {
                const inputFile = event.target;
                // Cari label yang terhubung dengan input ini
                const label = document.querySelector(`label[for="${inputFile.id}"]`);

                if (inputFile.files.length > 0) {
                    // Jika ada file, tampilkan nama file di label
                    label.textContent = inputFile.files[0].name;
                    label.classList.add('file-selected'); // Tambah class untuk styling
                } else {
                    // Jika tidak ada file (misal, pengguna membatalkan), kembalikan ke teks semula
                    label.textContent = 'Pilih File';
                    label.classList.remove('file-selected');
                }
                updateSlideshowPreview();
            }
        });

        addSlideshowInputBtn.addEventListener('click', () => {
            createFileInput();
        });

        function createImgPreview(value, key) {
            const src = value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}` : '';
            return `<img src="${src}" class="image-preview" data-preview-for="${key}" style="display: ${value ? 'block' : 'none'};" onload="this.style.display='block'" onerror="this.style.display='none'">`;
        };

        function updateImagePreviewUI(inputElement) {
            // ==== ATURAN UNTUK SEMUA JENIS BACKGROUND (Fase, Label, Scene) ====
            const backgroundEditorContainer = inputElement.closest('.phase-assets > div, .scene-input-group[data-scene-type="image"], .label-group-header');
            if (backgroundEditorContainer) {
                const previewContainer = backgroundEditorContainer.querySelector('.image-preview-container-16-9');
                const modeOptions = backgroundEditorContainer.querySelector('.background-mode-options');
                const previewImage = backgroundEditorContainer.querySelector('.image-preview');
                const placeholder = backgroundEditorContainer.querySelector('.preview-placeholder');

                if (!previewContainer || !previewImage || !placeholder) return;
                const filename = inputElement.value.trim();
                if (filename) {
                    const newSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${filename}?v=${Date.now()}`;
                    previewImage.src = newSrc;
                    previewImage.style.display = 'block';
                    placeholder.style.display = 'none';
                    previewContainer.style.display = 'flex';
                    if (modeOptions) modeOptions.style.display = 'flex';
                    previewImage.onerror = () => {
                        previewImage.style.display = 'none';
                        placeholder.style.display = 'flex';
                        placeholder.textContent = `Error: File "${filename}" tidak ditemukan.`;
                    };
                } else {
                    previewImage.src = '';
                    previewImage.style.display = 'none';
                    placeholder.style.display = 'flex';
                    placeholder.textContent = 'Pilih gambar...';
                    previewContainer.style.display = 'none';
                    if (modeOptions) modeOptions.style.display = 'none';
                }
                return;
            }

            // ==== ATURAN UNTUK SPRITE (DENGAN PENYESUAIAN) ====
            const spriteGroup = inputElement.closest('.file-input-group');
            if (
                spriteGroup &&
                spriteGroup.nextElementSibling &&
                spriteGroup.nextElementSibling.classList.contains('sprite-config-container')
            ) {
                const spriteConfigContainer = spriteGroup.nextElementSibling;
                const previewImage = spriteConfigContainer.querySelector('.image-preview');
                // PERUBAHAN 2: Temukan elemen animation-controls
                const animationControls = spriteConfigContainer.querySelector('.animation-controls');

                if (!previewImage || !animationControls) return;

                const filename = inputElement.value.trim();

                if (filename) {
                    const newSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${filename}?v=${Date.now()}`;
                    previewImage.src = newSrc;
                    previewImage.style.display = 'block';
                    // PERUBAHAN 2: Tampilkan animation-controls
                    animationControls.style.display = 'flex';
                } else {
                    previewImage.src = '';
                    previewImage.style.display = 'none';
                    // PERUBAHAN 2: Sembunyikan animation-controls
                    animationControls.style.display = 'none';
                }
            }
        }

        function createFileInput() {
            const inputId = 'slideshow-input-' + Date.now() + Math.random(); // Buat ID unik

            // Buat input file yang akan kita sembunyikan
            const newInput = document.createElement('input');
            newInput.type = 'file';
            newInput.id = inputId; // Berikan ID unik
            newInput.className = 'editor-slideshow-input';
            newInput.accept = 'image/jpeg, image/png, image/webp';

            // Buat label yang akan menjadi tombol palsu kita
            const newLabel = document.createElement('label');
            newLabel.htmlFor = inputId; // Hubungkan label dengan input
            newLabel.className = 'file-input-label';
            newLabel.textContent = 'Pilih File';

            // Tambah keduanya ke kontainer
            slideshowInputsContainer.appendChild(newInput);
            slideshowInputsContainer.appendChild(newLabel);
        }

        function updateSlideshowPreview() {
            editorSlideshowPreview.innerHTML = '';
            const inputFiles = slideshowInputsContainer.querySelectorAll('input.editor-slideshow-input');
            for (const inputFile of inputFiles) {
                if (inputFile.files && inputFile.files.length > 0) {
                    const file = inputFile.files.item(0);
                    const previewContainer = document.createElement('div');
                    previewContainer.className = 'preview-image-container';
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    previewContainer.appendChild(img);
                    editorSlideshowPreview.appendChild(previewContainer);
                }
            }
        }

        editorCancelBtn.addEventListener('click', async () => {
            if (isCreatingNewNovelFlow) {
                // Jika ini novel baru, konfirmasi sebelum menghapus folder
                const confirmed = await showConfirmation(`Anda membatalkan pembuatan novel "${currentlyEditingNovel}". Apakah Anda ingin menghapus file yang sudah dibuat?`);
                if (confirmed) {
                    await ipcRenderer.invoke('delete-novel-folder', currentlyEditingNovel);
                    showNotification('Pembuatan novel dibatalkan & file dihapus.', 'success');
                    await loadStories(); // Refresh daftar novel di menu utama
                }
            }
            hubEditor.classList.remove('visible');
            isCreatingNewNovelFlow = false; // Selalu reset flag saat keluar
        });

        confirmCreateBtn.addEventListener('click', handleCreateNovel);
        cancelCreateBtn.addEventListener('click', hideCreateNovelModal);
        editorSaveBtn.addEventListener('click', handleUpdateNovel);

        newNovelTitleInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleCreateNovel();
            }
        });
        // --------------------- End Create Novel Logic ------------------- //

        // --------------------------------------- Script Editor Logic ------------------------------------- //
        let currentNovelChapters = [];

        // --- Logika untuk Panel Pratinjau Aset ---
        const previewContainer = document.getElementById('asset-preview-container');
        const previewContent = document.getElementById('asset-preview-content');
        const closePreviewBtn = document.getElementById('close-asset-preview');

        // === Variabel untuk Live Audio Effects ===
        let liveAudioContext;
        const liveSourceNodes = new Map(); // Menyimpan source node untuk setiap elemen audio
        const livePannerNodes = new Map(); // Menyimpan panner node untuk setiap elemen audio
        let globalVolume = 0.8; // Asumsikan volume global, bisa juga dimuat dari settings

        function showAssetPreview(path, type, relativePath) {
            console.log(`[Asset Preview] Trying to show asset. Path: ${path}, Type: ${type}`);
            updateEditorContentView('preview'); // Atur tampilan ke mode pratinjau

            const previewContent = document.getElementById('asset-preview-content');
            previewContent.innerHTML = '';
            let assetElement;

            if (type === 'image') {
                assetElement = document.createElement('img');
            } else if (type === 'audio') {
                assetElement = document.createElement('audio');
                assetElement.controls = true;
                assetElement.autoplay = true;
            } else if (type === 'video') {
                assetElement = document.createElement('video');
                assetElement.controls = true;
                assetElement.autoplay = true;
                assetElement.loop = true;
                assetElement.muted = true;
            }

            if (assetElement) {
                assetElement.src = path;
                previewContent.appendChild(assetElement);
            }

            assetPreviewContainer.style.display = 'block';
            console.log('[Asset Preview] Preview container is now visible.');
        }

        function updateEditorContentView(viewState) {
            const scriptWrapper = document.getElementById('script-editing-wrapper');
            const assetView = document.getElementById('global-asset-view');
            const assetPreview = document.getElementById('asset-preview-container');
            const scriptArea = document.getElementById('script-editor-area');

            // Sembunyikan semua kontainer utama terlebih dahulu
            scriptWrapper.style.display = 'none';
            assetView.style.display = 'none';

            switch (viewState) {
                // Menampilkan area untuk mengedit skrip chapter
                case 'chapters':
                    scriptWrapper.style.display = 'flex';
                    assetPreview.style.display = 'none'; // Sembunyikan pratinjau aset
                    scriptArea.style.display = 'block';   // Tampilkan area skrip
                    break;

                // Menampilkan placeholder default untuk Hub Novel
                case 'assets':
                    assetView.style.display = 'flex';
                    break;

                // Menampilkan area untuk pratinjau (baik aset atau hub novel)
                case 'preview':
                    scriptWrapper.style.display = 'flex';
                    assetPreview.style.display = 'block'; // Tampilkan kontainer pratinjau
                    scriptArea.style.display = 'none';    // Sembunyikan area skrip
                    break;
            }
        }

        function hideAssetPreview() {
            console.log('[Asset Preview] Hiding asset preview.');
            assetPreviewContainer.style.display = 'none';
            previewContent.innerHTML = '';

            scriptEditorArea.innerHTML = '';

            const activeTab = document.querySelector('.sidebar-tab.active');
            if (!activeTab) {
                return;
            };
            const activeTabName = activeTab.dataset.tab;

            if (activeTabName === 'assets') {
                scriptEditingWrapper.style.display = 'none';
                globalAssetView.style.display = 'flex';
            } else {
                scriptEditingWrapper.style.display = 'flex';
                globalAssetView.style.display = 'none';

                // Atur ulang tampilan default untuk tab Chapters
                editingChapterName.textContent = 'Pilih chapter untuk diedit';
                editingChapterName.style.display = 'block';
                scriptEditorControls.style.display = 'none';
                chapterAssetExplorer.style.display = 'none';
            }
        }

        async function handleReplaceFile(assetInfo) {
            hideAssetPreview();

            const fileType = assetInfo.type;
            const filters = fileType === 'image'
                ? [{ name: 'Gambar', extensions: ['jpg', 'jpeg', 'png', 'webp'] }]
                : [{ name: 'Video', extensions: ['mp4', 'webm'] }];

            const newFile = await ipcRenderer.invoke('open-and-read-file', { filters });

            if (newFile) {
                const result = await ipcRenderer.invoke('replace-asset-file', {
                    novelTitle: currentlyEditing.novel,
                    relativePath: assetInfo.path,
                    buffer: newFile.buffer
                });

                if (result.success) {
                    showNotification(result.message, 'success');

                    const novelTitle = currentlyEditing.novel;

                    // 1. Tetap panggil ini untuk refresh sidebar editor
                    loadNovelForEditing(novelTitle);

                    // 2. Buat URL gambar baru dengan cache buster
                    const newImageUrl = `url('./visual_novels/${novelTitle}/cover.jpg?v=${Date.now()}')`;
                    console.log(`[DEBUG] Memperbarui story-card dengan URL: ${newImageUrl}`);

                    // 3. Update kartu di menu utama
                    const cardInMainMenu = document.querySelector(`#story-grid .story-card[data-title="${novelTitle}"]`);
                    if (cardInMainMenu) {
                        cardInMainMenu.style.backgroundImage = newImageUrl;
                        console.log('[DEBUG] Kartu di menu utama berhasil diperbarui.');
                    }

                    // 4. Update kartu di menu pilihan editor
                    const cardInEditorMenu = document.querySelector(`#editor-novel-list .story-card[data-title="${novelTitle}"]`);
                    if (cardInEditorMenu) {
                        cardInEditorMenu.style.backgroundImage = newImageUrl;
                        console.log('[DEBUG] Kartu di menu editor berhasil diperbarui.');
                    }
                } else {
                    showNotification(result.message, 'error');
                }
            }
        }

        function createSubLabelElement(name = '', parentLabelName = '', jumpTarget = '') {
            // Log saat fungsi ini dipanggil dan nilai apa yang diterimanya
            console.log(`[SubLabel Creator] Membuat sub-label '${name}' dengan jumpTarget awal: '${jumpTarget}'`);

            const subLabelContainer = document.createElement('div');
            subLabelContainer.className = 'sub-label-container';
            subLabelContainer.dataset.type = 'sub-label';
            subLabelContainer.dataset.parentName = parentLabelName;

            subLabelContainer.innerHTML = `
        <div class="sub-label-header">
            <div class="drag-handle"></div>
            <span class="label-icon"></span>
            <input type="text" class="script-input sub-label-name-input" value="${name}" placeholder="Nama sub-label...">
            <button type="button" class="delete-dialogue-btn" title="Hapus Sub Label dan Isinya"></button>
        </div>
        <div class="sub-label-content">
            </div>
        <div class="phase-card-controls sub-label-controls" style="padding: 10px 15px; border-top: 1px solid #3a3a3a;">
            <button class="add-entry-btn" data-type="dialogue">+ Tambah Dialog</button>
            <button class="add-entry-btn" data-type="choice">+ Tambah Pilihan</button>
        </div>
        <div class="sub-label-flow-control">
            <label>Alur selanjutnya:</label>
            <select class="sub-label-jump-target">
                <option value="##EXIT_SUB_LABEL##">Selesaikan sub-label ini (Default)</option>
                <optgroup label="------ Perintah Khusus ------">
                    <option value="##CONTINUE_PARENT_FLOW##">Lanjut di Label Induk (lewati sisa sub-label)</option>
                    <option value="##FINISH_PARENT##" class="option-main-label">Selesaikan Label "${parentLabelName}"</option>
                </optgroup>
            </select>
        </div>
    `;

            const dropdown = subLabelContainer.querySelector('.sub-label-jump-target');
            if (dropdown) {
                console.log(`[SubLabel Creator] ...Mencoba mengatur dropdown.value menjadi '${jumpTarget}'`);
                dropdown.value = jumpTarget;
                // Log nilai aktual setelah di-set untuk verifikasi
                console.log(`[SubLabel Creator] ...Nilai dropdown setelah diatur adalah: '${dropdown.value}'`);
                updateSelectColor(dropdown);
            }

            const contentArea = subLabelContainer.querySelector('.sub-label-content');
            new Sortable(contentArea, {
                group: {
                    name: 'phase-entries',
                    // penjaga gerbang antar kontainer
                    put: function (toList, fromList, draggedEl) {
                        const draggedType = draggedEl.dataset.type;
                        const sourceType = getDragContext(fromList);
                        const targetType = getDragContext(toList);

                        // ATURAN 1: Sub-label tidak boleh pindah ke kontainer lain sama sekali.
                        if (draggedType === 'sub-label') {
                            return false;
                        }

                        // ATURAN 2: Choice memiliki aturan ketat.
                        if (draggedType === 'choice') {
                            // Dilarang pindah dari Fase ke dalam Label/SubLabel.
                            if (sourceType === 'Phase' && (targetType === 'Label' || targetType === 'SubLabel')) {
                                return false;
                            }
                            // Dilarang pindah dari Label/SubLabel keluar ke Fase.
                            if ((sourceType === 'Label' || sourceType === 'SubLabel') && targetType === 'Phase') {
                                return false;
                            }
                        }

                        // ATURAN LAMA: Mencegah Label bersarang di dalam Label lain.
                        if (draggedEl.classList.contains('label-group-container') && (targetType === 'Label' || targetType === 'SubLabel')) {
                            return false;
                        }

                        // Jika semua aturan di atas lolos, izinkan.
                        return true;
                    }
                },
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                forceFallback: true,
                fallbackOnBody: true,

                // --- onMove untuk memberikan feedback ---
                onMove: function (evt) {
                    // Cek #1: Aturan "scene tidak boleh di awal" yang sudah ada
                    const isScene = evt.dragged.dataset.type === 'scene';
                    if (isScene) {
                        let isInvalidMove = false;
                        if (evt.to.children.length === 0 || (evt.to.children.length === 1 && evt.to.children[0] === evt.dragged)) { isInvalidMove = true; }
                        if (evt.willInsertAfter === false && evt.related === evt.to.children[0]) { isInvalidMove = true; }

                        if (isInvalidMove) {
                            document.body.classList.add('invalid-drag-state');
                            dragTooltip.textContent = "Entri Scene tidak bisa menjadi entri pertama!!";
                            return false;
                        }
                    }

                    // Cek #2: untuk perpindahan antar kontainer
                    if (evt.from !== evt.to) {
                        // Kita panggil logika 'put' secara manual untuk memeriksa validitas
                        const canPut = this.options.group.put(evt.to, evt.from, evt.dragged);
                        if (!canPut) {
                            document.body.classList.add('invalid-drag-state');
                            dragTooltip.textContent = " Tipe entri ini tidak bisa dipindahkan ke sini.";
                            return false;
                        }
                    }

                    // Jika semua valid, pastikan state bersih
                    document.body.classList.remove('invalid-drag-state');
                    return true;
                },

                onEnd: function (evt) {
                    // Cleanup tetap sama
                    document.body.classList.remove('invalid-drag-state');
                },
            });

            return subLabelContainer;
        }

        // pratinjau saat item aset diklik
        document.addEventListener('click', (event) => {
            const assetItem = event.target.closest('.asset-item:not(.ganti-btn)');
            const gantiBtn = event.target.closest('.ganti-btn');

            // Klik pada item aset -> buka pratinjau
            if (assetItem && !gantiBtn) {
                const fullPath = assetItem.dataset.fullPath;
                const type = assetItem.dataset.type;
                const relativePath = assetItem.dataset.path;
                showAssetPreview(fullPath, type, relativePath);
                return;
            }

            // Klik pada tombol Ganti/Edit
            if (gantiBtn) {
                console.log('[DEBUG] Tombol .ganti-btn DITEMUKAN. Memproses...');
                const assetInfo = {
                    path: gantiBtn.dataset.path,
                    fullPath: gantiBtn.dataset.fullPath,
                    type: gantiBtn.dataset.type
                };
                console.log('[DEBUG] Info aset dari tombol:', assetInfo);

                // Langsung panggil handleReplaceFile, tanpa membuka editor
                console.log('[DEBUG] Memanggil handleReplaceFile secara langsung...');
                handleReplaceFile(assetInfo);

                return; // Hentikan proses setelah ini
            }
        });

        // Listener untuk menutup pratinjau
        closePreviewBtn.addEventListener('click', hideAssetPreview);

        // Listener untuk tombol simpan storyDesc (event delegation karena tombol dibuat dinamis)
        document.addEventListener('click', async (event) => {
            if (event.target.id === 'save-story-desc-btn' || event.target.closest('#save-story-desc-btn')) {
                const storyDescInput = document.getElementById('editor-story-desc');
                if (!storyDescInput || !currentlyEditing.novel) return;

                const storyDesc = storyDescInput.value.trim();
                const btn = document.getElementById('save-story-desc-btn');
                const originalText = btn.innerHTML;

                // Tampilkan loading state
                btn.innerHTML = ' Menyimpan...';
                btn.disabled = true;

                try {
                    const result = await ipcRenderer.invoke('update-story-desc', {
                        novelTitle: currentlyEditing.novel,
                        storyDesc: storyDesc
                    });

                    if (result.success) {
                        showNotification('Tagline novel berhasil disimpan!', 'success');

                        // Update juga tampilan story-card di menu utama jika ada
                        const cardInMainMenu = storyGrid.querySelector(`.story-card[data-title="${currentlyEditing.novel}"]`);
                        if (cardInMainMenu) {
                            const descElement = cardInMainMenu.querySelector('.story-desc');
                            if (descElement) {
                                descElement.textContent = storyDesc || `Explore the story of ${currentlyEditing.novel}!`;
                            }
                        }
                    } else {
                        showNotification(result.message || 'Gagal menyimpan tagline.', 'error');
                    }
                } catch (error) {
                    console.error('Error saving storyDesc:', error);
                    showNotification('Terjadi kesalahan saat menyimpan.', 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        });

        // --- Logika Tambah Chapter ---
        document.getElementById('show-add-chapter-input-btn').addEventListener('click', () => {
            // Buat item baru yang kosong
            const newChapterElement = createChapterItemElement('');
            editorChapterListEditable.appendChild(newChapterElement);

            // Langsung masuk ke mode edit untuk item baru ini
            enterEditMode(newChapterElement);
        });

        function enterEditMode(chapterItemElement) {
            chapterItemElement.classList.add('editing');
            chapterItemElement.querySelector('.chapter-name-display').style.display = 'none';
            chapterItemElement.querySelector('.chapter-item-controls').style.display = 'none';

            const input = chapterItemElement.querySelector('.chapter-name-input');
            input.style.display = 'block';
            input.focus();

            // Buat tombol Simpan () dan Batal ()
            const actionButtons = document.createElement('div');
            actionButtons.className = 'chapter-edit-actions';
            actionButtons.innerHTML = `
        <button class="save-chapter-btn" title="Simpan"></button>
        <button class="cancel-edit-btn" title="Batal"></button>
    `;
            chapterItemElement.appendChild(actionButtons);
        }

        function exitEditMode(chapterItemElement) {
            chapterItemElement.classList.remove('editing');
            chapterItemElement.querySelector('.chapter-name-display').style.display = 'inline';
            chapterItemElement.querySelector('.chapter-item-controls').style.display = 'flex'; // atau 'block'
            chapterItemElement.querySelector('.chapter-name-input').style.display = 'none';

            const actionButtons = chapterItemElement.querySelector('.chapter-edit-actions');
            if (actionButtons) {
                actionButtons.remove();
            }
        }

        // Event listener utama untuk semua tombol di dalam daftar chapter
        editorChapterListEditable.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('add-sub-label-btn')) {
                const parentHeader = target.closest('.label-group-header');
                const parentContent = parentHeader.nextElementSibling; // .label-group-content
                if (parentContent && parentContent.classList.contains('label-group-content')) {
                    const newSubLabel = createSubLabelElement();
                    parentContent.appendChild(newSubLabel);
                    newSubLabel.querySelector('input').focus();
                }
                return;
            }
            const clearBtn = target.closest('.clear-input-btn-inside');
            if (clearBtn) {
                const wrapper = clearBtn.closest('.input-with-clear-wrapper');
                const textInput = wrapper?.querySelector('.script-input');
                if (textInput) {
                    textInput.value = '';
                    textInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                return;
            }
            const deleteBtn = target.closest('.delete-phase-btn, .delete-label-group-btn, .delete-dialogue-btn');

            const chapterItem = target.closest('.chapter-edit-item');
            if (!chapterItem) return;

            // --- Logika Tombol Hapus () ---
            if (target.classList.contains('delete-chapter-btn')) {
                const chapterName = chapterItem.dataset.originalName;
                const confirmed = await showConfirmation(`Yakin ingin menghapus chapter "${chapterName}" beserta semua isinya? Aksi ini tidak bisa dibatalkan.`);
                if (confirmed) {
                    const result = await ipcRenderer.invoke('delete-chapter', { novelTitle: currentlyEditing.novel, chapterName });
                    showNotification(result.message, result.success ? 'success' : 'error');
                    if (result.success) loadNovelForEditing(currentlyEditing.novel);
                }
            }

            // --- Logika Tombol Edit () ---
            if (target.classList.contains('edit-chapter-btn')) {
                enterEditMode(chapterItem);
            }

            // --- Logika Tombol Batal () ---
            if (target.classList.contains('cancel-edit-btn')) {
                // Jika ini chapter baru yang belum disimpan, hapus saja elemennya
                if (chapterItem.dataset.originalName === '') {
                    chapterItem.remove();
                } else {
                    exitEditMode(chapterItem);
                }
            }

            // --- Logika Tombol Simpan () ---
            if (target.classList.contains('save-chapter-btn')) {
                const input = chapterItem.querySelector('.chapter-name-input');
                const oldName = chapterItem.dataset.originalName;
                const newName = input.value.trim();

                if (!newName) {
                    showNotification('Nama chapter tidak boleh kosong.', 'error');
                    return;
                }

                let result;
                if (oldName === '') { // Ini adalah chapter baru
                    result = await ipcRenderer.invoke('create-new-chapter', { storyTitle: currentlyEditing.novel, newChapterName: newName });
                } else if (oldName !== newName) { // Ini ganti nama chapter lama
                    result = await ipcRenderer.invoke('rename-chapter', { novelTitle: currentlyEditing.novel, oldChapterName: oldName, newChapterName: newName });
                } else { // Nama tidak berubah
                    exitEditMode(chapterItem);
                    return;
                }

                showNotification(result.message, result.success ? 'success' : 'error');

                if (result.success) {
                    // Muat ulang daftar chapter untuk memastikan konsistensi
                    await loadNovelForEditing(currentlyEditing.novel);

                    // Jika chapter BARU yang berhasil dibuat, langsung buka chapter tersebut
                    if (oldName === '') {
                        await loadChapterScript(newName);
                    }
                }
            }
        });

        // Tampilkan overlay dan layar pilihan novel
        async function showScriptEditor() {
            editorNovelList.innerHTML = '';
            const stories = await ipcRenderer.invoke('get-story-list');

            renderNovelSelectionList(stories);

            editorMainScreen.style.display = 'none';
            editorNovelSelectionScreen.style.display = 'block';
            scriptEditorOverlay.style.display = 'flex';
            setTimeout(() => scriptEditorOverlay.classList.add('visible'), 10);
        }

        // Sembunyikan overlay editor
        function hideScriptEditor() {
            scriptEditorOverlay.classList.remove('visible');
            setTimeout(() => scriptEditorOverlay.style.display = 'none', 300);
        }

        ipcRenderer.on('hub-html-updated', (event, { novelTitle }) => {
            // Pastikan novel yang diupdate adalah novel yang sedang kita pratinjau
            if (novelTitle === currentlyEditing.novel) {
                // Cari elemen webview yang sedang aktif di dalam area editor
                const webview = document.querySelector('#script-editor-area webview');

                // Jika webview ditemukan, panggil metode reload() bawaannya
                if (webview) {
                    console.log('[Host] Menerima sinyal update hub. Me-reload webview...');
                    webview.reload();
                }
            }
        });

        function createChapterItemElement(chapterName) {
            const item = document.createElement('div');
            item.className = 'chapter-edit-item';
            item.dataset.originalName = chapterName; // Simpan nama asli untuk proses rename

            item.innerHTML = `
        <span class="chapter-name-display">${chapterName}</span>
        <input type="text" class="chapter-name-input" value="${chapterName}" style="display: none;">
        <div class="chapter-item-controls">
            <button class="edit-chapter-btn" title="Ganti Nama"></button>
            <button class="delete-chapter-btn" title="Hapus Chapter"></button>
        </div>
    `;
            return item;
        }

        function createAudioControls(keyPrefix, initialData = {}) {
            const initialVolume = initialData[`${keyPrefix}Volume`] ?? 1.0;
            const initialDelay = initialData[`${keyPrefix}Delay`] ?? 0;
            const initialPan = initialData[`${keyPrefix}Pan`] ?? 0;
            const value100 = Math.round(initialVolume * 100);

            const wrapper = document.createElement('div');
            wrapper.className = 'audio-controls-wrapper';
            wrapper.style.cssText = `
        display: flex; flex-direction: column; gap: 8px; margin-top: 5px;
        margin-bottom: 10px; background-color: #222; padding: 10px; border-radius: 5px;
    `;

            // Tata letak baru yang sepenuhnya responsif
            wrapper.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1 1 auto; min-width: 150px;">
                <label>Volume:</label>
                <input type="range" class="script-input" data-key="${keyPrefix}Volume" min="0" max="1" step="0.01" value="${initialVolume}" style="width: 100%; min-width: 80px;">
                <span class="volume-percentage">${value100}%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px; flex-shrink: 0;">
                <label>Delay (ms):</label>
                <input type="number" class="script-input" data-key="${keyPrefix}Delay" value="${initialDelay}" min="0" step="50" style="width: 70px;">
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <label>Pan:</label>
            <span style="font-size: 0.8em;">Kiri</span>
            <input type="range" class="script-input" data-key="${keyPrefix}Pan" min="-1" max="1" step="0.1" value="${initialPan}" style="flex-grow: 1;">
            <span style="font-size: 0.8em;">Kanan</span>
        </div>
    `;

            const slider = wrapper.querySelector(`input[data-key="${keyPrefix}Volume"]`);
            const display = wrapper.querySelector('.volume-percentage');
            slider.addEventListener('input', () => {
                display.textContent = `${Math.round(slider.value * 100)}%`;
            });

            return wrapper;
        }

        function linkAudioInputToVolumeControl(audioInput, volumeWrapper) {
            if (!audioInput || !volumeWrapper) return;

            const toggleVisibility = () => {
                // Cek apakah input memiliki teks (setelah membuang spasi kosong)
                const hasValue = audioInput.value.trim() !== '';
                // Tampilkan slider jika ada teks, sembunyikan jika kosong
                volumeWrapper.style.display = hasValue ? 'flex' : 'none';
            };

            // Panggil sekali untuk mengatur state awal saat kartu dibuat
            toggleVisibility();

            // akan memanggil fungsi di atas setiap kali input berubah
            audioInput.addEventListener('input', toggleVisibility);

            // Kita juga perlu memicu event 'input' saat tombol 'x' diklik
            const clearButton = audioInput.closest('.input-with-clear-wrapper')?.querySelector('.clear-input-btn-inside');
            if (clearButton) {
                clearButton.addEventListener('click', () => {
                    // Beri sedikit jeda agar value input sempat kosong sebelum kita cek
                    setTimeout(toggleVisibility, 0);
                });
            }
        }

        function connectAudioToLiveGraph(audioElement) {
            if (!liveAudioContext) {
                try {
                    liveAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API tidak didukung.", e);
                    return;
                }
            }

            if (liveSourceNodes.has(audioElement)) return; // Sudah terhubung, jangan buat ulang

            const source = liveAudioContext.createMediaElementSource(audioElement);
            const panner = liveAudioContext.createStereoPanner();

            source.connect(panner).connect(liveAudioContext.destination);

            liveSourceNodes.set(audioElement, source);
            livePannerNodes.set(audioElement, panner);
        }

        function createAudioPreview(src, previewKey) {
            const container = document.createElement('div');
            container.className = 'audio-preview-container';
            if (previewKey) {
                container.dataset.previewFor = previewKey;
            }

            const audio = document.createElement('audio');
            if (src) {
                const fullSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${src}?v=${Date.now()}`;
                audio.src = fullSrc;
            }

            const button = document.createElement('button');
            button.className = 'play-pause-btn';
            button.title = 'Pratinjau Audio';
            button.disabled = !src;

            const progressWrapper = document.createElement('div');
            progressWrapper.className = 'progress-wrapper';

            const timeDisplay = document.createElement('span');
            timeDisplay.className = 'time-display';
            timeDisplay.textContent = '0:00 / 0:00';

            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';

            const progressDelayFill = document.createElement('div');
            progressDelayFill.className = 'progress-delay-fill';
            const progressFill = document.createElement('div');
            progressFill.className = 'progress-fill';

            progressBar.appendChild(progressDelayFill);
            progressBar.appendChild(progressFill);

            progressWrapper.appendChild(progressBar);
            progressWrapper.appendChild(timeDisplay);

            container.appendChild(button);
            container.appendChild(progressWrapper);
            container.appendChild(audio);

            const formatTime = (seconds) => {
                if (isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            };

            let delayCountdownInterval = null;

            audio.addEventListener('loadedmetadata', () => {
                timeDisplay.textContent = `0:00 / ${formatTime(audio.duration)}`;
            });

            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressFill.style.width = `${progress}%`;
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
            });

            progressBar.addEventListener('click', (e) => {
                if (!audio.duration || button.disabled) return;
                const barWidth = progressBar.clientWidth;
                const clickPosition = e.offsetX;
                const seekTime = (clickPosition / barWidth) * audio.duration;
                audio.currentTime = seekTime;
            });

            button.addEventListener('click', () => {
                clearInterval(delayCountdownInterval);

                if (currentPreviewAudio && currentPreviewAudio !== audio) {
                    currentPreviewAudio.pause();
                }

                if (audio.paused) {
                    if (audio.currentTime === audio.duration) {
                        audio.currentTime = 0;
                    }

                    const card = container.closest('.dialogue-entry-card, .phase-header, .label-group-header');
                    if (card && previewKey) {
                        const volumeSliderKey = `${previewKey}Volume`;
                        const volumeSlider = card.querySelector(`input[data-key="${volumeSliderKey}"]`);
                        if (volumeSlider) {
                            const entryVolume = parseFloat(volumeSlider.value);
                            // Gunakan globalVolume (default 1 di editor) untuk konsistensi
                            audio.volume = globalVolume * entryVolume;
                            console.log(`[Pratinjau] Volume diatur ke ${audio.volume.toFixed(2)} sebelum diputar.`);
                        }
                    }

                    // --- LOGIKA PENCARIAN YANG FLEKSIBEL ---
                    const selector = `input[data-key*="${previewKey}"][data-key*="Delay"]`;
                    console.log(`[PlayClick] Mencari input delay dengan selector: "${selector}"`);
                    const delayInput = card ? card.querySelector(selector) : null;
                    console.log('[PlayClick] Elemen input delay yang ditemukan:', delayInput);

                    const delay = delayInput ? parseInt(delayInput.value, 10) || 0 : 0;
                    console.log(`[PlayClick] Nilai delay yang akan digunakan: ${delay}ms`);

                    if (delay > 0) {
                        button.disabled = true;
                        progressDelayFill.style.transition = `width ${delay}ms linear`;
                        progressDelayFill.style.width = '100%';

                        let timeLeft = delay / 1000;
                        timeDisplay.textContent = `Delay: ${timeLeft.toFixed(1)}s`;
                        delayCountdownInterval = setInterval(() => {
                            timeLeft -= 0.1;
                            if (timeLeft > 0) {
                                timeDisplay.textContent = `Delay: ${timeLeft.toFixed(1)}s`;
                            } else {
                                clearInterval(delayCountdownInterval);
                            }
                        }, 100);

                        setTimeout(() => {
                            button.disabled = false;
                            connectAudioToLiveGraph(audio);
                            audio.play();
                            currentPreviewAudio = audio;
                        }, delay);

                    } else {
                        connectAudioToLiveGraph(audio);
                        audio.play();
                        currentPreviewAudio = audio;
                    }
                } else {
                    audio.pause();
                }
            });

            audio.addEventListener('play', () => {
                button.classList.add('playing');
                progressDelayFill.style.transition = 'none';
                progressDelayFill.style.width = '0%';
                clearInterval(delayCountdownInterval);
            });

            audio.addEventListener('pause', () => {
                button.classList.remove('playing');
                progressDelayFill.style.transition = 'none';
                progressDelayFill.style.width = '0%';
                clearInterval(delayCountdownInterval);
                if (audio.duration) {
                    timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
                }
            });

            audio.addEventListener('ended', () => {
                button.classList.remove('playing');
                progressFill.style.width = '100%';
                timeDisplay.textContent = `${formatTime(audio.duration)} / ${formatTime(audio.duration)}`;
            });

            return container;
        }

        // Muat chapter dari novel yang dipilih untuk diedit
        async function loadNovelForEditing(novelTitle) {
            currentlyEditing.novel = novelTitle;
            editingNovelName.textContent = novelTitle;

            // Reset tampilan
            editorChapterListEditable.innerHTML = '<p>Memuat chapters...</p>';
            document.getElementById('asset-explorer-content').innerHTML = '<p>Memuat aset global...</p>';
            scriptEditorArea.innerHTML = '';
            editingChapterName.textContent = 'Pilih chapter untuk diedit atau edit aset';
            scriptEditorControls.style.display = 'none';
            document.getElementById('btn-visualize-flow').style.display = 'none';
            document.getElementById('chapter-asset-explorer').style.display = 'none'; // Sembunyikan aset chapter

            // Panggil IPC untuk mendapatkan daftar chapter
            const chapterData = await ipcRenderer.invoke('get-chapter-list', novelTitle);
            currentNovelChapters = chapterData.mainChapters.concat(chapterData.sideStories);

            // Render daftar chapter
            editorChapterListEditable.innerHTML = ''; // Kosongkan daftar
            if (currentNovelChapters.length === 0) {
                editorChapterListEditable.innerHTML = '<p>Belum ada chapter di novel ini.</p>';
            } else {
                currentNovelChapters.forEach(chapter => {
                    const chapterElement = createChapterItemElement(chapter);
                    chapterElement.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadChapterScript(chapter);
                        }
                    });
                    editorChapterListEditable.appendChild(chapterElement);
                });
            }

            const globalAssets = await ipcRenderer.invoke('get-global-novel-assets', novelTitle);
            renderAssetExplorer(globalAssets, 'asset-explorer-content');

            // Load storyDesc dan isi ke textarea
            const storyDescResult = await ipcRenderer.invoke('get-story-desc', novelTitle);
            const storyDescInput = document.getElementById('editor-story-desc');
            if (storyDescInput && storyDescResult.success) {
                storyDescInput.value = storyDescResult.storyDesc || '';
            }

            editorNovelSelectionScreen.style.display = 'none';
            editorMainScreen.style.display = 'block';
        }

        function renderAssetExplorer(assets, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (containerId === 'asset-explorer-content') {
                const hubPreviewHTML = `
            <div class="asset-category">
                <div class="asset-item" id="show-hub-preview-btn" style="cursor: pointer;" title="Tampilkan pratinjau halaman utama novel">
                    <span class="file-name" style="font-weight: bold; color: #00ffff;">Hub Novel</span>
                </div>
            </div>
        `;
                container.innerHTML += hubPreviewHTML;
            }

            if (!assets || (assets.images.length === 0 && assets.audios.length === 0 && assets.videos.length === 0)) {
                container.innerHTML = '<p style="opacity:0.7; font-size:0.9em;">Tidak ada aset yang ditemukan.</p>';
                // Khusus untuk gambar dan video, tetap tampilkan tombol tambah
                if (containerId === 'chapter-asset-content' || containerId === 'asset-explorer-content') {
                    container.innerHTML += `<div class="asset-category"><h4>Gambar Lainnya</h4><button class="add-asset-btn" data-type="image" title="Tambah Gambar Baru">+</button></div>`;
                    container.innerHTML += `<div class="asset-category"><h4>Video</h4><button class="add-asset-btn" data-type="video" title="Tambah Video Baru">+</button></div>`;
                }
                return;
            }

            const coverImage = assets.images.find(img => img.fileName.startsWith('cover.'));
            const otherImages = assets.images.filter(img => !img.fileName.startsWith('cover.'));

            if (coverImage) {
                const coverCategoryHTML = `
            <div class="asset-category">
                <h4>Cover Novel</h4>
                <div class="cover-image-wrapper">
                    <img src="${coverImage.fullPath}?v=${Date.now()}" alt="${coverImage.fileName}" class="cover-image-full">
                    <button class="ganti-btn" data-path="${coverImage.relativePath}" data-full-path="${coverImage.fullPath}" data-type="image">
                        Ganti Cover
                    </button>
                </div>
                
                <!-- Input untuk edit Story Description (tagline novel) -->
                <div class="story-desc-editor" style="margin-top: 15px;">
                    <label for="editor-story-desc" style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #aaa;">Tagline Novel (maks 80 karakter)</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <textarea id="editor-story-desc" 
                            placeholder="Deskripsi singkat / tagline novel yang muncul di kartu..." 
                            maxlength="80" 
                            rows="2"
                            style="flex: 1; padding: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 0.9em; resize: none; font-family: inherit;"></textarea>
                    </div>
                    <small style="color: #666; font-size: 0.8em; display: block; margin-top: 5px;">Tagline ini akan muncul di kartu novel pada menu utama.</small>
                        <button id="save-story-desc-btn" 
                            style="padding: 8px 16px; background: transparent; border: 1px dashed #555; border-radius: 6px; color: #aaa; cursor: pointer; font-size: 0.85em; white-space: nowrap; transition: all 0.2s ease; margin-top: 10px;"
                            onmouseover="this.style.borderColor='#00ffff'; this.style.color='#00ffff';"
                            onmouseout="this.style.borderColor='#555'; this.style.color='#aaa';"
                            title="Simpan Tagline">
                             Simpan
                        </button>
                </div>
            </div>
        `;
                container.innerHTML += coverCategoryHTML;
            }

            const createAssetCategory = (title, items, type) => {
                let itemsHTML = items.map(item => {
                    let previewHTML = '';
                    if (type === 'image') previewHTML = `<img src="${item.fullPath}?v=${Date.now()}" alt="${item.fileName}">`;
                    else if (type === 'video') previewHTML = '<span></span>';

                    // Tombol hapus untuk gambar dan video
                    const deleteButtonHTML = (type === 'image' || type === 'video')
                        ? `<button class="delete-asset-btn" data-path="${item.relativePath}" title="Hapus Aset"></button>`
                        : '';

                    return `
                <div class="asset-item" title="Klik untuk pratinjau" data-path="${item.relativePath}" data-full-path="${item.fullPath}" data-type="${type}">
                    ${previewHTML}
                    <span class="file-name">${item.fileName}</span>
                    ${deleteButtonHTML}
                </div>
            `;
                }).join('');

                // Tombol tambah kondisional
                let addButtonHTML = '';
                const buttonContent = `<span class="plus-icon">+</span><div class="spinner"></div>`;

                if (type === 'image') {
                    addButtonHTML = `<button class="add-asset-btn" data-type="image" title="Tambah Gambar Baru">${buttonContent}</button>`;
                } else if (type === 'video' && items.length === 0) {
                    addButtonHTML = `<button class="add-asset-btn" data-type="video" title="Tambah Video Baru">${buttonContent}</button>`;
                }

                // Jangan render kategori sama sekali jika kosong (kecuali gambar & video)
                if (items.length === 0 && (type !== 'image' && type !== 'video')) return '';

                return `<div class="asset-category"><h4>${title}</h4>${itemsHTML}${addButtonHTML}</div>`;
            };

            container.innerHTML += createAssetCategory('Gambar Lainnya', otherImages, 'image');
            container.innerHTML += createAssetCategory('Audio', assets.audios, 'audio');
            container.innerHTML += createAssetCategory('Video', assets.videos, 'video');
        }

        async function showHubPreview() {
            if (!currentlyEditing.novel) return;

            // SEMBUNYIKAN KONTROL SKRIP UTAMA SAAT MASUK KE EDITOR HUB
            document.getElementById('script-editor-controls').style.display = 'none';
            document.getElementById('btn-visualize-flow').style.display = 'none';

            // 1. Atur tampilan editor ke mode 'preview' menggunakan manajer terpusat
            updateEditorContentView('preview');

            // Siapkan kontainer dan bersihkan isinya
            const scriptArea = document.getElementById('script-editor-area');
            scriptArea.innerHTML = '';
            editingChapterName.textContent = `Pratinjau & Edit Halaman Utama: ${currentlyEditing.novel}`;

            // 2. Minta detail novel (judul & deskripsi) dari main process
            const details = await ipcRenderer.invoke('get-hub-details', currentlyEditing.novel);

            // 3. Buat elemen pratinjau <webview>
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `width: 100%; height: 100%; overflow: hidden; background-color: #000; border-radius: 8px; border: 2px solid #333; position: relative; margin-bottom: 20px;`;

            const webview = document.createElement('webview');
            const baseWidth = 1920;
            const baseHeight = 1080;

            webview.setAttribute('webpreferences', 'nodeIntegration=true, contextIsolation=false');
            const hubUrl = `./visual_novels/${currentlyEditing.novel}/index.html?v=${Date.now()}`;
            webview.src = hubUrl;
            webview.style.cssText = `width: ${baseWidth}px; height: ${baseHeight}px; border: none; position: absolute; top: 0; left: 0; transform-origin: 0 0;`;

            // 4. log diagnostik untuk <webview>
            webview.addEventListener('dom-ready', () => {
                console.log('%c[Host] Webview DOM Ready!', 'color: green; font-weight: bold;', `Konten untuk ${webview.src} telah dimuat.`);
            });
            webview.addEventListener('did-fail-load', (error) => {
                console.error('%c[Host] Webview Gagal Dimuat!', 'color: red; font-weight: bold;', `Error: ${error.errorDescription} (Code: ${error.errorCode})`, `URL: ${error.validatedURL}`);
            });
            webview.addEventListener('console-message', (e) => {
                console.log(`%c[Dari Webview]`, 'color: #3399FF; font-weight: bold;', e.message);
            });

            // 5. Buat elemen UI untuk editor (input judul, textarea, tombol)
            webview.style.pointerEvents = 'none';
            const interactionLayer = document.createElement('div');
            interactionLayer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: auto; /* Memastikan lapisan ini bisa di-scroll */
    `;
            const editorContainer = document.createElement('div');
            editorContainer.style.cssText = `display: flex; flex-direction: column; gap: 15px;`;

            const titleInputLabel = document.createElement('label');
            titleInputLabel.textContent = 'Judul Novel';
            titleInputLabel.style.fontWeight = 'bold';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.value = details.success ? details.title : currentlyEditing.novel;
            titleInput.placeholder = 'Judul Novel...';
            titleInput.style.cssText = `width: 100%; padding: 10px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 6px; font-size: 1.1em;`;

            const descEditorLabel = document.createElement('label');
            descEditorLabel.textContent = 'Deskripsi Novel';
            descEditorLabel.style.fontWeight = 'bold';

            const descEditor = document.createElement('textarea');
            descEditor.value = details.success ? details.description : 'Gagal memuat deskripsi...';
            descEditor.placeholder = 'Tulis deskripsi di sini...';
            descEditor.style.cssText = `width: 100%; min-height: 150px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 6px; padding: 10px; font-family: 'Lexend', sans-serif; resize: vertical;`;

            // === NEW META INPUTS ===
            const metaContainer = document.createElement('div');
            metaContainer.style.cssText = `display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;`;

            const createMetaInput = (label, value, placeholder) => {
                const container = document.createElement('div');
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                labelEl.style.cssText = `display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em;`;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value || '';
                input.placeholder = placeholder;
                input.style.cssText = `width: 100%; padding: 8px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 6px;`;
                container.appendChild(labelEl);
                container.appendChild(input);
                return { container, input };
            };

            const genreInputObj = createMetaInput('Genre', details.genre, 'Romance, Fantasy');
            const authorInputObj = createMetaInput('Penulis', details.author, 'Nama Penulis');
            const illustratorInputObj = createMetaInput('Ilustrator', details.illustrator, 'Nama Ilustrator');
            const vnMapperInputObj = createMetaInput('VN Mapper', details.vnMapper, 'Pembuat VN');

            metaContainer.appendChild(genreInputObj.container);
            metaContainer.appendChild(authorInputObj.container);
            metaContainer.appendChild(illustratorInputObj.container);
            metaContainer.appendChild(vnMapperInputObj.container);
            // =======================

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `display: flex; justify-content: flex-end; gap: 10px;`;

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Simpan Semua Perubahan';
            saveButton.className = 'editor-button-save';

            // --- Rebuild & Save ---
            const rebuildSaveButton = document.createElement('button');
            rebuildSaveButton.textContent = 'Simpan & Rebuild';
            rebuildSaveButton.className = 'editor-button-save';
            rebuildSaveButton.style.backgroundColor = '#e67e22'; // Warna oranye untuk membedakan
            rebuildSaveButton.title = "Mengambil ulang template dan menerapkan perubahan (Reset Struktur)";

            rebuildSaveButton.addEventListener('click', async () => {
                const confirmRebuild = await showConfirmation('Apakah Anda yakin ingin membangun ulang halaman Hub dari template? Ini akan mereset struktur HTML ke default template, namun tetap menyimpan data judul, deskripsi, dan meta.');
                if (!confirmRebuild) return;

                rebuildSaveButton.textContent = 'Memproses...';
                rebuildSaveButton.disabled = true;

                try {
                    const fs = require('fs');
                    const path = require('path');

                    const novelDir = path.join(__dirname, 'visual_novels', currentlyEditing.novel);
                    const templatePath = path.join(__dirname, '../../hub_template.html');
                    const targetPath = path.join(novelDir, 'index.html');

                    // 1. Baca Template
                    let templateContent = fs.readFileSync(templatePath, 'utf-8');

                    // 2. Siapkan Data Pengganti
                    const newTitle = titleInput.value.trim();
                    const newDesc = descEditor.value.replace(/\n/g, '<br>'); // Convert newlines to <br>

                    const newGenre = genreInputObj.input.value.trim() || '-';
                    const newAuthor = authorInputObj.input.value.trim() || '-';
                    const newIllustrator = illustratorInputObj.input.value.trim() || '-';
                    const newVnMapper = vnMapperInputObj.input.value.trim() || '-';

                    // 3. Generate Image Tags (Scan folder novel)
                    let imageTags = '';
                    if (fs.existsSync(novelDir)) {
                        const files = fs.readdirSync(novelDir);
                        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
                        const imageFiles = files.filter(file => imageExtensions.includes(path.extname(file).toLowerCase()));

                        // Buat tag img
                        imageTags = imageFiles.map(file => `<img src="${file}" alt="${file}">`).join('\n        ');
                    }

                    // 4. Lakukan Replacement pada Template
                    let newContent = templateContent
                        .replace(/{NOVEL_TITLE}/g, newTitle)
                        .replace(/{NOVEL_DESCRIPTION}/g, newDesc)
                        .replace(/{NOVEL_GENRE}/g, newGenre)
                        .replace(/{NOVEL_AUTHOR}/g, newAuthor)
                        .replace(/{NOVEL_ILLUSTRATOR}/g, newIllustrator)
                        .replace(/{NOVEL_VN_MAPPER}/g, newVnMapper)
                        .replace(/{IMAGE_TAGS}/g, imageTags);

                    // 5. Tulis File Baru
                    fs.writeFileSync(targetPath, newContent, 'utf-8');

                    // 6. Reload Webview untuk melihat hasil
                    webview.reload();

                    showNotification('Hub berhasil dibangun ulang dan disimpan!', 'success');

                } catch (error) {
                    console.error('Gagal melakukan Rebuild & Save:', error);
                    showNotification('Gagal menyimpan: ' + error.message, 'error');
                } finally {
                    rebuildSaveButton.textContent = 'Simpan & Rebuild';
                    rebuildSaveButton.disabled = false;
                }
            });
            // -----------------------------------

            // 6. Rangkai dan tampilkan semua elemen UI
            buttonContainer.appendChild(rebuildSaveButton);
            buttonContainer.appendChild(saveButton);
            editorContainer.appendChild(titleInputLabel);
            editorContainer.appendChild(titleInput);
            editorContainer.appendChild(descEditorLabel);
            editorContainer.appendChild(descEditor);
            editorContainer.appendChild(metaContainer);
            editorContainer.appendChild(buttonContainer);
            wrapper.appendChild(webview);
            wrapper.appendChild(interactionLayer);
            scriptArea.appendChild(wrapper);
            scriptArea.appendChild(editorContainer);

            document.getElementById('asset-preview-container').style.display = 'none';
            scriptArea.style.display = 'block';

            // 7. interaktivitas
            webview.addEventListener('ipc-message', async (event) => {
                if (event.channel === 'get-chapter-list-request') {
                    const chapters = await ipcRenderer.invoke('get-chapter-list', currentlyEditing.novel);
                    webview.send('chapter-data-response', chapters);
                }
                if (event.channel === 'play-chapter') {
                    ipcRenderer.send('play-chapter', event.args[0]);
                }
            });

            descEditor.addEventListener('input', () => {
                webview.send('update-description', descEditor.value.replace(/\n/g, '<br>'));
            });

            titleInput.addEventListener('input', () => {
                console.log(`[Host Editor] Mengirim 'update-title' dengan nilai: "${titleInput.value}"`);
                webview.send('update-title', titleInput.value);
            });

            saveButton.addEventListener('click', async () => {
                saveButton.textContent = 'Menyimpan...';
                saveButton.disabled = true;

                const result = await ipcRenderer.invoke('update-hub-details', {
                    originalTitle: currentlyEditing.novel,
                    newTitle: titleInput.value.trim(),
                    newDescription: descEditor.value,
                    newGenre: genreInputObj.input.value,
                    newAuthor: authorInputObj.input.value,
                    newIllustrator: illustratorInputObj.input.value,
                    newVnMapper: vnMapperInputObj.input.value
                });

                if (result.success) {
                    const newTitle = titleInput.value.trim();
                    if (currentlyEditing.novel !== newTitle) {
                        currentlyEditing.novel = newTitle;
                        editingNovelName.textContent = newTitle;
                        await loadStories();
                        const stories = await ipcRenderer.invoke('get-story-list');
                        renderNovelSelectionList(stories);
                    }
                    showNotification(result.message, 'success');
                } else {
                    showNotification(result.message, 'error');
                    titleInput.value = currentlyEditing.novel;
                }

                saveButton.textContent = 'Simpan Semua Perubahan';
                saveButton.disabled = false;
            });

            // 8. Atur skala webview agar responsif
            setTimeout(() => {
                if (!wrapper.clientWidth) return;
                const containerWidth = wrapper.clientWidth;
                const scale = containerWidth / baseWidth;
                webview.style.transform = `scale(${scale})`;
                wrapper.style.height = `${baseHeight * scale}px`;
            }, 50);
        }

        // helper untuk merender daftar novel di editor
        function renderNovelSelectionList(stories) {
            editorNovelList.innerHTML = '';
            if (stories.length === 0) {
                editorNovelList.innerHTML = `<p>Belum ada novel. Buat novel baru terlebih dahulu.</p>`;
            } else {
                stories.forEach((story, index) => {
                    const storyCard = document.createElement('div');
                    storyCard.className = 'story-card';
                    storyCard.dataset.title = story.title;

                    const coverFile = story.cover || 'cover.jpg';
                    // cache buster untuk memastikan cover terbaru yang ditampilkan
                    storyCard.style.backgroundImage = `url('./visual_novels/${encodeURIComponent(story.title)}/${coverFile}?v=${Date.now()}')`;

                    storyCard.innerHTML = `
                <div class="overlay"><h2 class="story-title">${story.title}</h2></div>
                <button class="delete-novel-btn" title="Hapus Novel"></button>
            `;

                    storyCard.onclick = (e) => {
                        // Jangan load novel jika yang diklik adalah tombol hapus
                        if (e.target.closest('.delete-novel-btn')) return;
                        loadNovelForEditing(story.title);
                    };

                    // Event listener untuk tombol hapus
                    const deleteBtn = storyCard.querySelector('.delete-novel-btn');
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation(); // Mencegah event bubbling ke storyCard
                        // Menggunakan showConfirmation() custom modal agar fokus tidak hilang
                        const confirmed = await showConfirmation(`Apakah Anda yakin ingin menghapus novel "${story.title}" beserta seluruh isinya? Tindakan ini tidak dapat dibatalkan.`);
                        if (confirmed) {
                            const result = await ipcRenderer.invoke('delete-novel-folder', story.title);
                            if (result.success) {
                                // Refresh list novel
                                const updatedStories = await ipcRenderer.invoke('get-story-list');
                                renderNovelSelectionList(updatedStories);
                                showNotification('Novel berhasil dihapus.', 'success');
                            } else {
                                showNotification(result.message || 'Gagal menghapus novel.', 'error');
                            }
                        }
                    };

                    editorNovelList.appendChild(storyCard);

                    // animasi muncul bertahap
                    setTimeout(() => {
                        storyCard.classList.add('show');
                    }, index * 50);
                });
            }
        }

        async function refreshAssetExplorers() {
            // Refresh Aset Global
            const globalAssets = await ipcRenderer.invoke('get-global-novel-assets', currentlyEditing.novel);
            renderAssetExplorer(globalAssets, 'asset-explorer-content');

            // Refresh Aset Chapter jika ada chapter yang aktif
            if (currentlyEditing.chapter) {
                const chapterAssets = await ipcRenderer.invoke('get-chapter-assets', {
                    storyTitle: currentlyEditing.novel,
                    chapterName: currentlyEditing.chapter
                });
                renderAssetExplorer(chapterAssets, 'chapter-asset-content');
            }
        }

        // Listener utama untuk tombol Tambah dan Hapus
        document.addEventListener('click', async (event) => {
            const addBtn = event.target.closest('.add-asset-btn');
            const deleteAssetBtn = event.target.closest('.delete-asset-btn');
            const deleteBtn = event.target.closest('.delete-dialogue-btn, .delete-label-group-btn, .delete-phase-btn');
            const hubPreviewBtn = event.target.closest('#show-hub-preview-btn');

            if (hubPreviewBtn) {
                showHubPreview();
                return;
            }

            // Logika Tombol Clone/Duplikat Entri
            const cloneBtn = event.target.closest('.clone-dialogue-btn');
            if (cloneBtn) {
                const entryCard = cloneBtn.closest('.dialogue-entry-card');
                if (entryCard) {
                    // 1. Ekstrak data dari kartu saat ini
                    const entryData = extractDataFromCard(entryCard);

                    // 2. Buat kartu baru dengan data tersebut
                    // Dialogue entry tidak butuh availableLabels (hanya choice yang butuh), jadi [] aman.
                    const newCard = createEntryEditorCard(entryData.type, entryData, []);

                    // 3. Sisipkan setelah kartu saat ini
                    entryCard.after(newCard);

                    // 4. Scroll ke kartu baru
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // 5. Animasi highlight
                    const originalBg = newCard.style.backgroundColor;
                    newCard.style.transition = 'background-color 0.5s';
                    newCard.style.backgroundColor = '#2c3e50'; // Highlight color
                    setTimeout(() => {
                        newCard.style.backgroundColor = originalBg;
                    }, 500);

                    showNotification('Entri berhasil diduplikasi.', 'success');
                }
                return;
            }

            // === MULTI-SPRITE SYSTEM: Tombol Tambah Sprite Tambahan ===
            const addExtraSpriteBtn = event.target.closest('.add-extra-sprite-btn');
            if (addExtraSpriteBtn) {
                const extraSpritesSection = addExtraSpriteBtn.closest('.extra-sprites-section');
                const container = extraSpritesSection?.querySelector('.extra-sprites-container');
                const emptyMsg = extraSpritesSection?.querySelector('.extra-sprites-empty-msg');
                const spriteIndex = container ? container.children.length : 0;

                if (container) {
                    // Buat item sprite baru dengan format yang sama seperti sprite preset
                    const newSpriteItem = document.createElement('div');
                    newSpriteItem.className = 'extra-sprite-item';
                    newSpriteItem.dataset.spriteIndex = spriteIndex;
                    newSpriteItem.innerHTML = `
                        <div class="file-input-group">
                            <div class="input-with-clear-wrapper">
                                <input type="text" class="script-input image-input extra-sprite-src" value="" placeholder="Pilih file gambar...">
                                <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                            </div>
                            <button type="button" class="browse-file-btn" data-type="image"></button>
                            <button type="button" class="remove-extra-sprite-btn" title="Hapus Sprite Custom" style="background: #f44; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.9em;"></button>
                        </div>
                        <div class="sprite-config-container">
                            <div class="sprite-anim-wrapper extra-sprite-wrapper" data-preview-for="extra-new"><img src="" class="sprite-anim-img extra-sprite-preview" onload="this.parentElement.classList.add('visible')" onerror="this.parentElement.classList.remove('visible')"></div>
                            <div class="animation-controls" style="display: none;">
                                <label class="animation-label"> Konfigurasi</label>
                                <select class="script-input sprite-anim-selector extra-sprite-anim">
                                    <option value="anim-in-fade" selected>Tampil Langsung</option>
                                    <optgroup label="Animasi Masuk">
                                        <option value="anim-in-slide-from-bottom">Naik dari Bawah</option>
                                        <option value="anim-in-slide-from-left">Geser dari Kiri</option>
                                        <option value="anim-in-slide-from-right">Geser dari Kanan</option>
                                    </optgroup>
                                    <optgroup label="Animasi Keluar">
                                        <option value="anim-out-fade">Hilang Perlahan</option>
                                        <option value="anim-out-slide-to-bottom">Turun ke Bawah</option>
                                    </optgroup>
                                    <optgroup label="Animasi Loop">
                                        <option value="anim-loop-pulse-glow">Berkedip Lembut</option>
                                        <option value="anim-loop-gentle-float">Mengambang</option>
                                    </optgroup>
                                </select>
                                <label class="animation-label" style="margin-top: 8px;">Transformasi</label>
                                <div class="transform-controls-group">
                                    <div class="transform-row">
                                        <span class="transform-label">Ukuran</span>
                                        <input type="range" class="script-input scale-slider extra-sprite-scale transform-slider" value="50" min="0" max="100" step="1">
                                        <span class="scale-value-display transform-value">50%</span>
                                    </div>
                                    <div class="transform-row position-x-row">
                                        <span class="transform-label">Posisi X</span>
                                        <input type="range" class="script-input extra-sprite-x transform-slider" value="50" min="0" max="100" step="1">
                                        <span class="position-value-display transform-value">50%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(newSpriteItem);

                    // Sembunyikan pesan kosong
                    if (emptyMsg) emptyMsg.style.display = 'none';

                    // Bind event listener untuk live animation preview pada selector animasi
                    const animSelector = newSpriteItem.querySelector('.extra-sprite-anim');
                    const imgPreview = newSpriteItem.querySelector('.extra-sprite-preview');

                    if (animSelector && imgPreview) {
                        // Fungsi untuk menerapkan animasi live
                        const applyLiveAnimation = () => {
                            const animValue = animSelector.value || 'anim-in-fade';
                            const animClassMap = {
                                // 'anim-in-fade': 'editor-anim-in-fade',
                                'anim-in-slide-from-bottom': 'editor-anim-in-slide-from-bottom',
                                'anim-in-slide-from-left': 'editor-anim-in-slide-from-left',
                                'anim-in-slide-from-right': 'editor-anim-in-slide-from-right',
                                'anim-out-fade': 'editor-anim-out-fade',
                                'anim-out-slide-to-bottom': 'editor-anim-out-slide-to-bottom',
                                'anim-out-slide-to-left': 'editor-anim-out-slide-to-left',
                                'anim-out-slide-to-right': 'editor-anim-out-slide-to-right',
                                'anim-loop-pulse-glow': 'editor-anim-loop-pulse-glow',
                                'anim-loop-gentle-float': 'editor-anim-loop-gentle-float',
                                'anim-loop-shake': 'editor-anim-loop-shake',
                                'anim-oneshot-shake': 'editor-anim-oneshot-shake',
                                'anim-oneshot-jump': 'editor-anim-oneshot-jump',
                                'anim-loop-pulse': 'editor-anim-loop-pulse'
                            };

                            // Hapus semua kelas animasi
                            Object.values(animClassMap).forEach(cls => imgPreview.classList.remove(cls));

                            // Terapkan kelas animasi baru - cek parent wrapper untuk visibility
                            const editorAnimClass = animClassMap[animValue];
                            const wrapper = imgPreview.closest('.sprite-anim-wrapper');
                            const isVisible = wrapper ? wrapper.classList.contains('visible') : imgPreview.parentElement && imgPreview.parentElement.style.display !== 'none';

                            if (editorAnimClass && isVisible) {
                                void imgPreview.offsetWidth; // Trigger reflow
                                imgPreview.classList.add(editorAnimClass);
                            }
                        };

                        // Pasang listener untuk perubahan selector
                        animSelector.addEventListener('change', applyLiveAnimation);
                    }

                    // Focus ke input file
                    newSpriteItem.querySelector('.extra-sprite-src')?.focus();
                }
                return;
            }

            // === MULTI-SPRITE SYSTEM: Tombol Hapus Sprite Tambahan ===
            const removeExtraSpriteBtn = event.target.closest('.remove-extra-sprite-btn');
            if (removeExtraSpriteBtn) {
                const spriteItem = removeExtraSpriteBtn.closest('.extra-sprite-item');
                const container = spriteItem?.parentElement;
                const extraSpritesSection = spriteItem?.closest('.extra-sprites-section');
                const emptyMsg = extraSpritesSection?.querySelector('.extra-sprites-empty-msg');

                if (spriteItem) {
                    spriteItem.remove();

                    // Tampilkan pesan kosong jika tidak ada sprite tersisa
                    if (container && container.children.length === 0 && emptyMsg) {
                        emptyMsg.style.display = 'block';
                    }
                }
                return;
            }

            // Logika Tombol Hapus Aset
            if (deleteAssetBtn) {
                const assetItem = deleteAssetBtn.closest('.asset-item');
                const relativePath = assetItem?.dataset.path;

                if (!relativePath) return;

                const confirmed = await showConfirmation(`Anda yakin ingin menghapus file aset "${path.basename(relativePath)}" secara permanen? Aksi ini tidak bisa dibatalkan.`);

                if (confirmed) {
                    const result = await ipcRenderer.invoke('delete-asset-file', {
                        novelTitle: currentlyEditing.novel,
                        relativePath: relativePath
                    });

                    showNotification(result.message, result.success ? 'success' : 'error');

                    if (result.success) {
                        refreshAssetExplorers(); // Memuat ulang daftar aset
                    }
                }
                return;
            }

            // Logika Tombol Tambah (+)
            if (addBtn) {
                const assetType = addBtn.dataset.type;
                let filters;

                if (assetType === 'image') {
                    filters = [{ name: 'Gambar', extensions: ['jpg', 'jpeg', 'png', 'webp'] }];
                } else if (assetType === 'video') {
                    filters = [{ name: 'Video', extensions: ['mp4', 'webm'] }];
                }

                if (!filters) return;

                const inChapterEditor = addBtn.closest('#chapter-asset-content');
                const targetChapter = inChapterEditor ? currentlyEditing.chapter : '';

                const newFile = await ipcRenderer.invoke('open-and-read-file', { filters });
                if (newFile) {
                    // Tampilkan loading indicator
                    addBtn.classList.add('loading');

                    try {
                        let result;
                        if (assetType === 'image') {
                            result = await ipcRenderer.invoke('add-asset-file', {
                                novelTitle: currentlyEditing.novel,
                                chapterName: targetChapter,
                                file: newFile
                            });
                        } else if (assetType === 'video') {
                            result = await ipcRenderer.invoke('add-asset-file', { // Tetap panggil handler yang pintar
                                novelTitle: currentlyEditing.novel,
                                chapterName: targetChapter, // akan bernilai '' untuk video global
                                file: newFile
                            });
                        }

                        showNotification(result.message, result.success ? 'success' : 'error');
                        if (result.success) {
                            refreshAssetExplorers();
                        }
                    } finally {
                        // Selalu hilangkan loading indicator setelah selesai
                        addBtn.classList.remove('loading');
                    }
                }
            }

            // --- Logika Hapus ---
            if (deleteBtn) {
                // Kasus 1: Hapus FASE
                if (deleteBtn.classList.contains('delete-phase-btn')) {
                    const phaseCard = deleteBtn.closest('.phase-card');
                    const nameInput = phaseCard?.querySelector('.phase-name-input');
                    const phaseName = nameInput ? nameInput.value.trim() : '(tanpa nama)';
                    const confirmed = await showConfirmation(`Anda yakin ingin menghapus fase "${phaseName}" beserta seluruh isinya?`);
                    if (confirmed) {
                        phaseCard.remove();
                        updateAllJumpTargetDropdowns();
                    }
                    return;
                }

                // Kasus 2: Hapus GRUP LABEL
                if (deleteBtn.classList.contains('delete-label-group-btn')) {
                    const groupToRemove = deleteBtn.closest('.label-group-container');
                    const confirmed = await showConfirmation('Anda yakin ingin menghapus label ini beserta seluruh dialog di dalamnya?');
                    if (confirmed) {
                        groupToRemove.remove();
                        updateAllJumpTargetDropdowns();
                    }
                    return;
                }

                // Kasus 3: Hapus ENTRI INDIVIDUAL (dialogue, scene, choice)
                if (deleteBtn.classList.contains('delete-dialogue-btn')) {
                    const cardToRemove = deleteBtn.closest('.dialogue-entry-card');
                    if (!cardToRemove) return;

                    if (cardToRemove.classList.contains('entry-type-choice')) {
                        const confirmed = await showConfirmation('Yakin ingin menghapus kartu Pilihan (Choice) ini?');
                        if (confirmed) {
                            cardToRemove.remove();
                            updateAllJumpTargetDropdowns();
                        }
                    } else if (cardToRemove.dataset.type === 'special_event') {
                        const confirmed = await showConfirmation('Yakin ingin menghapus Special Event ini?');
                        if (confirmed) {
                            cardToRemove.remove();
                        }
                    } else {
                        cardToRemove.remove();
                    }
                    return;
                }
            }
        });

        // ============== Edit cerita ================ //
        function groupScriptByPhase(scriptData) {
            const phaseGroups = [];
            let currentPhaseGroup = { phase: { type: 'phase', name: 'default' }, entries: [] };

            scriptData.forEach(entry => {
                if (entry.type === 'phase') {
                    // Jika sudah ada entri di grup sebelumnya, simpan dulu
                    if (currentPhaseGroup.entries.length > 0) {
                        phaseGroups.push(currentPhaseGroup);
                    }
                    // Mulai grup baru
                    currentPhaseGroup = { phase: entry, entries: [] };
                } else {
                    // Tambah entri ke grup yang sedang berjalan
                    currentPhaseGroup.entries.push(entry);
                }
            });

            // Jangan lupa simpan grup terakhir
            phaseGroups.push(currentPhaseGroup);

            return phaseGroups;
        }

        let editorObserver = null;

        // Muat isi script.json dari chapter yang dipilih
        async function loadChapterScript(chapterName) {
            if (!chapterName) {
                console.error("loadChapterScript dipanggil tanpa chapterName yang valid. Proses dibatalkan.");
                scriptEditorArea.innerHTML = '<h4>Gagal memuat chapter: Tidak ada nama chapter yang diberikan.</h4>';
                return;
            }

            updateEditorContentView('chapters');
            currentlyEditing.chapter = chapterName;
            editingChapterName.textContent = `Mengedit: ${chapterName}`;
            document.getElementById('btn-visualize-flow').style.display = 'block';
            scriptEditorArea.innerHTML = '<h4>Memuat skrip...</h4>';

            document.querySelectorAll('.chapter-edit-item').forEach(el => {
                el.classList.toggle('active', el.dataset.originalName === chapterName);
            });

            const result = await ipcRenderer.invoke('get-script-content', {
                storyTitle: currentlyEditing.novel,
                chapterName: currentlyEditing.chapter
            });

            if (result.success) {
                const availableLabels = result.data
                    .filter(entry => entry.type === 'label')
                    .map(entry => entry.name);

                const availablePhases = result.data
                    .filter(entry => entry.type === 'phase' && entry.name)
                    .map(entry => entry.name);

                const groupedData = groupScriptByPhase(result.data);
                renderGroupedScriptEditor(groupedData, availableLabels, availablePhases);

                scriptEditorArea.querySelectorAll('.image-input').forEach(input => {
                    updateImagePreviewUI(input);
                });

                scriptEditorControls.style.display = 'block';
                const btnVisualize = document.getElementById('btn-visualize-flow');
                if (btnVisualize) btnVisualize.style.display = 'inline-block';

                // Hentikan observer lama jika ada, untuk mencegah duplikasi
                if (editorObserver) {
                    editorObserver.disconnect();
                }

                // Panggil fungsi pengecekan sekali saat pertama kali dimuat
                updateSceneButtonStates();

                // Siapkan observer baru untuk mengawasi perubahan DOM
                const targetNode = scriptEditorArea;
                const config = { childList: true, subtree: true };

                // Callback yang akan dijalankan setiap ada perubahan
                const callback = function (mutationsList, observer) {
                    // Setiap kali ada entri ditambah atau dihapus, panggil ulang fungsi pengecekan
                    updateSceneButtonStates();
                };

                editorObserver = new MutationObserver(callback);
                editorObserver.observe(targetNode, config);

                scriptEditorArea.querySelectorAll('.persist-background-checkbox').forEach(checkbox => {
                    toggleTransitionOutControls(checkbox);
                });

                updateAllJumpTargetDropdowns();

            } else {
                scriptEditorArea.innerHTML = `<h4>Error: ${result.message}</h4>`;
                scriptEditorControls.style.display = 'none';
                const btnVisualize = document.getElementById('btn-visualize-flow');
                if (btnVisualize) btnVisualize.style.display = 'none';
                document.getElementById('chapter-asset-explorer').style.display = 'none';
            }

            const chapterAssets = await ipcRenderer.invoke('get-chapter-assets', {
                storyTitle: currentlyEditing.novel,
                chapterName: currentlyEditing.chapter
            });
            renderAssetExplorer(chapterAssets, 'chapter-asset-content');
            document.getElementById('chapter-asset-explorer').style.display = 'block';
        }

        function renderGroupedScriptEditor(groupedData, availableLabels = [], availablePhases = []) {
            scriptEditorArea.innerHTML = '';

            if (groupedData.length === 0 || (groupedData.length === 1 && groupedData[0].entries.length === 0)) {
                scriptEditorArea.innerHTML = '<h4>Skrip masih kosong. Buat fase dan entri pertama Anda.</h4>';
            } else {
                groupedData.forEach((group, index) => {
                    // Oper argumennya ke fungsi berikutnya, dan tandai jika index adalah 0
                    const phaseCard = createPhaseEditorCard(group, availableLabels, availablePhases, index === 0);
                    scriptEditorArea.appendChild(phaseCard);
                });
            }

            const addPhaseButton = createAddPhaseButton();
            scriptEditorArea.appendChild(addPhaseButton);
        }

        function structurePhaseEntries(entries) {
            const structured = [];
            let currentLabelGroup = null;
            let currentSubLabelGroup = null;

            // Bersihkan flag _processed dari pemanggilan sebelumnya
            entries.forEach(e => delete e._processed);

            for (const entry of entries) {
                if (entry._processed) continue;

                if (entry.type === 'label') {
                    if (entry.name.includes('.')) { // Ini adalah sub-label
                        if (currentLabelGroup) {
                            // Tutup sub-label sebelumnya jika ada
                            currentSubLabelGroup = null;
                            currentSubLabelGroup = { type: 'sub_label_group', label: entry, children: [] };
                            currentLabelGroup.children.push(currentSubLabelGroup);
                        }
                    } else { // Ini adalah label utama
                        // Sebuah label utama baru selalu menutup label utama sebelumnya
                        currentLabelGroup = null;
                        currentLabelGroup = { type: 'label_group', label: entry, children: [] };
                        structured.push(currentLabelGroup);
                        currentSubLabelGroup = null;
                    }
                } else if (entry.type === 'jump') {
                    if (currentSubLabelGroup) {
                        // Jump ini milik sub-label, jadikan anak terakhirnya
                        currentSubLabelGroup.children.push(entry);
                        // Setelah jump, sub-label ini selesai
                        currentSubLabelGroup = null;
                    } else if (currentLabelGroup) {
                        // Jump ini milik label utama, jadikan anak terakhirnya
                        currentLabelGroup.children.push(entry);
                        // Setelah jump, label utama ini selesai
                        currentLabelGroup = null;
                    } else {
                        // Jump ini berada di luar label manapun
                        structured.push(entry);
                    }
                } else {
                    // Ini adalah entri biasa (dialogue, scene, choice)
                    const container = currentSubLabelGroup?.children || currentLabelGroup?.children;
                    if (container) {
                        // Jika ada grup aktif, masukkan ke dalamnya
                        container.push(entry);
                    } else {
                        // Jika tidak, ini adalah entri di level fase
                        structured.push(entry);
                    }
                }
            }
            return structured;
        }

        function getDragContext(sortableList) {
            if (sortableList.closest('.sub-label-container')) {
                return 'SubLabel';
            }
            if (sortableList.closest('.label-group-container')) {
                return 'Label';
            }
            if (sortableList.closest('.phase-card')) {
                return 'Phase';
            }
            return null;
        }

        // membuat kartu fase lengkap
        function createPhaseEditorCard(group = { phase: {}, entries: [] }, availableLabels = [], availablePhases = [], isFirstPhase = false) {
            const phaseCard = document.createElement('div');
            phaseCard.className = `phase-card ${group.phase?.isEnding ? 'is-ending' : ''}`.trim();
            phaseCard.dataset.phaseName = group.phase.name || 'default';

            const createImgPreview = (value, key) => {
                const src = value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}` : '';
                return `<img src="${src}" class="image-preview" data-preview-for="${key}" style="display: ${value ? 'block' : 'none'};" onload="this.style.display='block'" onerror="this.style.display='none'">`;
            };

            const endingToggleHTML = isFirstPhase ? '' : `
                <div class="phase-ending-toggle">
                    <input type="checkbox" class="is-ending-checkbox" id="ending-check-${group.phase.name || Math.random()}" ${group.phase.isEnding ? 'checked' : ''}>
                    <label for="ending-check-${group.phase.name || Math.random()}">Jadikan Fase Akhir (Ending)</label>
                </div>
            `;

            // Determine initial value (video takes precedence if both exist, though they shouldn't)
            const initialMediaValue = group.phase.video || group.phase.background || '';
            const isVideo = !!group.phase.video;

            phaseCard.innerHTML = `
        <div class="phase-header">
            <h3>
                <input type="text" class="phase-name-input" value="${group.phase.name || ''}" placeholder="Nama Fase...">
                <button type="button" class="delete-phase-btn" title="Hapus Fase Ini"></button>
            </h3>
            <div class="phase-assets">
                <div>
                    <label>Default Background (Gambar / Video)</label>
                    <div class="file-input-group">
                        <div class="input-with-clear-wrapper ${initialMediaValue ? 'has-text' : ''}">
                            <input data-key="media" type="text" class="phase-media-input script-input" value="${initialMediaValue}" placeholder="Pilih file gambar atau video...">
                            <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                        </div>
                        <button type="button" class="browse-file-btn" data-type="all-media"></button>
                    </div>

                    <div class="media-preview-container" style="margin-top: 10px;">
                        <!-- Image Preview Wrapper -->
                        <div class="image-preview-wrapper" style="display: ${!isVideo && initialMediaValue ? 'block' : 'none'};">
                            <div class="image-preview-container-16-9">
                                <img class="image-preview" data-preview-for="background" src="${!isVideo && initialMediaValue ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${initialMediaValue}` : ''}" style="display: ${!isVideo && initialMediaValue ? 'block' : 'none'};">
                            </div>
                            <div class="background-mode-options">
                                <label>Tampilan:</label>
                                <label>
                                    <input type="radio" name="background-mode-${group.phase.name || Math.random()}" class="script-input" data-key="backgroundMode" value="cover" ${!group.phase.backgroundMode || group.phase.backgroundMode === 'cover' ? 'checked' : ''}> Crop (Penuhi Layar)
                                </label>
                                <label>
                                    <input type="radio" name="background-mode-${group.phase.name || Math.random()}" class="script-input" data-key="backgroundMode" value="contain" ${group.phase.backgroundMode === 'contain' ? 'checked' : ''}> Fit (Tampilkan Utuh)
                                </label>
                            </div>
                        </div>

                        <!-- Video Preview Wrapper -->
                        <div class="video-preview-wrapper" style="display: ${isVideo ? 'block' : 'none'};">
                            <div class="video-preview-container" style="width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #444;">
                                <video class="video-preview" data-preview-for="video" controls muted src="${isVideo ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${initialMediaValue}` : ''}" style="display: ${isVideo ? 'block' : 'none'}; width: 100%; height: 100%; object-fit: contain;"></video>
                            </div>
                        </div>
                        
                        <span class="preview-placeholder" style="display: ${!initialMediaValue ? 'block' : 'none'}; color: #777; text-align: center; padding: 20px; border: 1px dashed #555; border-radius: 4px;">Belum ada background dipilih...</span>
                    </div>
                </div>
                <div>
                    <label>Default BGM</label>
                    <div class="file-input-group">
                        <div class="input-with-clear-wrapper ${group.phase.bgm ? 'has-text' : ''}">
                            <input data-key="bgm" type="text" class="phase-default-bgm-input script-input audio-input" value="${group.phase.bgm || ''}" placeholder="Pilih file audio...">
                            <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                        </div>
                        <button type="button" class="browse-file-btn" data-type="audio"></button>
                    </div>
                    <div class="audio-preview-placeholder" data-src="${group.phase.bgm || ''}" data-preview-for="bgm"></div>
                </div>
            </div>
            ${endingToggleHTML}
        </div>
    `;

            const bgmInput = phaseCard.querySelector('.phase-default-bgm-input');
            const bgmVolumeControl = createAudioControls('bgm', group.phase);
            bgmInput.closest('.file-input-group').after(bgmVolumeControl);
            linkAudioInputToVolumeControl(bgmInput, bgmVolumeControl);

            // Logic to handle input changes and update preview
            const mediaInput = phaseCard.querySelector('.phase-media-input');
            const imageWrapper = phaseCard.querySelector('.image-preview-wrapper');
            const videoWrapper = phaseCard.querySelector('.video-preview-wrapper');
            const placeholder = phaseCard.querySelector('.preview-placeholder');
            const imgPreview = phaseCard.querySelector('.image-preview');
            const videoPreview = phaseCard.querySelector('.video-preview');

            const updateMediaPreview = (filename) => {
                if (!filename) {
                    imageWrapper.style.display = 'none';
                    videoWrapper.style.display = 'none';
                    placeholder.style.display = 'block';
                    return;
                }

                const ext = filename.split('.').pop().toLowerCase();
                const isVideoFile = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);
                const src = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${filename}`;

                if (isVideoFile) {
                    imageWrapper.style.display = 'none';
                    videoWrapper.style.display = 'block';
                    placeholder.style.display = 'none';
                    videoPreview.src = src;
                    videoPreview.style.display = 'block';
                    videoPreview.load();
                } else {
                    imageWrapper.style.display = 'block';
                    videoWrapper.style.display = 'none';
                    placeholder.style.display = 'none';
                    imgPreview.src = src;
                    imgPreview.style.display = 'block';
                }
            };

            mediaInput.addEventListener('input', (e) => {
                updateMediaPreview(e.target.value);
            });

            const contentDiv = document.createElement('div');
            contentDiv.className = 'phase-content';

            const structuredEntries = structurePhaseEntries(group.entries);

            const renderNode = (node, parentContainer) => {
                if (node.isDefaultAssetHolder) {
                    return;
                }

                const inLabelContext = parentContainer.matches('.label-group-content, .sub-label-content');

                if (node.type === 'label_group') {
                    const labelGroupEl = createLabelGroupElement(node.label, availableLabels, availablePhases, node.label);

                    const lastChild = node.children.length > 0 ? node.children[node.children.length - 1] : null;
                    const dropdown = labelGroupEl.querySelector('.label-jump-target');
                    if (dropdown && lastChild && lastChild.type === 'jump') {
                        dropdown.value = lastChild.target;
                        updateSelectColor(dropdown);
                        lastChild._processed = true;
                    }
                    const contentContainer = labelGroupEl.querySelector('.label-group-content');

                    node.children.forEach(childNode => {
                        renderNode(childNode, contentContainer)
                    });
                    parentContainer.appendChild(labelGroupEl);

                } else if (node.type === 'sub_label_group') {
                    const subLabelName = node.label.name.split('.')[1] || '';
                    const parentName = node.label.name.split('.')[0] || '';
                    const lastChild = node.children.length > 0 ? node.children[node.children.length - 1] : null;
                    const subLabelEl = createSubLabelElement(subLabelName, parentName, '');
                    if (lastChild && lastChild.type === 'jump') {
                        const dropdown = subLabelEl.querySelector('.sub-label-jump-target');
                        if (dropdown) {
                            dropdown.value = lastChild.target;
                            updateSelectColor(dropdown);
                        }
                        lastChild._processed = true;
                    }
                    const contentContainer = subLabelEl.querySelector('.sub-label-content');
                    node.children.forEach(childNode => renderNode(childNode, contentContainer));
                    parentContainer.appendChild(subLabelEl);
                } else {
                    if (!node._processed) {
                        const card = createEntryEditorCard(node.type, node, availableLabels, inLabelContext);
                        if (card) parentContainer.appendChild(card);
                    }
                }
            };

            structuredEntries.forEach(node => renderNode(node, contentDiv));
            phaseCard.appendChild(contentDiv);
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'phase-card-controls';
            controlsDiv.innerHTML = `
                <button class="add-entry-btn" data-type="label">+ Tambah Label</button>
                <button class="add-entry-btn" data-type="dialogue">+ Tambah Dialog</button>
                <button class="add-entry-btn" data-type="choice">+ Tambah Dialog ber-Pilihan Jawaban</button> 
                <button class="add-entry-btn" data-type="scene">+ Tambah Transisi</button>

            `;

            // Dropdown untuk transisi keluar fase
            const exitTransitionDiv = document.createElement('div');
            exitTransitionDiv.className = 'phase-exit-transition';
            exitTransitionDiv.innerHTML = `
                <label>Animasi Transisi Keluar Fase</label>
                <select class="phase-exit-transition-select script-input" data-key="transitionOut">
                    <option value="">Tanpa Transisi (Default)</option>
                    <option value="fade_black" ${group.phase.transitionOut === 'fade_black' ? 'selected' : ''}>Fade Hitam </option>
                    <option value="fade_white" ${group.phase.transitionOut === 'fade_white' ? 'selected' : ''}>Fade Putih </option>
                    <option value="swipe_black_left" ${group.phase.transitionOut === 'swipe_black_left' ? 'selected' : ''}>Geser Hitam Kiri </option>
                    <option value="swipe_black_right" ${group.phase.transitionOut === 'swipe_black_right' ? 'selected' : ''}>Geser Hitam Kanan </option>
                </select>
            `;

            const flowControlDiv = document.createElement('div');
            flowControlDiv.className = 'phase-flow-control';
            const phaseOptions = availablePhases.filter(name => name !== group.phase.name).map(name => `<option value="fase:${name}">${name}</option>`).join('');
            flowControlDiv.innerHTML = `
                <div class="label-with-tooltip">
                    <label>Jika alur cerita sampai ke ujung fase ini, mau ke mana? :</label>
                    <div class="tooltip-trigger">?
                        <span class="tooltip-text">Pada kasus tertentu mungkin cerita/dialog yang kamu buat tidak akan selalu sampai di ujung Fase, karena bisa saja ada label yang kamu atur untuk keluar ke Fase lain.</span>
                    </div>
                </div>
                <select class="phase-jump-target">
                    <option value="">Lanjut ke fase berikutnya (Default)</option>
                    <optgroup label="------ Fase ------">${phaseOptions}</optgroup>
                </select>
            `;
            if (group.phase?.isEnding) {
                flowControlDiv.style.display = 'none';
            }
            phaseCard.appendChild(controlsDiv);
            phaseCard.appendChild(exitTransitionDiv);
            phaseCard.appendChild(flowControlDiv);
            const sortableGroupConfig = {
                name: 'phase-entries',
                put: function (toList, fromList, draggedEl) {
                    return !draggedEl.classList.contains('label-group-container');
                }
            };
            new Sortable(contentDiv, {
                group: {
                    name: 'phase-entries',
                    put: function (toList, fromList, draggedEl) {
                        const draggedType = draggedEl.dataset.type;
                        const sourceType = getDragContext(fromList);
                        const targetType = getDragContext(toList);

                        if (draggedType === 'sub-label') {
                            return false;
                        }

                        if (draggedType === 'choice') {
                            if (sourceType === 'Phase' && (targetType === 'Label' || targetType === 'SubLabel')) {
                                return false;
                            }
                            if ((sourceType === 'Label' || sourceType === 'SubLabel') && targetType === 'Phase') {
                                return false;
                            }
                        }

                        if (draggedEl.classList.contains('label-group-container') && (targetType === 'Label' || targetType === 'SubLabel')) {
                            return false;
                        }

                        return true;
                    }
                },
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                forceFallback: true,
                fallbackOnBody: true,

                onMove: function (evt) {
                    const isScene = evt.dragged.dataset.type === 'scene';
                    if (isScene) {
                        let isInvalidMove = false;
                        if (evt.to.children.length === 0 || (evt.to.children.length === 1 && evt.to.children[0] === evt.dragged)) { isInvalidMove = true; }
                        if (evt.willInsertAfter === false && evt.related === evt.to.children[0]) { isInvalidMove = true; }

                        if (isInvalidMove) {
                            document.body.classList.add('invalid-drag-state');
                            dragTooltip.textContent = " Scene tidak boleh menjadi entri pertama.";
                            return false;
                        }
                    }

                    if (evt.from !== evt.to) {
                        const canPut = this.options.group.put(evt.to, evt.from, evt.dragged);
                        if (!canPut) {
                            document.body.classList.add('invalid-drag-state');
                            dragTooltip.textContent = " Tipe entri ini tidak bisa dipindahkan ke sini.";
                            return false;
                        }
                    }

                    document.body.classList.remove('invalid-drag-state');
                    return true;
                },

                onEnd: function (evt) {
                    document.body.classList.remove('invalid-drag-state');
                },
            });
            const innerSortableContainers = phaseCard.querySelectorAll('.label-group-content, .sub-label-content');
            innerSortableContainers.forEach(container => {
                new Sortable(container, {
                    group: {
                        name: 'phase-entries',
                        put: function (toList, fromList, draggedEl) {
                            const draggedType = draggedEl.dataset.type;
                            const sourceType = getDragContext(fromList);
                            const targetType = getDragContext(toList);

                            if (draggedType === 'sub-label') {
                                return false;
                            }

                            if (draggedType === 'choice') {
                                if (sourceType === 'Phase' && (targetType === 'Label' || targetType === 'SubLabel')) {
                                    return false;
                                }
                                if ((sourceType === 'Label' || sourceType === 'SubLabel') && targetType === 'Phase') {
                                    return false;
                                }
                            }

                            if (draggedEl.classList.contains('label-group-container') && (targetType === 'Label' || targetType === 'SubLabel')) {
                                return false;
                            }

                            return true;
                        }
                    },
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    forceFallback: true,
                    fallbackOnBody: true,

                    onMove: function (evt) {
                        const isScene = evt.dragged.dataset.type === 'scene';
                        if (isScene) {
                            let isInvalidMove = false;
                            if (evt.to.children.length === 0 || (evt.to.children.length === 1 && evt.to.children[0] === evt.dragged)) { isInvalidMove = true; }
                            if (evt.willInsertAfter === false && evt.related === evt.to.children[0]) { isInvalidMove = true; }

                            if (isInvalidMove) {
                                document.body.classList.add('invalid-drag-state');
                                dragTooltip.textContent = " Scene tidak boleh menjadi entri pertama.";
                                return false;
                            }
                        }

                        if (evt.from !== evt.to) {
                            const canPut = this.options.group.put(evt.to, evt.from, evt.dragged);
                            if (!canPut) {
                                document.body.classList.add('invalid-drag-state');
                                dragTooltip.textContent = " Tipe entri ini tidak bisa dipindahkan ke sini.";
                                return false;
                            }
                        }

                        document.body.classList.remove('invalid-drag-state');
                        return true;
                    },

                    onEnd: function (evt) {
                        document.body.classList.remove('invalid-drag-state');

                        // Update visibilitas kontrol transisi setelah drag karena posisi bisa berubah
                        // dan perbedaan sprite dengan entri sebelumnya mungkin tidak lagi relevan
                        if (typeof window.checkSpriteTransitionVisibility === 'function') {
                            setTimeout(window.checkSpriteTransitionVisibility, 100);
                        }
                    },
                });
            });
            const lastEntryOfPhase = group.entries[group.entries.length - 1];
            if (lastEntryOfPhase && lastEntryOfPhase.type === 'jump' && lastEntryOfPhase.target.startsWith('fase:')) {
                const phaseDropdown = phaseCard.querySelector('.phase-jump-target');
                if (phaseDropdown) {
                    phaseDropdown.value = lastEntryOfPhase.target;
                    updateSelectColor(phaseDropdown);
                }
            }
            phaseCard.querySelectorAll('.audio-preview-placeholder').forEach(p => {
                const src = p.dataset.src;
                const key = p.dataset.previewFor;
                p.replaceWith(createAudioPreview(src, key));
            });

            const bgMode = group.phase.backgroundMode || 'cover';
            const bgModeRadio = phaseCard.querySelector(`input[data-key="backgroundMode"][value="${bgMode}"]`);
            const bgPreviewImg = phaseCard.querySelector('.image-preview[data-preview-for="background"]');

            if (bgModeRadio) {
                bgModeRadio.checked = true;
            }
            if (bgPreviewImg) {
                bgPreviewImg.style.objectFit = bgMode;
            }

            // Event listener untuk toggle tipe background
            phaseCard.querySelectorAll('.phase-bg-type-selector').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const type = e.target.value;
                    phaseCard.querySelectorAll('.phase-bg-input-group').forEach(group => {
                        group.style.display = group.dataset.type === type ? 'block' : 'none';
                    });
                });
            });

            // Event listener untuk preview video
            const videoInput = phaseCard.querySelector('.phase-default-video-input');
            if (videoInput) {
                const videoPreviewContainer = phaseCard.querySelector('.video-preview-container');
                const videoPreview = phaseCard.querySelector('.video-preview');
                const placeholder = videoPreviewContainer.querySelector('.preview-placeholder');

                const updateVideoPreview = () => {
                    const val = videoInput.value.trim();
                    if (val) {
                        videoPreview.src = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${val}`;
                        videoPreview.style.display = 'block';
                        placeholder.style.display = 'none';
                        videoPreviewContainer.style.display = 'flex';
                    } else {
                        videoPreview.style.display = 'none';
                        placeholder.style.display = 'block';
                        videoPreviewContainer.style.display = 'none';
                    }
                };
                videoInput.addEventListener('input', updateVideoPreview);
                // Trigger initial preview
                updateVideoPreview();
            }

            return phaseCard;
        }

        // buat tombol "Tambah Fase"
        function createAddPhaseButton() {
            const buttonDiv = document.createElement('div');
            buttonDiv.id = 'add-phase-btn-styled';
            buttonDiv.innerHTML = `
        <div class="plus-icon">+</div>
        <div class="create-text">Tambah Fase Baru</div>
    `;
            return buttonDiv;
        }

        function createEntryEditorCard(type, data = {}, availableLabels = [], inLabelContext = false) {
            const card = document.createElement('div');
            card.className = `dialogue-entry-card entry-type-${type}`;
            card.dataset.type = type;
            card.dataset.inLabelContext = inLabelContext;

            let innerHTML = '';

            const createImgPreview = (value, key) => value ? `<img src="./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}" class="image-preview" data-preview-for="${key}" onload="this.style.display='block'" onerror="this.style.display='none'">` : `<img class="image-preview" data-preview-for="${key}" style="display: none;" onload="this.style.display='block'" onerror="this.style.display='none'">`;

            // Fungsi khusus untuk sprite dengan wrapper animasi
            // Struktur: wrapper (diam, overflow:hidden) > img (bergerak dengan animasi)
            const createSpriteAnimPreview = (value, key) => {
                const src = value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}` : '';
                const visibleClass = value ? 'visible' : '';
                return `<div class="sprite-anim-wrapper ${visibleClass}" data-preview-for="${key}"><img src="${src}" class="sprite-anim-img" onload="this.parentElement.classList.add('visible')" onerror="this.parentElement.classList.remove('visible')"></div>`;
            };


            // Helper untuk konversi scale factor ke persen (0-100)
            const getScalePercent = (val) => {
                if (val === undefined || val === null) return 50; // Default 1.0 -> 50%
                if (val <= 3) return Math.round((val - 0.25) / 0.015);
                return val;
            };
            const spriteScalePercent = getScalePercent(data.spriteScale);
            const sprite2ScalePercent = getScalePercent(data.sprite2Scale);
            const spriteCenterScalePercent = getScalePercent(data.spriteCenterScale);

            // Helper untuk posisi X sprite (default berdasarkan slot)
            const spriteXPercent = data.spriteX ?? 85;  // Kanan: default 85%
            const sprite2XPercent = data.sprite2X ?? 15; // Kiri: default 15%
            const spriteCenterXPercent = data.spriteCenterX ?? 50; // Tengah: default 50%

            // === SPRITE TRANSITION SYSTEM ===
            // Helper untuk membuat HTML kontrol transisi sprite
            const createTransitionControlHTML = (slotKey, transitionEnabled, transitionDuration) => {
                const checked = transitionEnabled ? 'checked' : '';
                const duration = transitionDuration || 500;
                return `
                    <div class="sprite-transition-controls" data-slot="${slotKey}">
                        <div class="transition-header">
                            <label>Transisi Sprite</label>
                            <span class="transition-hint">(Pergerakan halus dari posisi sebelumnya)</span>
                        </div>
                        <div class="transition-row">
                            <label class="transition-toggle-wrapper">
                                <input type="checkbox" class="script-input sprite-transition-toggle" data-key="${slotKey}Transition" ${checked}>
                                <span>Aktifkan Transisi Halus?</span>
                            </label>
                            <div class="transition-duration-control ${transitionEnabled ? '' : 'disabled'}">
                                <span class="transition-speed-label" style="font-size: 0.7em; color: #6c6;">Cepat</span>
                                <input type="range" class="script-input transition-duration-slider" data-key="${slotKey}TransitionDuration" value="${duration}" min="100" max="2000" step="50" ${transitionEnabled ? '' : 'disabled'}>
                                <span class="transition-speed-label" style="font-size: 0.7em; color: #c66;">Lambat</span>
                                <span class="transition-duration-value">${duration}ms</span>
                            </div>
                        </div>
                        <div class="prev-value-hint"></div>
                    </div>
                `;
            };

            // Ambil nilai transisi dari data
            const spriteTransitionHTML = createTransitionControlHTML('sprite', data.spriteTransition, data.spriteTransitionDuration);
            const sprite2TransitionHTML = createTransitionControlHTML('sprite2', data.sprite2Transition, data.sprite2TransitionDuration);
            const spriteCenterTransitionHTML = createTransitionControlHTML('spriteCenter', data.spriteCenterTransition, data.spriteCenterTransitionDuration);

            // --- Special Event UI Generator ---
            const specialEventData = data.specialEvent || {};
            const hasSpecialEvent = !!specialEventData.type;
            const specialEventHTML = `
                <div class="special-event-wrapper" style="margin-top: 15px; border-top: 1px dashed #444; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <button type="button" class="toggle-special-event-btn" style="background: transparent; border: 1px solid #777; color: #ccc; cursor: pointer; padding: 5px 10px; border-radius: 4px; font-size: 0.85em; display: flex; align-items: center; gap: 5px; transition: all 0.2s ease;">
                            ${hasSpecialEvent ? '<span style="color: #f3b;"></span>Edit Special Event (Active)' : '<span style="color: #777;"></span> Add Special Event'}
                        </button>
                    </div>
                    <div class="special-event-form" style="display: ${hasSpecialEvent ? 'block' : 'none'}; background: #222; padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px;">
                            <label style="color: #f3b; font-weight: bold; margin: 0; font-size: 0.95em;">Special Event Extension</label>
                            <button type="button" class="remove-special-event-btn" style="background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; transition: 0.2s;">Hapus Event</button>
                        </div>
                        
                        <label>Jenis Event:</label>

                        <select class="script-input special-event-type" style="background: #333; color: #eee; border-color: #555;">
                            <option value="" ${!specialEventData.type ? 'selected' : ''}>-- Pilih Event --</option>
                            <optgroup label=" Horror / Psychological">
                                <option value="glitch_screen" ${specialEventData.type === 'glitch_screen' ? 'selected' : ''}>Glitch Screen</option>
                                <option value="fake_bsod" ${specialEventData.type === 'fake_bsod' ? 'selected' : ''}>Fake BSOD (Blue Screen)</option>
                                <option value="shake_window" ${specialEventData.type === 'shake_window' ? 'selected' : ''}>Shake Window (Guncangan)</option>
                                <option value="invert_colors" ${specialEventData.type === 'invert_colors' ? 'selected' : ''}>Invert Colors (Negatif)</option>
                                <option value="heartbeat_zoom" ${specialEventData.type === 'heartbeat_zoom' ? 'selected' : ''}>Heartbeat Zoom (Detak Jantung)</option>
                                <option value="red_overlay" ${specialEventData.type === 'red_overlay' ? 'selected' : ''}>Red Pulse (Horror tint)</option>
                            </optgroup>
                            <optgroup label="Cinematic / Visual">
                                <option value="flash_white" ${specialEventData.type === 'flash_white' ? 'selected' : ''}>Flashbang (White Flash)</option>
                                <option value="crt_shutdown" ${specialEventData.type === 'crt_shutdown' ? 'selected' : ''}>CRT Shutdown (TV Mati)</option>
                                <option value="cinematic_bars" ${specialEventData.type === 'cinematic_bars' ? 'selected' : ''}>Cinematic Bars (Letterbox)</option>
                                <option value="sepia_tone" ${specialEventData.type === 'sepia_tone' ? 'selected' : ''}>Sepia Filter (Kuno)</option>
                                <option value="blur_vision" ${specialEventData.type === 'blur_vision' ? 'selected' : ''}>Blur Vision (Buram)</option>
                            </optgroup>
                        </select>
                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <div style="flex: 1;">
                                <label>Durasi (ms):</label>
                                <input type="number" class="script-input special-event-duration" value="${specialEventData.duration || 1000}" min="0" step="100">
                            </div>
                            <div style="flex: 1;">
                                <label>Intensitas:</label>
                                <input type="number" class="script-input special-event-intensity" value="${specialEventData.intensity || 1.0}" min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                        
                        <div style="margin-top: 8px; display: flex; gap: 10px;">
                             <div style="flex: 2;">
                                <label>SFX (Opsional):</label>
                                <input type="text" class="script-input special-event-sfx" value="${specialEventData.sfx || ''}" placeholder="audio.mp3">
                            </div>
                             <div style="flex: 1; padding-top: 24px;">
                                <div class="label-with-tooltip" style="display: flex; align-items: center; gap: 5px;">
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em; color: #ccc; margin: 0;">
                                        <input type="checkbox" class="script-input special-event-wait" ${specialEventData.wait ? 'checked' : ''}>
                                        Block Input
                                    </label>
                                    <div class="tooltip-trigger" style="width: 16px; height: 16px; font-size: 10px; line-height: 16px; background: #666;">?
                                        <span class="tooltip-text" style="width: 200px; right: 0; left: auto;">
                                            Jika dicentang, pemain TIDAK BISA melakukan klik/lanjut sampai efek selesai (sesuai durasi).
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- DELAY EXECUTION UI -->
                         <div style="margin-top: 8px; border-top: 1px dashed #444; padding-top: 8px;">
                            <div class="label-with-tooltip" style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em; color: #ccc; margin: 0;">
                                    <input type="checkbox" class="script-input special-event-delay-enable" ${specialEventData.delay ? 'checked' : ''}>
                                    Delay Execution (Tunda)
                                </label>
                            </div>
                            <div class="delay-input-container" style="display: ${specialEventData.delay ? 'block' : 'none'}; padding-left: 20px;">
                                <label style="font-size: 0.85em; color: #aaa;">Delay Time (ms):</label>
                                <input type="number" class="script-input special-event-delay" value="${specialEventData.delay || 1000}" min="0" step="100" style="width: 100%; margin-top: 2px;">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            switch (type) {
                case 'dialogue':
                case 'choice':
                    const animOptions = `
                <option value="anim-in-fade">Tampil Langsung (Default)</option>
                <optgroup label="Animasi Masuk">
                    <option value="anim-in-slide-from-bottom">Naik dari Bawah</option>
                    <option value="anim-in-slide-from-right">Geser dari Kanan</option>
                </optgroup>
                <optgroup label="Animasi Keluar">
                    <option value="anim-out-fade">Hilang Perlahan (Fade Out)</option>
                    <option value="anim-out-slide-to-bottom">Turun ke Bawah</option>
                    <option value="anim-out-slide-to-right">Geser ke Kanan</option>
                </optgroup>
                <optgroup label="Animasi Sekali Eksekusi">
                    <option value="anim-oneshot-shake">Berguncang Singkat (Nervous)</option>
                    <option value="anim-oneshot-jump">Melompat Kaget (Surprised)</option>
                </optgroup>
                <optgroup label="Animasi Loop">
                    <option value="anim-loop-pulse-glow">Berkedip Lembut</option>
                    <option value="anim-loop-gentle-float">Mengambang</option>
                    <option value="anim-loop-shake">Berguncang (Shake)</option>
                    <option value="anim-loop-pulse">Berdenyut (Pulse)</option>
                </optgroup>
            `;
                    const animOptions2 = `
                <option value="anim-in-fade">Tampil Langsung (Default)</option>
                <optgroup label="Animasi Masuk">
                    <option value="anim-in-slide-from-bottom">Naik dari Bawah</option>
                    <option value="anim-in-slide-from-left">Geser dari Kiri</option>
                </optgroup>
                <optgroup label="Animasi Keluar">
                    <option value="anim-out-fade">Hilang Perlahan (Fade Out)</option>
                    <option value="anim-out-slide-to-bottom">Turun ke Bawah</option>
                    <option value="anim-out-slide-to-left">Geser ke Kiri</option>
                </optgroup>
                <optgroup label="Animasi Sekali Eksekusi">
                    <option value="anim-oneshot-shake">Berguncang Singkat (Nervous)</option>
                    <option value="anim-oneshot-jump">Melompat Kaget (Surprised)</option>
                </optgroup>
                <optgroup label="Animasi Loop">
                    <option value="anim-loop-pulse-glow">Berkedip Lembut</option>
                    <option value="anim-loop-gentle-float">Mengambang</option>
                    <option value="anim-loop-shake">Berguncang (Shake)</option>
                    <option value="anim-loop-pulse">Berdenyut (Pulse)</option>
                </optgroup>
            `;
                    const animOptionsCenter = `
                <option value="anim-in-fade">Tampil Langsung (Default)</option>
                <optgroup label="Animasi Masuk">
                    <option value="anim-in-slide-from-bottom">Naik dari Bawah</option>
                    <option value="anim-in-slide-from-left">Geser dari Kiri</option>
                    <option value="anim-in-slide-from-right">Geser dari Kanan</option>
                </optgroup>
                <optgroup label="Animasi Keluar">
                    <option value="anim-out-fade">Hilang Perlahan (Fade Out)</option>
                    <option value="anim-out-slide-to-bottom">Turun ke Bawah</option>
                    <option value="anim-out-slide-to-left">Geser ke Kiri</option>
                    <option value="anim-out-slide-to-right">Geser ke Kanan</option>
                </optgroup>
                <optgroup label="Animasi Sekali Eksekusi">
                    <option value="anim-oneshot-shake">Berguncang Singkat (Nervous)</option>
                    <option value="anim-oneshot-jump">Melompat Kaget (Surprised)</option>
                </optgroup>
                <optgroup label="Animasi Loop">
                    <option value="anim-loop-pulse-glow">Berkedip Lembut</option>
                    <option value="anim-loop-gentle-float">Mengambang</option>
                    <option value="anim-loop-shake">Berguncang (Shake)</option>
                    <option value="anim-loop-pulse">Berdenyut (Pulse)</option>
                </optgroup>
            `;

                    let choiceHTML = '';
                    if (type === 'choice') {
                        let optionsHTML = (data.choices || []).map((opt, index) => {
                            let allOptionsHTML = '<option value="">Pilih Label Tujuan...</option>';
                            let specialCommandsHTML = '';
                            if (inLabelContext) {
                                specialCommandsHTML = `<option value="##CONTINUE_PARENT##" ${opt.jump === '##CONTINUE_PARENT##' ? 'selected' : ''}>Lanjut di Label Induk (lewati sub-label)</option><option value="##FINISH_PARENT##" ${opt.jump === '##FINISH_PARENT##' ? 'selected' : ''}>Selesaikan Label Induk</option><option value="##EXIT_LABEL##" ${opt.jump === '##EXIT_LABEL##' ? 'selected' : ''}>Keluar dari Label (lanjut ke bawah)</option>`;
                            } else {
                                specialCommandsHTML = `<option value="##SKIP_ALL_LABEL##" ${opt.jump === '##SKIP_ALL_LABEL##' ? 'selected' : ''}>Lewati/skip semua label di fase ini</option>`;
                            }
                            allOptionsHTML += `<optgroup label="------ Perintah Khusus ------">${specialCommandsHTML}</optgroup>`;
                            if (availableLabels && availableLabels.length > 0) {
                                const labelOptionsForSelect = availableLabels.map(labelName => {
                                    let displayName = labelName;
                                    let className = 'option-main-label';
                                    if (labelName.includes('.')) {
                                        displayName = ` (sub) ${labelName.split('.')[1]}`;
                                        className = 'option-sub-label';
                                    }
                                    const isSelected = opt.jump === labelName ? 'selected' : '';
                                    return `<option value="${labelName}" class="${className}" ${isSelected}>${displayName}</option>`;
                                }).join('');
                                allOptionsHTML += `<optgroup label="------ Lompat ke Label ------">${labelOptionsForSelect}</optgroup>`;
                            }
                            return `<div class="choice-option-editor"><input type="text" class="script-input choice-option-text" value="${opt.text || ''}" placeholder="Teks untuk pilihan ${index + 1}"><span class="jump-arrow"></span><select class="script-input choice-option-jump">${allOptionsHTML}</select><button type="button" class="remove-option-btn"></button></div>`;
                        }).join('');
                        const randomId = 'auto-dialogue-check-' + Math.random().toString(36).substr(2, 9);
                        const autoDialogueChecked = data.autoDialogue ? 'checked' : '';
                        const optionsVisible = data.autoDialogue ? 'visible' : '';
                        const characterRadioChecked = data.autoDialogue === 'character' ? 'checked' : '';
                        const narratorRadioChecked = data.autoDialogue === 'narrator' ? 'checked' : '';
                        choiceHTML = `<div class="choice-options-container"><label class="sub-label">Opsi Jawaban:</label>${optionsHTML}</div><div class="auto-dialogue-container"><div class="auto-dialogue-toggle-wrapper"><input type="checkbox" class="auto-dialogue-toggle" id="${randomId}" ${autoDialogueChecked}><label for="${randomId}">Setelah memilih opsi jawaban, Tampilkan dahulu teks dialog yang dipilih user itu?</label></div><div class="auto-dialogue-options ${optionsVisible}"><div style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px;"><input type="radio" name="auto-dialogue-type-${randomId}" class="auto-dialogue-type" value="character" ${characterRadioChecked || !data.autoDialogue ? 'checked' : ''} style="margin: 0;"><label style="margin: 0;">Diucapkan oleh karakter terakhir</label></div><div style="display: flex; align-items: center; gap: 6px;"><input type="radio" name="auto-dialogue-type-${randomId}" class="auto-dialogue-type" value="narrator" ${narratorRadioChecked} style="margin: 0;"><label style="margin: 0;">Ditampilkan sebagai narasi (tanpa speaker)</label></div></div></div><button type="button" class="add-choice-option-btn" data-labels='${JSON.stringify(availableLabels)}'>+ Tambah Opsi</button>`;
                    }

                    innerHTML = `
                <label class="entry-title">${type === 'choice' ? 'Pilihan (Choice)' : ' Speaker'}</label>
                <input type="text" class="script-input" data-key="speaker" value="${data.speaker || ''}" placeholder="${type === 'choice' ? 'Speaker (Opsional)' : 'Nama Karakter'}">
                <label>Teks Dialog</label>
                <div class="dialogue-main-row"> 
                    <textarea class="script-input" data-key="text" rows="2" placeholder="${type === 'choice' ? 'Teks pertanyaan atau prompt...' : 'Tulis dialog di sini...'}" style="height: ${type === 'choice' ? '100px' : 'auto'};">${data.text || ''}</textarea>
                    <div class="config-row"><div class="config-inputs"><label>Voice Audio</label><div class="file-input-group"><div class="input-with-clear-wrapper ${data.voice ? 'has-text' : ''}"><input type="text" class="script-input audio-input" data-key="voice" value="${data.voice || ''}" placeholder="Pilih file audio..."><button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button></div><button type="button" class="browse-file-btn" data-type="audio"></button></div><div class="volume-control-placeholder" data-key-prefix="voice"></div></div><div class="audio-preview-placeholder" data-src="${data.voice || ''}" data-preview-for="voice"></div></div>
                </div>                  
                <label>Sprite Kiri</label>
                <div class="file-input-group"><div class="input-with-clear-wrapper ${data.sprite2 ? 'has-text' : ''}"><input type="text" class="script-input image-input" data-key="sprite2" value="${data.sprite2 || ''}" placeholder="Pilih file gambar..."><button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button></div><button type="button" class="browse-file-btn" data-type="image"></button></div>
                <div class="sprite-config-container">${createSpriteAnimPreview(data.sprite2, 'sprite2')}
                    <div class="animation-controls" style="display: ${data.sprite2 ? 'flex' : 'none'};">
                        <label class="animation-label"> Konfigurasi Animasi</label>
                        <select class="script-input sprite-anim-selector" data-key="sprite2Anim">${animOptions2}</select>
                        <label class="animation-label" style="margin-top: 8px;">Transformasi</label>
                        <div class="transform-controls-group">
                            <div class="transform-row">
                                <span class="transform-label">Ukuran</span>
                                <input type="range" class="script-input scale-slider transform-slider" data-key="sprite2Scale" value="${sprite2ScalePercent}" min="0" max="100" step="1">
                                <span class="scale-value-display transform-value">${sprite2ScalePercent}%</span>
                            </div>
                            <div class="transform-row">
                                <span class="transform-label">Posisi X</span>
                                <input type="range" class="script-input sprite-position-slider transform-slider" data-key="sprite2X" value="${sprite2XPercent}" min="0" max="100" step="1">
                                <span class="position-value-display transform-value">${sprite2XPercent}%</span>
                            </div>
                        </div>
                        ${sprite2TransitionHTML}
                    </div>
                </div>
                <label>Sprite Tengah</label>
                <div class="file-input-group"><div class="input-with-clear-wrapper ${data.spriteCenter ? 'has-text' : ''}"><input type="text" class="script-input image-input" data-key="spriteCenter" value="${data.spriteCenter || ''}" placeholder="Pilih file gambar..."><button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button></div><button type="button" class="browse-file-btn" data-type="image"></button></div>
                <div class="sprite-config-container">${createSpriteAnimPreview(data.spriteCenter, 'spriteCenter')}
                    <div class="animation-controls" style="display: ${data.spriteCenter ? 'flex' : 'none'};">
                        <label class="animation-label"> Konfigurasi Animasi</label>
                        <select class="script-input sprite-anim-selector" data-key="spriteCenterAnim">${animOptionsCenter}</select>
                        <label class="animation-label" style="margin-top: 8px;">Transformasi</label>
                        <div class="transform-controls-group">
                            <div class="transform-row">
                                <span class="transform-label">Ukuran</span>
                                <input type="range" class="script-input scale-slider transform-slider" data-key="spriteCenterScale" value="${spriteCenterScalePercent}" min="0" max="100" step="1">
                                <span class="scale-value-display transform-value">${spriteCenterScalePercent}%</span>
                            </div>
                            <div class="transform-row">
                                <span class="transform-label">Posisi X</span>
                                <input type="range" class="script-input sprite-position-slider transform-slider" data-key="spriteCenterX" value="${spriteCenterXPercent}" min="0" max="100" step="1">
                                <span class="position-value-display transform-value">${spriteCenterXPercent}%</span>
                            </div>
                        </div>
                        ${spriteCenterTransitionHTML}
                    </div>
                </div>
                <label>Sprite Kanan</label>
                <div class="file-input-group"><div class="input-with-clear-wrapper ${data.sprite ? 'has-text' : ''}"><input type="text" class="script-input image-input" data-key="sprite" value="${data.sprite || ''}" placeholder="Pilih file gambar..."><button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button></div><button type="button" class="browse-file-btn" data-type="image"></button></div>
                <div class="sprite-config-container">${createSpriteAnimPreview(data.sprite, 'sprite')}
                    <div class="animation-controls" style="display: ${data.sprite ? 'flex' : 'none'};">
                        <label class="animation-label"> Konfigurasi Animasi</label>
                        <select class="script-input sprite-anim-selector" data-key="spriteAnim">${animOptions}</select>
                        <label class="animation-label" style="margin-top: 8px;">Transformasi</label>
                        <div class="transform-controls-group">
                            <div class="transform-row">
                                <span class="transform-label">Ukuran</span>
                                <input type="range" class="script-input scale-slider transform-slider" data-key="spriteScale" value="${spriteScalePercent}" min="0" max="100" step="1">
                                <span class="scale-value-display transform-value">${spriteScalePercent}%</span>
                            </div>
                            <div class="transform-row">
                                <span class="transform-label">Posisi X</span>
                                <input type="range" class="script-input sprite-position-slider transform-slider" data-key="spriteX" value="${spriteXPercent}" min="0" max="100" step="1">
                                <span class="position-value-display transform-value">${spriteXPercent}%</span>
                            </div>
                        </div>
                        ${spriteTransitionHTML}
                    </div>
                </div>
                
                <!-- === SPRITE CUSTOM (Multi-Sprite System) === -->
                <div class="extra-sprites-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #00CED1;">Sprite Custom</label>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 0.8em; color: #aaa; cursor: pointer;" title="Aktifkan untuk auto-distribute sprite (flexbox). Nonaktifkan untuk posisi manual.">
                                <input type="checkbox" class="script-input sprite-mode-toggle" data-key="spriteMode" ${data.spriteMode === 'auto' ? 'checked' : ''}>
                                <span style="color: ${data.spriteMode === 'auto' ? '#00FF7F' : '#888'};">Auto Spacing</span>
                            </label>
                        </div>
                        <button type="button" class="add-extra-sprite-btn" style="background: transparent; border: 1px solid #00CED1; color: #00CED1; cursor: pointer; padding: 3px 8px; border-radius: 4px; font-size: 0.75em;">+ Tambah</button>
                    </div>
                    <div class="extra-sprites-container">
                        ${(data.charSprites || []).filter(s => s.slot === 'custom').map((sp, idx) => {
                        const customScalePercent = getScalePercent(sp.scale);
                        return `
                        <div class="extra-sprite-item" data-sprite-index="${idx}">
                            <div class="file-input-group">
                                <div class="input-with-clear-wrapper ${sp.src ? 'has-text' : ''}">
                                    <input type="text" class="script-input image-input extra-sprite-src" value="${sp.src || ''}" placeholder="Pilih file gambar...">
                                    <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                                </div>
                                <button type="button" class="browse-file-btn" data-type="image"></button>
                                <button type="button" class="remove-extra-sprite-btn" title="Hapus Sprite Custom" style="background: #f44; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.9em;"></button>
                            </div>
                            <div class="sprite-config-container">
                                <div class="sprite-anim-wrapper extra-sprite-wrapper ${sp.src ? 'visible' : ''}" data-preview-for="extra-${idx}"><img src="${sp.src ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${sp.src}` : ''}" class="sprite-anim-img extra-sprite-preview" onload="this.parentElement.classList.add('visible')" onerror="this.parentElement.classList.remove('visible')"></div>
                                <div class="animation-controls" style="display: ${sp.src ? 'flex' : 'none'};">
                                    <label class="animation-label"> Konfigurasi</label>
                                    <select class="script-input sprite-anim-selector extra-sprite-anim">
                                        <option value="anim-in-fade" ${sp.anim === 'anim-in-fade' || !sp.anim ? 'selected' : ''}>Tampil Langsung</option>
                                        <optgroup label="Animasi Masuk">
                                            <option value="anim-in-slide-from-bottom" ${sp.anim === 'anim-in-slide-from-bottom' ? 'selected' : ''}>Naik dari Bawah</option>
                                            <option value="anim-in-slide-from-left" ${sp.anim === 'anim-in-slide-from-left' ? 'selected' : ''}>Geser dari Kiri</option>
                                            <option value="anim-in-slide-from-right" ${sp.anim === 'anim-in-slide-from-right' ? 'selected' : ''}>Geser dari Kanan</option>
                                        </optgroup>
                                        <optgroup label="Animasi Keluar">
                                            <option value="anim-out-fade" ${sp.anim === 'anim-out-fade' ? 'selected' : ''}>Hilang Perlahan</option>
                                            <option value="anim-out-slide-to-bottom" ${sp.anim === 'anim-out-slide-to-bottom' ? 'selected' : ''}>Turun ke Bawah</option>
                                        </optgroup>
                                        <optgroup label="Animasi Loop">
                                            <option value="anim-loop-pulse-glow" ${sp.anim === 'anim-loop-pulse-glow' ? 'selected' : ''}>Berkedip Lembut</option>
                                            <option value="anim-loop-gentle-float" ${sp.anim === 'anim-loop-gentle-float' ? 'selected' : ''}>Mengambang</option>
                                        </optgroup>
                                    </select>
                                    <label class="animation-label" style="margin-top: 8px;">Transformasi</label>
                                    <div class="transform-controls-group">
                                        <div class="transform-row">
                                            <span class="transform-label">Ukuran</span>
                                            <input type="range" class="script-input scale-slider extra-sprite-scale transform-slider" value="${customScalePercent}" min="0" max="100" step="1">
                                            <span class="scale-value-display transform-value">${customScalePercent}%</span>
                                        </div>
                                        <div class="transform-row position-x-row" style="${data.spriteMode === 'auto' ? 'display: none;' : ''}">
                                            <span class="transform-label">Posisi X</span>
                                            <input type="range" class="script-input extra-sprite-x transform-slider" value="${sp.x ?? 50}" min="0" max="100" step="1">
                                            <span class="position-value-display transform-value">${sp.x ?? 50}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                            `;
                    }).join('')}
                    </div>
                    <p style="font-size: 0.75em; color: #555; margin: 3px 0 0 0; display: ${(data.charSprites || []).filter(s => s.slot === 'custom').length === 0 ? 'block' : 'none'}; font-style: italic;" class="extra-sprites-empty-msg">Klik "+ Tambah" untuk menambah sprite dengan posisi kustom.</p>
                </div>

                ${choiceHTML}
                ${specialEventHTML}
            `;
                    break;
                case 'scene':
                    const uniqueRadioName = `background-mode-scene-${Math.random()}`;
                    const currentSceneType = data.sceneType || 'image';
                    const currentTransition = data.transition || 'cut';
                    const currentTransitionOut = data.transitionOut || 'cut';

                    // Inilah baris yang diubah
                    const bgmLoopChecked = data.bgmLoop === false ? '' : 'checked';

                    innerHTML = `
                <label style="font-weight: bold; font-size: 1.1em; color: #00f371;">Transisi Scene</label>
                
                <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="flex: 1 1 200px; min-width: 200px;">
                        <label>Animasi Transisi (Masuk):</label>
                            <select class="script-input scene-transition-selector" data-key="transition">
                            <option value="cut" ${currentTransition === 'cut' ? 'selected' : ''}>Langsung (Tanpa Animasi)</option>
                                <optgroup label="Fade">
                                    <option value="fade_black" ${currentTransition === 'fade_black' ? 'selected' : ''}>Fade Hitam </option>
                                    <option value="fade_white" ${currentTransition === 'fade_white' ? 'selected' : ''}>Fade Putih </option>
                                </optgroup>
                                <optgroup label="Slide">
                                    <option value="slide_left" ${currentTransition === 'slide_left' ? 'selected' : ''}>Geser dari Kiri </option>
                                    <option value="slide_right" ${currentTransition === 'slide_right' ? 'selected' : ''}>Geser dari Kanan </option>
                                    </optgroup>
                            </select>
                    </div>
                    <div style="flex: 1 1 200px; min-width: 200px;">
                        <label>SFX Masuk (Opsional)</label>
                        <div class="file-input-group">
                            <div class="input-with-clear-wrapper ${data.sfxIn ? 'has-text' : ''}">
                                <input type="text" class="script-input audio-input" data-key="sfxIn" value="${data.sfxIn || ''}" placeholder="Pilih file audio...">
                                <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                            </div>
                            <button type="button" class="browse-file-btn" data-type="audio"></button>
                        </div>
                    <div class="volume-control-placeholder" data-key-prefix="sfxIn"></div>
                    <div class="audio-preview-placeholder" data-src="${data.sfxIn || ''}" data-preview-for="sfxIn"></div>
                    </div>
                </div>

                <label>Jenis Scene:</label>
                <select class="script-input scene-type-selector" data-key="sceneType">
                    <option value="image" ${currentSceneType === 'image' ? 'selected' : ''}>Gambar Latar</option>
                    <option value="video" ${currentSceneType === 'video' ? 'selected' : ''}>Video Latar</option>
                    <option value="text_screen" ${currentSceneType === 'text_screen' ? 'selected' : ''}>Layar Teks (Hitam)</option>
                </select>

                <div class="scene-input-group" data-scene-type="image" style="display: ${currentSceneType === 'image' ? 'block' : 'none'};">
                    <label> Latar Belakang (Background)</label>
                    <div class="file-input-group">
                        <div class="input-with-clear-wrapper ${data.background ? 'has-text' : ''}">
                            <input type="text" class="script-input image-input" data-key="background" value="${data.background || ''}" placeholder="Pilih file gambar...">
                            <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                        </div>
                        <button type="button" class="browse-file-btn" data-type="image"></button>
                    </div>
                    <div style="display: flex; gap: 15px; align-items: flex-start; margin-top: 10px;">
                        <div class="image-preview-container-16-9" style="flex: 2; min-width: 0;">
                            <img class="image-preview" data-preview-for="background" style="display: none; object-fit: ${data.backgroundMode || 'cover'};">
                            <span class="preview-placeholder">Pilih gambar...</span>
                        </div>
                        <div class="options-container" style="flex: 1; display: flex; flex-direction: column; gap: 10px; background-color: #222; padding: 10px; border-radius: 5px;">
                            <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" class="script-input persist-background-checkbox" data-key="persistBackground" ${data.persistBackground || data.persistBackground === undefined ? 'checked' : ''}>
                                <span>Pertahankan background ini untuk jadi wallpaper baru?</span>
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="font-weight:normal;">Tampilan:</label>
                                <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="${uniqueRadioName}" class="script-input" data-key="backgroundMode" value="cover" ${!data.backgroundMode || data.backgroundMode === 'cover' ? 'checked' : ''}> Crop
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="${uniqueRadioName}" class="script-input" data-key="backgroundMode" value="contain" ${data.backgroundMode === 'contain' ? 'checked' : ''}> Fit
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="scene-input-group" data-scene-type="video" style="display: ${currentSceneType === 'video' ? 'block' : 'none'};">
                    <label> Video Latar</label>
                    <div class="file-input-group">
                        <div class="input-with-clear-wrapper ${data.video ? 'has-text' : ''}">
                            <input type="text" class="script-input video-input" data-key="video" value="${data.video || ''}" placeholder="Pilih file video...">
                            <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                        </div>
                        <button type="button" class="browse-file-btn" data-type="video"></button>
                    </div>

                    <div class="video-preview-container" style="width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 4px; overflow: hidden; display: none; align-items: center; justify-content: center; margin-top: 10px; border: 1px solid #444;">
                        <video class="video-preview" data-preview-for="video" controls muted style="display: none; width: 100%; height: 100%; object-fit: contain;"></video>
                        <span class="preview-placeholder" style="color: #777;">Pilih video...</span>
                    </div>

                    <div class="video-controls-block" style="display: ${data.video ? 'flex' : 'none'}; gap: 25px; margin-top: 10px; padding: 15px; background: #222; border-radius: 4px; align-items: flex-start; flex-wrap: wrap;">                        
                        <div style="display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; border-right: 1px solid #444; padding-right: 25px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="script-input video-muted-checkbox" data-key="videoMuted" ${data.videoMuted !== false ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="font-size: 0.9em;">Bisukan audio video ini</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="script-input mute-phase-bgm-checkbox" data-key="mutePhaseBgm" ${data.mutePhaseBgm !== false ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="font-size: 0.9em;">Bisukan BGM Fase</span>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 12px; flex-shrink: 0;">
                            <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px; padding-top: 5px;">
                                <input type="checkbox" class="script-input persist-background-checkbox" data-key="persistBackground" ${data.persistBackground || data.persistBackground === undefined ? 'checked' : ''}>
                                <span>Pertahankan video ini untuk jadi wallpaper baru di entri selanjutnya.</span>
                            </label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 0.9em; color: #ccc;">Durasi di entri ini (Jika Auto Mode):</label>
                                <input type="number" class="script-input" data-key="duration" value="${(data.duration || 3000) / 1000}" step="0.1" min="0.1" placeholder="detik" style="width: 70px; padding: 6px 8px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="scene-input-group" data-scene-type="text_screen" style="display: ${currentSceneType === 'text_screen' ? 'block' : 'none'};">
                    <label>Teks yang Ditampilkan (Bisa multi-baris)</label>
                    <textarea class="script-input" data-key="text" rows="4" placeholder="Contoh:\nChapter 1\nAwal yang Baru">${data.text || ''}</textarea>
                    <label>Durasi (detik) jika Auto Mode</label>
                    <input type="number" class="script-input" data-key="duration" value="${(data.duration || 3000) / 1000}" step="0.1" placeholder="Contoh: 2.5 (untuk 2.5 detik)">
                </div>

                <div class="transition-out-container">
                    <div style="display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; margin-top: 15px;">
                        <div style="flex: 1 1 200px; min-width: 200px;">
                            <label>Animasi Transisi (Keluar):</label>
                                <select class="script-input" data-key="transitionOut">
                                    <option value="cut" ${currentTransitionOut === 'cut' ? 'selected' : ''}>Langsung (Tanpa Animasi)</option>
                                    <optgroup label="Fade">
                                        <option value="fade_black" ${currentTransitionOut === 'fade_black' ? 'selected' : ''}>Fade Hitam </option>
                                        <option value="fade_white" ${currentTransitionOut === 'fade_white' ? 'selected' : ''}>Fade Putih </option>
                                    </optgroup>
                                    <optgroup label="Slide">
                                        <option value="swipe_black_left" ${currentTransitionOut === 'swipe_black_left' ? 'selected' : ''}>Swipe Hitam ke Kiri </option>
                                        <option value="swipe_black_right" ${currentTransitionOut === 'swipe_black_right' ? 'selected' : ''}>Swipe Hitam ke Kanan </option>
                                        </optgroup>
                                </select>
                        </div>
                        <div style="flex: 1 1 200px; min-width: 200px;">
                            <label>SFX Keluar (Opsional)</label>
                            <div class="file-input-group">
                                <div class="input-with-clear-wrapper ${data.sfxOut ? 'has-text' : ''}">
                                    <input type="text" class="script-input audio-input" data-key="sfxOut" value="${data.sfxOut || ''}" placeholder="Pilih file audio...">
                                    <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                                </div>
                                <button type="button" class="browse-file-btn" data-type="audio"></button>
                            </div>
                            <div class="volume-control-placeholder" data-key-prefix="sfxOut"></div>
                            <div class="audio-preview-placeholder" data-src="${data.sfxOut || ''}" data-preview-for="sfxOut"></div>
                        </div>
                    </div>
                </div>
                
                <hr style="border-color: #444; margin: 15px 0;">
                
                <div class="bgm-special-event-container" style="display: block; width: 100%; margin-top: 15px;">
                    <label> Musik Latar (BGM, hanya terdengar di entri ini saja)</label>
                    <div class="file-input-group">
                        <div class="input-with-clear-wrapper ${data.bgm ? 'has-text' : ''}">
                            <input type="text" class="script-input audio-input" data-key="bgm" value="${data.bgm || ''}" placeholder="Pilih file audio...">
                            <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                        </div>
                        <button type="button" class="browse-file-btn" data-type="audio"></button>
                    </div>
                    <div class="volume-control-placeholder" data-key-prefix="bgm"></div>
                    <div class="audio-preview-placeholder" data-src="${data.bgm || ''}" data-preview-for="bgm"></div>
                    <div style="display: flex; gap: 15px; align-items: center; margin-top: 8px;">
                        <div style="flex-grow: 1;">
                            <label>Durasi Fade BGM (detik)</label>
                            <input type="number" class="script-input" data-key="bgmFade" value="${data.bgmFade || 1}" step="0.1" min="0">
                        </div>
                        <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px; padding-top: 20px;">
                            <input type="checkbox" class="script-input" data-key="bgmLoop" ${bgmLoopChecked}>
                            <span>Loop</span>
                        </label>
                    </div>
                    
                    <div style="width: 100%; margin-top: 20px; border-top: 1px dashed #444; padding-top: 10px;">
                        ${specialEventHTML}
                    </div>
                </div>
            `;
                    break;

                default:
                    return null;
            }
            // Tombol Preview Entry - tersedia untuk semua tipe entri (dialogue, choice, scene)
            const previewButtonHTML = `<button class="preview-entry-btn" title="Preview seluruh entri ini di jendela terpisah" style="background-color: transparent; color: #9b59b6; border: 1px dashed #9b59b6; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: 0.2s;">Preview</button>`;

            let actionButtonsHTML = `
            <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;">
                <button class="delete-dialogue-btn" style="margin-top: 0;">Hapus</button>
                ${previewButtonHTML}
            </div>
        `;

            if (type === 'dialogue') {
                actionButtonsHTML = `
            <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;">
                <button class="delete-dialogue-btn" style="margin-top: 0;">Hapus</button>
                <button class="clone-dialogue-btn" title="Duplikat Entri" style="background-color: transparent; color: #3498db; border: 1px solid #3498db; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Duplikat Entri ini</button>
                ${previewButtonHTML}
            </div>
        `;
            } else if (type === 'choice') {
                actionButtonsHTML = `
            <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;">
                <button class="delete-dialogue-btn" style="margin-top: 0;">Hapus</button>
                ${previewButtonHTML}
            </div>
        `;
            }

            card.innerHTML = `
        <div class="drag-handle" title="Seret untuk mengubah urutan"></div>
        <div class="entry-content">
            ${innerHTML}
            ${actionButtonsHTML}
        </div>
    `;
            const sfxInInput = card.querySelector('input[data-key="sfxIn"]');
            const sfxInVolumePlaceholder = card.querySelector('.volume-control-placeholder[data-key-prefix="sfxIn"]');
            if (sfxInInput && sfxInVolumePlaceholder) {
                const sfxInControls = createAudioControls('sfxIn', data); // Buat kontrol untuk sfxIn
                sfxInVolumePlaceholder.replaceWith(sfxInControls);      // Ganti placeholder
                linkAudioInputToVolumeControl(sfxInInput, sfxInControls); // Hubungkan input & kontrol
            }

            // SFX Keluar (sfxOut)
            const sfxOutInput = card.querySelector('input[data-key="sfxOut"]');
            const sfxOutVolumePlaceholder = card.querySelector('.volume-control-placeholder[data-key-prefix="sfxOut"]');
            if (sfxOutInput && sfxOutVolumePlaceholder) {
                const sfxOutControls = createAudioControls('sfxOut', data); // Buat kontrol untuk sfxOut
                sfxOutVolumePlaceholder.replaceWith(sfxOutControls);      // Ganti placeholder
                linkAudioInputToVolumeControl(sfxOutInput, sfxOutControls); // Hubungkan input & kontrol
            }
            card.querySelectorAll('.volume-control-placeholder').forEach(placeholder => {
                const keyPrefix = placeholder.dataset.keyPrefix;
                const volumeControl = createAudioControls(keyPrefix, data);
                const associatedAudioInput = placeholder.previousElementSibling.querySelector('.audio-input');
                placeholder.replaceWith(volumeControl);
                if (associatedAudioInput) {
                    linkAudioInputToVolumeControl(associatedAudioInput, volumeControl);
                }
            });
            if (data.spriteAnim) card.querySelector('select[data-key="spriteAnim"]').value = data.spriteAnim;
            if (data.sprite2Anim) card.querySelector('select[data-key="sprite2Anim"]').value = data.sprite2Anim;
            if (data.spriteCenterAnim) card.querySelector('select[data-key="spriteCenterAnim"]').value = data.spriteCenterAnim;
            if (type === 'choice') {
                card.querySelectorAll('.choice-option-jump').forEach(select => {
                    updateSelectColor(select);
                });
            }

            // Untuk case video : Inisialisasi preview video jika ada data awal
            const videoInput = card.querySelector('input[data-key="video"]');
            const videoPreviewContainer = card.querySelector('.video-preview-container');
            const videoPreview = card.querySelector('.video-preview');
            const videoPlaceholder = videoPreviewContainer ? videoPreviewContainer.querySelector('.preview-placeholder') : null;

            if (videoInput && videoPreviewContainer && videoPreview && videoPlaceholder) {
                const initialVideoFile = data.video; // Ambil nama file dari data awal
                if (initialVideoFile) {
                    const videoSrc = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${initialVideoFile}?v=${Date.now()}`;
                    videoPreview.src = videoSrc;
                    videoPreviewContainer.style.display = 'flex'; // Tampilkan container
                    videoPreview.style.display = 'block';         // Tampilkan video
                    videoPlaceholder.style.display = 'none';      // Sembunyikan placeholder
                    videoPreview.onerror = () => { // Handle jika file tidak ditemukan
                        videoPreview.style.display = 'none';
                        videoPlaceholder.style.display = 'flex';
                        videoPlaceholder.textContent = `Error: File "${initialVideoFile}" tidak ditemukan.`;
                        videoPreviewContainer.style.display = 'flex'; // Tetap tampilkan container
                    };
                } else {
                    videoPreviewContainer.style.display = 'none'; // Sembunyikan jika tidak ada video awal
                }
            }
            card.querySelectorAll('.audio-preview-placeholder').forEach(placeholder => {
                const audioSrc = placeholder.dataset.src;
                const previewKey = placeholder.dataset.previewFor;
                const previewComponent = createAudioPreview(audioSrc, previewKey);
                placeholder.replaceWith(previewComponent);
            });

            // --- Handler UI Special Event ---
            const toggleSpecialBtn = card.querySelector('.toggle-special-event-btn');
            const specialForm = card.querySelector('.special-event-form');
            const removeSpecialBtn = card.querySelector('.remove-special-event-btn');

            if (toggleSpecialBtn && specialForm && removeSpecialBtn) {
                toggleSpecialBtn.addEventListener('click', () => {
                    const isHidden = specialForm.style.display === 'none';
                    specialForm.style.display = isHidden ? 'block' : 'none';
                    if (isHidden) {
                        toggleSpecialBtn.innerHTML = '<span style="color: #f3b;"></span> Edit Special Event (Active)';
                    }
                });

                removeSpecialBtn.addEventListener('click', () => {
                    specialForm.style.display = 'none';
                    specialForm.querySelector('.special-event-type').value = 'glitch_screen';
                    specialForm.querySelector('.special-event-duration').value = 1000;
                    specialForm.querySelector('.special-event-intensity').value = 1.0;
                    specialForm.querySelector('.special-event-sfx').value = '';
                    specialForm.querySelector('.special-event-wait').checked = false;
                    toggleSpecialBtn.innerHTML = '<span style="color: #777;"></span> Add Special Event';
                });

                const delayEnableCheckbox = specialForm.querySelector('.special-event-delay-enable');
                const delayInputContainer = specialForm.querySelector('.delay-input-container');
                if (delayEnableCheckbox && delayInputContainer) {
                    delayEnableCheckbox.addEventListener('change', () => {
                        delayInputContainer.style.display = delayEnableCheckbox.checked ? 'block' : 'none';
                    });
                }
            }

            // --- Handler Preview Entry (tersedia untuk SEMUA tipe entri: dialogue, choice, scene) ---
            const previewEntryBtn = card.querySelector('.preview-entry-btn');
            if (previewEntryBtn) {
                previewEntryBtn.addEventListener('click', () => {
                    // Ekstrak semua data dari card pakai logika yang sudah ada
                    const cardData = extractDataFromCard(card);

                    // Jika ada special event form yang aktif, ambil datanya juga
                    const specialFormElement = card.querySelector('.special-event-form');
                    if (specialFormElement && specialFormElement.style.display !== 'none') {
                        const eventType = specialFormElement.querySelector('.special-event-type')?.value;
                        if (eventType && eventType.trim() !== '') {
                            const duration = parseInt(specialFormElement.querySelector('.special-event-duration')?.value) || 1000;
                            const intensity = parseFloat(specialFormElement.querySelector('.special-event-intensity')?.value) || 1.0;
                            const sfx = specialFormElement.querySelector('.special-event-sfx')?.value || '';
                            const wait = specialFormElement.querySelector('.special-event-wait')?.checked || false;
                            const delayEnable = specialFormElement.querySelector('.special-event-delay-enable')?.checked || false;
                            const delayTime = parseInt(specialFormElement.querySelector('.special-event-delay')?.value) || 0;

                            cardData.specialEvent = {
                                type: eventType,
                                duration: duration,
                                intensity: intensity,
                                sfx: sfx,
                                wait: wait,
                                delay: delayEnable ? delayTime : 0
                            };
                        }
                    }

                    // === FITUR: Ambil konteks visual (background, BGM) dari hierarki DOM ===
                    // Ini penting agar preview menampilkan background/BGM yang sebenarnya aktif saat entri dijalankan

                    let contextBackground = null;
                    let contextBackgroundMode = null;
                    let contextVideo = null;
                    let contextBgm = null;

                    // 1. Cari fase induk dan ambil default background/BGM-nya
                    const parentPhaseCard = card.closest('.phase-card');
                    if (parentPhaseCard) {
                        const phaseMediaInput = parentPhaseCard.querySelector('.phase-media-input');
                        const phaseBgmInput = parentPhaseCard.querySelector('.phase-default-bgm-input');

                        if (phaseMediaInput && phaseMediaInput.value.trim()) {
                            const mediaValue = phaseMediaInput.value.trim();
                            const ext = mediaValue.split('.').pop().toLowerCase();
                            const isVideo = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);

                            if (isVideo) {
                                contextVideo = mediaValue;
                            } else {
                                contextBackground = mediaValue;
                                const bgModeRadio = parentPhaseCard.querySelector('.phase-header input[data-key="backgroundMode"]:checked');
                                contextBackgroundMode = bgModeRadio ? bgModeRadio.value : 'cover';
                            }
                        }

                        if (phaseBgmInput && phaseBgmInput.value.trim()) {
                            contextBgm = phaseBgmInput.value.trim();
                        }
                    }

                    // 2. Cari label induk (jika ada) dan ambil background-nya yang mungkin override fase
                    const parentLabelContainer = card.closest('.label-group-container');
                    if (parentLabelContainer) {
                        const labelMediaInput = parentLabelContainer.querySelector('.label-media-input');
                        if (labelMediaInput && labelMediaInput.value.trim()) {
                            const mediaValue = labelMediaInput.value.trim();
                            const ext = mediaValue.split('.').pop().toLowerCase();
                            const isVideo = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);

                            if (isVideo) {
                                contextVideo = mediaValue;
                                contextBackground = null; // Video override background
                            } else {
                                contextBackground = mediaValue;
                                contextVideo = null; // Background override video
                                const bgModeRadio = parentLabelContainer.querySelector('input[data-key="backgroundMode"]:checked');
                                contextBackgroundMode = bgModeRadio ? bgModeRadio.value : 'cover';
                            }
                        }
                    }

                    // 3. Cari entri scene sebelumnya yang mungkin mengubah background (persistBackground)
                    // Kita perlu menelusuri siblings sebelum card ini
                    const parentContainer = card.parentElement;
                    if (parentContainer) {
                        const allCards = Array.from(parentContainer.querySelectorAll('.dialogue-entry-card'));
                        const currentIndex = allCards.indexOf(card);

                        // Telusuri dari entri sebelum card ini ke belakang
                        for (let i = currentIndex - 1; i >= 0; i--) {
                            const prevCard = allCards[i];
                            if (prevCard.dataset.type === 'scene') {
                                const prevCardData = extractDataFromCard(prevCard);

                                // Cek apakah scene ini memiliki persistBackground aktif
                                const persistCheckbox = prevCard.querySelector('.persist-background-checkbox');
                                const isPersist = persistCheckbox ? persistCheckbox.checked : true; // Default true

                                if (isPersist) {
                                    // Scene ini mengubah background/video untuk entri selanjutnya
                                    if (prevCardData.background) {
                                        contextBackground = prevCardData.background;
                                        contextVideo = null;
                                        contextBackgroundMode = prevCardData.backgroundMode || 'cover';
                                    } else if (prevCardData.video) {
                                        contextVideo = prevCardData.video;
                                        contextBackground = null;
                                    }
                                    break; // Stop di scene terakhir yang persist
                                }
                            }
                        }
                    }

                    // 4. Terapkan konteks ke cardData jika entri tidak punya background sendiri
                    // (Khusus untuk dialogue dan choice yang tidak punya background property)
                    if (cardData.type === 'dialogue' || cardData.type === 'choice') {
                        if (!cardData.background && contextBackground) {
                            cardData._contextBackground = contextBackground;
                            cardData._contextBackgroundMode = contextBackgroundMode;
                        }
                        if (!cardData.video && contextVideo) {
                            cardData._contextVideo = contextVideo;
                        }
                        if (!cardData.bgm && contextBgm) {
                            cardData._contextBgm = contextBgm;
                        }
                    }

                    // Patch path aset untuk konteks preview dari root
                    if (currentlyEditing && currentlyEditing.novel && currentlyEditing.chapter) {
                        const assetPrefix = `aset/game/visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/`;
                        const assetKeys = ['background', 'video', 'sprite', 'sprite2', 'spriteCenter', 'bgm', 'sfx', 'sfxIn', 'sfxOut', 'voice', '_contextBackground', '_contextVideo', '_contextBgm'];

                        assetKeys.forEach(key => {
                            if (cardData[key] && !cardData[key].startsWith('http') && !cardData[key].startsWith('file:')) {
                                cardData[key] = assetPrefix + cardData[key];
                            }
                        });

                        // Patch sfx special event jika ada
                        if (cardData.specialEvent && cardData.specialEvent.sfx) {
                            cardData.specialEvent.sfx = assetPrefix + cardData.specialEvent.sfx;
                        }

                        // Patch array charSprites untuk sprite kustom
                        if (cardData.charSprites && Array.isArray(cardData.charSprites)) {
                            cardData.charSprites = cardData.charSprites.map(sprite => {
                                if (sprite.src && !sprite.src.startsWith('http') && !sprite.src.startsWith('file:')) {
                                    return { ...sprite, src: assetPrefix + sprite.src };
                                }
                                return sprite;
                            });
                        }
                    }

                    // Kirim payload ke main process untuk ditampilkan di popup preview
                    ipcRenderer.send('vn-engine:preview-special-event', cardData);

                    // Notifikasi berdasarkan tipe entri
                    const entryType = cardData.type || 'entry';
                    const hasSpecialEvent = cardData.specialEvent && cardData.specialEvent.type;
                    const hasContext = cardData._contextBackground || cardData._contextVideo;
                    let notifText = '';
                    if (hasSpecialEvent) {
                        notifText = `Preview ${entryType} + Special Event: ${cardData.specialEvent.type}`;
                    } else if (hasContext) {
                        notifText = `Preview ${entryType} dengan konteks background`;
                    } else {
                        notifText = `Preview ${entryType}: ${cardData.speaker || cardData.sceneType || 'Entry'}`;
                    }
                    showNotification(notifText, 'success');
                });
            }

            // === Toggle Jarak Otomatis (Mode Sprite) ===
            const spriteModeToggle = card.querySelector('.sprite-mode-toggle');
            if (spriteModeToggle) {
                // Update status awal berdasarkan data
                const updatePositionXVisibility = (isAuto) => {
                    const positionXRows = card.querySelectorAll('.position-x-row');
                    positionXRows.forEach(row => {
                        row.style.display = isAuto ? 'none' : '';
                    });
                    // Update warna label
                    const labelSpan = spriteModeToggle.parentElement.querySelector('span');
                    if (labelSpan) {
                        labelSpan.style.color = isAuto ? '#00FF7F' : '#888';
                    }
                };

                // Terapkan status awal
                updatePositionXVisibility(spriteModeToggle.checked);

                // Pantau perubahan
                spriteModeToggle.addEventListener('change', (e) => {
                    updatePositionXVisibility(e.target.checked);
                });
            }

            // === HANDLER: Live Sprite Animation Preview ===
            // Mapping dari nilai animasi player ke kelas animasi editor
            // Mapping dari nilai animasi player ke kelas animasi editor
            const animClassMap = {
                // 'anim-in-fade': 'editor-anim-in-fade', // Nonaktifkan animasi untuk Tampil Langsung (agar diam)
                'anim-in-slide-from-bottom': 'editor-anim-in-slide-from-bottom',
                'anim-in-slide-from-left': 'editor-anim-in-slide-from-left',
                'anim-in-slide-from-right': 'editor-anim-in-slide-from-right',
                'anim-out-fade': 'editor-anim-out-fade',
                'anim-out-slide-to-bottom': 'editor-anim-out-slide-to-bottom',
                'anim-out-slide-to-left': 'editor-anim-out-slide-to-left',
                'anim-out-slide-to-right': 'editor-anim-out-slide-to-right',
                'anim-loop-pulse-glow': 'editor-anim-loop-pulse-glow',
                'anim-loop-gentle-float': 'editor-anim-loop-gentle-float',
                'anim-loop-shake': 'editor-anim-loop-shake',
                'anim-oneshot-shake': 'editor-anim-oneshot-shake',
                'anim-oneshot-jump': 'editor-anim-oneshot-jump',
                'anim-loop-pulse': 'editor-anim-loop-pulse'
            };

            // Fungsi untuk menerapkan animasi live pada gambar sprite
            const applyLiveAnimation = (imgElement, animValue) => {
                if (!imgElement) return;

                // Hapus semua kelas animasi editor yang mungkin aktif
                Object.values(animClassMap).forEach(cls => imgElement.classList.remove(cls));

                // Terapkan animasi baru - cek parent wrapper untuk visibility
                const editorAnimClass = animClassMap[animValue];
                const wrapper = imgElement.closest('.sprite-anim-wrapper');
                const isVisible = wrapper ? wrapper.classList.contains('visible') : imgElement.parentElement && imgElement.parentElement.style.display !== 'none';

                if (editorAnimClass && isVisible) {
                    void imgElement.offsetWidth; // Trigger reflow untuk restart animasi
                    imgElement.classList.add(editorAnimClass);
                }
            };

            // Bind event untuk semua selector animasi sprite preset (sprite, sprite2, spriteCenter)
            card.querySelectorAll('.sprite-anim-selector:not(.extra-sprite-anim)').forEach(selector => {
                const animControls = selector.closest('.animation-controls');
                const spriteContainer = animControls ? animControls.closest('.sprite-config-container') : null;
                const imgPreview = spriteContainer ? spriteContainer.querySelector('.sprite-anim-img') : null;

                if (imgPreview) {
                    // Terapkan animasi awal saat kartu dibuat
                    const initialAnimValue = selector.value || 'anim-in-fade';
                    applyLiveAnimation(imgPreview, initialAnimValue);

                    // Pasang listener untuk perubahan selector
                    selector.addEventListener('change', () => {
                        const animValue = selector.value || 'anim-in-fade';
                        applyLiveAnimation(imgPreview, animValue);
                    });
                }
            });

            // Bind event untuk semua selector animasi sprite custom (extra sprites)
            card.querySelectorAll('.extra-sprite-anim').forEach(selector => {
                const animControls = selector.closest('.animation-controls');
                const spriteContainer = animControls ? animControls.closest('.sprite-config-container') : null;
                const imgPreview = spriteContainer ? spriteContainer.querySelector('.sprite-anim-img.extra-sprite-preview') : null;

                if (imgPreview) {
                    // Terapkan animasi awal saat kartu dibuat
                    const initialAnimValue = selector.value || 'anim-in-fade';
                    applyLiveAnimation(imgPreview, initialAnimValue);

                    // Pasang listener untuk perubahan selector
                    selector.addEventListener('change', () => {
                        const animValue = selector.value || 'anim-in-fade';
                        applyLiveAnimation(imgPreview, animValue);
                    });
                }
            });

            return card;
        }

        function updateSceneButtonStates() {
            // 1. Dapatkan semua kontainer di mana entri bisa ditambahkan
            const allContentContainers = document.querySelectorAll('.phase-content, .label-group-content, .sub-label-content');

            allContentContainers.forEach(container => {
                // 2. Temukan "induk" yang memegang tombol-tombol kontrol
                const controlsParent = container.closest('.phase-card, .label-group-container, .sub-label-container');
                if (!controlsParent) return;

                // 3. Dapatkan tombol "Tambah Transisi" yang spesifik untuk konteks ini
                const sceneButton = controlsParent.querySelector('.add-entry-btn[data-type="scene"]');
                if (!sceneButton) return;

                // 4. Periksa apakah kontainer memiliki elemen entri di dalamnya
                const hasEntries = container.querySelector('.dialogue-entry-card, .label-group-container, .sub-label-container');

                // 5. Terapkan logika blokir/izinkan dengan tambahan tooltip
                if (hasEntries) {
                    // Jika sudah ada entri, aktifkan tombol
                    sceneButton.disabled = false;
                    sceneButton.style.opacity = '1';
                    sceneButton.style.cursor = 'pointer';
                    // Atur kembali title ke teks normal saat tombol aktif
                    sceneButton.title = 'Tambah entri transisi scene';
                } else {
                    // Jika kosong, nonaktifkan tombol
                    sceneButton.disabled = true;
                    sceneButton.style.opacity = '0.4';
                    sceneButton.style.cursor = 'not-allowed';
                    sceneButton.title = 'Buat entri lain (seperti dialog) terlebih dahulu sebelum menambah transisi.';
                }
            });
        }

        function toggleTransitionOutControls(checkboxElement) {
            // Cari kartu entri scene terdekat
            const card = checkboxElement.closest('.dialogue-entry-card');
            if (!card) return;

            // Cek tipe scene saat ini
            const sceneTypeSelector = card.querySelector('.scene-type-selector');
            const currentSceneType = sceneTypeSelector ? sceneTypeSelector.value : 'image';

            // Jika tipe scene adalah 'text_screen', JANGAN nonaktifkan kontrol keluar
            if (currentSceneType === 'text_screen') {
                const container = card.querySelector('.transition-out-container');
                if (container) {
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    container.querySelectorAll('select, input, button').forEach(input => input.disabled = false);
                }
                return;
            }

            // Cari kontainer untuk kontrol 'keluar'
            const container = card.querySelector('.transition-out-container');
            if (!container) return;

            // Ambil semua input di dalamnya
            const inputs = container.querySelectorAll('select, input, button');

            // Tentukan apakah harus dinonaktifkan
            const isDisabled = checkboxElement.checked;

            // Atur properti disabled dan gaya visual
            container.style.opacity = isDisabled ? '0.5' : '1';
            container.style.pointerEvents = isDisabled ? 'none' : 'auto';
            inputs.forEach(input => {
                input.disabled = isDisabled;
            });
        }

        // Render data skrip menjadi form input
        function renderScriptEditor(scriptData) {
            scriptEditorArea.innerHTML = '';
            if (!scriptData || scriptData.length === 0) {
                scriptEditorArea.innerHTML = '<p style="opacity: 0.7;">Skrip masih kosong. Tambahkan entri pertama.</p>';
            }

            scriptData.forEach((entry, index) => {
                const card = document.createElement('div');
                card.className = 'dialogue-entry-card';
                card.dataset.index = index;
                card.dataset.type = entry.type; // Simpan tipe entri untuk proses save

                let contentHTML = '';

                // Fungsi helper untuk membuat preview gambar
                const createImgPreview = (name, value) => {
                    const imgSrc = value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}` : '';
                    return `<img src="${imgSrc}" class="image-preview" onerror="this.style.display='none'" onload="this.style.display='block'" alt="Preview">`;
                };

                switch (entry.type) {
                    case 'dialogue':
                        contentHTML = `
                    <label>Tipe: <strong>Dialog</strong></label>
                    <label>Speaker</label>
                    <input type="text" class="script-input" data-key="speaker" value="${entry.speaker || ''}">
                    <label>Teks Dialog</label>

                    <textarea class="script-input" data-key="text" rows="3">${entry.text || ''}</textarea>

                    <label>Sprite (cth: elaina1.png)</label>
                    <input type="text" class="script-input image-input" data-key="sprite" value="${entry.sprite || ''}">
                    ${createImgPreview('sprite', entry.sprite)}
                    <label>Sprite 2 (opsional)</label>
                    <input type="text" class="script-input image-input" data-key="sprite2" value="${entry.sprite2 || ''}">
                    ${createImgPreview('sprite2', entry.sprite2)}
                    <label>Background (cth: bg1.jpg)</label>
                    <input type="text" class="script-input image-input" data-key="background" value="${entry.background || ''}">
                    ${createImgPreview('background', entry.background)}
                    <label>BGM (opsional, cth: music.mp3)</label>
                    <input type="text" class="script-input audio-input" data-key="bgm" value="${entry.bgm || ''}">
                    <label>SFX (opsional, cth: sound.mp3)</label>
                    <input type="text" class="script-input audio-input" data-key="sfx" value="${entry.sfx || ''}">
                `;
                        break;
                    case 'scene':
                        contentHTML = `
                    <label>Tipe: <strong>Scene Transition</strong></label>
                    <label>Background</label>
                    <input type="text" class="script-input image-input" data-key="background" value="${entry.background || ''}">
                    ${createImgPreview('background', entry.background)}
                    <label>SFX (opsional)</label>
                    <input type="text" class="script-input audio-input" data-key="sfx" value="${entry.sfx || ''}">
                `;
                        break;

                    case 'label':
                        contentHTML = `
                    <label>Tipe: <strong>Label</strong> (Untuk tujuan 'jump')</label>
                    <label>Nama Label</label>
                    <input type="text" class="script-input" data-key="name" value="${entry.name || ''}">
                `;
                        break;
                    default:
                        contentHTML = `<p>Tipe: <strong>${entry.type}</strong> (editor untuk tipe ini belum lengkap)</p>`;
                        break;
                }

                card.innerHTML = contentHTML + '<button class="delete-dialogue-btn">Hapus</button>';
                scriptEditorArea.appendChild(card);
            });

            // preview real-time
            scriptEditorArea.querySelectorAll('.image-input').forEach(input => {
                const preview = input.nextElementSibling;
                input.addEventListener('input', () => {
                    const newSrc = input.value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${input.value}` : '';
                    preview.src = newSrc;
                });
            });
            scriptEditorArea.querySelectorAll('.audio-input').forEach(input => {
                const preview = input.nextElementSibling;
                input.addEventListener('input', () => {
                    const newSrc = input.value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${input.value}` : '';
                    preview.src = newSrc;
                });
            });
        }

        // memperbarui warna kotak <select> berdasarkan pilihan
        function updateSelectColor(selectElement) {
            if (!selectElement) return;

            // Hapus kelas warna lama terlebih dahulu
            selectElement.classList.remove('has-main-label-selection', 'has-sub-label-selection');

            // Dapatkan opsi yang sedang dipilih
            const selectedOption = selectElement.selectedOptions[0];
            if (!selectedOption) return;

            if (selectedOption.classList.contains('option-main-label')) {
                selectElement.classList.add('has-main-label-selection');
            } else if (selectedOption.classList.contains('option-sub-label')) {
                selectElement.classList.add('has-sub-label-selection');
            }
        }

        // refresh untuk dropdown
        function updateAllJumpTargetDropdowns() {
            console.log('[Updater] Memperbarui semua dropdown target lompatan...');

            const allPhaseNames = Array.from(document.querySelectorAll('.phase-name-input')).map(input => input.value.trim()).filter(Boolean);
            const allLabelNames = Array.from(document.querySelectorAll('.label-name-input, .sub-label-name-input')).map(input => {
                if (input.classList.contains('sub-label-name-input')) {
                    const parentLabelName = input.closest('.label-group-container')?.querySelector('.label-name-input')?.value.trim();
                    return parentLabelName ? `${parentLabelName}.${input.value.trim()}` : null;
                }
                return input.value.trim();
            }).filter(Boolean);

            // Memperbarui dropdown di akhir Fase
            document.querySelectorAll('.phase-jump-target').forEach(select => {
                const parentPhaseName = select.closest('.phase-card')?.querySelector('.phase-name-input')?.value.trim();
                const currentValue = select.value;
                let optionsHTML = '<option value="">Lanjut ke fase berikutnya (Default)</option>';
                allPhaseNames.forEach(name => {
                    if (name !== parentPhaseName) {
                        optionsHTML += `<option value="fase:${name}">Fase: ${name}</option>`;
                    }
                });
                select.innerHTML = optionsHTML;
                select.value = currentValue;
            });

            // Memperbarui dropdown di akhir Grup Label Utama
            document.querySelectorAll('.label-jump-target').forEach(select => {
                const parentLabelName = select.closest('.label-group-container')?.querySelector('.label-name-input')?.value.trim();
                const currentValue = select.value;
                const phaseOptionsHTML = allPhaseNames.map(name => `<option value="fase:${name}">Fase: ${name}</option>`).join('');
                const labelOptionsHTML = allLabelNames
                    .filter(name => name !== parentLabelName && !name.includes('.'))
                    .map(name => `<option value="${name}" class="option-main-label">Label: ${name}</option>`)
                    .join('');

                let optionsHTML = '<option value="">Lanjut ke entri berikutnya (Default)</option>';
                if (phaseOptionsHTML) optionsHTML += `<optgroup label="------ Lompat ke Fase ------">${phaseOptionsHTML}</optgroup>`;
                if (labelOptionsHTML) optionsHTML += `<optgroup label="------ Lompat ke Label ------">${labelOptionsHTML}</optgroup>`;

                optionsHTML += `
            <optgroup label="------ Perintah Khusus ------">
                <option value="##SKIP_ALL_LABEL##">Lewati/skip semua label yang ada di fase ini</option>
            </optgroup>
        `;

                select.innerHTML = optionsHTML;
                select.value = currentValue;
            });

            // Memperbarui dropdown di dalam kartu Pilihan (Choice)
            document.querySelectorAll('.choice-option-jump').forEach(select => {
                const currentValue = select.value;
                const parentChoiceCard = select.closest('.dialogue-entry-card');
                const parentLabelGroup = select.closest('.label-group-container');
                const inLabelContext = parentChoiceCard && parentChoiceCard.dataset.inLabelContext === 'true';
                const parentLabelName = parentLabelGroup?.querySelector('.label-name-input')?.value.trim();
                const availableLabels = allLabelNames.filter(name => {
                    const isSubLabel = name.includes('.');
                    if (!isSubLabel) return true;
                    if (parentLabelName && name.startsWith(parentLabelName + '.')) return true;
                    return false;
                });

                let optionsHTML = '<option value="">Pilih Label Tujuan...</option>';
                let specialCommandsHTML = '';

                if (inLabelContext) {
                    // Opsi ini HANYA muncul jika Choice berada DI DALAM sebuah Label
                    specialCommandsHTML = `
                <option value="##CONTINUE_PARENT##">Lanjut di Label Induk (lewati sub-label)</option>
                <option value="##FINISH_PARENT##">Selesaikan Label Induk</option>
                <option value="##EXIT_LABEL##">Keluar dari Label (lanjut ke bawah)</option>
            `;
                } else {
                    // Opsi ini HANYA muncul jika Choice berada DI LUAR Label (di level Fase)
                    specialCommandsHTML = `
                <option value="##SKIP_ALL_LABEL##">Lewati/skip semua label di fase ini</option>
            `;
                }
                optionsHTML += `<optgroup label="------ Perintah Khusus ------">${specialCommandsHTML}</optgroup>`;

                if (availableLabels.length > 0) {
                    optionsHTML += `<optgroup label="------ Lompat ke Label ------">`;
                    availableLabels.forEach(name => {
                        let displayName = name;
                        let className = 'option-main-label';
                        if (name.includes('.')) {
                            displayName = ` (sub) ${name.split('.')[1]}`;
                            className = 'option-sub-label';
                        }
                        optionsHTML += `<option value="${name}" class="${className}">${displayName}</option>`;
                    });
                    optionsHTML += `</optgroup>`;
                }

                select.innerHTML = optionsHTML;
                select.value = currentValue;
            });

            // Memperbarui dropdown di dalam Sub-Label
            document.querySelectorAll('.sub-label-jump-target').forEach(select => {
                const subLabelContainer = select.closest('.sub-label-container');
                const parentLabelName = subLabelContainer.dataset.parentName;
                const currentSubLabelInput = subLabelContainer.querySelector('.sub-label-name-input');
                const currentSubLabelName = currentSubLabelInput ? `${parentLabelName}.${currentSubLabelInput.value.trim()}` : null;
                const currentValue = select.value;
                const siblingSubLabels = allLabelNames.filter(name =>
                    name.startsWith(parentLabelName + '.') && name !== currentSubLabelName
                );

                let optionsHTML = `
            <option value="##EXIT_SUB_LABEL##">Selesaikan sub-label ini (Default, ini berarti alur cerita akan lanjut ke bawahnya.)</option>
        `;

                optionsHTML += `
            <optgroup label="------ Perintah Khusus ------">
                <option value="##CONTINUE_PARENT_FLOW##">Lanjut di Label Induk (Lewati semua sub-label Di bawahnya)</option>
                <option value="##FINISH_PARENT##" class="option-main-label">Selesaikan Label "${parentLabelName}" (ini Berarti Label "${parentLabelName}" dianggap telah berakhir)</option>
            </optgroup>
        `;

                if (siblingSubLabels.length > 0) {
                    optionsHTML += `<optgroup label="------ Lompat ke Sub-Label Lain ------">`;
                    siblingSubLabels.forEach(name => {
                        const displayName = name.split('.')[1];
                        optionsHTML += `<option value="${name}" class="option-sub-label"> ${displayName}</option>`;
                    });
                    optionsHTML += `</optgroup>`;
                }

                select.innerHTML = optionsHTML;
                select.value = currentValue;
            });

            console.log('[Updater] Semua dropdown telah diperbarui.');
            scriptEditorArea.querySelectorAll('.label-jump-target, .choice-option-jump, .sub-label-jump-target')
                .forEach(updateSelectColor);
        }

        // ======================== FUNGSI PREVIEW LABEL ======================== //
        // Fungsi untuk mengekstrak data preview dari grup label
        // Mengambil semua entri di dalam label dan membangun payload untuk diputar
        function extractLabelPreviewData(labelGroupContainer) {
            if (!labelGroupContainer) return null;

            // Ambil nama label
            const labelName = labelGroupContainer.querySelector('.label-name-input')?.value.trim() || 'Preview';

            // Ambil data konteks dari label (background, BGM, dll)
            const labelContext = {};

            // Background/Video dari label
            const mediaInput = labelGroupContainer.querySelector('.label-media-input');
            if (mediaInput && mediaInput.value.trim()) {
                const mediaValue = mediaInput.value.trim();
                const ext = mediaValue.split('.').pop().toLowerCase();
                const isVideo = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);

                if (isVideo) {
                    labelContext.video = mediaValue;
                } else {
                    labelContext.background = mediaValue;
                    const bgModeRadio = labelGroupContainer.querySelector('input[data-key="backgroundMode"]:checked');
                    labelContext.backgroundMode = bgModeRadio ? bgModeRadio.value : 'cover';
                }
            }

            // BGM dari label
            const bgmInput = labelGroupContainer.querySelector('.label-default-bgm-input');
            if (bgmInput && bgmInput.value.trim()) {
                labelContext.bgm = bgmInput.value.trim();

                // Volume BGM
                const bgmVolumeSlider = labelGroupContainer.querySelector('input[data-key="bgmVolume"]');
                if (bgmVolumeSlider) {
                    labelContext.bgmVolume = parseFloat(bgmVolumeSlider.value) || 100;
                }
            }

            // SFX dari label
            const sfxInput = labelGroupContainer.querySelector('.label-default-sfx-input');
            if (sfxInput && sfxInput.value.trim()) {
                labelContext.sfx = sfxInput.value.trim();
            }

            // Transisi masuk
            const transitionSelect = labelGroupContainer.querySelector('.label-entry-transition-select');
            if (transitionSelect && transitionSelect.value) {
                labelContext.transition = transitionSelect.value;
            }

            // Kumpulkan semua entri di dalam label
            const labelContent = labelGroupContainer.querySelector('.label-group-content');
            const entries = [];

            if (labelContent) {
                // Iterasi semua child elements (entry cards, sub-labels, dll)
                // Parameter parentLabelName digunakan untuk membangun nama lengkap sub-label
                const processChildren = (parentElement, parentLabelName = '') => {
                    const childElements = Array.from(parentElement.children);

                    childElements.forEach(element => {
                        if (element.classList.contains('dialogue-entry-card')) {
                            // Ekstrak data dari entry card
                            const cardData = extractDataFromCard(element);
                            entries.push(cardData);
                        } else if (element.classList.contains('sub-label-container')) {
                            // === PERBAIKAN: Tambahkan sub-label sebagai entri label header ===
                            const subLabelNameInput = element.querySelector('.sub-label-name-input');
                            const subLabelName = subLabelNameInput ? subLabelNameInput.value.trim() : '';

                            // Bangun nama lengkap sub-label (parentLabel.subLabel)
                            const fullSubLabelName = parentLabelName
                                ? `${parentLabelName}.${subLabelName}`
                                : `${labelName}.${subLabelName}`;

                            // Tambahkan entri label header untuk sub-label
                            entries.push({
                                type: 'label',
                                name: fullSubLabelName
                            });

                            // Proses isi sub-label secara rekursif
                            const subLabelContent = element.querySelector('.sub-label-content');
                            if (subLabelContent) {
                                processChildren(subLabelContent, fullSubLabelName);
                            }

                            // === PERBAIKAN: Tambahkan entri jump berdasarkan flow control sub-label ===
                            const jumpTargetSelect = element.querySelector('.sub-label-jump-target');
                            if (jumpTargetSelect) {
                                const jumpTarget = jumpTargetSelect.value;

                                // Hanya tambahkan jump jika bukan default exit (##EXIT_SUB_LABEL##)
                                // ##EXIT_SUB_LABEL## berarti lanjut ke entri berikutnya secara natural
                                if (jumpTarget && jumpTarget !== '##EXIT_SUB_LABEL##') {
                                    entries.push({
                                        type: 'jump',
                                        target: jumpTarget
                                    });
                                }
                            }
                        }
                    });
                };

                processChildren(labelContent);
            }

            // === PERBAIKAN: Tambahkan entri jump dari flow control label utama ===
            const mainLabelJumpSelect = labelGroupContainer.querySelector('.label-jump-target');
            if (mainLabelJumpSelect) {
                const mainJumpTarget = mainLabelJumpSelect.value;
                // Hanya tambahkan jump jika ada target (bukan default "lanjut ke entri berikutnya")
                if (mainJumpTarget && mainJumpTarget.trim() !== '') {
                    entries.push({
                        type: 'jump',
                        target: mainJumpTarget
                    });
                }
            }

            // Jika tidak ada entri, kembalikan null
            if (entries.length === 0) {
                return null;
            }

            // Patch path aset untuk semua entri
            if (currentlyEditing && currentlyEditing.novel && currentlyEditing.chapter) {
                const assetPrefix = `aset/game/visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/`;
                const assetKeys = ['background', 'video', 'sprite', 'sprite2', 'spriteCenter', 'bgm', 'sfx', 'sfxIn', 'sfxOut', 'voice'];

                // Patch konteks label
                assetKeys.forEach(key => {
                    if (labelContext[key] && !labelContext[key].startsWith('http') && !labelContext[key].startsWith('file:')) {
                        labelContext[key] = assetPrefix + labelContext[key];
                    }
                });

                // Patch setiap entri
                entries.forEach(entry => {
                    assetKeys.forEach(key => {
                        if (entry[key] && !entry[key].startsWith('http') && !entry[key].startsWith('file:')) {
                            entry[key] = assetPrefix + entry[key];
                        }
                    });

                    // Patch special event SFX
                    if (entry.specialEvent && entry.specialEvent.sfx) {
                        if (!entry.specialEvent.sfx.startsWith('http') && !entry.specialEvent.sfx.startsWith('file:')) {
                            entry.specialEvent.sfx = assetPrefix + entry.specialEvent.sfx;
                        }
                    }

                    // Patch array charSprites
                    if (entry.charSprites && Array.isArray(entry.charSprites)) {
                        entry.charSprites = entry.charSprites.map(sprite => {
                            if (sprite.src && !sprite.src.startsWith('http') && !sprite.src.startsWith('file:')) {
                                return { ...sprite, src: assetPrefix + sprite.src };
                            }
                            return sprite;
                        });
                    }
                });
            }

            return {
                labelName: labelName,
                context: labelContext,
                entries: entries,
                isPreview: true
            };
        }
        // ======================== AKHIR FUNGSI PREVIEW LABEL ======================== //

        // Fungsi helper untuk mengekstrak data dari kartu entri (dipakai untuk save & clone)
        const extractDataFromCard = (card) => {
            const entryData = { type: card.dataset.type };

            // --- Special Event Extraction (Extension System) ---
            const specialForm = card.querySelector('.special-event-form');
            // Hanya simpan jika form AKTIF (terbuka) DAN tipe event sudah dipilih (bukan kosong)
            if (specialForm && specialForm.style.display !== 'none') {
                const eventType = specialForm.querySelector('.special-event-type').value;

                // Validasi: Hanya simpan jika tipe event sudah dipilih
                if (eventType && eventType.trim() !== '') {
                    const delayEnable = specialForm.querySelector('.special-event-delay-enable');
                    const delayInput = specialForm.querySelector('.special-event-delay');

                    entryData.specialEvent = {
                        type: eventType,
                        duration: parseInt(specialForm.querySelector('.special-event-duration').value) || 1000,
                        intensity: parseFloat(specialForm.querySelector('.special-event-intensity').value) || 1.0,
                        sfx: specialForm.querySelector('.special-event-sfx').value.trim(),
                        wait: specialForm.querySelector('.special-event-wait').checked,
                        // Delay logic
                        delay: (delayEnable && delayEnable.checked && delayInput) ? (parseInt(delayInput.value) || 0) : 0
                    };
                }
            }

            // --- Dapatkan Tipe Scene AKTIF TERLEBIH DAHULU (jika relevan) ---
            let activeSceneType = null;
            if (entryData.type === 'scene') {
                const sceneSelector = card.querySelector('.scene-type-selector');
                activeSceneType = sceneSelector ? sceneSelector.value : 'image'; // Default jika selector tidak ada
                entryData.sceneType = activeSceneType; // Simpan tipe scene lebih awal
            }

            // --- Pilih hanya input yang relevan ---
            let relevantInputs;
            if (activeSceneType) {
                // Pilih input yang umum (di luar blok tipe) ATAU spesifik untuk tipe scene AKTIF
                const commonSelector = `.script-input:not(.choice-option-text):not(.choice-option-jump):not([data-scene-type] .script-input)`;
                const activeTypeSelector = `.scene-input-group[data-scene-type="${activeSceneType}"] .script-input:not(.choice-option-text):not(.choice-option-jump)`;
                const commonCheckboxSelector = `input[type="checkbox"][data-key]:not([data-scene-type] input[type="checkbox"])`;
                const activeCheckboxSelector = `.scene-input-group[data-scene-type="${activeSceneType}"] input[type="checkbox"][data-key]`; // Checkbox spesifik tipe

                relevantInputs = Array.from(card.querySelectorAll(
                    `${commonSelector}, ${activeTypeSelector}, ${commonCheckboxSelector}, ${activeCheckboxSelector}`
                ));
            } else {
                // Jika bukan scene, ambil semua input standar
                relevantInputs = Array.from(card.querySelectorAll('.script-input:not(.choice-option-text):not(.choice-option-jump), input[type="checkbox"][data-key]'));
            }

            // --- Loop 1: Proses Path Aset ---
            relevantInputs.forEach(input => {
                const key = input.dataset.key;
                if (key) {
                    // Gunakan daftar eksplisit kunci aset
                    const isAssetKey = ['background', 'video', 'sprite', 'sprite2', 'spriteCenter', 'bgm', 'sfx', 'sfxIn', 'sfxOut', 'voice'].includes(key);
                    if (isAssetKey && input.value.trim() !== '') {
                        entryData[key] = input.value.trim();
                    }
                }
            });

            // --- Loop 2: Proses Input Lainnya (Volume, Teks, Switch, Duration, dll.) ---
            relevantInputs.forEach(input => {
                const key = input.dataset.key;
                if (!key) return;

                // Lewati path aset (sudah diproses)
                const isAssetKey = ['background', 'video', 'sprite', 'sprite2', 'spriteCenter', 'bgm', 'sfx', 'sfxIn', 'sfxOut', 'voice'].includes(key);
                if (isAssetKey) return;

                // Tentukan relevansi (apakah aset dasarnya ada ATAU key ada di daftar inti)
                // Tambahkan 'X' untuk position keys: spriteX, sprite2X, spriteCenterX
                // Tambahkan 'Transition' dan 'TransitionDuration' untuk fitur transisi sprite
                // Key transisi bergantung pada keberadaan sprite (baseKey), tidak perlu di daftar includes
                const baseKey = key.replace(/Volume|Pan|Delay|Anim|Loop|Fade|Mode|Scale|X|Transition|TransitionDuration$/g, '');

                // Cek jika ini adalah key TransitionDuration, maka cek apakah Transition-nya aktif
                let isTransitionDurationRelevant = false;
                if (key.endsWith('TransitionDuration')) {
                    // Cari checkbox transisi terkait dan cek apakah checked
                    const transitionKey = key.replace('Duration', ''); // spriteTransitionDuration -> spriteTransition
                    const transitionCheckbox = card.querySelector(`[data-key="${transitionKey}"]`);
                    isTransitionDurationRelevant = transitionCheckbox && transitionCheckbox.checked;
                }

                const isRelevant = entryData[baseKey] || isTransitionDurationRelevant ||
                    ['persistBackground', 'sceneType', 'transition', 'transitionOut',
                        'speaker', 'text', 'duration', 'backgroundMode', 'bgmLoop',
                        'bgmFade', 'name', 'videoMuted', 'mutePhaseBgm',
                        'sfxInVolume', 'sfxInDelay', 'sfxInPan',
                        'sfxOutVolume', 'sfxOutDelay', 'sfxOutPan'
                    ].includes(key);

                if (isRelevant) {
                    // Ambil nilai: checkbox -> boolean, radio -> value jika checked, lainnya -> value
                    const value = input.type === 'checkbox' ? input.checked
                        : input.type === 'radio' ? (input.checked ? input.value : undefined)
                            : input.value;

                    // Hanya simpan jika value valid (bukan undefined/string kosong, kecuali boolean)
                    if (value !== undefined && (typeof value === 'boolean' || (typeof value === 'string' && value.trim() !== '') || typeof value === 'number')) {
                        if (key === 'duration' && !isNaN(parseFloat(value))) {
                            // Konversi detik ke ms, pastikan minimal 100ms
                            entryData.duration = Math.max(100, parseFloat(value) * 1000);
                        } else if (input.classList.contains('scale-slider')) {
                            // Konversi slider (0-100) ke scale factor (0.25 - 1.75)
                            // Formula: y = 0.015x + 0.25
                            const percent = parseFloat(value);
                            entryData[key] = 0.015 * percent + 0.25;
                        } else if (input.classList.contains('sprite-position-slider')) {
                            // Posisi X sprite (0-100%) - simpan sebagai integer
                            entryData[key] = parseInt(value) || 50;
                        } else if (input.classList.contains('transition-duration-slider')) {
                            // Durasi transisi sprite - simpan sebagai integer (ms)
                            entryData[key] = parseInt(value) || 500;
                        } else if (input.type === 'range' || (input.type === 'number' && key !== 'duration')) { // Input angka lain
                            entryData[key] = parseFloat(value);
                        } else { // String, boolean, radio value
                            entryData[key] = value;
                        }
                    }
                }
            });

            // --- Step 3: Cleanup properti spesifik scene (REVISI) ---
            if (entryData.type === 'scene') {
                // activeSceneType sudah didapatkan di awal
                switch (activeSceneType) {
                    case 'image':
                        delete entryData.video; delete entryData.videoMuted; delete entryData.duration; delete entryData.mutePhaseBgm;
                        break;
                    case 'video':
                        delete entryData.background; delete entryData.backgroundMode;
                        // JANGAN hapus duration, videoMuted, mutePhaseBgm
                        break;
                    case 'text_screen':
                        delete entryData.background; delete entryData.video; delete entryData.backgroundMode; delete entryData.persistBackground; delete entryData.videoMuted; delete entryData.mutePhaseBgm;
                        // JANGAN hapus duration
                        break;
                    default:
                        console.warn("Tipe scene tidak dikenal saat cleanup:", activeSceneType);
                        // Hapus semua properti spesifik jika tipe tidak dikenal
                        delete entryData.video; delete entryData.videoMuted; delete entryData.duration; delete entryData.background; delete entryData.backgroundMode; delete entryData.mutePhaseBgm;
                        break;
                }
            } else if (entryData.type === 'choice') {
                const autoDialogueToggle = card.querySelector('.auto-dialogue-toggle');
                if (autoDialogueToggle && autoDialogueToggle.checked) {
                    entryData.autoDialogue = card.querySelector('.auto-dialogue-type:checked').value;
                }
                const choices = [];
                card.querySelectorAll('.choice-option-editor').forEach(optEditor => {
                    const text = optEditor.querySelector('.choice-option-text').value.trim();
                    const jump = optEditor.querySelector('.choice-option-jump').value.trim();
                    if (text) { choices.push({ text, jump }); }
                });
                entryData.choices = choices;
            } else {
                // Untuk tipe selain scene (dialogue, label, jump), hapus properti scene
                delete entryData.sceneType;
                delete entryData.video; delete entryData.videoMuted; delete entryData.duration;
                delete entryData.background; delete entryData.backgroundMode; delete entryData.mutePhaseBgm;
                delete entryData.persistBackground; delete entryData.transition; delete entryData.transitionOut;
                delete entryData.sfxIn; delete entryData.sfxOut; delete entryData.bgmFade; delete entryData.bgmLoop;
            }
            if (entryData.type !== 'choice' && entryData.type !== 'special_event' && (entryData.type !== 'scene' || (activeSceneType !== 'video' && activeSceneType !== 'text_screen'))) {
                delete entryData.duration;
            }

            // === MULTI-SPRITE SYSTEM: Ekstrak Sprite Tambahan ===
            // Hanya untuk tipe dialogue dan choice
            if (entryData.type === 'dialogue' || entryData.type === 'choice') {
                // Ekstrak spriteMode (auto/custom) dari toggle
                const spriteModeToggle = card.querySelector('.sprite-mode-toggle');
                if (spriteModeToggle) {
                    entryData.spriteMode = spriteModeToggle.checked ? 'auto' : 'custom';
                }

                const extraSpritesContainer = card.querySelector('.extra-sprites-container');
                if (extraSpritesContainer) {
                    const extraSpriteItems = extraSpritesContainer.querySelectorAll('.extra-sprite-item');

                    if (extraSpriteItems.length > 0) {
                        // Inisialisasi charSprites array jika ada sprite tambahan
                        const charSprites = [];

                        // Tambahkan sprite preset yang sudah ada (untuk backward compatibility)
                        // CATATAN: Ini OPTIONAL - kita bisa tetap mempertahankan format lama
                        // untuk sprite preset (left, center, right) dan hanya menggunakan
                        // charSprites untuk sprite custom. Ini lebih aman untuk backward compat.

                        // Ekstrak sprite custom dari UI
                        extraSpriteItems.forEach((item, idx) => {
                            const srcInput = item.querySelector('.extra-sprite-src');
                            const xInput = item.querySelector('.extra-sprite-x');
                            const animSelect = item.querySelector('.extra-sprite-anim');
                            const scaleSlider = item.querySelector('.extra-sprite-scale');

                            const src = srcInput ? srcInput.value.trim() : '';
                            if (src) { // Hanya tambahkan jika ada file gambar
                                // Konversi slider percentage (0-100) ke scale factor (0.25 - 1.75)
                                const scalePercent = scaleSlider ? parseFloat(scaleSlider.value) : 50;
                                const scaleFactor = 0.015 * scalePercent + 0.25;

                                charSprites.push({
                                    id: `custom-sprite-${idx}`,
                                    src: src,
                                    slot: 'custom',
                                    x: xInput ? parseInt(xInput.value) || 50 : 50,
                                    anim: animSelect ? animSelect.value : 'anim-in-fade',
                                    scale: scaleFactor
                                });
                            }
                        });

                        // Hanya simpan charSprites jika ada isinya
                        if (charSprites.length > 0) {
                            entryData.charSprites = charSprites;
                        }
                    }
                }
            }

            return entryData;
        };

        // Fungsi untuk menyimpan perubahan
        async function saveScriptChanges() {
            if (!currentlyEditing.novel || !currentlyEditing.chapter) {
                showNotification('Tidak ada chapter yang dipilih untuk disimpan.', 'error');
                return;
            }

            const newScriptData = [];
            const phaseCards = scriptEditorArea.querySelectorAll('.phase-card');

            phaseCards.forEach(phaseCard => {
                const phaseObject = { type: 'phase', name: phaseCard.querySelector('.phase-name-input').value.trim() };

                // --- Logic Background Phase (Image vs Video) ---
                const mediaInput = phaseCard.querySelector('.phase-media-input');
                const mediaValue = mediaInput ? mediaInput.value.trim() : '';

                if (mediaValue) {
                    const ext = mediaValue.split('.').pop().toLowerCase();
                    const isVideo = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);

                    if (isVideo) {
                        phaseObject.video = mediaValue;
                    } else {
                        phaseObject.background = mediaValue;
                        const checkedModeRadio = phaseCard.querySelector('.phase-header input[data-key="backgroundMode"]:checked');
                        if (checkedModeRadio) {
                            phaseObject.backgroundMode = checkedModeRadio.value;
                        }
                    }
                }

                const defaultBgm = phaseCard.querySelector('.phase-default-bgm-input')?.value.trim();
                if (defaultBgm) phaseObject.bgm = defaultBgm;

                const phaseHeaderInputs = phaseCard.querySelectorAll('.phase-header .script-input');
                phaseHeaderInputs.forEach(input => {
                    const key = input.dataset.key;
                    // Skip background/video related keys as they are handled above
                    if (['background', 'video', 'backgroundMode', 'media'].includes(key)) return;

                    if (key) {
                        const value = input.value;
                        if (value.trim() !== '' || key.toLowerCase().includes('volume') || key.toLowerCase().includes('pan') || key.toLowerCase().includes('delay')) {
                            if (input.type === 'range' || input.type === 'number') {
                                phaseObject[key] = parseFloat(value);
                            } else if (value.trim() !== '') {
                                phaseObject[key] = value.trim();
                            }
                        }
                    }
                });

                if (phaseCard.querySelector('.is-ending-checkbox')?.checked) {
                    phaseObject.isEnding = true;
                }

                // Simpan transisi keluar fase
                const phaseExitTransition = phaseCard.querySelector('.phase-exit-transition-select')?.value;
                if (phaseExitTransition) {
                    phaseObject.transitionOut = phaseExitTransition;
                }

                newScriptData.push(phaseObject);

                const processChildren = (children) => {
                    const results = [];
                    children.forEach(element => {
                        if (element.classList.contains('label-group-container')) {
                            const labelName = element.querySelector('.label-name-input').value.trim();
                            if (labelName) {
                                const labelObject = { type: 'label', name: labelName };

                                const sceneTransition = element.querySelector('.label-entry-transition-select')?.value;
                                if (sceneTransition) labelObject.transition = sceneTransition;

                                // --- Logic Background Label (Image vs Video) ---
                                const mediaInput = element.querySelector('.label-media-input');
                                const mediaValue = mediaInput ? mediaInput.value.trim() : '';

                                if (mediaValue) {
                                    const ext = mediaValue.split('.').pop().toLowerCase();
                                    const isVideo = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);

                                    if (isVideo) {
                                        labelObject.video = mediaValue;
                                    } else {
                                        labelObject.background = mediaValue;
                                        const bgModeInput = element.querySelector('input[data-key="backgroundMode"]:checked');
                                        if (bgModeInput) labelObject.backgroundMode = bgModeInput.value;
                                    }
                                }

                                const headerAssetInputs = element.querySelectorAll('.phase-assets input[data-key]');
                                headerAssetInputs.forEach(input => {
                                    const key = input.dataset.key;
                                    // Skip background/video related keys as they are handled above
                                    if (['background', 'video', 'backgroundMode', 'media'].includes(key)) return;

                                    if (input.type === 'radio' && !input.checked) {
                                        return;
                                    }
                                    const value = input.value.trim();
                                    if (value) { labelObject[key] = value; }
                                });

                                // Simpan transisi keluar label
                                const labelExitTransition = element.querySelector('.label-exit-transition-select')?.value;
                                if (labelExitTransition) {
                                    labelObject.transitionOut = labelExitTransition;
                                }

                                results.push(labelObject);

                                const innerChildren = Array.from(element.querySelector('.label-group-content').children);
                                results.push(...processChildren(innerChildren));

                                const mainLabelJumpTarget = element.querySelector('.label-jump-target').value;
                                if (mainLabelJumpTarget) {
                                    results.push({ type: 'jump', target: mainLabelJumpTarget });
                                } else {
                                    results.push({ type: 'jump', target: '##EXIT_LABEL##' });
                                }
                            }
                        } else if (element.classList.contains('sub-label-container')) {
                            const parentLabelName = element.dataset.parentName;
                            const subLabelName = element.querySelector('.sub-label-name-input').value.trim();
                            if (parentLabelName && subLabelName) {
                                results.push({ type: 'label', name: `${parentLabelName}.${subLabelName}` });
                                const innerChildren = Array.from(element.querySelector('.sub-label-content').children);
                                results.push(...processChildren(innerChildren));
                                const subLabelJumpTarget = element.querySelector('.sub-label-jump-target')?.value;
                                if (subLabelJumpTarget) {
                                    results.push({ type: 'jump', target: subLabelJumpTarget });
                                }
                            }
                        } else if (element.classList.contains('dialogue-entry-card')) {
                            results.push(extractDataFromCard(element));
                        }
                    });
                    return results;
                };

                const topLevelChildren = Array.from(phaseCard.querySelector('.phase-content').children);
                let processedEntries = processChildren(topLevelChildren);

                newScriptData.push(...processedEntries);

                const phaseJumpTarget = phaseCard.querySelector('.phase-jump-target').value;
                if (phaseJumpTarget && !phaseObject.isEnding) {
                    newScriptData.push({ type: 'jump', target: phaseJumpTarget });
                }
            });

            saveScriptBtn.textContent = 'Menyimpan...';
            saveScriptBtn.disabled = true;
            try {
                console.log("Data yang akan disimpan:", JSON.stringify(newScriptData, null, 2));
                const result = await ipcRenderer.invoke('save-script-content', {
                    storyTitle: currentlyEditing.novel,
                    chapterName: currentlyEditing.chapter,
                    scriptContent: newScriptData
                });
                showNotification(result.message, 'success');
            } catch (error) {
                showNotification('Gagal menyimpan: ' + error.message, 'error');
                console.error("Error saat menyimpan skrip:", error);
            } finally {
                saveScriptBtn.textContent = 'Simpan Perubahan';
                saveScriptBtn.disabled = false;
            }
        }

        function createEntryCard(entryData, index) {
            const card = document.createElement('div');
            card.className = 'dialogue-entry-card';
            card.dataset.index = index;
            card.dataset.type = entryData.type;

            let contentHTML = '';
            if (entryData.type === 'dialogue') {
                contentHTML = `
            <label>Tipe: <strong>Dialog</strong></label>
            <label>Speaker</label>
            <input type="text" class="script-input" data-key="speaker" value="${entryData.speaker || ''}">
            <label>Teks Dialog</label>
            <textarea class="script-input" data-key="text" rows="3">${entryData.text || ''}</textarea>
        `;
            }

            card.innerHTML = contentHTML + '<button class="delete-dialogue-btn">Hapus</button>';

            // Pasang event listener di sini (untuk preview, tombol hapus, dll.)
            card.querySelector('.delete-dialogue-btn').onclick = () => card.remove();

            return card;
        }

        function createLabelGroupElement(data = {}, availableLabels = [], availablePhases = [], subsequentSceneData = {}) {
            const newLabelGroupContainer = document.createElement('div');
            newLabelGroupContainer.className = 'label-group-container';

            const createImgPreview = (value, key) => {
                const src = value ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${value}` : '';
                return `<img src="${src}" class="image-preview" data-preview-for="${key}" style="display: ${value ? 'block' : 'none'};" onload="this.style.display='block'" onerror="this.style.display='none'">`;
            };

            // Determine initial value
            const initialMediaValue = subsequentSceneData.video || subsequentSceneData.background || '';
            const isVideo = !!subsequentSceneData.video;

            const header = document.createElement('div');
            header.className = 'label-group-header';

            header.innerHTML = `
                <div class="drag-handle" title="Seret grup label ini"></div>
                <div style="flex-grow: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <span class="label-icon"></span>
                        <input type="text" class="script-input label-name-input" data-key="name" value="${data.name || ''}" placeholder="Beri nama unik untuk label ini...">
                        <button type="button" class="add-sub-label-btn" data-type="sub-label">+ Sub-Label</button>
                        <button type="button" class="preview-label-group-btn" title="Preview label ini di jendela terpisah"> Preview</button>
                        <button type="button" class="delete-label-group-btn" title="Hapus Label dan Isinya"></button>
                    </div>

                    <div class="label-config-row">
                        <div>
                            <label>Animasi Transisi Masuk Ke Label Ini</label>
                            <div class="file-input-group">
                                <select class="script-input label-entry-transition-select">
                                    <option value="">Tanpa Transisi (Default)</option>
                                    <option value="fade_black">Fade Hitam </option>
                                    <option value="fade_white">Fade Putih </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="phase-assets">
                        <div>
                            <label>Label Background (Gambar / Video)</label>
                            <div class="file-input-group">
                                <div class="input-with-clear-wrapper ${initialMediaValue ? 'has-text' : ''}">
                                    <input data-key="media" type="text" class="script-input label-media-input" value="${initialMediaValue}" placeholder="Kosongkan jika tidak berubah...">
                                    <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                                </div>
                                <button type="button" class="browse-file-btn" data-type="all-media"></button>
                            </div>

                            <div class="media-preview-container" style="margin-top: 10px;">
                                <!-- Image Preview Wrapper -->
                                <div class="image-preview-wrapper" style="display: ${!isVideo && initialMediaValue ? 'block' : 'none'};">
                                    <div class="image-preview-container-16-9">
                                        <img class="image-preview" data-preview-for="background" src="${!isVideo && initialMediaValue ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${initialMediaValue}` : ''}" style="display: ${!isVideo && initialMediaValue ? 'block' : 'none'};">
                                    </div>
                                    <div class="background-mode-options">
                                        <label>Tampilan:</label>
                                        <label>
                                            <input type="radio" name="background-mode-label-${data.name || Math.random()}" class="script-input" data-key="backgroundMode" value="cover" checked> Crop (Penuhi Layar)
                                        </label>
                                        <label>
                                            <input type="radio" name="background-mode-label-${data.name || Math.random()}" class="script-input" data-key="backgroundMode" value="contain"> Fit (Tampilkan Utuh)
                                        </label>
                                    </div>
                                </div>

                                <!-- Video Preview Wrapper -->
                                <div class="video-preview-wrapper" style="display: ${isVideo ? 'block' : 'none'};">
                                    <div class="video-preview-container" style="width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #444;">
                                        <video class="video-preview" data-preview-for="video" controls muted src="${isVideo ? `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${initialMediaValue}` : ''}" style="display: ${isVideo ? 'block' : 'none'}; width: 100%; height: 100%; object-fit: contain;"></video>
                                    </div>
                                </div>
                                
                                <span class="preview-placeholder" style="display: ${!initialMediaValue ? 'block' : 'none'}; color: #777; text-align: center; padding: 20px; border: 1px dashed #555; border-radius: 4px;">Belum ada background dipilih...</span>
                            </div>
                        </div>
                        <div>
                            <label>Label BGM</label>
                            <div class="file-input-group">
                                <div class="input-with-clear-wrapper ${subsequentSceneData.bgm ? 'has-text' : ''}">
                                    <input data-key="bgm" type="text" class="script-input audio-input label-default-bgm-input" value="${subsequentSceneData.bgm || ''}" placeholder="Kosongkan jika tidak berubah...">
                                    <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                                </div>
                                <button type="button" class="browse-file-btn" data-type="audio"></button>
                            </div>
                            
                            <div class="audio-preview-placeholder" data-src="${subsequentSceneData.bgm || ''}" data-preview-for="bgm"></div>
                        </div>
                        <div>
                            <label>Label SFX</label>
                            <div class="file-input-group">
                                <div class="input-with-clear-wrapper ${subsequentSceneData.sfx ? 'has-text' : ''}">
                                    <input data-key="sfx" type="text" class="script-input audio-input label-default-sfx-input" value="${subsequentSceneData.sfx || ''}" placeholder="Kosongkan jika tidak ada...">
                                    <button type="button" class="clear-input-btn-inside" title="Hapus Input">&times;</button>
                                </div>
                                <button type="button" class="browse-file-btn" data-type="audio"></button>
                            </div>

                            <div class="audio-preview-placeholder" data-src="${subsequentSceneData.sfx || ''}" data-preview-for="sfx"></div>
                        </div>
                    </div>
                    </div>
            `;

            const bgMode = subsequentSceneData.backgroundMode || 'cover';
            const bgModeRadio = header.querySelector(`input[data-key="backgroundMode"][value="${bgMode}"]`);
            if (bgModeRadio) {
                bgModeRadio.checked = true;
            }

            const bgPreviewImg = header.querySelector('.image-preview[data-preview-for="background"]');
            if (bgPreviewImg) {
                bgPreviewImg.style.objectFit = bgMode;
            }
            const labelBgmInput = header.querySelector('.label-default-bgm-input');
            const labelBgmVolume = createAudioControls('bgm', subsequentSceneData);
            labelBgmInput.closest('.file-input-group').after(labelBgmVolume);
            linkAudioInputToVolumeControl(labelBgmInput, labelBgmVolume);

            const labelSfxInput = header.querySelector('.label-default-sfx-input');
            const labelSfxVolume = createAudioControls('sfx', subsequentSceneData);
            labelSfxInput.closest('.file-input-group').after(labelSfxVolume);
            linkAudioInputToVolumeControl(labelSfxInput, labelSfxVolume);

            const transitionDropdown = header.querySelector('.label-entry-transition-select');
            if (transitionDropdown && subsequentSceneData.transition) {
                transitionDropdown.value = subsequentSceneData.transition;
            }

            // Logic to handle input changes and update preview
            const mediaInput = header.querySelector('.label-media-input');
            const imageWrapper = header.querySelector('.image-preview-wrapper');
            const videoWrapper = header.querySelector('.video-preview-wrapper');
            const placeholder = header.querySelector('.preview-placeholder');
            const imgPreview = header.querySelector('.image-preview');
            const videoPreview = header.querySelector('.video-preview');

            const updateMediaPreview = (filename) => {
                if (!filename) {
                    imageWrapper.style.display = 'none';
                    videoWrapper.style.display = 'none';
                    placeholder.style.display = 'block';
                    return;
                }

                const ext = filename.split('.').pop().toLowerCase();
                const isVideoFile = ['mp4', 'webm', 'mkv', 'avi', 'mov'].includes(ext);
                const src = `./visual_novels/${currentlyEditing.novel}/${currentlyEditing.chapter}/${filename}`;

                if (isVideoFile) {
                    imageWrapper.style.display = 'none';
                    videoWrapper.style.display = 'block';
                    placeholder.style.display = 'none';
                    videoPreview.src = src;
                    videoPreview.style.display = 'block';
                    videoPreview.load();
                } else {
                    imageWrapper.style.display = 'block';
                    videoWrapper.style.display = 'none';
                    placeholder.style.display = 'none';
                    imgPreview.src = src;
                    imgPreview.style.display = 'block';
                }
            };

            mediaInput.addEventListener('input', (e) => {
                updateMediaPreview(e.target.value);
            });

            const newContentWrapper = document.createElement('div');
            newContentWrapper.className = 'label-group-content';

            const newControlsDiv = document.createElement('div');
            newControlsDiv.className = 'phase-card-controls';
            newControlsDiv.style.paddingTop = '15px';
            newControlsDiv.innerHTML = `
                <button class="add-entry-btn" data-type="dialogue">+ Tambah Dialog</button>
                <button class="add-entry-btn" data-type="choice">+ Tambah Dialog ber-Pilihan Jawaban</button>
                <button class="add-entry-btn" data-type="scene">+ Tambah Transisi</button>
            `;

            // Dropdown untuk transisi keluar label
            const labelExitTransitionDiv = document.createElement('div');
            labelExitTransitionDiv.className = 'label-exit-transition';
            labelExitTransitionDiv.innerHTML = `
                <label>Animasi Transisi Keluar Label</label>
                <select class="label-exit-transition-select script-input" data-key="transitionOut">
                    <option value="">Tanpa Transisi (Default)</option>
                    <option value="fade_black" ${subsequentSceneData.transitionOut === 'fade_black' ? 'selected' : ''}>Fade Hitam </option>
                    <option value="fade_white" ${subsequentSceneData.transitionOut === 'fade_white' ? 'selected' : ''}>Fade Putih </option>
                    <option value="swipe_black_left" ${subsequentSceneData.transitionOut === 'swipe_black_left' ? 'selected' : ''}>Geser Hitam Kiri </option>
                    <option value="swipe_black_right" ${subsequentSceneData.transitionOut === 'swipe_black_right' ? 'selected' : ''}>Geser Hitam Kanan </option>
                </select>
            `;

            const flowControlDiv = document.createElement('div');
            flowControlDiv.className = 'label-group-flow-control';

            const labelOptionsHTML = availableLabels
                .filter(name => name !== data.name)
                .map(name => `<option value="${name}">Label: ${name}</option>`)
                .join('');

            const phaseOptionsHTML = availablePhases
                .map(name => `<option value="fase:${name}">Fase: ${name}</option>`)
                .join('');

            let selectHTML = `
                <label>Setelah Label ini selesai/berakhir, mau ke mana? :</label>
                <select class="label-jump-target">
                    <option value="">Lanjut ke entri berikutnya (Default)</option>
            `;

            if (phaseOptionsHTML) {
                selectHTML += `<optgroup label="------ Fase ------">${phaseOptionsHTML}</optgroup>`;
            }

            if (labelOptionsHTML) {
                selectHTML += `<optgroup label="------ Label ------">${labelOptionsHTML}</optgroup>`;
            }

            selectHTML += `
                <optgroup label="------ Perintah Khusus ------">
                    <option value="##SKIP_ALL_LABEL##">Lewati/skip semua label yang ada di fase ini</option>
                </optgroup>
            `;

            selectHTML += `</select>`;
            flowControlDiv.innerHTML = selectHTML;

            newLabelGroupContainer.appendChild(header);
            newLabelGroupContainer.appendChild(newContentWrapper);
            newLabelGroupContainer.appendChild(newControlsDiv);
            newLabelGroupContainer.appendChild(labelExitTransitionDiv);
            newLabelGroupContainer.appendChild(flowControlDiv);

            new Sortable(newContentWrapper, {
                group: {
                    name: 'phase-entries',
                    put: function (toList, fromList, draggedEl) {
                        if (draggedEl.classList.contains('label-group-container')) {
                            return false;
                        }
                        if (!draggedEl.classList.contains('entry-type-choice')) {
                            return true;
                        }
                        const fromIsLabel = fromList.closest('.label-group-container, .sub-label-container');
                        const toIsLabel = toList.closest('.label-group-container, .sub-label-container');
                        if (fromIsLabel && !toIsLabel) {
                            return false;
                        }
                        if (!fromIsLabel && toIsLabel) {
                            return false;
                        }
                        return true;
                    }
                },
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                forceFallback: true,
                fallbackOnBody: true,

                onMove: function (evt) {
                    const isScene = evt.dragged.dataset.type === 'scene';
                    if (!isScene) {
                        document.body.classList.remove('invalid-drag-state');
                        return true;
                    }
                    let isInvalidMove = false;
                    if (evt.to.children.length === 0 || (evt.to.children.length === 1 && evt.to.children[0] === evt.dragged)) {
                        isInvalidMove = true;
                    }
                    if (evt.willInsertAfter === false && evt.related === evt.to.children[0]) {
                        isInvalidMove = true;
                    }
                    if (isInvalidMove) {
                        document.body.classList.add('invalid-drag-state');
                        return false;
                    } else {
                        document.body.classList.remove('invalid-drag-state');
                        return true;
                    }
                },

                onEnd: function (evt) {
                    document.body.classList.remove('invalid-drag-state');
                },
            });

            newLabelGroupContainer.querySelectorAll('.audio-preview-placeholder').forEach(p => {
                const src = p.dataset.src;
                const key = p.dataset.previewFor;
                p.replaceWith(createAudioPreview(src, key));
            });

            return newLabelGroupContainer;
        }

        // Menambahkan entri dialog baru ke editor
        function addNewDialogueEntry() {
            const placeholder = scriptEditorArea.querySelector('p');
            if (placeholder) placeholder.remove(); // Hapus pesan "skrip masih kosong"

            const newIndex = scriptEditorArea.children.length;
            const defaultData = { type: 'dialogue', speaker: '', text: '' };
            const newCard = createEntryCard(defaultData, newIndex);
            scriptEditorArea.appendChild(newCard);
        }

        // Event Listeners untuk tombol-tombol di editor
        closeEditorBtn.addEventListener('click', hideScriptEditor);
        backToNovelSelectionBtn.addEventListener('click', () => {
            // Reset state tampilan sebelum kembali
            updateEditorContentView('chapters');
            editingChapterName.textContent = 'Pilih chapter untuk diedit atau edit aset';
            scriptEditorArea.innerHTML = '';
            scriptEditorControls.style.display = 'none';
            document.getElementById('btn-visualize-flow').style.display = 'none';
            document.getElementById('chapter-asset-explorer').style.display = 'none';
            currentlyEditing = { novel: null, chapter: null }; // Reset data novel/chapter yang diedit

            showScriptEditor();
        });
        saveScriptBtn.addEventListener('click', saveScriptChanges);

        // membuat chapter baru
        // Untuk saat ini, kita hanya akan refresh list
        editorAddNewChapterBtn.addEventListener('click', async () => {
            showConfirmation("Fungsi 'Tambah Chapter Baru' perlu diimplementasikan di main.js untuk membuat folder baru.", true);
            loadNovelForEditing(currentlyEditing.novel);
        });

        const sidebarTabsContainer = document.querySelector('.sidebar-tabs');
        if (sidebarTabsContainer) {
            sidebarTabsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('sidebar-tab')) {
                    const tabName = event.target.dataset.tab;

                    // Nonaktifkan semua tab dan konten
                    document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.sidebar-content').forEach(content => content.classList.remove('active'));

                    // Aktifkan tab yang diklik
                    event.target.classList.add('active');
                    const targetContent = document.getElementById(`sidebar-content-${tabName}`);
                    if (targetContent) targetContent.classList.add('active');
                }
            });
        } else {
            console.warn('Sidebar tabs container not found at line 8502');
        }
        // ------------------------------------------ End Script Editor Logic ------------------------------------ //

        // ------------------- Page Transition ------------------- //    
        function startPlayAnimation(selectedCard, playPath) {
            document.querySelectorAll('.story-card').forEach(card => {
                if (card !== selectedCard) {
                    card.classList.add('fade-out-scatter');
                }
            });
            selectedCard.classList.add('focused');
            setTimeout(() => {
                document.body.classList.add('page-fade-out');
                setTimeout(() => {
                    window.location.href = playPath;
                }, 600);
            }, 800);
        }
        // ------------------- Search ------------------- //

        function searchStories() {
            const query = searchInput.value.toLowerCase();
            const filtered = storiesData.filter(story => story.title.toLowerCase().includes(query));
            renderStories(filtered);
        }

        searchBtn.addEventListener('click', searchStories);
        searchInput.addEventListener('keyup', event => {
            if (event.key === 'Enter') {
                searchStories();
            }
        });
    </script>

    <!-- Flow Visualization Modal -->
    <div id="flow-visualization-modal" class="modal-overlay" style="z-index: 6000;">
        <div class="modal-content"
            style="width: 95%; height: 95%; max-width: none; background: #1a1a1a; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden;">

            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #333; background: #222;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <h3 style="margin: 0; color: #fff;">Visualisasi Alur Cerita</h3>
                    <span id="viz-chapter-info" style="color: #888; font-size: 0.9em;"></span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <!-- Toolbar -->
                    <div
                        style="display: flex; gap: 5px; margin-right: 15px; padding-right: 15px; border-right: 1px solid #444;">
                        <button id="viz-zoom-in" title="Zoom In"
                            style="background: #333; border: 1px solid #555; color: #fff; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 1.1em;">+</button>
                        <button id="viz-zoom-out" title="Zoom Out"
                            style="background: #333; border: 1px solid #555; color: #fff; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 1.1em;"></button>
                        <button id="viz-fit" title="Fit to Screen"
                            style="background: #333; border: 1px solid #555; color: #fff; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 0.9em;"></button>
                        <button id="viz-layout" title="Toggle Layout (Vertikal/Horizontal)"
                            style="background: #333; border: 1px solid #555; color: #fff; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 0.9em;"></button>
                    </div>
                    <div
                        style="display: flex; gap: 5px; margin-right: 15px; padding-right: 15px; border-right: 1px solid #444;">
                        <button id="viz-mode-detail" title="Mode Detail: Tampilkan semua entri"
                            style="background: #0074d9; border: 1px solid #0074d9; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                            Detail</button>
                        <button id="viz-mode-summary" title="Mode Ringkasan: Tampilkan hanya elemen alur"
                            style="background: #333; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                            Ringkasan</button>
                    </div>
                    <button id="close-flow-modal"
                        onclick="document.getElementById('flow-visualization-modal').classList.remove('visible');"
                        class="editor-button-cancel" style="padding: 8px 16px;"> Tutup</button>
                </div>
            </div>

            <!-- Graph Container -->
            <div id="cy" style="flex: 1; min-height: 0; background: #0d0d0d;"></div>

            <!-- Legend Footer -->
            <div
                style="padding: 12px 20px; font-size: 0.8em; color: #aaa; display: flex; gap: 15px; flex-wrap: wrap; background: #1a1a1a; border-top: 1px solid #333; align-items: center;">
                <span style="font-weight: bold; color: #fff; margin-right: 5px;">LEGEND:</span>
                <span title="Titik awal cerita"><span
                        style="display:inline-block;width:14px;height:14px;background:#0074d9;border-radius:50%;margin-right:4px;vertical-align:middle;"></span>Mulai</span>
                <span title="Fase/Chapter"><span
                        style="display:inline-block;width:14px;height:14px;background:#1e3a5f;border:2px solid #0074d9;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Fase</span>
                <span title="Label utama"><span
                        style="display:inline-block;width:14px;height:14px;background:#f1c40f;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Label</span>
                <span title="Sub-label"><span
                        style="display:inline-block;width:14px;height:14px;background:#3498db;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Sub-Label</span>
                <span title="Dialog"><span
                        style="display:inline-block;width:14px;height:14px;background:#222;border:2px solid #00ffff;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Dialog</span>
                <span title="Scene (gambar/video/teks)"><span
                        style="display:inline-block;width:14px;height:14px;background:#00f371;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Scene</span>
                <span title="Pilihan/Choice"><span
                        style="display:inline-block;width:10px;height:10px;background:#aa00ff;transform:rotate(45deg);margin-right:6px;vertical-align:middle;"></span>Pilihan</span>
                <span title="Opsi pilihan"><span
                        style="display:inline-block;width:14px;height:14px;background:#9b59b6;border-radius:3px;margin-right:4px;vertical-align:middle;"></span>Opsi</span>
                <span title="Akhir cerita"><span
                        style="display:inline-block;width:14px;height:14px;background:#ff851b;border-radius:50%;margin-right:4px;vertical-align:middle;"></span>Selesai</span>
                <span title="Target tidak ditemukan"><span
                        style="display:inline-block;width:14px;height:14px;background:#ff4136;margin-right:4px;vertical-align:middle;"></span>Error</span>
                <span style="margin-left: auto; color: #666; font-style: italic;"> Klik node untuk navigasi ke
                    editor</span>
            </div>
        </div>
    </div>
    <div id="notification-toast"></div>
    <div id="confirmation-modal-overlay">
        <div id="confirmation-modal-box">
            <p id="confirmation-modal-text"></p>
            <div class="confirmation-modal-buttons">
                <button id="confirm-no-btn">Batal</button>
                <button id="confirm-yes-btn">Yakin</button>
            </div>
        </div>
    </div>
    <div id="drag-tooltip">
        Entri "Transisi Scene" Tidak bisa menjadi entri pertama dalam sebuah Fase atau Label.<br>
    </div>
</body>

</html>